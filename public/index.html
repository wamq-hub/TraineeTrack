<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† - Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-blue: #0A5F8F;
            --secondary-green: #2C9A4F;
            --accent-gold: #D4AF37;
            --light-blue: #E8F4F8;
            --dark-blue: #053D5C;
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --text-dark: #333333;
            --border-color: #DDD;
        }

        body {
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(10, 95, 143, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--secondary-green);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50%, -50%);
            z-index: 0;              /* ØªØ­Øª ÙƒÙ„ Ø´ÙŠØ¡ */
            pointer-events: none;    /* Ù„Ø§ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ù†Ù‚Ø± */
        }

        .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        position: relative;
        z-index: 1; /* Ø¨Ø­ÙŠØ« ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ::before */
        }


        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.1);
        }

        .btn {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 95, 143, 0.3);
        }

        .btn-success {
            background: var(--secondary-green);
            color: white;
        }

        .btn-success:hover {
            background: #247d42;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-gold);
            color: var(--dark-blue);
        }

        .btn-warning:hover {
            background: #c5a032;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 30px;
            background: var(--gray);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-card {
            background: var(--light-blue);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid var(--primary-blue);
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .info-item strong {
            color: var(--primary-blue);
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-item span {
            color: var(--text-dark);
            font-size: 15px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-green), var(--accent-gold));
            margin: 30px 0;
            border-radius: 2px;
        }

        .ticket-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ticket-number {
            background: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .ticket-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }


        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border-right: 4px solid #17A2B8;
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border-right: 4px solid #28A745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .rating {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .star {
            font-size: 30px;
            color: #DDD;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover,
        .star.active {
            color: var(--accent-gold);
            transform: scale(1.2);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 2;              /* ÙÙˆÙ‚ Ø§Ù„Ø²Ø®Ø±ÙØ© */
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-blue);
        }

        .footer {
            background: var(--gray);
            padding: 20px;
            text-align: center;
            color: var(--text-dark);
            border-top: 3px solid var(--accent-gold);
        }

        .service-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .service-btn {
            position: relative;
            display: block;
            cursor: pointer;
            padding: 20px;
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .service-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 95, 143, 0.2);
        }

        .service-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .service-btn input[type="radio"]:checked + span {
            color: white;
        }

        .service-btn input[type="radio"]:checked ~ span {
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            border-color: var(--primary-blue);
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) span {
            color: white;
        }

        .service-btn span {
            display: block;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        /* ========== Ø¨Ø·Ø§Ù‚Ø© ØªØ°ÙƒØ±Ø© Ø­Ø¯ÙŠØ«Ø© ========== */
        .ticket-card.modern {
        border: 1.5px solid var(--border-color);
        border-radius: 14px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 4px 18px rgba(10,95,143,.06);
        transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .ticket-card.modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 26px rgba(10,95,143,.12);
        border-color: rgba(10,95,143,.25);
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
        .ticket-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
        }
        .ticket-id-chip {
        background: var(--dark-blue);
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: .3px;
        font-size: 13px;
        }
        .ticket-status-badge {
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        border: 1px solid transparent;
        }
        .ticket-status--completed {
        background: #E8F5E9;
        color: #1B5E20;
        border-color: #C8E6C9;
        }
        .ticket-status--pending {
        background: #FFF8E1;
        color: #8B6B00;
        border-color: #FFECB3;
        }
        .ticket-status--inprogress {
        background: #E1F5FE;
        color: #01579B;
        border-color: #B3E5FC;
        }

        /* ÙØ§ØµÙ„ */
        .ticket-sep {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent);
        margin: 10px 0 14px;
        border-radius: 1px;
        }

        /* Ø´Ø¨ÙƒØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .ticket-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 10px 18px;
        }
        @media (max-width: 640px) {
        .ticket-grid { grid-template-columns: 1fr; }
        }
        .ticket-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        line-height: 1.7;
        }
        .ticket-row .k {
        min-width: 110px;
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 13px;
        }
        .ticket-row .v {
        color: var(--text-dark);
        font-size: 14px;
        word-wrap: break-word;
        }

        /* Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù†Øµ Ù…Ù…ØªØ¯ */
        .ticket-details {
        margin-top: 6px;
        background: var(--light-blue);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
        color: #0c2b3c;
        border: 1px dashed rgba(10,95,143,.25);
        }

        /* ÙÙˆØªØ± */
        .ticket-foot {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        color: #6b7280;
        font-size: 12px;
        }
        .ticket-foot .dot {
        width: 4px; height: 4px; border-radius: 50%; background:#c9cdd2;
        display: inline-block; margin-inline: 6px;
        }


    </style>

    <style>
  /* âœ… ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  .modal {
    width: 100%; max-width: 640px;
    background: #fff; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    overflow: hidden;
    border: 2px solid var(--border-color);
  }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
    color: #fff;
  }
  .modal-close {
    background: transparent; border: 2px solid #fff; color: #fff;
    width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
    font-size: 20px; line-height: 1;
  }
  .modal-body {
    padding: 18px 20px;
  }
  .modal-label {
    display: block; font-weight: 700; color: var(--text-dark); margin-bottom: 8px;
  }
  .modal-textarea {
    width: 100%; padding: 14px;
    border: 2px solid var(--border-color); border-radius: 8px;
    font-size: 16px; resize: vertical;
    transition: box-shadow .2s, border-color .2s;
  }
  .modal-textarea:focus {
    outline: none; border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(10,95,143,.12);
  }
  .modal-hint {
    margin-top: 10px; color: #6B7280; font-size: 13px;
    background: var(--light-blue); padding: 10px 12px; border-radius: 8px;
  }
  .modal-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    padding: 14px 20px; border-top: 1px solid var(--border-color);
    background: #FAFAFA;
  }

  /* ====== ØªÙ‚ÙŠÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ ====== */
.rating-pro {
  display: flex; align-items: center; gap: 10px; justify-content: center;
}
.rating-pro .star {
  font-size: 30px; cursor: pointer; user-select: none; transition: transform .15s ease;
}
.rating-pro .star:hover { transform: scale(1.12); }
.rating-pro .star.dim { color: #D1D5DB; }          /* ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„ */
.rating-pro .star.lit { color: #D4AF37; }          /* Ù…ÙØ¶Ø§Ø¡Ø© */

.rating-scale {
  display: grid; grid-template-columns: repeat(5, minmax(0,1fr));
  gap: 6px; margin-top: 10px;
}
.rating-chip {
  text-align: center; font-size: 12px; padding: 6px 8px; border-radius: 999px;
  border: 1px solid #E5E7EB; color: #374151; background: #F9FAFB;
}
.rating-chip.active {
  background: #FFF7E6; border-color: #FBBF24; color: #92400E; font-weight: 700;
}

.rating-note {
  margin-top: 10px; color: #6B7280; font-size: 13px; text-align: center;
}

/* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
.modal-backdrop--rating { z-index: 10001; }
.modal-rating .modal-header { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
.modal-rating .modal-body label { font-weight: 700; color: #0F172A; margin-bottom: 8px; display:block; }
.modal-rating .modal-textarea { min-height: 90px; }

/* Ø´Ø§Ø±Ø© ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
.rating-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; background:#FEF9C3; color:#854D0E; border:1px solid #FDE68A; font-weight:700; font-size:12px;
}

</style>
</head>


<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <h1>Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</h1>
                <p>ÙˆÙƒØ§Ù„Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† - ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</p>
                <p style="font-size: 14px; margin-top: 10px;">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ</p>
            </div>
            <div class="content">
                <div class="login-form">
                    <h2 style="color: var(--primary-blue); margin-bottom: 30px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                        <input type="text" id="userId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
                    </div>
                    <button class="btn btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                </div>
            </div>
        </div>

        <!-- Advisory Services Unit Interface -->
        <div id="advisoryInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1>ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</h1>
                <p id="welcomeMessage"></p>
            </div>
            <div class="content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'newTicket')">ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <button class="tab" onclick="switchTab(event, 'myRequests')">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
                    <button class="tab" onclick="switchTab(event, 'statistics')">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                    <button class="tab hidden" id="advisoryTabRatings" onclick="switchTab(event, 'advisoryRatings')">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
                </div>

                <!-- New Ticket Tab -->
                 <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ -->
                    <div id="advisoryRatings" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
                    <div id="advisoryRatingsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                    </div>
                    </div>

                <div id="newTicket" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ØªØ¯Ø±Ø¨</label>
                        <input type="text" id="traineeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ">
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="loadTraineeData()">Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>

                    <div id="traineeInfo" class="hidden">
                        <div class="info-card">
                            <h3 style="color: var(--primary-blue); margin-bottom: 15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨</h3>
                            <div class="info-row">
                                <div class="info-item">
                                    <strong>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</strong>
                                    <span id="traineeName">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</strong>
                                    <span id="traineeIdDisplay">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ù‚Ø³Ù…</strong>
                                    <span id="traineeDept">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„ØªØ®ØµØµ</strong>
                                    <span id="traineeSpec">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</strong>
                                    <span id="traineeAdvisor">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</strong>
                                    <span id="currentDate">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„ÙŠÙˆÙ…</strong>
                                    <span id="currentDay">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div class="form-group">
                            <label>Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</label>
                            <div class="service-buttons">
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø³Ù„ÙˆÙƒÙŠØ©">
                                    <span>Ø³Ù„ÙˆÙƒÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ù…Ø§Ù„ÙŠØ©">
                                    <span>Ù…Ø§Ù„ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="ØªØ¯Ø±ÙŠØ¨ÙŠØ©">
                                    <span>ØªØ¯Ø±ÙŠØ¨ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©">
                                    <span>Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†">
                                    <span>Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø£Ø®Ø±Ù‰">
                                    <span>Ø£Ø®Ø±Ù‰</span>
                                </label>
                            </div>
                        </div>

                        <div id="otherServiceDiv" class="form-group hidden">
                            <label>Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <input type="text" id="otherService" placeholder="Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©">
                        </div>

                        <div class="form-group">
                            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                            <textarea id="requestDetails" rows="4" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                            <button class="btn btn-success" onclick="completeTicket()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
                            <button class="btn btn-warning" onclick="showTransferOptions()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>

                        <div id="transferOptions" class="hidden" style="margin-top: 20px;">
                                <div class="form-group">
                                <label>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰</label>
                                <div class="service-buttons" id="transferToGroup">
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="advisor">
                                    <span>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="dept_head">
                                    <span>Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="elearning">
                                    <span>Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainees_vice">
                                    <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainers_deputy">
                                    <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</span>
                                    </label>
                                </div>
                                </div>
                            <button class="btn btn-primary" onclick="transferTicketAction()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                        </div>
                    </div>
                </div>

                <!-- My Requests Tab -->
                <div id="myRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
                    <div id="requestsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statistics" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalTickets">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
                            <div class="stat-number" id="completedTickets">0</div>
                            <div class="stat-label">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
                            <div class="stat-number" id="pendingTickets">0</div>
                            <div class="stat-label">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
                            <div class="stat-number" id="inProgressTickets">0</div>
                            <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Advisor Interface -->
        <div id="advisorInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</h1>
                <p id="advisorWelcome"></p>
            </div>
            <div class="content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'assignedTickets')">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„ÙŠ</button>
                    <button class="tab" onclick="switchTab(event, 'advisorRequests')">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
                </div>

                <div id="assignedTickets" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„ÙŠ</h2>
                    <div id="advisorTicketsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
                    </div>
                    <div class="alert alert-info" style="margin-top: 30px;">
                        <span>â„¹ï¸</span>
                        <span>Ù†Ø£Ù…Ù„ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨ØªÙ‚ÙŠÙŠÙ… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ù‡</span>
                    </div>
                </div>

                <div id="advisorRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
                    <div id="advisorRequestsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Head / Deputy Interface -->
         <div id="managementInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1 id="managementTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                <p id="managementWelcome"></p>
            </div>

            <div class="content">
                <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'managementAll')">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button class="tab hidden" id="tabRatings" onclick="switchTab(event, 'managementRatings')">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
                <button class="tab" onclick="switchTab(event, 'managementStats')">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
                <div id="managementAll" class="tab-content active">
                <div id="managementTicketsList">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª -->
                <div id="managementRatings" class="tab-content">
                <div id="ratingsList">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div id="managementStats" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                    <div class="stat-number" id="m_totalTickets">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
                    <div class="stat-number" id="m_completedTickets">0</div>
                    <div class="stat-label">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
                    <div class="stat-number" id="m_pendingTickets">0</div>
                    <div class="stat-label">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
                    <div class="stat-number" id="m_inProgressTickets">0</div>
                    <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                    </div>
                </div>
                </div>
            </div>
            </div>



        <!-- Trainee Interface -->
        <div id="traineeInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h1>
                <p id="traineeWelcome"></p>
            </div>
            <div class="content">
                <h2 style="color: var(--primary-blue); margin-bottom: 25px;">ØªØ°Ø§ÙƒØ±ÙŠ</h2>
                <div id="traineeTicketsList">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
                </div>
                <div class="alert alert-info" style="margin-top: 30px;">
                    <span>â„¹ï¸</span>
                    <span><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù„Ù…Ø¹Ø±ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù†Ø£Ù…Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2025 Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
        </div>
    </div>

    <!-- ØªØ¶Ù…ÙŠÙ† Ù…Ù„Ù API -->
    <script src="api_integration.js"></script>

    <script>
        let currentUser = null;
        let currentTraineeData = null;

        let __ratingTicketNumber = null;
        let __ratingValue = 0;

        let __lastTraineeTickets = [];   // Ø¢Ø®Ø± Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ØªØ¯Ø±Ø¨
        let __ratingSubmitting   = false; // ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ÙƒØ±Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„


        const RATING_LABELS = {
        1: 'Ø³ÙŠØ¦',
        2: 'Ù…Ù‚Ø¨ÙˆÙ„',
        3: 'Ø¬ÙŠØ¯',
        4: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§',
        5: 'Ù…Ù…ØªØ§Ø²'
        };

        function buildRatingUI(containerStars, containerScale, current=0) {
        // Ù†Ø¬ÙˆÙ…
        containerStars.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const s = document.createElement('span');
            s.textContent = 'â˜…';
            s.className = 'star ' + (i <= current ? 'lit' : 'dim');
            s.title = `${i} - ${RATING_LABELS[i]}`;
            s.onclick = () => selectRating(i);
            containerStars.appendChild(s);
        }

        // Ø´Ø±Ø§Ø¦Ø­ Ù„ÙØ¸ÙŠØ©
        containerScale.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const chip = document.createElement('div');
            chip.className = 'rating-chip' + (i === current ? ' active' : '');
            chip.textContent = `${i} â€” ${RATING_LABELS[i]}`;
            chip.onclick = () => selectRating(i);
            containerScale.appendChild(chip);
        }

        const note = document.getElementById('ratingNote');
        note.textContent = current ? `Ø§Ø®ØªØ±Øª: ${current} â€” ${RATING_LABELS[current]}` : 'Ø§Ø®ØªØ± Ù…Ù† 1 (Ø³ÙŠØ¦) Ø¥Ù„Ù‰ 5 (Ù…Ù…ØªØ§Ø²)';
        }

        function selectRating(val) {
        __ratingValue = val;
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        if (stars && scale) buildRatingUI(stars, scale, __ratingValue);
        }

        function openRatingModal(ticketNumber) {
        // Ø­Ù…Ø§ÙŠØ©: Ù„Ø§ ØªÙØªØ­ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ù‚ÙŠÙ‘Ù…Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
        if (isTicketRatedLocal(ticketNumber)) {
            showSuccess('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…');
            return;
        }

        __ratingTicketNumber = ticketNumber;
        __ratingValue = 0;

        const modal = document.getElementById('ratingModal');
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        const textarea = document.getElementById('ratingComment');

        if (textarea) textarea.value = '';
        if (stars && scale) buildRatingUI(stars, scale, 0);

        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => { stars?.querySelector('.star')?.focus?.(); }, 50);
        }
        }


        function getRoleCapabilities(user){
        const r = normalizeRole(user?.role || user?.data?.role || '');
        const CAPS = {
            dean: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            quality_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            trainees_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            advisory_unit: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['newTicket','myRequests','assignedTickets','statistics','ratingsBoard'] },
            trainers_deputy: { scope:'all', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:['dashboard','managementAll','managementStats'] },
            dept_head: { scope:'department', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['deptTickets','managementStats'] }, // â† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
            advisor: { scope:'assigned_and_self', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['assignedTickets','advisorRequests','myRequests'] },

            // âœ… Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            elearning: { scope:'assigned_or_transferred', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['managementAll','managementStats'] },

            trainee: { scope:'self', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['newTicket','traineeTicketsList','rateService'] }
        };
        return CAPS[r] || { scope:'none', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:[] };
        }


        function closeRatingModal() {
        const modal = document.getElementById('ratingModal');
        if (modal) modal.classList.add('hidden');
        __ratingTicketNumber = null;
        __ratingValue = 0;
        }

        // Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø© ÙˆÙ†ØµÙ‡Ø§

        function statusBadgeText(st) {
        if (st === 'completed') return 'Ù…ÙƒØªÙ…Ù„Ø©';
        if (st === 'in_progress') return 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
        return 'Ù…Ø¹Ù„Ù‚Ø©';
        }

        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø¨Ù‚ÙŠ Ø§Ù„Ø¯Ø§Ù„ØªÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…ØªÙŠÙ† Ù„ÙƒÙ† ÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function statusBadgeClass(st){ if (st === 'completed') return 'ticket-status--completed'; if (st === 'in_progress') return 'ticket-status--inprogress'; return 'ticket-status--pending'; }
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªØ°ÙƒØ±Ø©
        if (typeof window.updateTicketStatus !== 'function') {

        window.updateTicketStatus = async (ticketNumber, payload) => {
            const res = await sendRequest('updateTicketStatus', { ticketNumber, ...payload });
            return !!(res && res.success);
        };
        }

        
        // ØªØ­ÙˆÙŠÙ„ ØªØ°ÙƒØ±Ø©
        if (typeof window.transferTicket !== 'function') {
        window.transferTicket = async (ticketNumber, to, by) => {
            const res = await sendRequest('transferTicket', { ticketNumber, to, by });
            return !!(res && res.success);
        };
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ ØªØ°ÙƒØ±Ø© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„)
        if (typeof window.completeTicketRequest !== 'function') {
        window.completeTicketRequest = async (ticketNumber, solutionText, completedBy, completionDate) => {
            const payload = { ticketNumber, solutionText, completedBy };
            if (completionDate) payload.completionDate = completionDate;
            const res = await sendRequest('completeTicket', payload);
            return !!(res && res.success);
        };
        }

        async function submitTraineeRating() {
        // ØªØ­Ù‚Ù‚ Ø£Ø³Ø§Ø³ÙŠ
        if (!__ratingTicketNumber) { showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return; }
        if (!__ratingValue)        { showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5'); return; }
        if (__ratingSubmitting)     return; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ†

        // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù„ØªØ¹Ø·ÙŠÙ„Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
        const btn = document.querySelector('#ratingModal .btn.btn-success');

        // ÙØ­Øµ Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹: Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙŠÙ‘Ù…Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©/Ø§Ù„Ø¹Ø±Ø¶ØŸ
        try {
            if (Array.isArray(__lastTraineeTickets)) {
            const localHit = __lastTraineeTickets.find(
                x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (localHit) {
                // Ø¥ØºÙ„Ø§Ù‚ ÙˆØªÙ‡Ø°ÙŠØ¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                closeRatingModal();
                showSuccess('Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙŠÙ‘Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„ âœ…');
                return;
            }
            }
        } catch (_) { /* ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ù…Ø­Ù„ÙŠ */ }

        __ratingSubmitting = true;
        if (btn) { btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'; }

        try {
            // ÙØ­Øµ Ø­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‚ÙŠÙ‘Ù… Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±)
            const fresh = await loadTraineeTickets(currentUser.id);
            const already = (fresh || []).find(
            x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (already) {
            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø«Ù… Ø§Ø®Ø±Ø¬
            __lastTraineeTickets = fresh;
            displayTraineeTickets(__lastTraineeTickets);
            closeRatingModal();
            showSuccess('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…');
            return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø®Ø§Ø¯ÙˆÙ… (Apps Script) â€” ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹ÙŠØ¯ {success, code?}
            const comment = (document.getElementById('ratingComment')?.value || '').trim();
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...');
            const res = await saveRating(__ratingTicketNumber, __ratingValue, comment);
            hideLoading();

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¯Ù‘ Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…
            if (!res || res.success === false) {
            if (res?.code === 'ALREADY_RATED') {
                // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…: Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                closeRatingModal();
                showError('ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù„Ø¥Ø®ÙØ§Ø¡ Ø²Ø± "Ù‚ÙŠÙ‘Ù…"
                if (typeof loadTraineeTicketsView === 'function') await loadTraineeTicketsView();
                return;
            }
            showError(res?.message || 'ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
            return;
            }

            // Ù†Ø¬Ø§Ø­
            closeRatingModal();
            showSuccess('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚ÙŠÙŠÙ…Ùƒ. Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!');

            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… â€” Ø³ÙŠØ®ØªÙÙŠ Ø²Ø± "Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" ÙˆØªØ¸Ù‡Ø± Ø§Ù„Ø´Ø§Ø±Ø©
            await loadTraineeTicketsView();

            // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ (ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø¨ Ø£Ùˆ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³)
            try {
            if (Array.isArray(__lastTraineeTickets)) {
                const idx = __lastTraineeTickets.findIndex(
                x => String(x.ticketNumber) === String(__ratingTicketNumber)
                );
                if (idx >= 0) {
                __lastTraineeTickets[idx].rating = Number(__ratingValue);
                __lastTraineeTickets[idx].ratingComment = comment;
                displayTraineeTickets(__lastTraineeTickets);
                }
            }
            } catch (_) { /* Ø§Ø®ØªÙŠØ§Ø±ÙŠ */ }

        } catch (e) {
            hideLoading();
            showError(e?.message || String(e));
        } finally {
            __ratingSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'; }
        }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ESC ÙˆØ§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeRatingModal(); });
        document.addEventListener('click', (ev) => {
        const m = document.getElementById('ratingModal');
        if (m && ev.target === m) closeRatingModal();
        });
        // âœ… 3) Ù…Ù† ÙŠÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ (ÙŠØ´ÙˆÙ ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª + ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª")
        function hasFullAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return ['dean','trainees_vice','quality_vice','advisory_unit'].includes(r);
        }



        function hasOrgViewNoRatings() { // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'trainers_deputy';
        }

        // âœ… 4) Ù…Ù† ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª")
        function hasDeptScopedAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'dept_head';
        }

        async function login() {
        const userId = (document.getElementById('userId')?.value || '').trim();

        if (!userId) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
            return;
        }

        try {
            // ÙŠÙØªØ±Ø¶ Ø£Ù† checkUserPermission ØªØ³ØªØ¯Ø¹ÙŠ Apps Script ÙˆØªØ¹ÙŠØ¯ {type, name, role?, department?...}
            const userData = await checkUserPermission(userId);

            if (!userData || userData.success === false) {
            showError(userData?.message || 'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
            return;
            }

            // Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© (Ø¨Ø¯ÙˆÙ† success):
            const payload = userData.data ? userData.data : userData;

            // Ø·ÙØ¨Ù‘ÙØ¹ Ø§Ù„Ø¯ÙˆØ± (Ø¥Ù† ÙˆÙØ¬Ø¯)
            const role = normalizeRole(payload.role || '');

            // Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ù‘Ø¯ ÙˆÙ…ØªÙˆÙÙ‘Ø± Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§
            currentUser = {
            id: userId,
            data: { ...payload, role }
            };
            window.currentUser = currentUser;

            // ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
            if (payload.type === 'trainee') {
            showTraineeInterface();
            return;
            }

            if (payload.type === 'staff') {
            switch (role) {
                case 'advisory_unit':
                showAdvisoryInterface();
                return;

                case 'advisor':
                showAdvisorInterface();
                return;
                // Ø¯Ø§Ø®Ù„ switch(role) ÙÙŠ login()
                case 'elearning':
                showManagementInterface();
                return;

                // Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:
                case 'dept_head':        // Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ÙŠØ±Ù‰ Ù‚Ø³Ù…Ù‡ ÙÙ‚Ø·
                case 'trainees_vice':    // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†: ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… + ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                case 'trainers_deputy':  // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†: ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¯ÙˆÙ† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                case 'dean':
                case 'quality_vice':
                showManagementInterface();
                return;

                default:
                showError('ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©');
                return;
            }
            }

            // Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Trainee Ø£Ùˆ Staff
            showError('Ù†ÙˆØ¹ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
        } catch (err) {
            showError(err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }
        }
          document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('userId');
                if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                    }
                });
                }
            });
        // ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù‚Ø¯ÙŠÙ…Ø© (camelCase) Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯ (snake_case)
            // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©/Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„
            function normalizeRole(role=''){
            let v = String(role || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g,'_');

            // ØªØ·Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const map = {
                // Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù‚Ø¯ÙŠÙ…/Ù…ØªÙ†ÙˆØ¹
                'depthead':'dept_head',
                'dept_head':'dept_head',
                'qualityvice':'quality_vice',
                'quality_vice':'quality_vice',
                'advisoryunit':'advisory_unit',
                'advisory_unit':'advisory_unit',
                'dean':'dean',
                'elearning':'elearning',
                'advisor':'advisor',
                'trainees_deputy':'trainees_vice',
                'trainees_vice':'trainees_vice',
                'trainers_deputy':'trainers_deputy',

                // Ø¹Ø±Ø¨ÙŠ
                'Ø§Ù„Ø¹Ù…ÙŠØ¯':'dean',
                'ÙˆÙƒÙŠÙ„_Ø¶Ø¨Ø·_Ø§Ù„Ø¬ÙˆØ¯Ø©':'quality_vice',
                'ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†':'trainees_vice',
                'ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†':'trainers_deputy',
                'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©':'advisory_unit',
                'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø§Ø±Ø´Ø§Ø¯ÙŠØ©':'advisory_unit',
                'Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù…':'dept_head',
                'Ø§Ù„ØªØ¯Ø±ÙŠØ¨_Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ':'elearning',
                'Ø§Ù„ØªØ¯Ø±ÙŠØ¨_Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ':'elearning',
                'Ø§Ù„Ù…Ø±Ø´Ø¯':'advisor',
                'Ø§Ù„Ù…Ø±Ø´Ø¯_Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ':'advisor',
                'Ù…ØªØ¯Ø±Ø¨':'trainee'
            };

            // ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            v = v
                .replace(/^depthead$/,'dept_head')
                .replace(/^qualityvice$/,'quality_vice')
                .replace(/^advisoryunit$/,'advisory_unit')
                .replace(/^dean$/,'dean')
                .replace(/^trainees_deputy$/,'trainees_vice');

            return map[v] || v;
            }

                const ROLE_LABELS = {
                dean: 'Ø§Ù„Ø¹Ù…ÙŠØ¯',
                quality_vice: 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
                trainees_vice: 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
                trainers_deputy: 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†',   // â† Ø¬Ø¯ÙŠØ¯
                advisory_unit: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©',
                dept_head: 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
                advisor: 'Ø§Ù„Ù…Ø±Ø´Ø¯/Ø§Ù„Ù…Ø¯Ø±Ø¨',
                elearning: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
                };

            function labelOf(v) {
            const key = normalizeRole(v);
            return ROLE_LABELS[key] || v;
            }


        function logout() {
        currentUser = null;
        window.currentUser = null; // ğŸ‘ˆ Ù…Ù‡Ù… Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        currentTraineeData = null;
        closeRatingModal?.();
        closeSolutionModal?.();
        document.getElementById('userId').value = '';
        hideAllInterfaces();
        document.getElementById('loginScreen').classList.remove('hidden');
        }


        function hideAllInterfaces() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('advisoryInterface').classList.add('hidden');
            document.getElementById('advisorInterface').classList.add('hidden');
            document.getElementById('managementInterface').classList.add('hidden');
            document.getElementById('traineeInterface').classList.add('hidden');
        }

        async function showAdvisoryInterface() {
        hideAllInterfaces();
        document.getElementById('advisoryInterface').classList.remove('hidden');
        document.getElementById('welcomeMessage').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;

        // ğŸ‘‡ Ø£Ø¸Ù‡Ø± ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
        const advRatingsBtn = document.getElementById('advisoryTabRatings');
        if (advRatingsBtn) advRatingsBtn.classList.remove('hidden');

        await loadStatistics();
        }


        async function showAdvisorInterface() {
            hideAllInterfaces();
            document.getElementById('advisorInterface').classList.remove('hidden');
            document.getElementById('advisorWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;
            await loadAdvisorTicketsView();
        }


        // âœ… 5) Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        async function showManagementInterface() {
        hideAllInterfaces();
        document.getElementById('managementInterface').classList.remove('hidden');

        const role = normalizeRole(currentUser.data.role);
        const title =
            role === 'dean' ? 'Ø§Ù„Ø¹Ù…ÙŠØ¯' :
            role === 'quality_vice' ? 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©' :
            role === 'trainees_vice' ? 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†' :
            role === 'trainers_deputy' ? 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†' :
            role === 'advisory_unit' ? 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©' :
            role === 'elearning'       ? 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ù‡
            role === 'dept_head' ? 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…' : 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';

        document.getElementById('managementTitle').textContent = title;
        document.getElementById('managementWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;

        // Ø²Ø± ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù€ HTML Ø¨Ø¹Ù†ØµØ± #tabRatings)
        const ratingsTabBtn = document.getElementById('tabRatings');
        if (ratingsTabBtn) {
            if (hasFullAccess()) ratingsTabBtn.classList.remove('hidden');
            else ratingsTabBtn.classList.add('hidden');
        }

        await loadManagementTicketsView();
        }


        async function loadManagementRatingsView(listId = 'ratingsList') {
        if (!hasFullAccess()) {
            const target = document.getElementById(listId);
            if (target) {
            target.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</p>';
            }
            return;
        }

        const box = document.getElementById(listId);
        if (!box) return;
        box.innerHTML = '<p style="text-align:center;color:#999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>';

        let tickets = await loadAllTickets();
        tickets = Array.isArray(tickets) ? tickets : [];

        const rated = tickets.filter(t => String(t.status) === 'completed' && Number(t.rating) > 0);

        if (!rated.length) {
            box.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>';
            return;
        }

        const card = (t) => {
            const stars   = Number(t.rating) || 0;
            const comment = (t.ratingComment || '').trim();
            const actionTaken = t.actionTaken || t['Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°'] || t.updateAction || '-';
            const solution = t.solution || t.executedSolution || t['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°'] || t.solutionText || '-';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ticket-status--completed">Ù…ÙƒØªÙ…Ù„Ø©</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span><span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span><span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡:</span><span class="v">${t.completionDate || t.date || '-'}</span></div>
                </div>

                <div class="ticket-details">
                <div><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> â˜… ${stars}/5</div>
                ${comment ? `<div style="margin-top:6px;"><strong>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</strong> <em>${comment}</em></div>` : ''}
                <div style="margin-top:6px;"><strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${solution}</div>
                <div style="margin-top:6px;"><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°:</strong> ${actionTaken}</div>
                ${t.completedBy ? `<div style="margin-top:6px;">ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>${t.completedBy}</strong></div>` : ''}
                </div>
            </div>
            `;
        };

        try { rated.sort((a,b) => new Date(b.completionDate || b.date || 0) - new Date(a.completionDate || a.date || 0)); } catch(_){}

        box.innerHTML = rated.map(card).join('');
        }

        async function showTraineeInterface() {
            hideAllInterfaces();
            document.getElementById('traineeInterface').classList.remove('hidden');
            document.getElementById('traineeWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;
            await loadTraineeTicketsView();
        }


        async function loadTraineeData() {
            const traineeId = document.getElementById('traineeId').value.trim();
            
            if (!traineeId) {
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ');
                return;
            }

            const trainee = await getTraineeById(traineeId);
            
            if (trainee) {
                currentTraineeData = trainee;
                
                document.getElementById('traineeName').textContent = trainee.name;
                document.getElementById('traineeIdDisplay').textContent = traineeId;
                document.getElementById('traineeDept').textContent = trainee.department;
                document.getElementById('traineeSpec').textContent = trainee.specialization;
                document.getElementById('traineeAdvisor').textContent = trainee.advisor;
                
                const now = new Date();
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA');
                document.getElementById('currentDay').textContent = days[now.getDay()];
                
                document.getElementById('traineeInfo').classList.remove('hidden');
            } else {
                showError('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            }
        }

        function handleServiceTypeChange() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked');
            const otherDiv = document.getElementById('otherServiceDiv');
            
            if (serviceType && serviceType.value === 'Ø£Ø®Ø±Ù‰') {
                otherDiv.classList.remove('hidden');
            } else {
                otherDiv.classList.add('hidden');
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        document.addEventListener('DOMContentLoaded', function() {
            const serviceButtons = document.querySelectorAll('input[name="serviceType"]');
            serviceButtons.forEach(btn => {
                btn.addEventListener('change', handleServiceTypeChange);
            });
        });

        function showTransferOptions() {
            document.getElementById('transferOptions').classList.remove('hidden');
        }

        async function completeTicket() {
        if (!currentTraineeData) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();

        if (!serviceTypeRadio || !details) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
            return;
        }

        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ = Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°
        const solutionText = details;

        const now  = new Date();
        const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];

        const serviceType = serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰' && !serviceType) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©');
            return;
        }

        // 1) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù…Ù‡Ø§ (ØªØ¨Ù‚Ù‰ pending Ø§Ù„Ø¢Ù†)
        const payload = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            createdBy:      currentUser.data.name
        };

        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©...');
        const createRes = await saveNewTicket(payload);
        hideLoading();

        if (!createRes?.success || !createRes.ticketNumber) {
            showError('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©');
            return;
        }

        const ticketNumber = createRes.ticketNumber;

        // 2) Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙÙˆØ±Ù‹Ø§ â€” Ù‡Ø°Ø§ Ù…Ø§ ÙŠÙƒØªØ¨ "Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°" ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© + Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const completionDate = now.toLocaleDateString('ar-SA');

        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„...');
        const ok = await completeTicketRequest(ticketNumber, solutionText, currentUser.data.name, completionDate);
        hideLoading();

        if (ok) {
            resetTicketForm();
            showSuccess('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ "Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°" Ø¨Ù†Ø¬Ø§Ø­');
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø§Øª Ø¥Ù† Ù„Ø²Ù…
            if (typeof loadStatistics === 'function') loadStatistics();
            if (typeof loadMyRequests === 'function') loadMyRequests('requestsList');
        } else {
            showError('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©ØŒ Ù„ÙƒÙ† ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§. Ø¬Ø±Ù‘Ø¨ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±.');
        }
        }

        async function transferTicketAction() {
        if (!currentTraineeData) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();
        const transferRadio = document.querySelector('input[name="transferTo"]:checked');

        if (!serviceTypeRadio || !details || !transferRadio) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            return;
        }

        let transferTo = normalizeRole(transferRadio.value);

        const serviceType = serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰' && !serviceType) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©');
            return;
        }

        const now = new Date();
        const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];

        const ticketData = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            transferredTo:  transferTo,
            createdBy:      currentUser.data.name
        };

        const result = await saveNewTicket(ticketData);
        if (result.success) resetTicketForm();
        }


        async function saveNewTicket(payload) {
        const res = await sendRequest('createTicket', payload);

        if (res && res.success) {
            const tn = res?.data?.ticketNumber ?? res?.ticketNumber ?? 'â€”';
            showSuccess(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: ${tn}`);
            return { success: true, ticketNumber: tn };
        } else {
            showError(res?.message || 'ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©');
            return { success: false };
        }
        }

        function resetTicketForm() {
            document.getElementById('traineeId').value = '';
            document.querySelectorAll('input[name="serviceType"]').forEach(btn => btn.checked = false);
            document.getElementById('requestDetails').value = '';
            document.getElementById('otherService').value = '';
            document.getElementById('traineeInfo').classList.add('hidden');
            document.getElementById('transferOptions').classList.add('hidden');
            document.getElementById('otherServiceDiv').classList.add('hidden');
            currentTraineeData = null;
        }

        async function loadStatistics() {
            const stats = await calculateStatistics();
            
            document.getElementById('totalTickets').textContent = stats.total || 0;
            document.getElementById('completedTickets').textContent = stats.completed || 0;
            document.getElementById('pendingTickets').textContent = stats.pending || 0;
            document.getElementById('inProgressTickets').textContent = stats.inProgress || 0;
        }

        // âœ… Ø¬Ø¯ÙŠØ¯: ÙŠØ¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± â€œØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©/Ø¥Ù†Ù‡Ø§Ø¡/ØªØ­ÙˆÙŠÙ„â€ ÙˆÙŠØ³ØªØ®Ø¯Ù… ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø«

        async function loadAdvisorTicketsView() {
        const containerId = 'advisorTicketsList';
        const container = document.getElementById(containerId);
        container.innerHTML = '<p style="text-align:center;color:#999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>';

        const ticketsRaw = await loadAdvisorTickets(currentUser.data.name);
        const tickets = (ticketsRaw || []).filter(t => String(t.status) !== 'completed');

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„Ùƒ</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';

            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">ØªÙ… Ø§Ù„Ø­Ù„</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">ØªØ­ÙˆÙŠÙ„</button>
                </div>
            </div>
            `;
        }).join('');

        // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        container.onclick = async (ev) => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const ticketNumber = btn.getAttribute('data-ticket');
            if (!ticketNumber) { showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return; }

            try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser.data.name,
                startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadAdvisorTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                const to = prompt('Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ù…Ù†ØŸ (Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¯ÙˆØ± Ù…Ø«Ù„ advisor / dept_head / elearning / trainees_vice)');
                if (!to || !to.trim()) { showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„'); return; }
                const ok = await transferTicket(ticketNumber, to.trim(), currentUser.data.name);
                if (ok) await loadAdvisorTicketsView();
            }
            } catch (err) {
            showError(err?.message || String(err));
            }
        };
        }


        // âœ… 6) ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        async function loadManagementTicketsView() {
        const role   = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myName = (currentUser?.data?.name || '').trim();   // ğŸ‘ˆ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§
        let tickets  = [];

        if (hasFullAccess()) {
            // Ø§Ù„Ø¹Ù…ÙŠØ¯ + ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† + Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© + ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯
            tickets = await loadAllTickets();

        } else if (role === 'elearning') {
            // ÙŠØ´ÙˆÙ ÙÙ‚Ø· Ù…Ø§ Ø­ÙÙˆÙ‘ÙÙ„ Ø¥Ù„Ù‰ "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" Ø£Ùˆ Ø£ÙØ³Ù†ÙØ¯ Ù„Ø§Ø³Ù…Ù‡
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
            const toRole        = normalizeRole((t.transferredTo || '').trim());
            const toName        = (t.transferredTo || '').trim();
            const assigned      = (t.assignedTo || '').trim();
            // 1) Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ø¯ÙˆØ± elearning (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ø¹Ø±Ø¨ÙŠ Ø¨Ø¹Ø¯ normalize)
            const forElearningRole = toRole === 'elearning';
            // 2) Ù…Ø­ÙˆÙ‘Ù„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ùˆ Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØªØ­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±)
            const forMeByName      = toName === myName || assigned === myName;
            return forElearningRole || forMeByName;
            });

        } else if (role === 'trainers_deputy') {
            // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†: Ø±Ø¤ÙŠØ© Ø¹Ø§Ù…Ø© Ø¨Ø¯ÙˆÙ† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            tickets = await loadAllTickets();

        } else if (role === 'dept_head' && myDept) {
            // Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: Ù‚Ø³Ù…Ù‡ ÙÙ‚Ø·
            const res = await sendRequest('searchTickets', { department: myDept });
            tickets = (res && res.success) ? res.data : [];
        }


        function displayTicketsWithActions(containerId, tickets){
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!Array.isArray(tickets) || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">ØªÙ… Ø§Ù„Ø­Ù„</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">ØªØ­ÙˆÙŠÙ„</button>
                </div>
            </div>
            `;
        }).join('');
        }


        function attachManagementActions(containerId){
        const container = document.getElementById(containerId);
        if (!container) return;

        container.onclick = async (ev) => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const ticketNumber = btn.getAttribute('data-ticket');
            if (!ticketNumber) { showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return; }

            try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser.data.name,
                startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadManagementTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                const to = prompt('Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ù…Ù†ØŸ (Ø§Ø³Ù…/Ø¯ÙˆØ±: advisor / dept_head / elearning / trainees_vice ...)');
                if (!to || !to.trim()) { showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„'); return; }
                const ok = await transferTicket(ticketNumber, to.trim(), currentUser.data.name);
                if (ok) await loadManagementTicketsView();
            }
            } catch (err) {
            showError(err?.message || String(err));
            }
        };
        }


        const caps = getRoleCapabilities(currentUser.data);
        if (caps.canClose) {
        displayTicketsWithActions('managementTicketsList', tickets);
        attachManagementActions('managementTicketsList'); // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        } else {
        displayTickets('managementTicketsList', tickets); // Ø¹Ø±Ø¶ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
        }   
        }

        async function loadTraineeTicketsView() {
        const tickets = await loadTraineeTickets(currentUser.id);
        __lastTraineeTickets = Array.isArray(tickets) ? tickets : [];
        displayTraineeTickets(__lastTraineeTickets);
        }

        function isTicketRatedLocal(ticketNumber) {
        const t = (__lastTraineeTickets || []).find(x => String(x.ticketNumber) === String(ticketNumber));
        return t && Number(t.rating) > 0;
        }


        // 2) Ø¹Ø¯Ù‘Ù„ loadMyRequests Ù„ØªØ£Ø®Ø° containerId ÙˆØªØ¹Ø±Ø¶ ÙÙŠÙ‡
        async function loadMyRequests(containerId = 'requestsList') {
        try {
            showLoading('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...');
            const tickets = await loadAllTickets();
            hideLoading();

            if (!Array.isArray(tickets) || !tickets.length) {
            displayTickets(containerId, []);
            return;
            }

            const meName = (currentUser?.data?.name || '').trim();
            const meRole = normalizeRole((currentUser?.data?.role || '').trim());
            const meType = (currentUser?.data?.type || '').trim();

            let myTickets = [];

            if (meType === 'staff') {
            if (meRole === 'advisory_unit') {
                // ğŸ‘ˆ ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ØªØ±Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø·Ù„Ø¨Ø§ØªÙŠ"
                myTickets = tickets;
            } else {
                myTickets = tickets.filter((t) => {
                const completedBy   = (t.completedBy   || '').trim();
                const createdBy     = (t.createdBy     || '').trim();
                const assignedTo    = (t.assignedTo    || '').trim();
                const advisorName   = (t.advisor       || '').trim();
                const transferredTo = normalizeRole((t.transferredTo || '').trim());
                return (
                    completedBy === meName ||
                    createdBy   === meName ||
                    assignedTo  === meName ||
                    transferredTo === meName ||
                    transferredTo === meRole ||
                    advisorName === meName
                );
                });
            }
            } else if (meType === 'trainee') {
            myTickets = tickets.filter((t) =>
                String(t.traineeId).trim() === String(currentUser.id).trim()
            );
            } else {
            myTickets = tickets.filter((t) => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy   = (t.createdBy   || '').trim();
                return completedBy === meName || createdBy === meName;
            });
            }

            try { myTickets.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)); } catch (_) {}

            const withLabels = myTickets.map((t) => ({
            ...t,
            transferredToLabel: labelOf(t.transferredTo || '')
            }));

            displayTickets(containerId, withLabels);
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }



        function displayTickets(containerId, tickets) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ®ØµØµ:</span> <span class="v">${t.specialization || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}

                <div class="ticket-foot">
                ${t.completedBy ? `<span>ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>${t.completedBy}</strong></span>` : ''}
                ${t.completedBy && (t.transferredTo || t.assignedTo) ? '<span class="dot"></span>' : ''}
                ${(t.transferredTo || t.transferredToLabel)  ? `<span>Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰: <strong>${t.transferredToLabel || labelOf(t.transferredTo)}</strong></span>`: ''}
                ${t.assignedTo ? `<span class="dot"></span><span>Ù…ÙØ³Ù†ÙØ¯ Ø¥Ù„Ù‰: <strong>${t.assignedTo}</strong></span>` : ''}
                </div>
            </div>
            `;
        }).join('');
        }

        function displayTraineeTickets(tickets) {
        const container = document.getElementById('traineeTicketsList');
        if (!container) return;

        const list = Array.isArray(tickets) ? tickets : [];

        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØªØ°Ø§ÙƒØ±: Ù…ÙƒØªÙ…Ù„Ø© ØªØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ… / Ù…ÙƒØªÙ…Ù„Ø© ÙˆØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ø§
        const needRating = list.filter(t =>
            String(t.status) === 'completed' && !(Number(t.rating) > 0)
        );
        const rated = list.filter(t =>
            String(t.status) === 'completed' && (Number(t.rating) > 0)
        );

        // Ø¨Ø·Ø§Ù‚Ø© ØªØ°ÙƒØ±Ø©
        const card = (ticket) => {
            const isRated = Number(ticket.rating) > 0;
            const cls = statusBadgeClass(ticket.status); // âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø©
            const txt = statusBadgeText(ticket.status);  // âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø©

            const ratingBadge = isRated
            ? `<span class="rating-badge" title="${ticket.rating} â€” ${RATING_LABELS[ticket.rating] || ''}">â˜… ${ticket.rating}/5</span>`
            : '';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="v">${ticket.date || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…Ø±Ø´Ø¯:</span><span class="v">${ticket.advisor || '-'}</span></div>
                </div>

                <div class="ticket-foot">
                ${ratingBadge}
                ${isRated && ticket.ratingComment ? `<span class="dot"></span><span>ØªØ¹Ù„ÙŠÙ‚Ùƒ: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(!isRated && String(ticket.status) === 'completed')
                    ? `<span class="dot"></span>
                    <button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</button>`
                    : ''}
                </div>
            </div>
            `;
        };

        const needHtml = needRating.length
            ? needRating.map(card).join('')
            : `<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…ÙƒØªÙ…Ù„Ø© ØªÙ†ØªØ¸Ø± ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>`;

        const ratedHtml = rated.length
            ? rated.map(card).join('')
            : `<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ù‚ÙŠÙ‘ÙÙ…Ø©</p>`;

        // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        container.innerHTML = `
            <div class="tabs" id="traineeTicketsTabs" style="margin-bottom:16px;">
            <button class="tab active" data-tab="need" onclick="switchTraineeTicketsTab('need')">
                Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙ‚ÙŠÙŠÙ… <span style="opacity:.8;font-size:12px;">(${needRating.length})</span>
            </button>
            <button class="tab" data-tab="rated" onclick="switchTraineeTicketsTab('rated')">
                Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ù‚ÙŠÙ‘ÙÙ…Ø© <span style="opacity:.8;font-size:12px;">(${rated.length})</span>
            </button>
            </div>

            <div id="traineeTab-need" class="tab-content active">
            ${needHtml}
            </div>
            <div id="traineeTab-rated" class="tab-content">
            ${ratedHtml}
            </div>
        `;
        }


        // Ø­Ø¯Ù‘Ø« Ù…Ø¨Ø¯Ù‘Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: need / rated
        function switchTraineeTicketsTab(which) {
        const tabsBar = document.getElementById('traineeTicketsTabs');
        if (!tabsBar) return;

        tabsBar.querySelectorAll('.tab').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === which);
        });

        ['need','rated'].forEach(name => {
            const pane = document.getElementById('traineeTab-' + name);
            if (pane) pane.classList.toggle('active', name === which);
        });
        }


        async function loadMyTicketsUI() {
                    if (currentUser?.data?.type === 'trainee') {
        await loadTraineeTicketsView(); // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¯ÙŠØ« ÙÙ‚Ø·
        return;
        }

        try {
            const me = window.currentUser ?? currentUser;   // Ø®Ø° Ø£ÙŠÙ‡Ù…Ø§ Ù…ØªÙˆÙØ±
            if (!me || !me.id) {
            showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ');
            return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...');
            const res = await sendRequest('getTraineeTickets', { traineeId: me.id });
            hideLoading();

            if (!res || !res.success) {
            showError(res?.message || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ');
            return;
            }

            const list = document.getElementById('myTicketsList');
            if (!list) return;
            list.innerHTML = '';

            (res.data || []).forEach((row, i) => {
            const li = document.createElement('li');
            li.className = 'ticket-item';
            li.innerHTML = `
                <div class="ticket-head">
                <span class="ticket-id">#${i + 1}</span>
                <span class="ticket-date">${row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''} (${row['Ø§Ù„ÙŠÙˆÙ…'] || ''})</span>
                </div>
                <div class="ticket-body">
                <div><strong>Ø§Ù„Ù…Ø±Ø´Ø¯:</strong> ${row['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '-'}</div>
                <div><strong>Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${row['Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '-'}</div>
                <div><strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${row['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°'] || row['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨'] || '-'}</div>
                </div>
            `;
            list.appendChild(li);
            });
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // âœ… Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        let __activeTicketNumber = null;

        function openSolutionModal(ticketNumber) {
        __activeTicketNumber = ticketNumber;
        const modal = document.getElementById('solutionModal');
        const textarea = document.getElementById('solutionText');
        if (!modal || !textarea) return;

        textarea.value = ''; // ØªØµÙÙŠØ± ÙƒÙ„ Ù…Ø±Ø©
        modal.classList.remove('hidden');
        textarea.focus();
        }

        function closeSolutionModal() {
        const modal = document.getElementById('solutionModal');
        if (modal) modal.classList.add('hidden');
        __activeTicketNumber = null;
        }


        async function submitSolution() {
        const textarea = document.getElementById('solutionText');
        const solution = (textarea?.value || '').trim();

        if (!__activeTicketNumber) {
            showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
            return;
        }
        if (!solution) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°');
            textarea?.focus();
            return;
        }

        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©...');

        // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…
        const ok = await completeTicketRequest(__activeTicketNumber, solution, currentUser.data.name);

        hideLoading();

        if (ok) {
            // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ±ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„)
            const card = document.querySelector(`.ticket-card[data-ticket="${__activeTicketNumber}"]`);
            if (card) card.remove();

            closeSolutionModal();

            // ØªØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ "Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„ÙŠ" (Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©) + ØªØ­Ø¯Ù‘Ø« "Ø·Ù„Ø¨Ø§ØªÙŠ"
            if (typeof loadAdvisorTicketsView === 'function') {
            await loadAdvisorTicketsView();
            }
            if (typeof loadMyRequests === 'function') {
            await loadMyRequests();
            }

            showSuccess('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
        }
        }


        // âœ… Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ESC ÙˆØ§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø±Ø¨Ø¹
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeSolutionModal();
        });
        const _sm = document.getElementById('solutionModal');
        if (_sm) {
        _sm.addEventListener('click', (ev) => {
            if (ev.target.id === 'solutionModal') closeSolutionModal();
        });
        } else {
        // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØªØ­Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª: Ø§Ù†ØªØ¸Ø± DOM Ø¬Ø§Ù‡Ø²
        document.addEventListener('DOMContentLoaded', () => {
            const sm2 = document.getElementById('solutionModal');
            if (sm2) {
            sm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'solutionModal') closeSolutionModal();
            });
            }
        });
        }


async function switchTab(event, tabName) {
  // 1) ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ .content
  const parentContent = event.target.closest('.content');
  parentContent.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  parentContent.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  // 2) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  if (tabName === 'statistics') {
    loadStatistics();

  } else if (tabName === 'myRequests') {
    if (currentUser?.data?.type === 'trainee') {
      loadTraineeTickets(currentUser.id).then(list => {
        const holder = document.getElementById('requestsList');
        if (!holder) return;

        holder.innerHTML = '';
        const cards = (list || []).map(ticket => {
        const rated   = Number(ticket.rating) > 0;
        const details = ticket.requestDetails || ticket.details || '-';

        // âœ… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        const cls = statusBadgeClass(ticket.status);
        const txt = statusBadgeText(ticket.status);

        const ratingBadge = rated
            ? `<span class="rating-badge" title="${ticket.rating} â€” ${RATING_LABELS[ticket.rating] || ''}">â˜… ${ticket.rating}/5</span>`
            : '';

        return `
            <div class="ticket-card modern">
            <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || 'â€”'}</span>
            </div>
            <div class="ticket-sep"></div>
            <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="v">${ticket.date || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…Ø±Ø´Ø¯:</span><span class="v">${ticket.advisor || '-'}</span></div>
            </div>
            ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}
            <div class="ticket-foot">
                ${ratingBadge}
                ${rated && ticket.ratingComment ? `<span class="dot"></span><span>ØªØ¹Ù„ÙŠÙ‚Ùƒ: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(ticket.status === 'completed' && !rated)
                ? `<span class="dot"></span><button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</button>`
                : ''}
            </div>
            </div>
        `;
        }).join('');


        holder.innerHTML = cards || '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
      });
    } else {
      loadMyRequests('requestsList');
    }

  } else if (tabName === 'advisorRequests') {
    loadMyRequests('advisorRequestsList');

  } else if (tabName === 'advisoryRatings') {
    // âœ… ØªØ¨ÙˆÙŠØ¨ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
    await loadManagementRatingsView('advisoryRatingsList');

  } else if (tabName === 'managementRatings') {
    if (!hasFullAccess()) {
      showError('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª');
      return;
    }
    await loadManagementRatingsView('ratingsList');

  } else if (tabName === 'managementStats') {
    const stats = await calculateStatistics();
    document.getElementById('m_totalTickets').textContent      = stats.total || 0;
    document.getElementById('m_completedTickets').textContent  = stats.completed || 0;
    document.getElementById('m_pendingTickets').textContent    = stats.pending || 0;
    document.getElementById('m_inProgressTickets').textContent = stats.inProgress || 0;
  }
}


    </script>
    

    <!-- âœ… Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ø§Ù„Ø­Ù€Ù€Ù„ -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ø§Ù„Ø­Ù„</h3>
      <button class="modal-close" aria-label="Ø§ØºÙ„Ø§Ù‚" onclick="closeSolutionModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <label for="solutionText" class="modal-label">Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ° <span style="color:#DC3545;">*</span></label>
      <textarea id="solutionText" rows="5" class="modal-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ° Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ ÙˆÙ…Ø®ØªØµØ±..."></textarea>

      <div class="modal-hint">
        ğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ø¬ÙŠØ¯Ø©: <em>ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø±Ø´Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ â€” ØªÙ… Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ØŒ Ø£Ø¹Ø·ÙŠ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹.</em>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeSolutionModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitSolution()">ØªÙ… Ø§Ù„Ø­Ù„</button>
    </div>
  </div>
</div>
<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
      <button class="modal-close" aria-label="Ø¥ØºÙ„Ø§Ù‚" onclick="closeRatingModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <!-- Ù†Ø¬ÙˆÙ… -->
      <div id="ratingStars" class="rating-pro" style="margin:6px 0 4px;"></div>
      <!-- Ù…Ù‚ÙŠØ§Ø³ Ù„ÙØ¸ÙŠ -->
      <div class="rating-scale" id="ratingScale"></div>
      <div class="rating-note" id="ratingNote">Ø§Ø®ØªØ± Ù…Ù† 1 (Ø³ÙŠØ¦) Ø¥Ù„Ù‰ 5 (Ù…Ù…ØªØ§Ø²)</div>

      <label for="ratingComment" style="margin-top:14px;">ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeRatingModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
  </div>
</div>

</body>
</html>