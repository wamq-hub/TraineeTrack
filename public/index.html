<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† - Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --tvtc-primary: #006341;
            --tvtc-primary-700: #0B5C3F;
            --tvtc-primary-100: #E6F1EC;
            --tvtc-secondary: #C8A55C;
            --tvtc-accent: #00A287;
            --tvtc-text: #1F2937;
            --tvtc-text-muted: #6B7280;
            --success: #1E7F5C;
            --warning: #C38E00;
            --error: #C0392B;
            --info: #2563EB;
            --border: #E5E7EB;
            --card: #FFFFFF;
            --surface: #F7FAF9;
            
            /* Compatibility aliases */
            --primary-blue: var(--tvtc-primary);
            --secondary-green: var(--success);
            --accent-gold: var(--tvtc-secondary);
            --light-blue: var(--tvtc-primary-100);
            --dark-blue: var(--tvtc-primary-700);
            --white: #FFFFFF;
            --gray: var(--surface);
            --text-dark: var(--tvtc-text);
            --border-color: var(--border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-blue: var(--tvtc-primary);
            --secondary-green: var(--success);
            --accent-gold: var(--tvtc-secondary);
            --light-blue: var(--tvtc-primary-100);
            --dark-blue: var(--tvtc-primary-700);
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --text-dark: #333333;
            --border-color: #DDD;
        }

        body {
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(10, 95, 143, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--secondary-green);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50%, -50%);
            z-index: 0;              /* ØªØ­Øª ÙƒÙ„ Ø´ÙŠØ¡ */
            pointer-events: none;    /* Ù„Ø§ ÙŠØ­Ø¬Ø¨ Ø§Ù„Ù†Ù‚Ø± */
        }

        .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        position: relative;
        z-index: 1; /* Ø¨Ø­ÙŠØ« ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ::before */
        }


        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.1);
        }

        .btn {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 95, 143, 0.3);
        }

        .btn-success {
            background: var(--secondary-green);
            color: white;
        }

        .btn-success:hover {
            background: #247d42;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-gold);
            color: var(--dark-blue);
        }

        .btn-warning:hover {
            background: #c5a032;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 30px;
            background: var(--gray);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .info-card {
            background: var(--light-blue);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid var(--primary-blue);
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .info-item strong {
            color: var(--primary-blue);
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-item span {
            color: var(--text-dark);
            font-size: 15px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-green), var(--accent-gold));
            margin: 30px 0;
            border-radius: 2px;
        }

        .ticket-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ticket-number {
            background: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .ticket-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }


        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border-right: 4px solid #17A2B8;
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border-right: 4px solid #28A745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .rating {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .star {
            font-size: 30px;
            color: #DDD;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover,
        .star.active {
            color: var(--accent-gold);
            transform: scale(1.2);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 2;              /* ÙÙˆÙ‚ Ø§Ù„Ø²Ø®Ø±ÙØ© */
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-blue);
        }

        .footer {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            border-top: 4px solid var(--accent-gold);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }

        .footer-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .footer-main {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .footer-divider {
            width: 80px;
            height: 3px;
            background: var(--accent-gold);
            margin: 15px auto;
            border-radius: 2px;
        }

        .footer-details {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 12px;
        }

        .footer-separator {
            color: var(--accent-gold);
            font-weight: bold;
        }

        .footer-version {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 10px;
            font-style: italic;
        }

        .service-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .service-btn {
            position: relative;
            display: block;
            cursor: pointer;
            padding: 20px;
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .service-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 95, 143, 0.2);
        }

        .service-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .service-btn input[type="radio"]:checked + span {
            color: white;
        }

        .service-btn input[type="radio"]:checked ~ span {
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            border-color: var(--primary-blue);
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) span {
            color: white;
        }

        .service-btn span {
            display: block;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        /* ========== Ø¨Ø·Ø§Ù‚Ø© ØªØ°ÙƒØ±Ø© Ø­Ø¯ÙŠØ«Ø© ========== */
        .ticket-card.modern {
        border: 1.5px solid var(--border-color);
        border-radius: 14px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 4px 18px rgba(10,95,143,.06);
        transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .ticket-card.modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 26px rgba(10,95,143,.12);
        border-color: rgba(10,95,143,.25);
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
        .ticket-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
        }
        .ticket-id-chip {
        background: var(--dark-blue);
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: .3px;
        font-size: 13px;
        }
        .ticket-status-badge {
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        border: 1px solid transparent;
        }
        .ticket-status--completed {
        background: #E8F5E9;
        color: #1B5E20;
        border-color: #C8E6C9;
        }
        .ticket-status--pending {
        background: #FFF8E1;
        color: #8B6B00;
        border-color: #FFECB3;
        }
        .ticket-status--inprogress {
        background: #E1F5FE;
        color: #01579B;
        border-color: #B3E5FC;
        }

        /* ÙØ§ØµÙ„ */
        .ticket-sep {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent);
        margin: 10px 0 14px;
        border-radius: 1px;
        }

        /* Ø´Ø¨ÙƒØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .ticket-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 10px 18px;
        }
        @media (max-width: 640px) {
        .ticket-grid { grid-template-columns: 1fr; }
        }
        .ticket-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        line-height: 1.7;
        }
        .ticket-row .k {
        min-width: 110px;
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 13px;
        }
        .ticket-row .v {
        color: var(--text-dark);
        font-size: 14px;
        word-wrap: break-word;
        }

        /* Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù†Øµ Ù…Ù…ØªØ¯ */
        .ticket-details {
        margin-top: 6px;
        background: var(--light-blue);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
        color: #0c2b3c;
        border: 1px dashed rgba(10,95,143,.25);
        }

        /* ÙÙˆØªØ± */
        .ticket-foot {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        color: #6b7280;
        font-size: 12px;
        }
        .ticket-foot .dot {
        width: 4px; height: 4px; border-radius: 50%; background:#c9cdd2;
        display: inline-block; margin-inline: 6px;
        }


        /* âœ… Ø£Ù†Ù…Ø§Ø· Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ */
        .transferred-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .transfer-info {
            background: #FFF3E0;
            border: 1px solid #FFE0B2;
            border-right: 4px solid #FF9800;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: #E65100;
        }

        .transfer-info strong {
            color: #BF360C;
        }

        .transfer-from-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 8px;
        }

.badge.badge-transfer{
  display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:700;
  background:var(--success);color:#fff;vertical-align:middle
}
.ticket-card{border:1px solid #ddd;border-radius:10px;padding:12px;background:#fff;margin-bottom:10px}
.ticket-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.ticket-id{font-weight:800}
.transfer-meta{margin-top:6px;color:#555}

    </style>

    <style>
  /* âœ… ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  .modal {
    width: 100%; max-width: 640px;
    background: #fff; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    overflow: hidden;
    border: 2px solid var(--border-color);
  }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
    color: #fff;
  }
  .modal-close {
    background: transparent; border: 2px solid #fff; color: #fff;
    width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
    font-size: 20px; line-height: 1;
  }
  .modal-body {
    padding: 18px 20px;
  }
  .modal-label {
    display: block; font-weight: 700; color: var(--text-dark); margin-bottom: 8px;
  }
  .modal-textarea {
    width: 100%; padding: 14px;
    border: 2px solid var(--border-color); border-radius: 8px;
    font-size: 16px; resize: vertical;
    transition: box-shadow .2s, border-color .2s;
  }
  .modal-textarea:focus {
    outline: none; border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(10,95,143,.12);
  }
  .modal-hint {
    margin-top: 10px; color: #6B7280; font-size: 13px;
    background: var(--light-blue); padding: 10px 12px; border-radius: 8px;
  }
  .modal-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    padding: 14px 20px; border-top: 1px solid var(--border-color);
    background: #FAFAFA;
  }

  /* ====== ØªÙ‚ÙŠÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ ====== */
.rating-pro {
  display: flex; align-items: center; gap: 10px; justify-content: center;
}
.rating-pro .star {
  font-size: 30px; cursor: pointer; user-select: none; transition: transform .15s ease;
}
.rating-pro .star:hover { transform: scale(1.12); }
.rating-pro .star.dim { color: #D1D5DB; }          /* ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„ */
.rating-pro .star.lit { color: var(--tvtc-secondary); }          /* Ù…ÙØ¶Ø§Ø¡Ø© */

.rating-scale {
  display: grid; grid-template-columns: repeat(5, minmax(0,1fr));
  gap: 6px; margin-top: 10px;
}
.rating-chip {
  text-align: center; font-size: 12px; padding: 6px 8px; border-radius: 999px;
  border: 1px solid #E5E7EB; color: #374151; background: #F9FAFB;
}
.rating-chip.active {
  background: #FFF7E6; border-color: #FBBF24; color: #92400E; font-weight: 700;
}

.rating-note {
  margin-top: 10px; color: #6B7280; font-size: 13px; text-align: center;
}

/* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
.modal-backdrop--rating { z-index: 10001; }
.modal-rating .modal-header { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
.modal-rating .modal-body label { font-weight: 700; color: #0F172A; margin-bottom: 8px; display:block; }
.modal-rating .modal-textarea { min-height: 90px; }

/* Ø´Ø§Ø±Ø© ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
.rating-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; background:#FEF9C3; color:#854D0E; border:1px solid #FDE68A; font-weight:700; font-size:12px;
}

  .date-filter{background:#e8f4f8;border-radius:14px;padding:12px}
  .date-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  .chip{border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff}
  .chip.active{background:var(--primary-blue,var(--tvtc-primary));color:#fff}
  .range-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .range-row .sep{opacity:.6;font-weight:700}
  .date-input{height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff}
  .btn-apply{height:38px;padding:0 14px;border-radius:10px;border:0;background:var(--tvtc-primary);color:#fff;font-weight:700;cursor:pointer}



</style>
</head>
<script>
(function(){
  const $ = s=>document.querySelector(s);

  function ymd(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
  function startOfWeek(d){const x=new Date(d);const day=(x.getDay());x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x;}
  function endOfWeek(d){const s=startOfWeek(d);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);return e;}
  function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}

  function setRange(from,to){
    $('#fltDateFrom').value = from ? ymd(from) : '';
    $('#fltDateTo').value   = to   ? ymd(to)   : '';
  }

  function applyRange(){
    const from=$('#fltDateFrom')?.value||'', to=$('#fltDateTo')?.value||'';
    document.dispatchEvent(new CustomEvent('filters:dateRangeChanged',{detail:{from,to}}));
    if(typeof window.applyFilters==='function') window.applyFilters();
  }

  function activate(pr){
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.pr===pr));
  }

  // presets
  const now=new Date();
  const presets={
    today: ()=>{const a=new Date();const b=new Date();setRange(a,b);},
    week:  ()=>{setRange(startOfWeek(now), endOfWeek(now));},
    month: ()=>{setRange(startOfMonth(now), endOfMonth(now));},
    quarter: ()=>{
      const m=Math.floor(now.getMonth()/3)*3;
      const s=new Date(now.getFullYear(),m,1);
      const e=new Date(now.getFullYear(),m+3,0);
      setRange(s,e);
    },
    custom: ()=>{}
  };

  // bind
  document.querySelectorAll('#dateFilter .chip').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const pr=btn.dataset.pr;
      activate(pr);
      if(presets[pr]) presets[pr]();
    });
  });
  $('#btnApplyRange')?.addEventListener('click', applyRange);

  // default: Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
  activate('month'); presets.month(); applyRange();
})();
</script>


<script>
(function(){
  const $ = s => document.querySelector(s);

  function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function startOfWeek(d){ const x=new Date(d); const day=x.getDay(); x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(s.getDate()+6); e.setHours(23,59,59,999); return e; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

  function setDbRange(from,to){
    const f = $('#dbFrom'), t = $('#dbTo');
    if (f) f.value = from ? ymd(from) : '';
    if (t) t.value = to   ? ymd(to)   : '';
  }

  window.applyDbFilters = function(){
    const from = $('#dbFrom')?.value || '';
    const to   = $('#dbTo')?.value   || '';
    document.dispatchEvent(new CustomEvent('filters:dateRangeChanged', { detail:{ from, to } }));
    if (typeof window.applyFilters === 'function') window.applyFilters();
    else if (typeof window.refreshDashboard === 'function') window.refreshDashboard();
  };

  function activateChip(pr){
    document.querySelectorAll('#dateFilter .chip')
      .forEach(c=>c.classList.toggle('active', c.dataset.pr===pr));
  }

  const now = new Date();
  const presets = {
    today:   ()=>{ const a=new Date(); const b=new Date(); setDbRange(a,b); },
    week:    ()=> setDbRange(startOfWeek(now), endOfWeek(now)),
    month:   ()=> setDbRange(startOfMonth(now), endOfMonth(now)),
    quarter: ()=> { const m=Math.floor(now.getMonth()/3)*3; const s=new Date(now.getFullYear(),m,1); const e=new Date(now.getFullYear(),m+3,0); setDbRange(s,e); },
    custom:  ()=> {}
  };

  document.querySelectorAll('#dateFilter .chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const pr = btn.dataset.pr;
      activateChip(pr);
      if (presets[pr]) presets[pr]();
    });
  });

  // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
  activateChip('month'); presets.month(); window.applyDbFilters();
})();
</script>


<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <h1>Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</h1>
            </div>
            <div class="content">
                <div class="login-form">
                    <h2 style="color: var(--primary-blue); margin-bottom: 30px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                        <input type="text" id="userId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
                    </div>
                    <button class="btn btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                </div>
            </div>
        </div>

        <!-- Advisory Services Unit Interface -->
        <div id="advisoryInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1>ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</h1>
                <p id="welcomeMessage"></p>
            </div>
            <div class="content">
                <!-- âœ… Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ - Ù…ÙˆØ¶ÙˆØ¹ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ -->
                <div style="margin-bottom: 20px; text-align: right;">
                    <button id="advisoryModeToggle" class="btn btn-primary hidden" onclick="switchAdvisoryMode(advisoryCurrentMode === 'basic' ? 'admin' : 'basic')">
                        <span id="advisoryModeToggleText">ğŸ”“ ÙˆØ¶Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ</span>
                    </button>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'newTicket')">ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <button class="tab" onclick="switchTab(event, 'myRequests')">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
                    <button class="tab hidden" id="advisoryTabRatings" onclick="switchTab(event, 'advisoryRatings')">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
                </div>

                <!-- New Ticket Tab -->
                 <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ -->
                    <div id="advisoryRatings" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
                    <div id="advisoryRatingsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                    </div>
                    </div>

                <div id="newTicket" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ØªØ¯Ø±Ø¨</label>
                        <input type="text" id="traineeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ">
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="loadTraineeData()">Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>

                    <div id="traineeInfo" class="hidden">
                        <div class="info-card">
                            <h3 style="color: var(--primary-blue); margin-bottom: 15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨</h3>
                            <div class="info-row">
                                <div class="info-item">
                                    <strong>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨</strong>
                                    <span id="traineeName">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</strong>
                                    <span id="traineeIdDisplay">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ù‚Ø³Ù…</strong>
                                    <span id="traineeDept">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„ØªØ®ØµØµ</strong>
                                    <span id="traineeSpec">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</strong>
                                    <span id="traineeAdvisor">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</strong>
                                    <span id="currentDate">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>Ø§Ù„ÙŠÙˆÙ…</strong>
                                    <span id="currentDay">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div class="form-group">
                            <label>Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</label>
                            <div class="service-buttons">
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø³Ù„ÙˆÙƒÙŠØ©">
                                    <span>Ø³Ù„ÙˆÙƒÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ù…Ø§Ù„ÙŠØ©">
                                    <span>Ù…Ø§Ù„ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="ØªØ¯Ø±ÙŠØ¨ÙŠØ©">
                                    <span>ØªØ¯Ø±ÙŠØ¨ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©">
                                    <span>Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†">
                                    <span>Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="Ø£Ø®Ø±Ù‰">
                                    <span>Ø£Ø®Ø±Ù‰</span>
                                </label>
                            </div>
                        </div>

                        <div id="otherServiceDiv" class="form-group hidden">
                            <label>Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <input type="text" id="otherService" placeholder="Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©">
                        </div>

                        <div class="form-group">
                            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                            <textarea id="requestDetails" rows="4" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="completeTicket()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
                        <button id="transferBtn" class="btn btn-warning hidden" onclick="showTransferOptions()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>

                        <div id="transferOptions" class="hidden" style="margin-top: 20px;">
                                <div class="form-group">
                                <label>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰</label>
                                <div class="service-buttons" id="transferToGroup">
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="advisor">
                                    <span>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="dept_head">
                                    <span>Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="elearning">
                                    <span>Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainees_vice">
                                    <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainers_deputy">
                                    <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</span>
                                    </label>
                                </div>
                                </div>
                            <button class="btn btn-primary" onclick="transferTicketAction()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                        </div>
                    </div>
                </div>

                <!-- My Requests Tab -->
                <div id="myRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
                    
                    <!-- âœ… ÙÙ„ØªØ±Ù‡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ -->
                    <div id="advRequestsFilterContainer" class="hidden" style="margin-bottom: 20px; background: var(--light-blue); padding: 15px; border-radius: 8px;">
                        <label style="font-weight: 600; color: var(--primary-blue); display: block; margin-bottom: 10px;">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…:</label>
                        <select id="advRequestsDeptFilter" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 5px; font-size: 14px;" onchange="filterRequestsByDept()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                        </select>
                    </div>

                    <div id="requestsList">
                        <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Advisor Interface -->
        <div id="advisorInterface" class="hidden">
          <div class="header">
            <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <h1>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ</h1>
            <p id="advisorWelcome"></p>
          </div>

          <div class="content">
            <div class="tabs">
              <button class="tab active" onclick="switchTab(event, 'assignedTickets')">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„ÙŠ</button>
              <button class="tab" onclick="switchTab(event, 'advisorRequests')">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
              <button class="tab" id="advisorRatingsTab" onclick="switchTab(event, 'advisorRatings')">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
            </div>

            <!-- ğŸŸ¦ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ -->
            <div id="assignedTickets" class="tab-content active">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„ÙŠ</h2>

              <div id="advisorTicketsList">
                <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
              </div>

              <!-- â„¹ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ -->
              <div class="alert alert-info" style="margin-top: 30px;">
                <span>â„¹ï¸</span>
                <span>Ù†Ø£Ù…Ù„ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨ØªÙ‚ÙŠÙŠÙ… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ù‡</span>
              </div>

              <!-- âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù… Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© -->
              <div class="alert alert-warning" style="
                margin-top: 12px;
                display: flex; gap: 10px; align-items: flex-start;
                background: #FFF7E6; border: 1px solid #F5C26B; color: #7A4B00;
                padding: 12px 14px; border-radius: 10px; line-height: 1.7; font-size: 14.5px;">
                <span aria-label='ØªÙ†Ø¨ÙŠÙ‡' title='ØªÙ†Ø¨ÙŠÙ‡' style='font-size: 18px;'>âš ï¸</span>
                <div>
                  <strong style='display:inline-block; margin-bottom:4px;'>ØªÙ†Ø¨ÙŠÙ‡:</strong>
                  <div>
                    ÙŠØ¸Ù‡Ø± Ù„Ø¯ÙŠÙƒ <u>ÙÙ‚Ø·</u> Ø§Ù„Ø­Ø§Ù„Ø§Øª <strong>Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</strong> Ø§Ù„ØªÙŠ ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„ÙŠÙƒ.
                    ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ† Ø¶Ù…Ù† Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ ÙˆÙ‡ÙŠ <strong>Ø®Ø§ØµØ©</strong> ÙˆÙ„Ø§ ØªÙØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø­ÙØ§Ø¸Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµÙˆØµÙŠØ©.
                    Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø£Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø´Ø£Ù†Ù‡Ø§ØŒ Ù†Ø£Ù…Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ <strong>ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</strong>.
                  </div>
                </div>
              </div>
            </div> <!-- âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ -->

            <!-- ğŸŸ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
            <div id="advisorRequests" class="tab-content">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
              <div id="advisorRequestsList">
                <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
              </div>
            </div>

            <!-- ğŸŸ¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù„Ø« -->
            <div id="advisorRatings" class="tab-content">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
              <div id="advisorRatingsList">
                <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
              </div>
            </div>
          </div>
        </div>


        <!-- Department Head / Deputy Interface Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ -->
        <div id="managementInterface" class="hidden">
        <div class="header">
            <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <!-- âœ… Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© -->
            <button id="backToBasicMode" class="btn btn-warning hidden" style="position: absolute; right: 20px; top: 30px;" onclick="switchAdvisoryMode('basic')">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ â†
            </button>
            <h1 id="managementTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            <p id="managementWelcome"></p>
        </div>

        <div class="content">
            <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'managementAll')">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button class="tab hidden" id="tabRatings" onclick="switchTab(event, 'managementRatings')">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
            <!-- Ø²Ø± ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„Ø°ÙˆÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ ÙÙ‚Ø·) -->
            <button class="tab hidden" id="tabDeptBoard" onclick="switchTab(event, 'managementDeptBoard')">Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <!-- âœ… Ø²Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø¶Ø§Ù -->
            <button class="btn" 
                    style="background:var(--tvtc-primary);color:#fff;border:0;padding:8px 14px;border-radius:8px;font-weight:600;margin-right:10px;"
                    onclick="openAdminReports()">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</button>
        </div>

            <!-- ØªØ¨ÙˆÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
            <div id="managementAll" class="tab-content active">
            <!-- ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ -->
            <div id="mgmtRequestsFilterContainer" class="info-card" style="margin-bottom:16px;">
                <h3 style="color: var(--primary-blue); margin-bottom: 10px;">Ø§Ù„ÙÙ„Ø§ØªØ±</h3>
                <div class="info-row">
                <div class="info-item">
                    <strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</strong>
                    <select id="mgmtRequestsDeptFilter" multiple style="height: 80px;">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                    </select>
                </div>
                <div class="info-item">
                    <strong>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</strong>
                    <select id="requestsTypeFilter" style="width:100%;">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                    <option value="Ø³Ù„ÙˆÙƒÙŠØ©">Ø³Ù„ÙˆÙƒÙŠØ©</option>
                    <option value="Ù…Ø§Ù„ÙŠØ©">Ù…Ø§Ù„ÙŠØ©</option>
                    <option value="ØªØ¯Ø±ÙŠØ¨ÙŠØ©">ØªØ¯Ø±ÙŠØ¨ÙŠØ©</option>
                    <option value="Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©">Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option>
                    <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†">Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ³ÙƒÙ†</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="info-item">
                    <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</strong>
                    <select id="requestsStatusFilter" style="width:100%;">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
                    <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                    <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
                    </select>
                </div>
                <div class="info-item">
                    <button class="btn btn-primary" onclick="filterManagementRequestsByAll()" style="margin-top: 28px;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
                </div>
                </div>
            </div>
            <div id="managementTicketsList">
                <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
            </div>
            </div>

            <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª -->
            <div id="managementRatings" class="tab-content">
            <div id="ratingsList">
                <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
            </div>
            </div>

            <!-- âœ… ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ØªØ§Ø¨ Ù…Ø³ØªÙ‚Ù„ Ø´Ù‚ÙŠÙ‚) -->
            <div id="managementDeptBoard" class="tab-content">
            <!-- ÙÙ„Ø§ØªØ± -->
            <div class="info-card" style="margin-bottom:16px;">
            <h3 style="color: var(--primary-blue); margin-bottom: 10px;">Ø§Ù„ÙÙ„Ø§ØªØ±</h3>

            <!-- Ø´Ø±ÙŠØ· Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <div class="date-filter" id="dateFilter" style="background:#e8f4f8;border-radius:14px;padding:12px;margin-bottom:12px;">
                <div class="date-toolbar" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;">
                <button class="chip" data-pr="today"   style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="chip" data-pr="week"    style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="chip" data-pr="month"   style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
                <button class="chip" data-pr="quarter" style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹</button>
                <button class="chip" data-pr="custom"  style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">Ù…Ø®ØµØµ</button>
                </div>
                <div class="range-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <!-- Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ -->
                <input id="dbFrom" class="date-input" type="date" placeholder="YYYY-MM-DD" style="height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff">
                <span class="sep" style="opacity:.6;font-weight:700">â€”</span>
                <input id="dbTo" class="date-input" type="date" placeholder="YYYY-MM-DD" style="height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff">
                <button class="btn-apply" id="btnApplyDbRange" onclick="applyDbFilters()" style="height:38px;padding:0 14px;border-radius:10px;border:0;background:var(--tvtc-primary);color:#fff;font-weight:700;cursor:pointer">ØªØ·Ø¨ÙŠÙ‚</button>
                </div>
            </div>

            <div class="info-row">
                <div class="info-item">
                <strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</strong>
                <select id="dbDept" multiple style="height: 110px;"></select>
                </div>
                <div class="info-item">
                <strong>Ø§Ù„Ø­Ø§Ù„Ø©</strong>
                <div style="display:flex; gap:10px; flex-wrap:wrap; padding-top:6px;">
                    <label><input type="checkbox" id="dbStPending" checked> Ù…Ø¹Ù„Ù‘Ù‚Ø©</label>
                    <label><input type="checkbox" id="dbStInProgress" checked> Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</label>
                    <label><input type="checkbox" id="dbStCompleted" checked> Ù…ÙƒØªÙ…Ù„Ø©</label>
                </div>
                </div>
                <div class="info-item">
                <strong>Ø§Ù„Ù…ØµØ¯Ø±</strong>
                <select id="dbSource">
                    <option value="all" selected>Ø§Ù„ÙƒÙ„</option>
                    <option value="advisory">Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯</option>
                    <option value="elearning">Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                    <option value="departments">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</option>
                </select>
                </div>
            </div>
            </div>


            <!-- KPIs -->
            <div class="stats-grid" id="dbKpis" style="margin-top: -8px;">
                <!-- ÙŠÙÙ…Ù„Ø£ Ø¨Ø±Ù…Ø¬ÙŠÙ‹Ø§ -->
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… -->
            <div class="divider"></div>
            <div id="dbTableWrap">
                <div style="overflow:auto;">
                <table id="dbTable" style="width:100%; border-collapse: collapse;">
                    <thead>
                    <tr style="background: var(--light-blue);">
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ø§Ù„Ù‚Ø³Ù…</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ø¬Ø¯ÙŠØ¯Ø©</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ù…Ø¹Ù„Ù‘Ù‚Ø©</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ù…ÙƒØªÙ…Ù„Ø©</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">% Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ÙŠÙˆÙ…)</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">% Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù€ SLA</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ (Ù…ÙƒØªÙ…Ù„Ø©)</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</th>
                    </tr>
                    </thead>
                    <tbody id="dbTableBody">
                    <!-- ÙŠÙÙ…Ù„Ø£ Ø¨Ø±Ù…Ø¬ÙŠÙ‹Ø§ -->
                    </tbody>
                </table>
                </div>
            </div>
            </div> <!-- /managementDeptBoard -->

        </div> <!-- /content -->
        </div> <!-- /managementInterface -->



        <!-- Trainee Interface -->
        <div id="traineeInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <h1>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h1>
                <p id="traineeWelcome"></p>
            </div>
            <div class="content">
                <h2 style="color: var(--primary-blue); margin-bottom: 25px;">ØªØ°Ø§ÙƒØ±ÙŠ</h2>
                <div id="traineeTicketsList">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
                </div>
                <div class="alert alert-info" style="margin-top: 30px;">
                    <span>â„¹ï¸</span>
                    <span><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù„Ù…Ø¹Ø±ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù†Ø£Ù…Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <div class="footer-main">Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø­Ù‚Ù„</div>
                <div class="footer-divider"></div>
                <div class="footer-details">
                    <span>ÙˆÙƒØ§Ù„Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
                    <span class="footer-separator">â€¢</span>
                    <span>ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</span>
                </div>
                <div class="footer-version">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0 | Â© 2025 Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ</div>
            </div>
        </div>
    </div>


    
    <!-- ØªØ¶Ù…ÙŠÙ† Ù…Ù„Ù API -->
    <script src="api_integration.js"></script>

    <script>
        let currentUser = null;
        let currentTraineeData = null;

        let __ratingTicketNumber = null;
        let __ratingValue = 0;

        let __lastTraineeTickets = [];   // Ø¢Ø®Ø± Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ØªØ¯Ø±Ø¨
        let __ratingSubmitting   = false; // ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ÙƒØ±Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„

        /**
         * âœ… Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® - ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ ØµÙŠØºØ© ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…Ù‚Ø±ÙˆØ¡Ø©
         * @param {string|Date} dateInput - Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø£ÙŠ ØµÙŠØºØ©
         * @param {boolean} includeTime - Ù‡Ù„ Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø£ÙŠØ¶Ø§Ù‹ØŸ
         * @returns {string} - Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…Ù‚Ø±ÙˆØ¡Ø©
         */
        function formatArabicDate(dateInput, includeTime = false) {
            if (!dateInput) return '-';
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Date object
                let date;
                if (dateInput instanceof Date) {
                    date = dateInput;
                } else if (typeof dateInput === 'string') {
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO (Ù…Ø«Ù„: 2025-10-28T21:00:00.000Z)
                    date = new Date(dateInput);
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® invalid
                    if (isNaN(date.getTime())) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙŠØº Ø£Ø®Ø±Ù‰
                        const parts = dateInput.match(/(\d{4})-(\d{2})-(\d{2})/);
                        if (parts) {
                            date = new Date(parts[1], parseInt(parts[2]) - 1, parts[3]);
                        } else {
                            return dateInput; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                        }
                    }
                } else {
                    return '-';
                }

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (isNaN(date.getTime())) {
                    return dateInput.toString();
                }

                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                let formatted = `${year}-${month}-${day}`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨
                if (includeTime) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    formatted += ` ${hours}:${minutes}:${seconds}`;
                }
                
                return formatted;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
                return dateInput.toString();
            }
        }

        /**
         * âœ… Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…)
         */
        function formatArabicDateFull(dateInput) {
            if (!dateInput) return '-';
            
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return dateInput.toString();
                
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                const dayName = days[date.getDay()];
                
                return `${dayName} ${formatArabicDate(dateInput, false)}`;
            } catch (error) {
                return formatArabicDate(dateInput, false);
            }
        }

        /**
         * âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø·
         */
        function formatTimeOnly(dateInput) {
            if (!dateInput) return '-';
            
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return '-';
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return '-';
            }
        }


        const RATING_LABELS = {
        1: 'Ø³ÙŠØ¦',
        2: 'Ù…Ù‚Ø¨ÙˆÙ„',
        3: 'Ø¬ÙŠØ¯',
        4: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§',
        5: 'Ù…Ù…ØªØ§Ø²'
        };

        // ğŸ”¹ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¶Ø¹Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ù…Ù„ÙÙƒ Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
        function normalizeServiceType(v){
        v = String(v || '').trim().toLowerCase();
        if (['ØªØ¯Ø±ÙŠØ¨ÙŠØ©','ØªØ¯Ø±ÙŠØ¨ÙŠ','training','train','ØªØ¹Ù„ÙŠÙ…ÙŠ'].includes(v)) return 'training';
        return v;
        }
        function isAdvisoryUser(){
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '')
                        .toLowerCase().replace(/\s+/g,'_');
        return role === 'advisory_unit' || role === 'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©';
        }

        // trainee_platform_live copy.html
        function refreshAdvisorTransferUI(){
        const btn  = document.getElementById('transferBtn');
        const opts = document.getElementById('transferOptions');
        if (!btn) return;
        const roleOk = isAdvisoryUser();
        const checked = document.querySelector('input[name="serviceType"]:checked');
        const type = normalizeServiceType(checked ? checked.value : '');
        const canTransfer = roleOk && type === 'training';
        btn.classList.toggle('hidden', !canTransfer);
        if (!canTransfer && opts) opts.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[name="serviceType"]').forEach(r=>{
            r.addEventListener('change', refreshAdvisorTransferUI);
        });
        refreshAdvisorTransferUI();
        });

        // Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ØŸ

        // âœ³ï¸ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø¯Ù…Ø© "ØªØ¯Ø±ÙŠØ¨ÙŠØ©" â‡’ ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„.
        // Ù„Ùˆ "ØºÙŠØ± ØªØ¯Ø±ÙŠØ¨ÙŠØ©" â‡’ ØªÙØ¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¨Ø¯ÙˆÙ† "ØªØ­ÙˆÙŠÙ„".
        function advisorAllowedActions(ticket){
        if (!isAdvisoryUser()) return null;
        const isTraining = normalizeServiceType(ticket?.serviceType) === 'training';
        return isTraining ? ['transfer'] : ['comment','request-info','close'];
        }
        // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… =====
        const SLA_DAYS = 5;  // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† config

        // ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® (ÙŠØ¯Ø¹Ù… ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø§Ø¦Ø¹Ø© Ùˆ/ar-SA)
        function tryParseDate(s) {
        if (!s) return null;
        // Ù„Ùˆ ØµÙŠØºØ© yyyy-mm-dd Ù…Ù† <input type="date">
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00');
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø§Ù…Ø©
        const d = new Date(s);
        if (!isNaN(d)) return d;
        // Ø¯Ø¹Ù… Ø´ÙƒÙ„ dd/mm/yyyy
        const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
        if (m) {
            const dd = +m[1], mm = +m[2]-1, yyyy = +m[3] < 100 ? 2000 + (+m[3]) : +m[3];
            return new Date(yyyy, mm, dd);
        }
        return null;
        }

        function daysBetween(a, b) {
        const MS = 1000*60*60*24;
        return Math.round((+b - +a)/MS);
        }

        // ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        (function exposeDeptBoardTab(){
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('tabDeptBoard');
            if (btn) {
            if (hasFullAccess()) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
            }
        });
        })();

        function buildRatingUI(containerStars, containerScale, current=0) {
        // Ù†Ø¬ÙˆÙ…
        containerStars.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const s = document.createElement('span');
            s.textContent = 'â˜…';
            s.className = 'star ' + (i <= current ? 'lit' : 'dim');
            s.title = `${i} - ${RATING_LABELS[i]}`;
            s.onclick = () => selectRating(i);
            containerStars.appendChild(s);
        }

        // Ø´Ø±Ø§Ø¦Ø­ Ù„ÙØ¸ÙŠØ©
        containerScale.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const chip = document.createElement('div');
            chip.className = 'rating-chip' + (i === current ? ' active' : '');
            chip.textContent = `${i} â€” ${RATING_LABELS[i]}`;
            chip.onclick = () => selectRating(i);
            containerScale.appendChild(chip);
        }

        const note = document.getElementById('ratingNote');
        note.textContent = current ? `Ø§Ø®ØªØ±Øª: ${current} â€” ${RATING_LABELS[current]}` : 'Ø§Ø®ØªØ± Ù…Ù† 1 (Ø³ÙŠØ¦) Ø¥Ù„Ù‰ 5 (Ù…Ù…ØªØ§Ø²)';
        }

        function selectRating(val) {
        __ratingValue = val;
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        if (stars && scale) buildRatingUI(stars, scale, __ratingValue);
        }


        function openRatingModal(ticketNumber) {
        // Ø­Ù…Ø§ÙŠØ©: Ù„Ø§ ØªÙØªØ­ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ù‚ÙŠÙ‘Ù…Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
        if (isTicketRatedLocal(ticketNumber)) {
            showSuccess('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…');
            return;
        }

        __ratingTicketNumber = ticketNumber;
        __ratingValue = 0;

        const modal = document.getElementById('ratingModal');
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        const textarea = document.getElementById('ratingComment');

        if (textarea) textarea.value = '';
        if (stars && scale) buildRatingUI(stars, scale, 0);

        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => { stars?.querySelector('.star')?.focus?.(); }, 50);
        }
        }


        // === Helper: Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø¨Ø¯Ø§Ø¦Ù„ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ© (en/snake_case/Ø¹Ø±Ø¨ÙŠ)
        function _val(v){ return v===0 || v ? String(v).trim() : ''; }
        function fieldOf(obj, names=[]){
        for (const k of names){
            const v = obj?.[k];
            if (v!==undefined && v!==null && _val(v)!=='') return v;
        }
        return '';
        }

        // Ø­Ø²Ù… Ø¨Ø¯Ø§Ø¦Ù„ Ø¬Ø§Ù‡Ø²Ø©
        function getStatus(t){ return (fieldOf(t, ['status','Ø§Ù„Ø­Ø§Ù„Ø©']) || 'pending').toLowerCase(); }
        function getCreatedBy(t){ return fieldOf(t, ['createdBy','created_by','Ø£Ù†Ø´Ø£ Ø¨ÙˆØ§Ø³Ø·Ø©','Ø§Ù„Ù…Ù†Ø´Ø¦','Ù…Ù†Ø´Ø¦']); }
        function getCompletedBy(t){ return fieldOf(t, ['completedBy','completed_by','Ø£Ù†Ù‡Ù‰','Ø£Ù†Ù‡Ù‰ Ø¨ÙˆØ§Ø³Ø·Ø©']); }
        function getAssignedTo(t){ return fieldOf(t, ['assignedTo','assigned_to','Ø§Ù„Ù…Ø³Ù†ÙØ¯_Ø¥Ù„Ù‰','Ø§Ù„Ù…Ø³Ù†Ø¯ Ø¥Ù„Ù‰','Ø§Ù„Ù…Ø³Ù†ÙØ¯ Ø¥Ù„Ù‰']); }
        function getTransferredBy(t){ return fieldOf(t, ['transferredBy','transferred_by','Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„_Ø¨ÙˆØ§Ø³Ø·Ø©','Ù…Ø­ÙˆÙ‘Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©','Ø§Ù„Ù…Ø­ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø©']); }
        function getTransferredTo(t){ return fieldOf(t, ['transferredTo','transferred_to','Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„_Ø¥Ù„Ù‰','Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰','Ø§Ù„Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰']); }
        function getDepartment(t){ return fieldOf(t, ['department','Ø§Ù„Ù‚Ø³Ù…']); }
        function getServiceType(t){ return fieldOf(t, ['serviceType','service_type','Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©','Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©']); }
        function getDateStr(t){ return fieldOf(t, ['date','creationDate','created_at','Ø§Ù„ØªØ§Ø±ÙŠØ®']); }
        function getTicketNumber(t){ return fieldOf(t, ['ticketNumber','ticket_number','Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©','Ø§Ù„ØªØ°ÙƒØ±Ø©']); }
        function getDetails(t){ return fieldOf(t, ['requestDetails','details','ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨']); }
        function getSolution(t){ return fieldOf(t, ['solution','executedSolution','solutionText','Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°']); }

        function getRoleCapabilities(user){
        const r = normalizeRole(user?.role || user?.data?.role || '');
        const CAPS = {
            dean: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            quality_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            trainees_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            advisory_unit: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['newTicket','myRequests','assignedTickets','statistics','ratingsBoard','managementAll','deptBoard'] },
            trainers_deputy: { scope:'elearning_and_depts', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['dashboard','managementAll','managementRatings'] },
            dept_head: { scope:'department', canSeeRatings:true, canManageTickets:true, canAssign:false, canClose:true, ui:['deptTickets','deptRatings'] }, // â† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
            advisor: { scope:'assigned_and_self', canSeeRatings:true, canManageTickets:true, canAssign:false, canClose:true, ui:['assignedTickets','advisorRequests','myRequests','advisorRatings'] },

            // âœ… Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            elearning: { scope:'assigned_or_transferred', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['managementAll'] },

            trainee: { scope:'self', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['newTicket','traineeTicketsList','rateService'] }
        };
        return CAPS[r] || { scope:'none', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:[] };
        }


        function closeRatingModal() {
        const modal = document.getElementById('ratingModal');
        if (modal) modal.classList.add('hidden');
        __ratingTicketNumber = null;
        __ratingValue = 0;
        }

        // Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø© ÙˆÙ†ØµÙ‡Ø§

        function statusBadgeText(st) {
        if (st === 'completed') return 'Ù…ÙƒØªÙ…Ù„Ø©';
        if (st === 'in_progress') return 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°';
        return 'Ù…Ø¹Ù„Ù‚Ø©';
        }

        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø¨Ù‚ÙŠ Ø§Ù„Ø¯Ø§Ù„ØªÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…ØªÙŠÙ† Ù„ÙƒÙ† ÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function statusBadgeClass(st){ if (st === 'completed') return 'ticket-status--completed'; if (st === 'in_progress') return 'ticket-status--inprogress'; return 'ticket-status--pending'; }
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªØ°ÙƒØ±Ø©
        if (typeof window.updateTicketStatus !== 'function') {

        window.updateTicketStatus = async (ticketNumber, payload) => {
            const res = await sendRequest('updateTicketStatus', { ticketNumber, ...payload });
            return !!(res && res.success);
        };
        }

        // ÙŠÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ currentUser.role Ùˆ/Ø£Ùˆ currentUser.data.role Ø­Ø³Ø¨ ØªØ·Ø¨ÙŠÙ‚Ùƒ
        function canShowTransferButton(ticket){
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '').toLowerCase().replace(/\s+/g,'_');
        const isAdvisory = (role === 'advisory_unit' || role === 'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©');
        return isAdvisory && normalizeServiceType(ticket.serviceType) === 'training';
        }

        // Ù…Ø«Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø¨Ù†Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:
        function renderTicketActions(ticket){
        const actions = [];
        // Ø£Ø²Ø±Ø§Ø± Ø­Ø§Ù„ÙŠØ©â€¦ (Ù„Ø§ ØªØºÙŠÙ‘Ø±Ù‡Ø§)
        // ...
        const advisorActions = advisorAllowedActions(ticket);
        if (advisorActions) {
            // Ø²Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„
            if (advisorActions.includes('transfer')) {
            actions.push(`<button class="btn btn-primary" onclick="openAdvisorTransferModal('${ticket.ticketNumber}')">ØªØ­ÙˆÙŠÙ„</button>`);
            }
            // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù†Øª ØºÙŠØ± ØªØ¯Ø±ÙŠØ¨ÙŠØ©
            if (advisorActions.includes('comment')) {
            actions.push(`<button class="btn" onclick="openAddCommentModal('${ticket.ticketNumber}')">Ù…Ù„Ø§Ø­Ø¸Ø©</button>`);
            }
            if (advisorActions.includes('request-info')) {
            actions.push(`<button class="btn" onclick="openRequestMoreInfo('${ticket.ticketNumber}')">Ø·Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>`);
            }
            if (advisorActions.includes('close')) {
            actions.push(`<button class="btn btn-danger" onclick="confirmCloseTicket('${ticket.ticketNumber}')">Ø¥ØºÙ„Ø§Ù‚</button>`);
            }
            return `<div class="ticket-actions">${actions.join('')}</div>`;
        }
        // âœ… Ø²Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ + ØªØ¯Ø±ÙŠØ¨ÙŠØ©
        // ğŸ”¹ Ø²Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ + ØªØ¯Ø±ÙŠØ¨ÙŠØ©
        if (canShowTransferButton(ticket)) {
            actions.push(`<button class="btn btn-primary" onclick="openAdvisorTransferModal('${ticket.ticketNumber}')">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>`);
        }
        return `<div class="ticket-actions">${actions.join('')}</div>`;
        }
        
        // ØªØ­ÙˆÙŠÙ„ ØªØ°ÙƒØ±Ø©
        // === Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ===
        if (typeof window.transferTicket !== 'function') { window.transferTicket = async () => {}; }
        window.transferTicket = async (ticketNumber, to, by) => {
        const transferDate = new Date().toLocaleDateString('ar-SA');
        // Ù†Ø±Ø³Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙƒÙ„Ù‡Ø§ Ø§Ø­ØªÙŠØ§Ø·Ù‹Ø§
        const payload = {
            ticketNumber,
            to,
            transferredTo: to,
            by,
            transferredBy: by,
            transferDate
        };
        const res = await sendRequest('transferTicket', payload);
        return !!(res && res.success);
        };
        // Ø¥Ù†Ù‡Ø§Ø¡ ØªØ°ÙƒØ±Ø© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„)
        if (typeof window.completeTicketRequest !== 'function') {
        window.completeTicketRequest = async (ticketNumber, solutionText, completedBy, completionDate) => {
            const payload = { ticketNumber, solutionText, completedBy };
            if (completionDate) payload.completionDate = completionDate;
            const res = await sendRequest('completeTicket', payload);
            return !!(res && res.success);
        };
        }

        async function submitTraineeRating() {
        // ØªØ­Ù‚Ù‚ Ø£Ø³Ø§Ø³ÙŠ
        if (!__ratingTicketNumber) { showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return; }
        if (!__ratingValue)        { showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5'); return; }
        if (__ratingSubmitting)     return; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ†

        // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù„ØªØ¹Ø·ÙŠÙ„Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
        const btn = document.querySelector('#ratingModal .btn.btn-success');

        // ÙØ­Øµ Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹: Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙŠÙ‘Ù…Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©/Ø§Ù„Ø¹Ø±Ø¶ØŸ
        try {
            if (Array.isArray(__lastTraineeTickets)) {
            const localHit = __lastTraineeTickets.find(
                x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (localHit) {
                // Ø¥ØºÙ„Ø§Ù‚ ÙˆØªÙ‡Ø°ÙŠØ¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                closeRatingModal();
                showSuccess('Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙŠÙ‘Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„ âœ…');
                return;
            }
            }
        } catch (_) { /* ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ù…Ø­Ù„ÙŠ */ }

        __ratingSubmitting = true;
        if (btn) { btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...'; }

        try {
            // ÙØ­Øµ Ø­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‚ÙŠÙ‘Ù… Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±)
            const fresh = await loadTraineeTickets(currentUser.id);
            const already = (fresh || []).find(
            x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (already) {
            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø«Ù… Ø§Ø®Ø±Ø¬
            __lastTraineeTickets = fresh;
            displayTraineeTickets(__lastTraineeTickets);
            closeRatingModal();
            showSuccess('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…');
            return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø®Ø§Ø¯ÙˆÙ… (Apps Script) â€” ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹ÙŠØ¯ {success, code?}
            const comment = (document.getElementById('ratingComment')?.value || '').trim();
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...');
            const res = await saveRating(__ratingTicketNumber, __ratingValue, comment);
            hideLoading();

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¯Ù‘ Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…
            if (!res || res.success === false) {
            if (res?.code === 'ALREADY_RATED') {
                // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…: Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                closeRatingModal();
                showError('ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù„Ø¥Ø®ÙØ§Ø¡ Ø²Ø± "Ù‚ÙŠÙ‘Ù…"
                if (typeof loadTraineeTicketsView === 'function') await loadTraineeTicketsView();
                return;
            }
            showError(res?.message || 'ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
            return;
            }

            // Ù†Ø¬Ø§Ø­
            closeRatingModal();
            showSuccess('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚ÙŠÙŠÙ…Ùƒ. Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!');

            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… â€” Ø³ÙŠØ®ØªÙÙŠ Ø²Ø± "Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" ÙˆØªØ¸Ù‡Ø± Ø§Ù„Ø´Ø§Ø±Ø©
            await loadTraineeTicketsView();

            // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ (ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø¨ Ø£Ùˆ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³)
            try {
            if (Array.isArray(__lastTraineeTickets)) {
                const idx = __lastTraineeTickets.findIndex(
                x => String(x.ticketNumber) === String(__ratingTicketNumber)
                );
                if (idx >= 0) {
                __lastTraineeTickets[idx].rating = Number(__ratingValue);
                __lastTraineeTickets[idx].ratingComment = comment;
                displayTraineeTickets(__lastTraineeTickets);
                }
            }
            } catch (_) { /* Ø§Ø®ØªÙŠØ§Ø±ÙŠ */ }

        } catch (e) {
            hideLoading();
            showError(e?.message || String(e));
        } finally {
            __ratingSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'; }
        }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ESC ÙˆØ§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeRatingModal(); });
        document.addEventListener('click', (ev) => {
        const m = document.getElementById('ratingModal');
        if (m && ev.target === m) closeRatingModal();
        });
        // âœ… 3) Ù…Ù† ÙŠÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ (ÙŠØ´ÙˆÙ ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª + ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª")
        function hasFullAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        // ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„ÙŠØ§ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† ÙÙŠ ÙˆØ¶Ø¹ admin
        if (r === 'advisory_unit' && advisoryCurrentMode === 'admin') {
            return true;
        }
        return ['dean','trainees_vice','quality_vice'].includes(r);
        }


        // âœ… Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø±Ø´Ø¯ÙŠÙ† (Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙˆØ±ÙŠÙ†)
        let advisoryCurrentMode = 'basic'; // 'basic' Ø£Ùˆ 'admin'

        // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¯ÙˆØ± Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§
        function switchAdvisoryMode(mode) {
        if (normalizeRole((currentUser?.data?.role || '').trim()) !== 'advisory_unit') {
            showError('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©');
            return;
        }

        advisoryCurrentMode = mode; // 'basic' Ø£Ùˆ 'admin'

        // Ø­Ø¯Ù‘Ø« Ù†Øµ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙˆØ±Ù‹Ø§
        const toggleText = document.getElementById('advisoryModeToggleText');
        if (toggleText) {
            toggleText.textContent = advisoryCurrentMode === 'admin' ? 'ğŸ”’ ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ' : 'ğŸ”“ ÙˆØ¶Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ';
        }

        if (mode === 'admin') {
            // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„ÙŠØ§
            showManagementInterface();
        } else {
            // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            showAdvisoryInterface();
        }
        }

        // === ğŸŸ¢ Ø´Ø±Ø· Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙÙ‚Ø· Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© ===
        function canShowTransferButton(ticket) {
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '').toLowerCase().replace(/\s+/g,'_');
        const serviceType = String(ticket.serviceType || '').trim().toLowerCase();
        const isTraining = ['ØªØ¯Ø±ÙŠØ¨ÙŠØ©','training','train','ØªØ¹Ù„ÙŠÙ…ÙŠ'].includes(serviceType);
        const isAdvisory = (role === 'advisory_unit' || role === 'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©');
        return isAdvisory && isTraining;
        }

        // âœ… CORRECT: Ø§ÙƒØªØ´Ø§Ù Ù‚ÙˆÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ + ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ø¶Ø­Ø© + ØªÙˆØ§ÙÙ‚ ØªØ§Ù… Ù…Ø¹ CSS
// âœ… ØªØµØ­ÙŠØ­ ÙƒØ§Ù…Ù„ Ù„Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹ Ø´Ø§Ø±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ (transfer badge) ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
        function renderTicketCard(ticket) {
        const card = document.createElement('div');
        card.className = 'ticket-card';

        // Ù‚ÙŠÙ… Ø®Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
        const toRaw   = String(ticket.transferredTo || '').trim();
        const byRaw   = String(ticket.transferredBy || '').trim();
        const dateRaw = String(ticket.transferDate  || '').trim();
        const stRaw   = String(ticket.status        || '').trim();

        // ØªØ·Ø¨ÙŠØ¹ Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø´ÙƒÙ„ Ù…ÙˆØ­Ù‘Ø¯
        const toNorm = (typeof normalizeRole === 'function')
            ? normalizeRole(toRaw)
            : toRaw.toLowerCase().replace(/\s+/g,'_');

        // ğŸ” Ø§ÙƒØªØ´Ø§Ù Ø´Ø§Ù…Ù„ Ù„ÙˆØ¶Ø¹ "Ù…Ø­ÙˆÙ‘Ù„Ø©"
        const isTransferred =
            (!!toRaw) || (!!byRaw) || (!!dateRaw) ||
            (stRaw.toUpperCase() === 'TRANSFERRED') ||
            (ticket.transferred === true);

        // ğŸ·ï¸ Ø´Ø§Ø±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ (ØªÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù† isTransferred = true)
        const badgeHTML = isTransferred
            ? `<span class="badge badge-transfer" title="${
                [
                byRaw   ? ('Ø¨ÙˆØ§Ø³Ø·Ø©: ' + byRaw) : '',
                toRaw   ? ('Ø¥Ù„Ù‰: '     + toRaw) : '',
                dateRaw ? ('Ø¨ØªØ§Ø±ÙŠØ®: '  + dateRaw) : ''
                ].filter(Boolean).join(' | ')
            }">Ù…Ø­ÙˆÙ‘ÙÙ„Ø©</span>`
            : '';

        // ğŸ—‚ï¸ ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙˆØ¬Ù‡Ø§Øª Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø±Ø¨ÙŠØ© Ù„Ø·ÙŠÙØ©
        const roleTranslation = {
            'advisor':        'Ø§Ù„Ù…Ø±Ø´Ø¯',
            'dept_head':      'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
            'elearning':      'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
            'trainees_vice':  'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
            'quality_vice':   'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
            'dean':           'Ø§Ù„Ø¹Ù…ÙŠØ¯'
        };
        const toLabel = roleTranslation[toNorm] || toRaw || (isTransferred ? 'Ø¬Ù‡Ø© Ø£Ø®Ø±Ù‰' : '');

        // ğŸŸ¢ Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¯ÙˆØ§Ù„Ùƒ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©)
        const stKey = stRaw.toLowerCase();
        const statusClass = (typeof statusBadgeClass === 'function') ? statusBadgeClass(stKey) : (
            stKey === 'completed'   ? 'ticket-status--completed' :
            stKey === 'in_progress' ? 'ticket-status--inprogress' :
                                    'ticket-status--pending'
        );
        const statusText = (typeof statusBadgeText === 'function') ? statusBadgeText(stKey) : (
            stKey === 'completed'   ? 'Ù…ÙƒØªÙ…Ù„Ø©' :
            stKey === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' :
                                    'Ù…Ø¹Ù„Ù‚Ø©'
        );

        // âœ… Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        card.innerHTML = `
            <div class="ticket-header">
            <span class="ticket-id">#${ticket.ticketNumber || ''}</span>
            ${badgeHTML}
            </div>

            <div class="ticket-body">
            <div><strong>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> ${ticket.title || ticket.requestDetails || '-'}</div>
            <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="ticket-status-badge ${statusClass}">${statusText}</span></div>
            ${
                isTransferred
                ? `<div class="transfer-meta">
                    <small>
                        ${byRaw   ? ('Ù…Ø­ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø©: ' + byRaw) : ''}
                        ${toLabel ? (byRaw ? ' | ' : '') + 'Ø¥Ù„Ù‰: ' + toLabel : ''}
                        ${dateRaw ? ' | Ø¨ØªØ§Ø±ÙŠØ®: ' + formatArabicDate(dateRaw, true) : ''}
                    </small>
                    </div>`
                : ''
            }
            </div>
        `;

        // Ø³Ù…Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
        if (ticket.department)  card.setAttribute('data-mgmt-dept',   ticket.department);
        if (ticket.serviceType) card.setAttribute('data-mgmt-type',   ticket.serviceType);
        if (ticket.status)      card.setAttribute('data-mgmt-status', ticket.status);

        return card;
        }


        // âœ… Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ù‡
        // âœ… Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙÙ„ØªØ± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
        function showManagementRequestsFilter() {
        const filterContainer = document.getElementById('mgmtRequestsFilterContainer');
        if (filterContainer) {
            if (hasFullAccess()) {
            filterContainer.style.display = '';
            populateManagementDeptFilter();
            } else {
            filterContainer.style.display = 'none';
            }
        }
        }


        // âœ… Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        function populateManagementDeptFilter() {
        const filterSelect = document.getElementById('mgmtRequestsDeptFilter');
        if (!filterSelect) return;
        const depts = new Set();
        const cards = document.querySelectorAll('[data-mgmt-dept]');
        cards.forEach(card => {
            const dept = card.getAttribute('data-mgmt-dept');
            if (dept && dept.trim()) depts.add(dept);
        });
        const keep = Array.from(filterSelect.options).filter(o => o.value === '');
        filterSelect.innerHTML = '';
        keep.forEach(opt => filterSelect.appendChild(opt));
        Array.from(depts).sort((a,b)=>a.localeCompare(b,'ar')).forEach(dept=>{
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            filterSelect.appendChild(option);
        });
        }


        // âœ… Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©
        function filterManagementRequestsByAll() {
        const deptFilterSelect   = document.getElementById('mgmtRequestsDeptFilter');
        const typeFilterSelect   = document.getElementById('requestsTypeFilter');
        const statusFilterSelect = document.getElementById('requestsStatusFilter');

        const selectedDepts = Array.from(deptFilterSelect?.selectedOptions || []).map(o => o.value).filter(Boolean);
        const selectedType  = typeFilterSelect?.value || '';
        const selectedStatus= statusFilterSelect?.value || '';

        document.querySelectorAll('[data-mgmt-dept]').forEach(card => {
            const cardDept   = card.getAttribute('data-mgmt-dept');
            const cardType   = card.getAttribute('data-mgmt-type') || '';
            const cardStatus = card.getAttribute('data-mgmt-status') || '';
            const okDept   = !selectedDepts.length || selectedDepts.includes(cardDept);
            const okType   = !selectedType || cardType === selectedType;
            const okStatus = !selectedStatus || cardStatus === selectedStatus;
            card.style.display = (okDept && okType && okStatus) ? '' : 'none';
        });
        }


        // âœ… Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
        function filterManagementRequestsByDept() {
            filterManagementRequestsByAll();
        }
        function showRequestsFilterForAdmin() {
        const filterContainer = document.getElementById('advRequestsFilterContainer');
        if (filterContainer) {
            if (advisoryCurrentMode === 'admin') {
            filterContainer.classList.remove('hidden');
            populateDeptFilter();
            } else {
            filterContainer.classList.add('hidden');
            }
        }
        }


        // âœ… Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„ÙÙ„ØªØ±Ù‡
        function populateDeptFilter() {
        const filterSelect = document.getElementById('advRequestsDeptFilter');
        if (!filterSelect) return;
        const depts = new Set();
        if (window.__allRequestsData && Array.isArray(window.__allRequestsData)) {
            window.__allRequestsData.forEach(req => { if (req.department) depts.add(req.department); });
        }
        const existing = new Set(Array.from(filterSelect.options).map(o => o.value));
        depts.forEach(dept => {
            if (dept && !existing.has(dept)) {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            filterSelect.appendChild(option);
            }
        });
        }


        // âœ… Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
        function filterRequestsByDept() {
        const filterSelect = document.getElementById('advRequestsDeptFilter');
        const selectedDept = filterSelect ? filterSelect.value : '';
        document.querySelectorAll('[data-req-dept]').forEach(card => {
            const cardDept = card.getAttribute('data-req-dept');
            card.style.display = (!selectedDept || cardDept === selectedDept) ? '' : 'none';
        });
        }




        function hasOrgViewNoRatings() { // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'trainers_deputy';
        }

        // âœ… 4) Ù…Ù† ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª")
        function hasDeptScopedAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'dept_head';
        }

        async function login() {
        const userId = (document.getElementById('userId')?.value || '').trim();

        if (!userId) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
            return;
        }

        try {
            // ÙŠÙØªØ±Ø¶ Ø£Ù† checkUserPermission ØªØ³ØªØ¯Ø¹ÙŠ Apps Script ÙˆØªØ¹ÙŠØ¯ {type, name, role?, department?...}
            const userData = await checkUserPermission(userId);

            if (!userData || userData.success === false) {
            showError(userData?.message || 'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
            return;
            }

            // Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© (Ø¨Ø¯ÙˆÙ† success):
            const payload = userData.data ? userData.data : userData;

            // Ø·ÙØ¨Ù‘ÙØ¹ Ø§Ù„Ø¯ÙˆØ± (Ø¥Ù† ÙˆÙØ¬Ø¯)
            const role = normalizeRole(payload.role || '');

            // Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ù‘Ø¯ ÙˆÙ…ØªÙˆÙÙ‘Ø± Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§
            currentUser = {
            id: userId,
            data: { ...payload, role }
            };
            window.currentUser = currentUser;

            // ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
            if (payload.type === 'trainee') {
            showTraineeInterface();
            return;
            }

            if (payload.type === 'staff') {
            switch (role) {
                case 'advisory_unit':
                advisoryCurrentMode = 'basic';  // ğŸ‘ˆ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                showAdvisoryInterface();
                return;

                case 'advisor':
                showAdvisorInterface();
                return;
                // Ø¯Ø§Ø®Ù„ switch(role) ÙÙŠ login()
                case 'elearning':
                showManagementInterface();
                return;

                // Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:
                case 'dept_head':        // Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ÙŠØ±Ù‰ Ù‚Ø³Ù…Ù‡ ÙÙ‚Ø·
                case 'trainees_vice':    // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†: ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… + ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                case 'trainers_deputy':  // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†: ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¯ÙˆÙ† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                case 'dean':
                case 'quality_vice':
                showManagementInterface();
                return;

                default:
                showError('ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©');
                return;
            }
            }

            // Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Trainee Ø£Ùˆ Staff
            showError('Ù†ÙˆØ¹ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
        } catch (err) {
            showError(err?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }
        }
          document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('userId');
                if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                    }
                });
                }
            });
        // ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù‚Ø¯ÙŠÙ…Ø© (camelCase) Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯ (snake_case)
            // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©/Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„
            function normalizeRole(role=''){
            let v = String(role || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g,'_');

            // ØªØ·Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const map = {
                // Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù‚Ø¯ÙŠÙ…/Ù…ØªÙ†ÙˆØ¹
                'depthead':'dept_head',
                'dept_head':'dept_head',
                'qualityvice':'quality_vice',
                'quality_vice':'quality_vice',
                'advisoryunit':'advisory_unit',
                'advisory_unit':'advisory_unit',
                'dean':'dean',
                'elearning':'elearning',
                'advisor':'advisor',
                'trainees_deputy':'trainees_vice',
                'trainees_vice':'trainees_vice',
                'trainers_deputy':'trainers_deputy',

                // Ø¹Ø±Ø¨ÙŠ
                'Ø§Ù„Ø¹Ù…ÙŠØ¯':'dean',
                'ÙˆÙƒÙŠÙ„_Ø¶Ø¨Ø·_Ø§Ù„Ø¬ÙˆØ¯Ø©':'quality_vice',
                'ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†':'trainees_vice',
                'ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†':'trainers_deputy',
                'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©':'advisory_unit',
                'ÙˆØ­Ø¯Ø©_Ø§Ù„Ø®Ø¯Ù…Ø§Øª_Ø§Ù„Ø§Ø±Ø´Ø§Ø¯ÙŠØ©':'advisory_unit',
                'Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù…':'dept_head',
                'Ø§Ù„ØªØ¯Ø±ÙŠØ¨_Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ':'elearning',
                'Ø§Ù„ØªØ¯Ø±ÙŠØ¨_Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ':'elearning',
                'Ø§Ù„Ù…Ø±Ø´Ø¯':'advisor',
                'Ø§Ù„Ù…Ø±Ø´Ø¯_Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ':'advisor',
                'Ù…ØªØ¯Ø±Ø¨':'trainee'
            };

            // ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            v = v
                .replace(/^depthead$/,'dept_head')
                .replace(/^qualityvice$/,'quality_vice')
                .replace(/^advisoryunit$/,'advisory_unit')
                .replace(/^dean$/,'dean')
                .replace(/^trainees_deputy$/,'trainees_vice');

            return map[v] || v;
            }

                const ROLE_LABELS = {
                dean: 'Ø§Ù„Ø¹Ù…ÙŠØ¯',
                quality_vice: 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
                trainees_vice: 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
                trainers_deputy: 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†',
                advisory_unit: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©',
                dept_head: 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
                advisor: 'Ø§Ù„Ù…Ø±Ø´Ø¯/Ø§Ù„Ù…Ø¯Ø±Ø¨',
                elearning: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
                };

            function labelOf(v) {
            const key = normalizeRole(v);
            return ROLE_LABELS[key] || v;
            }


        function logout() {
        currentUser = null;
        window.currentUser = null; // ğŸ‘ˆ Ù…Ù‡Ù… Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        currentTraineeData = null;
        closeRatingModal?.();
        closeSolutionModal?.();
        document.getElementById('userId').value = '';
        hideAllInterfaces();
        document.getElementById('loginScreen').classList.remove('hidden');
        }


        function hideAllInterfaces() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('advisoryInterface').classList.add('hidden');
            document.getElementById('advisorInterface').classList.add('hidden');
            document.getElementById('managementInterface').classList.add('hidden');
            document.getElementById('traineeInterface').classList.add('hidden');
        }

        async function showAdvisoryInterface() {
        hideAllInterfaces();
        document.getElementById('advisoryInterface').classList.remove('hidden');
        document.getElementById('welcomeMessage').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;

        // ğŸ‘‡ Ø£Ø¸Ù‡Ø± ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
        const advRatingsBtn = document.getElementById('advisoryTabRatings');
        if (advRatingsBtn) advRatingsBtn.classList.remove('hidden');

        // âœ… Ø£Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
        const modeToggle = document.getElementById('advisoryModeToggle');
        if (modeToggle && normalizeRole((currentUser?.data?.role || '').trim()) === 'advisory_unit') {
            modeToggle.classList.remove('hidden');
            const toggleText = document.getElementById('advisoryModeToggleText');
            if (toggleText) {
                toggleText.textContent = advisoryCurrentMode === 'admin' ? 'ğŸ”’ ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ' : 'ğŸ”“ ÙˆØ¶Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ';
            }
        } else if (modeToggle) {
            modeToggle.classList.add('hidden');
        }

        // âœ… Ø£Ø¸Ù‡Ø± Ø§Ù„ÙÙ„ØªØ±Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        showRequestsFilterForAdmin();

        await loadStatistics();
        }


        async function showAdvisorInterface() {
            hideAllInterfaces();
            document.getElementById('advisorInterface').classList.remove('hidden');
            document.getElementById('advisorWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;
            await loadAdvisorTicketsView();
        }


        // âœ… 5) Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        async function showManagementInterface() {
        hideAllInterfaces();
        document.getElementById('managementInterface').classList.remove('hidden');

        const role = normalizeRole(currentUser.data.role);
        const title =
            role === 'dean' ? 'Ø§Ù„Ø¹Ù…ÙŠØ¯' :
            role === 'quality_vice' ? 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©' :
            role === 'trainees_vice' ? 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†' :
            role === 'trainers_deputy' ? 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†' :
            role === 'advisory_unit' ? 'ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© - ÙˆØ¶Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ' :
            role === 'elearning'       ? 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' :
            role === 'dept_head' ? 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…' : 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';

        document.getElementById('managementTitle').textContent = title;
        document.getElementById('managementWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;

        // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        const backBtn = document.getElementById('backToBasicMode');
        if (backBtn) {
            if (role === 'advisory_unit' && advisoryCurrentMode === 'admin') {
            backBtn.classList.remove('hidden');
            } else {
            backBtn.classList.add('hidden');
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù…Ù† ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„ÙŠØ§
        const deptBoardBtn = document.getElementById('tabDeptBoard');
        if (deptBoardBtn) {
            if (hasFullAccess()) deptBoardBtn.classList.remove('hidden');
            else deptBoardBtn.classList.add('hidden');
        }

        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ù…Ø¹ ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ù„Ø©)
        const ratingsTabBtn = document.getElementById('tabRatings');
        if (ratingsTabBtn) ratingsTabBtn.classList.remove('hidden');

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        await loadManagementTicketsView();

        // âœ… Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ø£Ø¸Ù‡Ø± ÙˆØ§Ù…Ù„Ø£ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù…Ù† ÙŠÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        populateManagementDeptFilter();
        showManagementRequestsFilter();
        }


        async function loadManagementRatingsView(listId = 'ratingsList') {
        const box = document.getElementById(listId);
        if (!box) return;
        box.innerHTML = '<p style="text-align:center;color:#999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>';

        let tickets = await loadAllTickets();
        tickets = Array.isArray(tickets) ? tickets : [];

        const role = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myId = currentUser?.id || '';

        // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        let filtered = tickets.filter(t => String(t.status) === 'completed' && Number(t.rating) > 0);

        if (hasFullAccess()) {
            // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§: ØªØ´ÙˆÙ ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            // (Ù„Ø§ ØªØºÙŠÙŠØ± - ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª)
        } else if (role === 'trainers_deputy') {
            // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†: ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙ‚Ø·
            filtered = filtered.filter(t => {
                const transferredTo = (t.transferredTo || '').trim();
                const toRole = normalizeRole(transferredTo);
                const dept = (t.department || '').trim();
                
                // ÙŠØ±Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                if (toRole === 'elearning' || dept === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
                    return true;
                }
                
                // ÙŠØ±Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                if (dept && dept !== 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
                    return true;
                }
                
                return false;
            });
        } else if (role === 'dept_head' && myDept) {
            // âœ… Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù‚Ø³Ù…Ù‡ + Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ "Ø·Ù„Ø¨Ø§ØªÙŠ")
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const dept = (t.department || '').trim();
                const completedBy = (t.completedBy || '').trim();
                const createdBy = (t.createdBy || '').trim();
                const assignedTo = (t.assignedTo || '').trim();
                const transferredToName = (t.transferredTo || '').trim();
                
                // ÙŠØ±Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù‚Ø³Ù…Ù‡ Ø£Ùˆ Ù…Ø§ ÙŠØ®ØµÙ‡ Ø´Ø®ØµÙŠÙ‹Ø§
                return dept === myDept ||
                       completedBy === myName ||
                       createdBy === myName ||
                       assignedTo === myName ||
                       transferredToName === myName;
            });
        } else if (role === 'advisor') {
            // âœ… Ø§Ù„Ù…Ø±Ø´Ø¯: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ "Ø·Ù„Ø¨Ø§ØªÙŠ")
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy = (t.createdBy || '').trim();
                const assignedTo = (t.assignedTo || '').trim();
                const transferredToName = (t.transferredTo || '').trim();
                
                return (
                    completedBy === myName ||
                    createdBy === myName ||
                    assignedTo === myName ||
                    transferredToName === myName
                );
            });
        } else if (role === 'elearning') {
            // Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‡
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const transferredTo = (t.transferredTo || '').trim();
                const toRole = normalizeRole(transferredTo);
                return toRole === 'elearning' || transferredTo === myName;
            });
        } else {
            // âœ… Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙˆÙ†: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ù… (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ "Ø·Ù„Ø¨Ø§ØªÙŠ")
            const myName = (currentUser?.data?.name || '').trim();
            const myType = (currentUser?.data?.type || '').trim();
            
            if (myType === 'staff') {
                // Ù…ÙˆØ¸Ù Ø¹Ø§Ø¯ÙŠ: ÙŠØ±Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø£Ùˆ Ø£ÙƒÙ…Ù„Ù‡Ø§ Ø£Ùˆ Ù…ÙØ³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙ‡ Ø£Ùˆ Ù…Ø­ÙˆÙ‘Ù„Ø© Ø¥Ù„ÙŠÙ‡
                filtered = filtered.filter(t => {
                    const completedBy = (t.completedBy || '').trim();
                    const createdBy = (t.createdBy || '').trim();
                    const assignedTo = (t.assignedTo || '').trim();
                    const transferredToName = (t.transferredTo || '').trim();
                    
                    return (
                        completedBy === myName ||
                        createdBy === myName ||
                        assignedTo === myName ||
                        transferredToName === myName
                    );
                });
            } else if (myType === 'trainee') {
                // Ù…ØªØ¯Ø±Ø¨: ÙŠØ±Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø·Ù„Ø¨Ø§ØªÙ‡ ÙÙ‚Ø·
                filtered = filtered.filter(t => (t.traineeId || '').trim() === myId);
            } else {
                // Ø­Ø§Ù„Ø© Ø£Ø®Ø±Ù‰: ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø§ Ø£Ù†Ø´Ø£Ù‡ Ø£Ùˆ Ø£ÙƒÙ…Ù„Ù‡
                filtered = filtered.filter(t => {
                    const completedBy = (t.completedBy || '').trim();
                    const createdBy = (t.createdBy || '').trim();
                    return completedBy === myName || createdBy === myName;
                });
            }
        }

        const rated = filtered;

        if (!rated.length) {
            box.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</p>';
            return;
        }

        // âœ… Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ ÙÙ‚Ø·
        let averageRatingHtml = '';
        if (hasFullAccess()) {
            const validRatings = rated.filter(t => Number(t.rating) > 0);
            if (validRatings.length > 0) {
                const total = validRatings.reduce((sum, t) => sum + (Number(t.rating) || 0), 0);
                const average = (total / validRatings.length).toFixed(1);
                const roundedAvg = Math.round(parseFloat(average));
                const stars = 'â˜…'.repeat(roundedAvg);
                const emptyStars = 'â˜†'.repeat(5 - roundedAvg);
                
                averageRatingHtml = `
                <div style="background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-secondary) 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 99, 65, 0.2);">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        <span style="color: #FFD700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${stars}${emptyStars}</span>
                    </div>
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 4px;">${average}</div>
                    <div style="font-size: 16px; opacity: 0.9; margin-bottom: 4px;">Ù…Ù† 5 Ù†Ø¬ÙˆÙ…</div>
                    <div style="font-size: 14px; opacity: 0.85;">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
                    <div style="font-size: 13px; margin-top: 8px; opacity: 0.8; background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 12px; display: inline-block;">${validRatings.length} ØªÙ‚ÙŠÙŠÙ…</div>
                </div>
                `;
            } else {
                averageRatingHtml = `
                <div style="background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-secondary) 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">â˜†â˜†â˜†â˜†â˜†</div>
                    <div style="font-size: 18px; opacity: 0.9;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>
                </div>
                `;
            }
        }

        const card = (t) => {
            const stars   = Number(t.rating) || 0;
            const comment = (t.ratingComment || '').trim();
            const solution = t.solution || t.executedSolution || t['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°'] || t.solutionText || '-';
            // âœ… Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
            const details = t.requestDetails || t.details || '-';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ticket-status--completed">Ù…ÙƒØªÙ…Ù„Ø©</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span><span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span><span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡:</span><span class="v">${formatArabicDate(t.completionDate || t.date)}</span></div>
                </div>

                <div class="ticket-details">
                <div><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> â˜… ${stars}/5</div>
                ${comment ? `<div style="margin-top:6px;"><strong>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</strong> <em>${comment}</em></div>` : ''}
                ${details && details !== '-' ? `<div style="margin-top:6px;"><strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong> ${details}</div>` : ''}
                <div style="margin-top:6px;"><strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${solution}</div>
                ${t.completedBy ? `<div style="margin-top:6px;">ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>${t.completedBy}</strong></div>` : ''}
                </div>
            </div>
            `;
        };

        try { rated.sort((a,b) => new Date(b.completionDate || b.date || 0) - new Date(a.completionDate || a.date || 0)); } catch(_){}

        box.innerHTML = averageRatingHtml + rated.map(card).join('');
        }

        async function showTraineeInterface() {
            hideAllInterfaces();
            document.getElementById('traineeInterface').classList.remove('hidden');
            document.getElementById('traineeWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.data.name}`;
            await loadTraineeTicketsView();
        }


        async function loadTraineeData() {
            const traineeId = document.getElementById('traineeId').value.trim();
            
            if (!traineeId) {
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ');
                return;
            }

            const trainee = await getTraineeById(traineeId);
            
            if (trainee) {
                currentTraineeData = trainee;
                
                document.getElementById('traineeName').textContent = trainee.name;
                document.getElementById('traineeIdDisplay').textContent = traineeId;
                document.getElementById('traineeDept').textContent = trainee.department;
                document.getElementById('traineeSpec').textContent = trainee.specialization;
                document.getElementById('traineeAdvisor').textContent = trainee.advisor;
                
                const now = new Date();
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA');
                document.getElementById('currentDay').textContent = days[now.getDay()];
                
                document.getElementById('traineeInfo').classList.remove('hidden');
            } else {
                showError('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            }
        }

        function handleServiceTypeChange() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked');
            const otherDiv = document.getElementById('otherServiceDiv');
            
            if (serviceType && serviceType.value === 'Ø£Ø®Ø±Ù‰') {
                otherDiv.classList.remove('hidden');
            } else {
                otherDiv.classList.add('hidden');
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        document.addEventListener('DOMContentLoaded', function() {
            const serviceButtons = document.querySelectorAll('input[name="serviceType"]');
            serviceButtons.forEach(btn => {
                btn.addEventListener('change', handleServiceTypeChange);
            });
        });

        function showTransferOptions() {
            document.getElementById('transferOptions').classList.remove('hidden');
        }

        async function completeTicket() {
        if (!currentTraineeData) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();

        if (!serviceTypeRadio || !details) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
            return;
        }

        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ = Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°
        const solutionText = details;

        const now  = new Date();
        const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];

        const serviceType = serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰' && !serviceType) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©');
            return;
        }

        // 1) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù…Ù‡Ø§ (ØªØ¨Ù‚Ù‰ pending Ø§Ù„Ø¢Ù†)
        const payload = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            createdBy:      currentUser.data.name
        };

        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        const createRes = await saveNewTicket(payload);

        if (!createRes?.success || !createRes.ticketNumber) {
            hideLoading();
            showError('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©');
            return;
        }

        const ticketNumber = createRes.ticketNumber;

        // 2) Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙÙˆØ±Ù‹Ø§ â€” Ù‡Ø°Ø§ Ù…Ø§ ÙŠÙƒØªØ¨ "Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°" ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© + Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        const completionDate = now.toLocaleDateString('ar-SA');

        const ok = await completeTicketRequest(ticketNumber, solutionText, currentUser.data.name, completionDate);
        hideLoading();

        if (ok) {
            resetTicketForm();
            showSuccess('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ "Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°" Ø¨Ù†Ø¬Ø§Ø­');
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø§Øª Ø¥Ù† Ù„Ø²Ù…
            if (typeof loadStatistics === 'function') loadStatistics();
            if (typeof loadMyRequests === 'function') loadMyRequests('requestsList');
        } else {
            showError('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©ØŒ Ù„ÙƒÙ† ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§. Ø¬Ø±Ù‘Ø¨ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±.');
        }
        }

        async function transferTicketAction() {
        if (!currentTraineeData) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();
        const transferRadio = document.querySelector('input[name="transferTo"]:checked');

        if (!serviceTypeRadio || !details || !transferRadio) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            return;
        }

        let transferTo = normalizeRole(transferRadio.value);

        const serviceType = serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'Ø£Ø®Ø±Ù‰' && !serviceType) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©');
            return;
        }

        const now = new Date();
        const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];

        const ticketData = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            transferredTo:  transferTo,
            createdBy:      currentUser.data.name
        };

        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        const result = await saveNewTicket(ticketData);
        hideLoading();
        
        if (result.success) resetTicketForm();
        }


        async function saveNewTicket(payload) {
        const res = await sendRequest('createTicket', payload);

        if (res && res.success) {
            const tn = res?.data?.ticketNumber ?? res?.ticketNumber ?? 'â€”';
            showSuccess(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: ${tn}`);
            return { success: true, ticketNumber: tn };
        } else {
            showError(res?.message || 'ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©');
            return { success: false };
        }
        }

        function resetTicketForm() {
            document.getElementById('traineeId').value = '';
            document.querySelectorAll('input[name="serviceType"]').forEach(btn => btn.checked = false);
            document.getElementById('requestDetails').value = '';
            document.getElementById('otherService').value = '';
            document.getElementById('traineeInfo').classList.add('hidden');
            document.getElementById('transferOptions').classList.add('hidden');
            document.getElementById('otherServiceDiv').classList.add('hidden');
            currentTraineeData = null;
        }

        async function loadStatistics() {
        const stats = await calculateStatistics();
        const ids = ['totalTickets','completedTickets','pendingTickets','inProgressTickets'];
        const vals = [stats.total||0, stats.completed||0, stats.pending||0, stats.inProgress||0];
        ids.forEach((id,i)=>{
            const el = document.getElementById(id);
            if (el) el.textContent = vals[i];
        });
        }


        // âœ… Ø¬Ø¯ÙŠØ¯: ÙŠØ¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± â€œØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©/Ø¥Ù†Ù‡Ø§Ø¡/ØªØ­ÙˆÙŠÙ„â€ ÙˆÙŠØ³ØªØ®Ø¯Ù… ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø«

// ========== Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ø¹Ø±Ø¶ ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ ==========
// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ø±Ø¶ Ø¨ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù…Ø¹ Ø¹Ø¨Ø§Ø±Ø© "Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰"

async function loadAdvisorTicketsView() {
    const containerId = 'advisorTicketsList';
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '<p style="text-align:center;color:#999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>';

    // 1) Ø§Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±
    let allTickets = await loadAllTickets();
    allTickets = Array.isArray(allTickets) ? allTickets : [];

    const myName = (currentUser?.data?.name || '').trim();
    const myRole = normalizeRole((currentUser?.data?.role || '').trim());

    // 2) ÙÙ„ØªØ±Ø© Ø°ÙƒÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ "Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„Ø© Ù…Ù†Ù‘ÙŠ" Ø¸Ø§Ù‡Ø±Ø©
    const tickets = allTickets.filter(t => {
        const st = String(t.status || '').trim().toLowerCase();
        if (st === 'completed') return false; // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù‡Ù†Ø§

        const assignedTo     = (t.assignedTo     || '').trim();
        const createdBy      = (t.createdBy      || '').trim();
        const transferredTo  = (t.transferredTo  || '').trim();
        const transferredBy  = (t.transferredBy  || '').trim();

        // ØªØ°Ø§ÙƒØ± "Ù„ÙŠ" ØµØ±Ø§Ø­Ø©
        const forMe =
            normalizeRole(transferredTo) === 'advisor' ||   // Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø±Ø´Ø¯
            transferredTo === myName ||                     // Ø£Ùˆ Ù…Ø­ÙˆÙ‘Ù„Ø© Ø¨Ø§Ø³Ù…ÙŠ
            assignedTo === myName;                          // Ø£Ùˆ Ù…ÙØ³Ù†ÙØ¯Ø© Ø¨Ø§Ø³Ù…ÙŠ

        // ØªØ°Ø§ÙƒØ± "Ø­ÙˆÙ‘Ù„ØªÙ‡Ø§ Ø£Ù†Ø§" Ø¥Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø© Ø£Ø®Ø±Ù‰
        const fromMe =
            transferredBy === myName &&
            normalizeRole(transferredTo) !== 'advisor' &&
            transferredTo !== myName;

        // ØªØ°Ø§ÙƒØ± Ø£Ù†Ø´Ø£ØªÙ‡Ø§ Ø£Ù†Ø§ ÙˆÙ„Ù… Ø£Ø­ÙˆÙ„Ù‡Ø§ (Ø¨Ø¹Ø¯)
        const createdByMe = createdBy === myName && !transferredTo;

        return forMe || fromMe || createdByMe;
    });

    // 3) Ø¹Ø±Ø¶ Ø§Ù„ØªØ°Ø§ÙƒØ±
    if (!tickets.length) {
        container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
        return;
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ø§Ø±Ø§Øª
    const clsOf = (st) =>
        st === 'completed'   ? 'ticket-status--completed' :
        st === 'in_progress' ? 'ticket-status--inprogress' : 'ticket-status--pending';

    const txtOf = (st) =>
        st === 'completed'   ? 'Ù…ÙƒØªÙ…Ù„Ø©' :
        st === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'Ù…Ø¹Ù„Ù‚Ø©';

    container.innerHTML = tickets.map(t => {
        const details = t.requestDetails || t.details || '-';
        const stCls = clsOf(String(t.status||'').trim().toLowerCase());
        const stTxt = txtOf(String(t.status||'').trim().toLowerCase());
        const transferredBy  = (t.transferredBy  || '').trim();
        const transferredTo  = (t.transferredTo  || '').trim();
        const toNorm = normalizeRole(transferredTo);
        
        // âœ… Ù‡Ù„ Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø§Ù„Ù…Ø±Ø´Ø¯ØŸ
        const isTransferredByMe =
            transferredBy === myName &&
            toNorm !== 'advisor' &&           // Ø¬Ù‡Ø© ØºÙŠØ± "Ø§Ù„Ù…Ø±Ø´Ø¯"
            transferredTo !== myName;         // Ù„ÙŠØ³Øª Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„Ø§Ø³Ù…ÙŠ

        // ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ù‡Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const roleTranslation = {
            'advisor': 'Ø§Ù„Ù…Ø±Ø´Ø¯',
            'dept_head': 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
            'elearning': 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
            'trainees_vice': 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
            'quality_vice': 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
            'dean': 'Ø§Ù„Ø¹Ù…ÙŠØ¯'
        };

        let transferDestination = '';
        if (isTransferredByMe) {
            const toRoleNorm = normalizeRole(transferredTo);
            transferDestination = roleTranslation[toRoleNorm] || transferredTo || 'Ø¬Ù‡Ø© Ø£Ø®Ø±Ù‰';
            if (toRoleNorm === 'dept_head' && t.department) {
                transferDestination = `Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… (${t.department})`;
            }
        }

        return `
        <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
            <div class="ticket-head">
            ${isTransferredByMe ? '<span class="transferred-badge">â†—ï¸ Ù…Ø­ÙˆÙ‘Ù„Ø©</span>' : ''}
            <span class="ticket-status-badge ${stCls}">${stTxt}</span>
            <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
            </div>

            <div class="ticket-sep"></div>

            <div class="ticket-grid">
            <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${t.department || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${formatArabicDate(t.date)}</span></div>

            ${(() => {
                let statusDisplay = 'ğŸ“‹ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡';
                if (isTransferredByMe) {
                    // âœ… Ø¹Ø±Ø¶ ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹: "Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰"
                    statusDisplay = `ğŸ“¤ <strong style="color:#FF9800; font-size:16px;">Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰:</strong> <strong style="color:var(--tvtc-primary); font-size:17px;">${transferDestination}</strong>`;
                    if (t.transferDate) statusDisplay += ` <span style="color:#6B7280;">â€” Ø¨ØªØ§Ø±ÙŠØ® ${formatArabicDate(t.transferDate, true)}</span>`;
                } else if (String(t.status) === 'in_progress' && t.startedBy) {
                    statusDisplay = `â±ï¸ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù†Ø°: ${t.startDate || 'â€”'} (Ø¨ÙˆØ§Ø³Ø·Ø© ${t.startedBy})`;
                } else if (String(t.status) === 'pending') {
                    statusDisplay = 'ğŸ”” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡';
                }
                return `<div class="ticket-row" style="background:#FFF3E0; padding:12px; border-radius:6px; border-right:4px solid #FF9800;">
                <span class="v" style="width:100%; text-align:right;">${statusDisplay}</span>
                </div>`;
            })()}
            </div>

            ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}

            ${isTransferredByMe ? `
            <div class="transfer-info" style="background:#FFF3E0; border:2px solid #FFE0B2; border-right:4px solid #FF9800; padding:14px;">
                <div style="font-size:17px; margin-bottom:10px; font-weight:700;">
                    <strong style="color:#E65100;">ğŸ“ Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰:</strong> 
                    <strong style="color:var(--tvtc-primary); font-size:19px;">${transferDestination}</strong>
                </div>
                ${t.transferDate ? `<div style="color:#6B7280; font-size:14px; margin-top:6px;"><strong>â° ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„:</strong> ${formatArabicDate(t.transferDate, true)}</div>` : ''}
                ${transferredBy ? `<div style="color:#6B7280; font-size:14px; margin-top:4px;"><strong>ğŸ‘¤ Ø­ÙˆÙ‘Ù„Ù‡Ø§:</strong> ${transferredBy}</div>` : ''}
                <div style="margin-top:12px; font-size:13px; color:#6B7280; padding:10px; background:#FFF8E1; border-radius:6px; border:1px dashed #FFB74D;">
                    âš ï¸ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø­ÙˆÙ‘Ù„Ø© Ø¥Ù„Ù‰ <strong>${transferDestination}</strong> â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="view-details" data-ticket="${t.ticketNumber}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                <button class="btn btn-warning" data-action="cancel-transfer" data-ticket="${t.ticketNumber}">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            </div>
            ` : `
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">ØªÙ… Ø§Ù„Ø­Ù„</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">ØªØ­ÙˆÙŠÙ„</button>
            </div>
            `}
        </div>`;
    }).join('');

    // 4) ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    container.onclick = async (ev) => {
        const btn = ev.target.closest('button[data-action]');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        const ticketNumber = btn.getAttribute('data-ticket');
        if (!ticketNumber) { 
            showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); 
            return; 
        }

        try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                    status: 'in_progress',
                    startedBy: currentUser.data.name,
                    startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadAdvisorTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                openAdvisorTransferModal(ticketNumber);

            } else if (action === 'view-details') {
                showMessage('Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù„ÙˆØ­Ø© "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª".');

            } else if (action === 'cancel-transfer') {
                const go = window.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¥Ù„ÙŠÙƒØŸ');
                if (!go) return;
                const ok = await updateTicketStatus(ticketNumber, {
                    transferredTo: 'advisor',
                    transferredBy: '',
                    transferDate: ''
                });
                if (ok) {
                    showMessage('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„', 'ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                    await loadAdvisorTicketsView();
                }
            }
        } catch (err) {
            showError(err?.message || String(err));
        }
    };
}

        // âœ… 6) ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        async function loadManagementTicketsView() {
        const role   = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myName = (currentUser?.data?.name || '').trim();   // ğŸ‘ˆ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§
        let tickets  = [];

        if (hasFullAccess()) {
            // Ø§Ù„Ø¹Ù…ÙŠØ¯ + ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† + Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© + ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯
            tickets = await loadAllTickets();

        } else if (role === 'elearning') {
            // ÙŠØ´ÙˆÙ ÙÙ‚Ø· Ù…Ø§ Ø­ÙÙˆÙ‘ÙÙ„ Ø¥Ù„Ù‰ "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" Ø£Ùˆ Ø£ÙØ³Ù†ÙØ¯ Ù„Ø§Ø³Ù…Ù‡
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
            const toRole        = normalizeRole((t.transferredTo || '').trim());
            const toName        = (t.transferredTo || '').trim();
            const assigned      = (t.assignedTo || '').trim();
            // 1) Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ø¯ÙˆØ± elearning (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ø¹Ø±Ø¨ÙŠ Ø¨Ø¹Ø¯ normalize)
            const forElearningRole = toRole === 'elearning';
            // 2) Ù…Ø­ÙˆÙ‘Ù„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ùˆ Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØªØ­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±)
            const forMeByName      = toName === myName || assigned === myName;
            return forElearningRole || forMeByName;
            });

        } else if (role === 'trainers_deputy') {
            // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†: ÙŠØ´ÙˆÙ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·)
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
                const dept = (t.department || '').trim();
                // ÙŠØ´ÙˆÙ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                return dept === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' || (dept && dept !== '');
            });

        } else if (role === 'dept_head' && myDept) {
            // Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: Ù‚Ø³Ù…Ù‡ ÙÙ‚Ø·
            const res = await sendRequest('searchTickets', { department: myDept });
            tickets = (res && res.success) ? res.data : [];
        }


        function displayTicketsWithActions(containerId, tickets){
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!Array.isArray(tickets) || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
            return;
        }

        const myRole = normalizeRole(currentUser?.data?.role || '');
        const myName = (currentUser?.data?.name || '').trim();
        
        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass((t.status || '').toLowerCase());
            const txt = statusBadgeText((t.status || '').toLowerCase());
            const details = t.requestDetails || t.details || '-';
            const isCompleted = String(t.status).toLowerCase() === 'completed';
            
            const transferredByRaw = (t.transferredBy || '').trim();
            const transferredToRaw = (t.transferredTo || '').trim();
            const toNorm = normalizeRole(transferredToRaw); // âœ… Ù…Ù‡Ù…

            // âœ… ØµØ­ÙŠØ­: Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ "Ù…Ø­ÙˆÙ‘Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø´Ø¯" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ù‡ØªÙ‡Ø§ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… (Ø¨Ø£ÙŠ Ù„ØºØ©/ØªÙ†Ø³ÙŠÙ‚) Ø£Ùˆ Ù…Ø­ÙˆÙ‘Ù„Ø© Ø¨Ø§Ù„Ø§Ø³Ù…
            const isFromAdvisor =
                !!transferredByRaw && (
                toNorm === 'dept_head' ||
                transferredToRaw === myName
                );

            // ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙˆØ¬Ù‡Ø§Øª Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ toNorm Ø£ÙˆÙ„Ù‹Ø§
            const roleTranslation = {
                'advisor': 'Ø§Ù„Ù…Ø±Ø´Ø¯',
                'dept_head': 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
                'elearning': 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                'trainees_vice': 'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
                'quality_vice': 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
                'dean': 'Ø§Ù„Ø¹Ù…ÙŠØ¯'
            };
            const roleAr = roleTranslation[toNorm] || transferredToRaw || 'Ø¬Ù‡Ø© Ø£Ø®Ø±Ù‰';

            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}" data-mgmt-dept="${t.department || ''}" data-mgmt-type="${t.serviceType || ''}" data-mgmt-status="${t.status || ''}">
                <div class="ticket-head">
                ${isFromAdvisor ? '<span class="transfer-from-badge">â†—ï¸ Ù…Ø­ÙˆÙ‘Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø´Ø¯</span>' : ''}
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${formatArabicDate(t.date)}</span></div>

                ${(() => {
                    let statusDisplay = 'ğŸ“‹ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
                    if (String(t.status).toLowerCase() === 'in_progress' && t.startedBy) {
                    statusDisplay = `â±ï¸ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ø¯Ù‰: <strong>${t.startedBy}</strong>`;
                    } else if (isFromAdvisor && transferredByRaw) {
                    statusDisplay = `ğŸ“¥ Ù…Ø­ÙˆÙ‘Ù„Ø© Ù…Ù†: <strong>${transferredByRaw}</strong>`;
                    } else if (transferredToRaw) {
                    statusDisplay = `ğŸ“¤ Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰: <strong>${roleAr}</strong>`;
                    }
                    return `<div class="ticket-row" style="background:#f0f0f0; padding:8px; border-radius:4px;"><span class="k">Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class="v">${statusDisplay}</span></div>`;
                })()}
                
                ${t.completedBy ? `<div class="ticket-row"><span class="k">Ø£Ù†Ù‡Ø§Ù‡:</span> <span class="v" style="color:#2c9a4f; font-weight:600;">${t.completedBy}</span></div>` : ''}
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}

                ${isCompleted 
                ? `<div style="padding:12px; background:#e8f5e9; border-radius:6px; text-align:center; color:#2c9a4f; font-weight:600; margin-top:12px;">âœ“ Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„</div>` 
                : `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                    <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
                    <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">ØªÙ… Ø§Ù„Ø­Ù„</button>
                    <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">ØªØ­ÙˆÙŠÙ„</button>
                    </div>`
                }
            </div>
            `;
        }).join('');
        }

      /* ===== [FIX] attachManagementActions: Ø§ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¯Ù„ prompt ===== */
      function attachManagementActions(containerId){
        const container = document.getElementById(containerId);
        if (!container) return;

        container.onclick = async (ev) => {
          const btn = ev.target.closest('button[data-action]');
          if (!btn) return;

          const action = btn.getAttribute('data-action');
          const ticketNumber = btn.getAttribute('data-ticket');
          if (!ticketNumber) { showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return; }

          try {
            if (action === 'start') {
              const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser?.data?.name || currentUser?.name || 'Ù…Ø´Ø±Ù',
                startDate: new Date().toLocaleDateString('ar-SA')
              });
              if (ok) await loadManagementTicketsView();

            } else if (action === 'complete') {
              openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
              openAdvisorTransferModal(ticketNumber); // âœ… Ù„Ø§ prompt
            }
          } catch (err) {
            showError(err?.message || String(err));
          }
        };
      }




        const caps = getRoleCapabilities(currentUser.data);
        if (caps.canClose) {
        displayTicketsWithActions('managementTicketsList', tickets);
        attachManagementActions('managementTicketsList'); // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        } else {
        displayTickets('managementTicketsList', tickets); // Ø¹Ø±Ø¶ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
        }   
        }

        async function loadTraineeTicketsView() {
        const tickets = await loadTraineeTickets(currentUser.id);
        __lastTraineeTickets = Array.isArray(tickets) ? tickets : [];
        displayTraineeTickets(__lastTraineeTickets);
        }

        function isTicketRatedLocal(ticketNumber) {
        const t = (__lastTraineeTickets || []).find(x => String(x.ticketNumber) === String(ticketNumber));
        return t && Number(t.rating) > 0;
        }


        // 2) Ø¹Ø¯Ù‘Ù„ loadMyRequests Ù„ØªØ£Ø®Ø° containerId ÙˆØªØ¹Ø±Ø¶ ÙÙŠÙ‡
        // ========== Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯Ø§Ù„Ø© ==========
        async function loadMyRequests(containerId = 'requestsList') {
        try {
            showLoading('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...');
            const tickets = await loadAllTickets();
            hideLoading();

            if (!Array.isArray(tickets) || !tickets.length) {
            displayTickets(containerId, []);
            return;
            }

            const meName = (currentUser?.data?.name || '').trim();
            const meRole = normalizeRole((currentUser?.data?.role || '').trim());
            const meType = (currentUser?.data?.type || '').trim();

            let myTickets = [];

            if (meType === 'staff') {
            if (meRole === 'advisory_unit') {
                // ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯: ØªÙØ¸Ù‡Ø± Ø§Ù„ÙƒÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø¥Ø¯Ø§Ø±ÙŠ (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø³ÙˆÙŠØªØ´ ÙˆØ¶Ø¹)
                // Ø¥Ù† Ø£Ø±Ø¯ØªÙ‡Ø§ Ù…Ù‚ÙŠÙ‘Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
                myTickets = tickets;
            } else {
                // Ø§Ù„Ù…Ø±Ø´Ø¯/Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙˆÙ†:
                myTickets = tickets.filter((t) => {
                const st                 = String(t.status || '').trim().toLowerCase();
                const createdBy          = (t.createdBy || '').trim();
                const completedBy        = (t.completedBy || '').trim();
                const assignedTo         = (t.assignedTo || '').trim();
                const transferredToName  = (t.transferredTo || '').trim();
                const transferredByName  = (t.transferredBy || '').trim();

                // ğŸ‘ˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø«Ø¨Ù‘Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø§Ù„Ù…Ø±Ø´Ø¯ "Ù…Ù†Ù‘ÙŠ"
                // Ø¨Ø´Ø±Ø· Ø£Ù„Ø§ ØªÙƒÙˆÙ† Ù…ÙÙƒØªÙ…Ù„Ø© â€” Ù…ØªÙ‰ Ø§ÙƒØªÙ…Ù„ØªØŒ Ù†ØªØ±ÙƒÙ‡Ø§ ØªØ³Ù‚Ø· Ù…Ø§ Ù„Ù… ØªÙƒÙ† ØªØ®ØµÙ‘Ù‡ Ø¨Ø´ÙŠØ¡ Ø¢Ø®Ø±.
                const fromMeAndNotClosed = (transferredByName === meName) && (st !== 'completed');

                // Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙØ¨Ù‚ÙŠ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙÙŠ Â«Ø·Ù„Ø¨Ø§ØªÙŠÂ»
                return (
                    fromMeAndNotClosed ||           // âœ… Ø¬Ø¯ÙŠØ¯Ø©
                    completedBy === meName ||       // Ø£ÙƒÙ…Ù„ØªÙ‡Ø§ Ø£Ù†Ø§
                    createdBy   === meName ||       // Ø£Ù†Ø´Ø£ØªÙ‡Ø§ Ø£Ù†Ø§
                    assignedTo  === meName ||       // Ù…ÙØ³Ù†ÙØ¯Ø© Ù„ÙŠ
                    transferredToName === meName    // Ù…ÙØ­ÙˆÙ‘Ù„Ø© Ù„Ø§Ø³Ù…ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
                );
                });
            }

            } else if (meType === 'trainee') {
            myTickets = tickets.filter((t) =>
                String(t.traineeId).trim() === String(currentUser.id).trim()
            );

            } else {
            // Ø£ÙŠ Ù†ÙˆØ¹ Ø¢Ø®Ø±: Ø§Ø¹Ø±Ø¶ Ù…Ø§ Ø£Ù†Ø´Ø£ØªÙ‡ Ø£Ùˆ Ø£ÙƒÙ…Ù„ØªÙ‡
            myTickets = tickets.filter((t) => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy   = (t.createdBy   || '').trim();
                return completedBy === meName || createdBy === meName;
            });
            }

            // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù† ÙˆÙØ¬Ø¯
            try { myTickets.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)); } catch (_) {}

            // Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¨Ù„ ÙˆØ¯ÙŠ Ù„Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„
            const withLabels = myTickets.map((t) => ({
            ...t,
            transferredToLabel: labelOf(t.transferredTo || '')
            }));

            displayTickets(containerId, withLabels);

        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }
        // ======== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯Ø§Ù„Ø© ==========



        function displayTickets(containerId, tickets) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            // âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°
            const solution = t.solution || t.executedSolution || t['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°'] || t.solutionText || '-';
            const showSolution = String(t.status) === 'completed' && solution !== '-';
            
            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ®ØµØµ:</span> <span class="v">${t.specialization || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="v">${formatArabicDate(t.date)}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong> ${details}</div>` : ''}
                ${showSolution ? `<div class="ticket-details" style="margin-top:8px;">âœ… <strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${solution}</div>` : ''}

                <div class="ticket-foot">
                ${t.completedBy ? `<span>ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>${t.completedBy}</strong></span>` : ''}
                ${t.completedBy && (t.transferredTo || t.assignedTo) ? '<span class="dot"></span>' : ''}
                ${(t.transferredTo || t.transferredToLabel)  ? `<span>Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰: <strong>${t.transferredToLabel || labelOf(t.transferredTo)}</strong></span>`: ''}
                ${t.assignedTo ? `<span class="dot"></span><span>Ù…ÙØ³Ù†ÙØ¯ Ø¥Ù„Ù‰: <strong>${t.assignedTo}</strong></span>` : ''}
                </div>
            </div>
            `;
        }).join('');
        }

        // âœ… CORRECT
        function displayTraineeTickets(tickets) {
        const host = document.getElementById('traineeTicketsList');
        if (!host) return;

        const list = Array.isArray(tickets) ? tickets : [];

        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØªØ°Ø§ÙƒØ±
        const needRating = list.filter(t => String(t.status) === 'completed' && !(Number(t.rating) > 0));
        const rated      = list.filter(t => String(t.status) === 'completed' &&  (Number(t.rating) > 0));

        // Ù…ÙˆÙ„Ø¯ Ø¨Ø·Ø§Ù‚Ø© (Ù…Ø¨Ø³Ù‘Ø· ÙˆÙŠØ³ØªØ®Ø¯Ù… Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø¯ÙŠÙƒ)
        const card = (ticket) => {
            const isRated = Number(ticket.rating) > 0;
            const cls = statusBadgeClass(String(ticket.status).toLowerCase());
            const txt = statusBadgeText(String(ticket.status).toLowerCase());
            const ratingBadge = isRated
            ? `<span class="rating-badge" title="${ticket.rating} â€” ${RATING_LABELS[ticket.rating] || ''}">â˜… ${ticket.rating}/5</span>`
            : '';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || 'â€”'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="v">${formatArabicDate(ticket.date)}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…Ø±Ø´Ø¯:</span><span class="v">${ticket.advisor || '-'}</span></div>
                </div>

                <div class="ticket-foot">
                ${ratingBadge}
                ${isRated && ticket.ratingComment ? `<span class="dot"></span><span>ØªØ¹Ù„ÙŠÙ‚Ùƒ: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(!isRated && String(ticket.status) === 'completed')
                    ? `<span class="dot"></span>
                    <button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</button>`
                    : ''}
                </div>
            </div>
            `;
        };

        

        const needHtml  = needRating.length ? needRating.map(card).join('') :
            `<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…ÙƒØªÙ…Ù„Ø© ØªÙ†ØªØ¸Ø± ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>`;

        const ratedHtml = rated.length ? rated.map(card).join('') :
            `<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ù‚ÙŠÙ‘ÙÙ…Ø©</p>`;

        // Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© (#traineeTicketsList)
        host.innerHTML = `
            <div class="tabs" id="traineeTicketsTabs" style="margin-bottom:16px;">
            <button class="tab active" data-tab="need"  onclick="switchTraineeTicketsTab('need')">
                Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙ‚ÙŠÙŠÙ… <span style="opacity:.8;font-size:12px;">(${needRating.length})</span>
            </button>
            <button class="tab"        data-tab="rated" onclick="switchTraineeTicketsTab('rated')">
                Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ù‚ÙŠÙ‘ÙÙ…Ø© <span style="opacity:.8;font-size:12px;">(${rated.length})</span>
            </button>
            </div>

            <div id="traineeTab-need"  class="tab-content active">${needHtml}</div>
            <div id="traineeTab-rated" class="tab-content">${ratedHtml}</div>
        `;
        }

        // Ø­Ø¯Ù‘Ø« Ù…Ø¨Ø¯Ù‘Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: need / rated
        function switchTraineeTicketsTab(which) {
        const tabsBar = document.getElementById('traineeTicketsTabs');
        if (!tabsBar) return;

        tabsBar.querySelectorAll('.tab').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === which);
        });

        ['need','rated'].forEach(name => {
            const pane = document.getElementById('traineeTab-' + name);
            if (pane) pane.classList.toggle('active', name === which);
        });
        }


        async function loadMyTicketsUI() {
                    if (currentUser?.data?.type === 'trainee') {
        await loadTraineeTicketsView(); // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¯ÙŠØ« ÙÙ‚Ø·
        return;
        }

        try {
            const me = window.currentUser ?? currentUser;   // Ø®Ø° Ø£ÙŠÙ‡Ù…Ø§ Ù…ØªÙˆÙØ±
            if (!me || !me.id) {
            showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ');
            return;
            }

            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ...');
            const res = await sendRequest('getTraineeTickets', { traineeId: me.id });
            hideLoading();

            if (!res || !res.success) {
            showError(res?.message || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§ØªÙƒ');
            return;
            }

            const list = document.getElementById('myTicketsList');
            if (!list) return;
            list.innerHTML = '';

            (res.data || []).forEach((row, i) => {
            const li = document.createElement('li');
            li.className = 'ticket-item';
            li.innerHTML = `
                <div class="ticket-head">
                <span class="ticket-id">#${i + 1}</span>
                <span class="ticket-date">${row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''} (${row['Ø§Ù„ÙŠÙˆÙ…'] || ''})</span>
                </div>
                <div class="ticket-body">
                <div><strong>Ø§Ù„Ù…Ø±Ø´Ø¯:</strong> ${row['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '-'}</div>
                <div><strong>Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${row['Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '-'}</div>
                <div><strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${row['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°'] || row['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨'] || '-'}</div>
                </div>
            `;
            list.appendChild(li);
            });
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // âœ… Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        let __activeTicketNumber = null;

        function openSolutionModal(ticketNumber) {
        __activeTicketNumber = ticketNumber;
        const modal = document.getElementById('solutionModal');
        const textarea = document.getElementById('solutionText');
        if (!modal || !textarea) return;

        textarea.value = ''; // ØªØµÙÙŠØ± ÙƒÙ„ Ù…Ø±Ø©
        modal.classList.remove('hidden');
        textarea.focus();
        }

        function closeSolutionModal() {
        const modal = document.getElementById('solutionModal');
        if (modal) modal.classList.add('hidden');
        __activeTicketNumber = null;
        }


        async function submitSolution() {
        const textarea = document.getElementById('solutionText');
        const solution = (textarea?.value || '').trim();
        const saveButton = document.getElementById('saveSolutionBtn') || event?.target;

        if (!__activeTicketNumber) {
            showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
            return;
        }
        if (!solution) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°');
            textarea?.focus();
            return;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        let originalText = '';
        if (saveButton) {
            originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span style="display:inline-block;animation:spin 1s linear infinite">â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        }

        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©...');

        try {
            // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯ÙˆÙ…
            const ok = await completeTicketRequest(__activeTicketNumber, solution, currentUser.data.name);

            hideLoading();

            if (ok) {
                // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ±ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„)
                const card = document.querySelector(`.ticket-card[data-ticket="${__activeTicketNumber}"]`);
                if (card) card.remove();

                closeSolutionModal();

                // ØªØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ "Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„ÙŠ" (Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©) + ØªØ­Ø¯Ù‘Ø« "Ø·Ù„Ø¨Ø§ØªÙŠ"
                if (typeof loadAdvisorTicketsView === 'function') {
                await loadAdvisorTicketsView();
                }
                if (typeof loadMyRequests === 'function') {
                await loadMyRequests();
                }

                showSuccess('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        } finally {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
            if (saveButton && originalText) {
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }
        }
        }


        // âœ… Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ESC ÙˆØ§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø±Ø¨Ø¹
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeSolutionModal();
        });
        const _sm = document.getElementById('solutionModal');
        if (_sm) {
        _sm.addEventListener('click', (ev) => {
            if (ev.target.id === 'solutionModal') closeSolutionModal();
        });
        } else {
        // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØªØ­Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª: Ø§Ù†ØªØ¸Ø± DOM Ø¬Ø§Ù‡Ø²
        document.addEventListener('DOMContentLoaded', () => {
            const sm2 = document.getElementById('solutionModal');
            if (sm2) {
            sm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'solutionModal') closeSolutionModal();
            });
            }
        });
        }

      // âœ… Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
      function openAdminReports() {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
          const user = currentUser?.data || currentUser;
          if (!user) {
              showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
              return;
          }

          const role = normalizeRole(user.role);
          
          // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙˆØµÙˆÙ„
          const allowedRoles = [
              'management', 'admin', 'quality_admin', 
              'quality_vice', 'dean', 'trainees_vice'
          ];

          if (!allowedRoles.includes(role)) {
              showError('â›”ï¸ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù‚ØµÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ ÙÙ‚Ø·');
              return;
          }

          // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
          window.open('reports_admin.html', '_blank', 'width=1200,height=700,scrollbars=yes');
      }

        // ===== ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¥Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Ù…ÙˆØ­Ù‘Ø¯Ø© =====
      function normalizeRoleId(rawRole) {
        if (!rawRole) return '';
        const r = String(rawRole).trim().toLowerCase().replace(/\s+/g, '_');

        // Ø®Ø±Ø§Ø¦Ø· Ù…Ø±Ø§Ø¯ÙØ§Øª Ø¹Ø±Ø¨ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„ÙƒÙ„ Ø¯ÙˆØ±
        const MAP = {
          // Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
          dept_head: new Set([
            'dept_head','department_head','head_of_department','hod',
            'Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù…','Ø±Ø¦ÙŠØ³-Ø§Ù„Ù‚Ø³Ù…','Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…','Ø±Ø¦ÙŠØ³/Ø§Ù„Ù‚Ø³Ù…','Ø±Ø¦ÙŠØ³Ø§Ù„Ù‚Ø³Ù…'
          ]),
          // Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
          advisor: new Set([
            'advisor','training_advisor','student_counselor',
            'Ø§Ù„Ù…Ø±Ø´Ø¯','Ø§Ù„Ù…Ø±Ø´Ø¯_Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ','Ù…Ø±Ø´Ø¯_ØªØ¯Ø±ÙŠØ¨ÙŠ','Ù…Ø±Ø´Ø¯ ØªØ¯Ø±ÙŠØ¨ÙŠ'
          ]),
          // Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          elearning: new Set([
            'elearning','e_learning','e-learning','Ù…Ø¯ÙŠØ±_Ø§Ù„ØªØ¯Ø±ÙŠØ¨_Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'
          ]),
          // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
          trainees_vice: new Set([
            'trainees_vice','vice_dean_trainees','ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†','ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†'
          ]),
          // ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          trainers_vice: new Set([
            'trainers_vice','vice_dean_trainers','ÙˆÙƒÙŠÙ„_Ø´Ø¤ÙˆÙ†_Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†','ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†'
          ]),
          // ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©
          quality_vice: new Set([
            'quality_vice','vice_dean_quality','ÙˆÙƒÙŠÙ„_Ø¶Ø¨Ø·_Ø§Ù„Ø¬ÙˆØ¯Ø©','ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©'
          ]),
          // Ø§Ù„Ø¹Ù…ÙŠØ¯
          dean: new Set([
            'dean','Ø§Ù„Ø¹Ù…ÙŠØ¯'
          ])
        };

        for (const [key, variants] of Object.entries(MAP)) {
          if (variants.has(r)) return key;
        }
        // Ù„Ùˆ Ù…Ø§ ØªØ·Ø§Ø¨Ù‚ Ø´ÙŠØ¡ Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ ØªØ¨Ø³ÙŠØ·Ù‡ â€” Ù…Ø¹Ù†Ø§Ù‡ Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ù„ÙƒÙ† Ø³Ù†Ø¹Ø±Ø¶Ù‡ ÙƒØ®ÙŠØ§Ø± Ø¹Ø§Ù…
        return r;
      }

        // ============================================
        // âœ… Ø¯ÙˆØ§Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø±Ø´Ø¯
        // ============================================

        // ===== [FIX] ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
        /* ===== [FIX] openAdvisorTransferModal: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ ===== */
        let __advisorTransferTicketNumber = null;

        function openAdvisorTransferModal(ticketNumber) {
          __advisorTransferTicketNumber = ticketNumber;

          // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙƒÙ„ Ø¯ÙˆØ±
          const LABELS = {
            advisor:        'Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ',
            dept_head:      'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…',
            elearning:      'Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
            trainees_vice:  'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
            trainers_vice:  'ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†',   // âœ… Ù…Ø¶Ø§Ù
            quality_vice:   'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
            dean:           'Ø§Ù„Ø¹Ù…ÙŠØ¯'
          };

          // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          let base = [
            'dept_head',
            'elearning',
            'trainees_vice',
            'trainers_vice', // âœ… Ù…Ø¶Ø§Ù
            'quality_vice',
            'dean',
            'advisor'
          ];

          const myRole = (currentUser?.role || currentUser?.data?.role || '').trim();

          // Ù„Ø§ ØªØ¸Ù‡Ø± Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø¬Ù‡Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„
          base = base.filter(r => r && r !== myRole);

          // ØªØ®ØµÙŠØµ: Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù…ØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…" ÙˆØ£Ø¨Ø±Ø² "Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ"
          if (myRole === 'dept_head') {
            base = base.filter(r => r !== 'dept_head');
            if (!base.includes('advisor')) base.unshift('advisor');
          }

          // Ø­Ù‚Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          const listEl = document.querySelector('#advisorTransferModal .transfer-options, #advisorTransferModal .transfer-targets');
          if (listEl) {
            listEl.innerHTML = base.map(role => {
              const id = `transfer_to_${role}`;
              return `
                <label for="${id}" class="transfer-card">
                  <input type="radio" id="${id}" name="advisorTransferTo" value="${role}">
                  <span>${LABELS[role] || role}</span>
                </label>
              `;
            }).join('');
          } else {
            console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ .transfer-options Ø¯Ø§Ø®Ù„ #advisorTransferModal');
          }

          // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          document.getElementById('advisorTransferModal')?.classList.remove('hidden');
          document.body.classList.add('modal-open');
        }

        function closeAdvisorTransferModal() {
          document.getElementById('advisorTransferModal')?.classList.add('hidden');
          document.body.classList.remove('modal-open');
        }



        async function submitAdvisorTransfer() {
        const selected = document.querySelector('input[name="advisorTransferTo"]:checked');
        
        if (!__advisorTransferTicketNumber) {
            showError('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
            return;
        }
        
        if (!selected) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„');
            return;
        }

        const transferTo = selected.value; // dept_head Ø£Ùˆ elearning
        
        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©...');

        try {
            // âœ… ØªØ«Ø¨ÙŠØª Ù…Ø­Ù„ÙŠ + Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
            const ok = await transferTicket(__advisorTransferTicketNumber, transferTo, currentUser.data.name);
            hideLoading();
            if (ok) {
            // ØªØ·Ø¨ÙŠØ¹ ÙÙˆØ±ÙŠ Ø¹Ù„Ù‰ DOM Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙŠØ¨Ù‚Ù‰ Ø§Ù„ÙƒØ±Øª Ø¸Ø§Ù‡Ø±Ù‹Ø§ ÙƒÙ€ "â†—ï¸ Ù…Ø­ÙˆÙ‘Ù„Ø©"
            try {
                const card = document.querySelector(`.ticket-card[data-ticket="${__advisorTransferTicketNumber}"]`);
                if (card) {
                const badge = card.querySelector('.transferred-badge');
                if (!badge) {
                    const head = card.querySelector('.ticket-head');
                    if (head) head.insertAdjacentHTML('afterbegin', '<span class="transferred-badge">â†—ï¸ Ù…Ø­ÙˆÙ‘Ù„Ø©</span>');
                }
                }
            } catch(_) {}

            closeAdvisorTransferModal();
            await loadAdvisorTicketsView();
            showSuccess('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }

        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ ESC ÙˆØ§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø±Ø¨Ø¹
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeAdvisorTransferModal();
        });
        
        const _atm = document.getElementById('advisorTransferModal');
        if (_atm) {
        _atm.addEventListener('click', (ev) => {
            if (ev.target.id === 'advisorTransferModal') closeAdvisorTransferModal();
        });
        } else {
        document.addEventListener('DOMContentLoaded', () => {
            const atm2 = document.getElementById('advisorTransferModal');
            if (atm2) {
            atm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'advisorTransferModal') closeAdvisorTransferModal();
            });
            }
        });
        }
        // ============================================
// Utility: Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (ØªÙØ§Ø¯ÙŠ undefined)
function showMessage(title = 'Ù…Ø¹Ù„ÙˆÙ…Ø©', text = '') {
  try {
    // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù†Ø¸Ø§Ù… ØªÙˆØ³Øª/Ù…ÙˆØ¯Ø§Ù„ Ù…ÙˆØ­Ø¯ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§
    if (typeof showSuccess === 'function' && !text) return showSuccess(title);
    if (typeof showSuccess === 'function') return showSuccess(`${title} â€” ${text}`);
  } catch(_) {}
  alert(`${title}${text ? ':\n' + text : ''}`);
}


async function switchTab(event, tabName) {
  // 1) ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ .content
  const parentContent = event.target.closest('.content');
  parentContent.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  parentContent.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  // 2) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  if (tabName === 'statistics') {
    loadStatistics();

  } else if (tabName === 'managementAll') {
    // âœ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±
    await loadManagementTicketsView();
    // Ù…Ù„Ø¡ Ø§Ù„ÙÙ„ØªØ± ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡ Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙŠØ§
    populateManagementDeptFilter();
    showManagementRequestsFilter();

  } else if (tabName === 'myRequests') {
    if (currentUser?.data?.type === 'trainee') {
      loadTraineeTickets(currentUser.id).then(list => {
        const holder = document.getElementById('requestsList');
        if (!holder) return;

        window.__allRequestsData = list || [];  // âœ… Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙÙ„ØªØ±Ù‡
        holder.innerHTML = '';
        const cards = (list || []).map(ticket => {
        const rated   = Number(ticket.rating) > 0;
        const details = ticket.requestDetails || ticket.details || '-';

        // âœ… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        const cls = statusBadgeClass(ticket.status);
        const txt = statusBadgeText(ticket.status);

        const ratingBadge = rated
            ? `<span class="rating-badge" title="${ticket.rating} â€” ${RATING_LABELS[ticket.rating] || ''}">â˜… ${ticket.rating}/5</span>`
            : '';

        return `
            <div class="ticket-card modern" data-req-dept="${ticket.department || ''}">
            <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || 'â€”'}</span>
            </div>
            <div class="ticket-sep"></div>
            <div class="ticket-grid">
                <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="v">${formatArabicDate(ticket.date)}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">Ø§Ù„Ù…Ø±Ø´Ø¯:</span><span class="v">${ticket.advisor || '-'}</span></div>
            </div>
            ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}
            <div class="ticket-foot">
                ${ratingBadge}
                ${rated && ticket.ratingComment ? `<span class="dot"></span><span>ØªØ¹Ù„ÙŠÙ‚Ùƒ: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(ticket.status === 'completed' && !rated)
                ? `<span class="dot"></span><button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</button>`
                : ''}
            </div>
            </div>
        `;
        }).join('');


        holder.innerHTML = cards || '<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±</p>';
        // âœ… Ù…Ù„Ø¡ Ø§Ù„ÙÙ„ØªØ±Ù‡ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        populateDeptFilter();
        showRequestsFilterForAdmin();
      });
    } else {
      loadMyRequests('requestsList');
    }

    } else if (tabName === 'managementDeptBoard') {
  await loadDeptBoardView();

  } else if (tabName === 'advisorRequests') {
    loadMyRequests('advisorRequestsList');

  } else if (tabName === 'advisorRatings') {
    // âœ… ØªØ¨ÙˆÙŠØ¨ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
    await loadManagementRatingsView('advisorRatingsList');

  } else if (tabName === 'advisoryRatings') {
    // âœ… ØªØ¨ÙˆÙŠØ¨ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
    await loadManagementRatingsView('advisoryRatingsList');

  } else if (tabName === 'managementRatings') {
    // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø±Ø¤ÙŠØ© ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙ‡Ù… Ø­Ø³Ø¨ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
    await loadManagementRatingsView('ratingsList');
  }
}


// Ø¨Ù†Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„ÙÙ„ØªØ± Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function dbFillDepartmentsOptions(tickets) {
  const sel = document.getElementById('dbDept');
  if (!sel) return;

  const set = new Set();
  tickets.forEach(t => {
    const d = (t.department || '').trim();
    if (d) set.add(d);
  });
  // Ø¥Ø¶Ø§ÙØ© "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" ÙƒØ³Ø·Ø± Ù…Ø³ØªÙ‚Ù„ Ø¥Ù† Ø£Ø±Ø¯Øª Ø¬Ù…Ø¹ Ø®Ø§Øµ
  set.add('Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');

  const arr = Array.from(set).sort((a,b)=> a.localeCompare(b, 'ar'));

  sel.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
}

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function dbReadFilters() {
  const from = tryParseDate(document.getElementById('dbFrom')?.value || '');
  const to   = tryParseDate(document.getElementById('dbTo')?.value || '');
  const deptSel = document.getElementById('dbDept');
  const selectedDepts = Array.from(deptSel?.selectedOptions || []).map(o => o.value);

  const stPending   = document.getElementById('dbStPending')?.checked;
  const stInProg    = document.getElementById('dbStInProgress')?.checked;
  const stCompleted = document.getElementById('dbStCompleted')?.checked;

  const source = (document.getElementById('dbSource')?.value || 'all');

  return {
    from, to,
    depts: selectedDepts,
    allow: {
      pending: !!stPending,
      in_progress: !!stInProg,
      completed: !!stCompleted
    },
    source
  };
}

// Ù‡Ù„ ÙŠÙ†Ø·Ø¨Ù‚ Ø§Ù„Ù…ØµØ¯Ø±ØŸ
function dbMatchSource(t, sourceValue) {
  if (sourceValue === 'all') return true;

  const roleOfTransfer = normalizeRole((t.transferredTo || '').trim());
  const createdBy  = (t.createdBy || '').trim();
  const dept       = (t.department || '').trim();

  if (sourceValue === 'elearning') {
    return roleOfTransfer === 'elearning' || dept === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
  }
  if (sourceValue === 'advisory') {
    // Ù†Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù "ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯" Ù…Ù† createdBy Ø£Ùˆ source field Ø¥Ù† ÙˆÙØ¬Ø¯
    const src = (t.source || '').trim();
    return /Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯/i.test(src) || /Ø¥Ø±Ø´Ø§Ø¯/i.test(createdBy) || /ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©/.test(src);
  }
  if (sourceValue === 'departments') {
    // Ù„ÙŠØ³ Ù…Ù† Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙˆÙ„Ø§ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
    const isEL = (roleOfTransfer === 'elearning' || dept === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
    const isAd = /Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯|Ø¥Ø±Ø´Ø§Ø¯ÙŠ|ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©/.test((t.source||'') + ' ' + createdBy);
    return !isEL && !isAd;
  }
  return true;
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ°Ø§ÙƒØ±
function dbFilterTickets(tickets, filters) {
  return (tickets || []).filter(t => {
    // Ø§Ù„ØªØ§Ø±ÙŠØ®
    const dt = tryParseDate(t.date || t.creationDate || '');
    if (filters.from && dt && dt < filters.from) return false;
    if (filters.to   && dt && dt > filters.to)   return false;

    // Ø§Ù„Ø­Ø§Ù„Ø©
    const st = String(t.status || 'pending');
    if (st === 'pending'     && !filters.allow.pending)     return false;
    if (st === 'in_progress' && !filters.allow.in_progress) return false;
    if (st === 'completed'   && !filters.allow.completed)   return false;

    // Ø§Ù„Ù…ØµØ¯Ø±
    if (!dbMatchSource(t, filters.source)) return false;

    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    const d = (t.department || '').trim();
    if (filters.depts && filters.depts.length && !filters.depts.includes(d) && !(filters.depts.includes('Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') && normalizeRole((t.transferredTo||'').trim())==='elearning')) {
      return false;
    }

    return true;
  });
}

// ØªØ¬Ù…ÙŠØ¹ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…
function dbAggregateByDept(tickets) {
  const map = new Map(); // dept -> { counts..., sums... }

  function ensure(dept) {
    if (!map.has(dept)) {
      map.set(dept, {
        dept,
        newCount: 0,
        inProgress: 0,
        pending: 0,
        completed: 0,
        closeDaysSum: 0,
        closeDaysCount: 0,
        slaOk: 0,
        slaAll: 0,
        advisorySolved: 0,
        alerts: { older7: 0 }
      });
    }
    return map.get(dept);
  }

  tickets.forEach(t => {
    let dept = (t.department || '').trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    // Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ù†Ø¶Ø¹Ù‡Ø§ ØªØ­Øª Ù‚Ø³Ù… "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" Ù„ØªØ¬Ù…ÙŠØ¹ Ø®Ø§Øµ
    const toRole = normalizeRole((t.transferredTo || '').trim());
    if (toRole === 'elearning') dept = 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

    const row = ensure(dept);

    const st = String(t.status || 'pending');
    if (st === 'pending') row.pending++;
    else if (st === 'in_progress') row.inProgress++;
    else if (st === 'completed') row.completed++;

    // "Ø¬Ø¯ÙŠØ¯Ø©" ÙƒØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© = Ù†Ø­ØªØ³Ø¨ ÙƒÙ„ Ù…Ø§ Ù„Ù‡ ØªØ§Ø±ÙŠØ® Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± ÙƒÙ€ newCount
    row.newCount++;

    // SLA & Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    if (st === 'completed') {
      const start = tryParseDate(t.date || t.creationDate || '');
      const end   = tryParseDate(t.completionDate || t.updateDate || t.date || '');
      if (start && end) {
        const d = Math.max(0, daysBetween(start, end));
        row.closeDaysSum += d;
        row.closeDaysCount++;
        row.slaAll++;
        if (d <= SLA_DAYS) row.slaOk++;
      }
    }

    // Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ (Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·)
    const src = (t.source || '').trim();
    const createdBy = (t.createdBy || '').trim();
    const isAdvisory = /Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯|Ø¥Ø±Ø´Ø§Ø¯ÙŠ|ÙˆØ­Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©/.test(src + ' ' + createdBy);
    if (isAdvisory && st === 'completed') row.advisorySolved++;

    // ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù…Ø± > 7 Ø£ÙŠØ§Ù… Ù„Ù„ØªØ°Ø§ÙƒØ± ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    if (st !== 'completed') {
      const start = tryParseDate(t.date || t.creationDate || '');
      if (start) {
        const age = daysBetween(start, new Date());
        if (age > 7) row.alerts.older7++;
      }
    }
  });

  return Array.from(map.values()).sort((a,b) => a.dept.localeCompare(b.dept, 'ar'));
}

// Ø±Ø³Ù… KPIs Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
function dbRenderKpis(containerId, tickets) {
  const box = document.getElementById(containerId);
  if (!box) return;

  const total = tickets.length;
  const completed = tickets.filter(t => String(t.status)==='completed').length;
  const inprog   = tickets.filter(t => String(t.status)==='in_progress').length;
  const pending  = tickets.filter(t => String(t.status)==='pending').length;

  // Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… + SLA
  let sum = 0, cnt = 0, slaAll=0, slaOk=0;
  tickets.forEach(t => {
    if (String(t.status)==='completed') {
      const s = tryParseDate(t.date || t.creationDate || '');
      const e = tryParseDate(t.completionDate || t.updateDate || t.date || '');
      if (s && e) {
        const d = Math.max(0, daysBetween(s, e));
        sum += d; cnt++; slaAll++;
        if (d <= SLA_DAYS) slaOk++;
      }
    }
  });

  const avg = cnt ? (sum/cnt).toFixed(1) : 'â€”';
  const slaPct = slaAll ? Math.round((slaOk/slaAll)*100) + '%' : 'â€”';

  box.innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${total}</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
      <div class="stat-number">${completed}</div>
      <div class="stat-label">Ù…ÙƒØªÙ…Ù„Ø©</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
      <div class="stat-number">${inprog}</div>
      <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
      <div class="stat-number">${pending}</div>
      <div class="stat-label">Ù…Ø¹Ù„Ù‘Ù‚Ø©</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--dark-blue) 0%, #031f31 100%);">
      <div class="stat-number">${avg}</div>
      <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ÙŠÙˆÙ…)</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--success) 0%, #1d6a36 100%);">
      <div class="stat-number">${slaPct}</div>
      <div class="stat-label">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù€ SLA â‰¤ ${SLA_DAYS} Ø£ÙŠØ§Ù…</div>
    </div>
  `;
}

// Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
function dbRenderTable(rows) {
  const tbody = document.getElementById('dbTableBody');
  if (!tbody) return;

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:16px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const rate = (r.newCount ? Math.round((r.completed / r.newCount)*100) : 0) + '%';
    const avg  = r.closeDaysCount ? (r.closeDaysSum / r.closeDaysCount).toFixed(1) : 'â€”';
    const sla  = r.slaAll ? Math.round((r.slaOk / r.slaAll)*100) + '%' : 'â€”';
    const alert = r.alerts.older7 ? `âš ï¸ ${r.alerts.older7} > 7 Ø£ÙŠØ§Ù…` : '-';

    // Ù†Ø¶Ø¹ data-attrs Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø¯Ø±ÙˆØ± Ø¨Ø§Ù„Ù†Ù‚Ø±
    return `
      <tr>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${r.dept}</td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="new">${r.newCount}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="in_progress">${r.inProgress}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="pending">${r.pending}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="completed">${r.completed}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${rate}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${avg}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${sla}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${r.advisorySolved}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${alert}</td>
      </tr>
    `;
  }).join('');
}

// ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ø¯Ø±ÙˆØ±
function openDbDrawer(title, tickets) {
  const host = document.getElementById('dbDrawer');
  const body = document.getElementById('dbDrawerBody');
  const head = document.getElementById('dbDrawerTitle');
  if (!host || !body || !head) return;
  head.textContent = title;

  if (!tickets.length) {
    body.innerHTML = `<p style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…Ø·Ø§Ø¨Ù‚Ø©</p>`;
  } else {
    body.innerHTML = tickets.map(t => {
      const stTxt = statusBadgeText(t.status);
      const stCls = statusBadgeClass(t.status);
      const details = t.requestDetails || t.details || '-';
      return `
        <div class="ticket-card modern">
          <div class="ticket-head">
            <span class="ticket-status-badge ${stCls}">${stTxt}</span>
            <span class="ticket-id-chip" onclick="navigator.clipboard.writeText('${t.ticketNumber||''}')">${t.ticketNumber || 'â€”'}</span>
          </div>
          <div class="ticket-sep"></div>
          <div class="ticket-grid">
            <div class="ticket-row"><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span><span class="v">${t.department || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span class="v">${t.serviceType || '-'}</span></div>
            <div class="ticket-row"><span class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="v">${formatArabicDate(t.date)}</span></div>
            <div class="ticket-row"><span class="k">Ø§Ù„Ù…ÙØ³Ù†ÙØ¯:</span><span class="v">${t.assignedTo || '-'}</span></div>
          </div>
          ${details && details !== '-' ? `<div class="ticket-details">ğŸ“ ${details}</div>` : ''}
        </div>
      `;
    }).join('');
  }

  host.classList.remove('hidden');
}

function closeDbDrawer() {
  const host = document.getElementById('dbDrawer');
  if (host) host.classList.add('hidden');
}

// Ù…ÙØ¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
async function loadDeptBoardView() {
  if (!hasFullAccess()) {
    document.getElementById('managementDeptBoard')?.classList.add('hidden');
    showError?.('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
    return;
  }

  const list = await loadAllTickets();
  const tickets = Array.isArray(list) ? list : [];

  // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ù†Ù…Ù„Ø£ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙÙ„ØªØ±
  dbFillDepartmentsOptions(tickets);

  const filters = dbReadFilters();
  const view = dbFilterTickets(tickets, filters);
  dbRenderKpis('dbKpis', view);

  const rows = dbAggregateByDept(view);
  dbRenderTable(rows);

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙØªØ­ Ø§Ù„Ø¯Ø±ÙˆØ±
  const table = document.getElementById('dbTable');
  if (table && !table.__dbBound) {
    table.addEventListener('click', (ev) => {
      const a = ev.target.closest('[data-db-click="open"]');
      if (!a) return;
      ev.preventDefault();
      const dept = a.getAttribute('data-dept');
      const kind = a.getAttribute('data-kind'); // new|pending|in_progress|completed
      openDeptBucket(dept, kind, tickets);
    });
    table.__dbBound = true;
  }

  // Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  dbBindFiltersOnce(tickets);
}

// Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
function dbBindFiltersOnce(allTickets) {
  const ids = ['dbFrom','dbTo','dbDept','dbStPending','dbStInProgress','dbStCompleted','dbSource'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el && !el.__dbBound) {
      el.addEventListener('change', () => loadDeptBoardView());
      el.__dbBound = true;
    }
  });
}

// ÙØªØ­ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ±
function openDeptBucket(deptName, kind, allTickets) {
  // 1) Ù†Ù‚Ø±Ø£ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙ†Ø·Ø¨Ù‘Ù‚Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„ÙØªØ±Ø©/Ø§Ù„Ù…ØµØ¯Ø±/Ø§Ù„Ø­Ø§Ù„Ø§Øª)
  const filters = dbReadFilters();
  let view = dbFilterTickets(allTickets, filters);

  // 2) Ø­ØµØ± Ø§Ù„Ù‚Ø³Ù…:
  //    - Ù„Ùˆ Â«Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÂ»: Ù†Ø¬Ù…Ø¹ Ù…Ø§ ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø¯ÙˆØ± elearning Ø£Ùˆ Ù‚Ø³Ù…Ù‡ Ù…Ø³Ø¬Ù„ "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
  //    - ØºÙŠØ± Ø°Ù„Ùƒ: Ù†Ø·Ø§Ø¨Ù‚ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù†ØµØ§Ù‹
  view = view.filter(t => {
    const toRole = normalizeRole((t.transferredTo || '').trim());
    const dept   = (t.department || '').trim();
    if (deptName === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ') {
      return toRole === 'elearning' || dept === 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
    }
    return dept === deptName;
  });

  // 3) Ù†ÙˆØ¹ Ø§Ù„Ø³Ø·Ù„ (bucket) Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø°ÙŠ Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„:
  //    new        => ÙƒÙ„ Ù…Ø§ Ø¶Ù…Ù† Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ù„Ø§ Ù†Ø¶ÙŠÙ ÙÙ„ØªØ± Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙÙŠ)
  //    pending    => Ø­Ø§Ù„Ø© Ù…Ø¹Ù„Ù‘Ù‚Ø© ÙÙ‚Ø·
  //    in_progress=> Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙ‚Ø·
  //    completed  => Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·
  if (kind === 'pending' || kind === 'in_progress' || kind === 'completed') {
    view = view.filter(t => String(t.status || 'pending') === kind);
  } else if (kind === 'new') {
    // Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠâ€”Â«newÂ» ØªØ¹Ù†ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„ÙÙ„Ø§ØªØ±
  }

  // 4) Ø¹Ù†ÙˆØ§Ù† Ø£Ù†ÙŠÙ‚
  const kindLabel =
    kind === 'pending'     ? 'Ù…Ø¹Ù„Ù‘Ù‚Ø©' :
    kind === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' :
    kind === 'completed'   ? 'Ù…ÙƒØªÙ…Ù„Ø©' :
                              'Ø¬Ø¯ÙŠØ¯Ø© (Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©)';

  const title = `${deptName} â€” ${kindLabel}`;

  // 5) Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¬ ÙˆØ§Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  openDbDrawer(title, view);
}


    </script>
    

    <!-- âœ… Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ø§Ù„Ø­Ù€Ù€Ù„ -->
<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ° -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°</h3>
      <button class="modal-close" onclick="closeSolutionModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <label class="modal-label" for="solutionText">Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°:</label>
      <textarea id="solutionText" class="modal-textarea" placeholder="Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..."></textarea>
      <div class="modal-hint">Ø³ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ù„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSolutionModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitSolution()">Ø­ÙØ¸ Ø§Ù„Ø­Ù„</button>
    </div>
  </div>
</div>

<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù„Ù„Ù…Ø±Ø´Ø¯ -->
<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±Ø´Ø¯) -->
<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø±Ø´Ø¯ -->
<div id="advisorTransferModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©</h3>
      <button class="modal-close" onclick="closeAdvisorTransferModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;gap:10px;">
        <label class="modal-label">Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„:</label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="dept_head">
          <span>Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="elearning">
          <span>Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="trainees_vice">
          <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="quality_vice">
          <span>ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="dean">
          <span>Ø§Ù„Ø¹Ù…ÙŠØ¯</span>
        </label>
      </div>
      <div class="modal-hint">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„ØªØ§Ø±ÙŠØ®/Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„).</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAdvisorTransferModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="submitAdvisorTransfer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
    </div>
  </div>
</div>

<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
      <button class="modal-close" aria-label="Ø¥ØºÙ„Ø§Ù‚" onclick="closeRatingModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <!-- Ù†Ø¬ÙˆÙ… -->
      <div id="ratingStars" class="rating-pro" style="margin:6px 0 4px;"></div>
      <!-- Ù…Ù‚ÙŠØ§Ø³ Ù„ÙØ¸ÙŠ -->
      <div class="rating-scale" id="ratingScale"></div>
      <div class="rating-note" id="ratingNote">Ø§Ø®ØªØ± Ù…Ù† 1 (Ø³ÙŠØ¦) Ø¥Ù„Ù‰ 5 (Ù…Ù…ØªØ§Ø²)</div>

      <label for="ratingComment" style="margin-top:14px;">ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeRatingModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
  </div>
</div>

<!-- Ø¯Ø±ÙˆØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
<!-- âœ… Ø¯Ø±Ø¬ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
<!-- âœ… Ø¯Ø±Ø¬ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Â«Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…Â» -->
<div id="dbDrawer" class="modal-backdrop hidden" style="align-items:flex-end;">
  <div class="modal" style="max-width:900px;width:100%;max-height:85vh;overflow:auto;">
    <div class="modal-header">
      <h3 id="dbDrawerTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h3>
      <button class="modal-close" onclick="closeDbDrawer()">Ã—</button>
    </div>
    <div id="dbDrawerBody" class="modal-body">
      <!-- ØªÙÙ…Ù„Ø£ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ -->
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeDbDrawer()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>


<!-- âœ… Ø¯Ø±Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù„ (dbDrawer) -->
<div id="dbDrawer" class="db-drawer" aria-hidden="true">
  <!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© -->
</div>

<!-- âœ… Ù†Ø§ÙØ°Ø© Ø­Ù„Ù‘ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (solutionModal) -->
<div id="solutionModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="solutionTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="solutionTitle">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‘ / Ø¥Ø¬Ø±Ø§Ø¡</h3>
      <button class="modal-close" data-close="true" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    </header>
    <section class="modal-body">
      <textarea id="solutionNotes" rows="6" class="w-full" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø­Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª..."></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" id="saveSolutionBtn" onclick="submitSolution()">Ø­ÙØ¸</button>
    </footer>
  </div>
</div>

<!-- âœ… Ù†Ø§ÙØ°Ø© ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø±Ø´Ø¯ (advisorTransferModal) -->
<div id="advisorTransferModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="advisorTransferTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="advisorTransferTitle">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±Ø´Ø¯</h3>
      <button class="modal-close" data-close="true" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    </header>
    <section class="modal-body">
      <label class="block mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø´Ø¯:</label>
      <select id="advisorSelect" class="w-full mb-4"></select>
      <label class="block mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <textarea id="advisorNotes" rows="4" class="w-full"></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" id="confirmAdvisorTransferBtn">ØªØ­ÙˆÙŠÙ„</button>
    </footer>
  </div>
</div>

<!-- âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (ratingModal) -->
<div id="ratingModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="ratingTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="ratingTitle">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
      <button class="modal-close" data-close="true" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    </header>
    <section class="modal-body">
      <div class="rating-stars" id="ratingStars" aria-label="Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5"></div>
      <textarea id="ratingNotes" rows="4" class="w-full mt-3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn btn-primary" id="submitRatingBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </footer>
  </div>
</div>

<!-- âœ… Ù…ÙˆØ¯Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
      <button class="modal-close" onclick="closeRatingModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="ratingStars" class="rating-pro" style="margin-bottom:10px;"></div>
      <div id="ratingScale" class="rating-scale"></div>
      <div id="ratingNote" class="rating-note">Ø§Ø®ØªØ± Ù…Ù† 1 (Ø³ÙŠØ¦) Ø¥Ù„Ù‰ 5 (Ù…Ù…ØªØ§Ø²)</div>

      <label for="ratingComment" style="margin-top:14px;">ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø©..."></textarea>
      <div class="modal-hint">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚ÙŠÙŠÙ… Ù†ÙØ³ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeRatingModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
  </div>
</div>
<!-- =========================
  âœ… Ù…ÙˆØ¯Ø§Ù„ "Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°" (Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©)
========================= -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„</h3>
      <button class="modal-close" onclick="closeSolutionModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <label for="solutionText" class="modal-label">Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ°</label>
      <textarea id="solutionText" class="modal-textarea" rows="5" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙØ° Ø¨Ø¯Ù‚Ø©..."></textarea>
      <div class="modal-hint">Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¥Ù„Ù‰ Â«Ù…ÙƒØªÙ…Ù„Ø©Â» ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSolutionModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitSolution()">ØªÙ… Ø§Ù„Ø­Ù„</button>
    </div>
  </div>
</div>

<!-- =========================
  âœ… Ù…ÙˆØ¯Ø§Ù„ "ØªØ­ÙˆÙŠÙ„ ØªØ°ÙƒØ±Ø©" Ù„Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ
========================= -->
<div id="advisorTransferModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©</h3>
      <button class="modal-close" onclick="closeAdvisorTransferModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:10px;font-weight:700;">Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„:</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="dept_head">
          <span>Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="elearning">
          <span>Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="trainees_vice">
          <span>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="quality_vice">
          <span>ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="dean">
          <span>Ø§Ù„Ø¹Ù…ÙŠØ¯</span>
        </label>
      </div>
      <div class="modal-hint" style="margin-top:12px;">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ØªØ¸Ù‡Ø± Ø§Ù„ØªØ°ÙƒØ±Ø© ÙƒÙ€ Â«â†—ï¸ Ù…Ø­ÙˆÙ‘Ù„Ø©Â» ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø´Ø¯ØŒ Ù…Ø¹ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¬Ù‡Ø© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAdvisorTransferModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="submitAdvisorTransfer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
    </div>
  </div>
</div>

<!-- =========================
  âœ… Ù…ÙˆØ¯Ø§Ù„ "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©" Ù„Ù„Ù…ØªØ¯Ø±Ø¨
========================= -->
<div id="ratingModal" class="modal-backdrop hidden modal-rating">
  <div class="modal">
    <div class="modal-header">
      <h3>Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
      <button class="modal-close" onclick="closeRatingModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <label class="modal-label">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
      <div id="ratingStars" class="rating-pro" style="margin-bottom:8px;"></div>
      <div id="ratingScale" class="rating-scale"></div>
      <div id="ratingNote" class="rating-note" style="margin-top:8px;">Ø§Ø®ØªØ± Ù…Ù† 1 Ø¥Ù„Ù‰ 5</div>

      <label for="ratingComment" class="modal-label" style="margin-top:14px;">ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="ratingComment" class="modal-textarea" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø©..."></textarea>
      <div class="modal-hint">Ù„Ù† ØªØ³ØªØ·ÙŠØ¹ ØªÙ‚ÙŠÙŠÙ… Ù†ÙØ³ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeRatingModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
  </div>
</div>

<!-- =========================
  âœ… Ø¯Ø±Ø¬ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©)
========================= -->
<div id="dbDrawer" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10000;display:flex;justify-content:flex-end;">
  <div style="width:min(900px,100%);height:100%;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,.25);display:flex;flex-direction:column;">
    <div style="padding:14px 16px;background:linear-gradient(135deg, var(--primary-blue), var(--dark-blue));color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <h3 id="dbDrawerTitle" style="font-size:18px;margin:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h3>
      <button class="modal-close" onclick="document.getElementById('dbDrawer').classList.add('hidden')">Ã—</button>
    </div>
    <div id="dbDrawerBody" style="padding:16px;overflow:auto;">
      <!-- ÙŠÙÙ…Ù„Ø£ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ -->
    </div>
  </div>
</div>
<!-- ========== Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ========== -->
<div id="reportsModal" class="modal-backdrop hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;">
  <div class="modal" style="width:95%;max-width:1400px;height:90vh;display:flex;flex-direction:column;background:#fff;border-radius:16px;overflow:hidden;">
    <div class="modal-header" style="background:linear-gradient(135deg, var(--tvtc-primary), var(--tvtc-primary-700));color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;">
      <h3 style="margin:0;font-size:22px;">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h3>
      <button class="modal-close" onclick="closeAdminReports()" style="background:transparent;border:0;color:#fff;font-size:28px;cursor:pointer;padding:0;line-height:1;">Ã—</button>
    </div>
    
    <div class="modal-body" style="flex:1;overflow-y:auto;padding:24px;">
      <!-- ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
      <div class="report-filters" style="background:var(--tvtc-primary-100);border-radius:12px;padding:16px;margin-bottom:24px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <select id="reportType" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
              <option value="overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</option>
              <option value="departments">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
              <option value="advisors">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†</option>
              <option value="services">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
              <option value="performance">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="reportFromDate" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="reportToDate" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px;">
            <button class="btn btn-primary" onclick="generateReport()" style="flex:1;padding:10px;">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn btn-success" onclick="exportReportPDF()" style="padding:10px;">PDF â¬‡</button>
            <button class="btn" onclick="exportReportExcel()" style="padding:10px;background:var(--success);color:#fff;border:0;">Excel â¬‡</button>
          </div>
        </div>
      </div>

      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØµØ¯ÙŠØ± -->
      <div id="reportContent" style="background:white;padding:20px;">
        <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="reportKPIs" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
          <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ -->
        </div>

        <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
        <div id="reportCharts" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px;">
          <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ -->
        </div>

        <!-- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
        <div id="reportTables" style="margin-top:24px;">
          <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ -->
        </div>
      </div>
    </div>

    <div class="modal-footer" style="border-top:1px solid #ddd;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9;">
      <div style="color:#666;font-size:13px;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="reportLastUpdate"></span></div>
      <button class="btn" onclick="closeAdminReports()" style="background:#6c757d;color:#fff;border:0;padding:10px 24px;border-radius:8px;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ========== CSS Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ========== -->
<style>
.kpi-card {
  background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-accent) 100%);
  color: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 99, 65, 0.25);
  transition: all 0.3s;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.kpi-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 8px 25px rgba(0, 99, 65, 0.35);
}

.kpi-card.green {
  background: linear-gradient(135deg, var(--success) 0%, var(--tvtc-primary-700) 100%);
  box-shadow: 0 4px 15px rgba(30, 127, 92, 0.25);
}

.kpi-card.green:hover {
  box-shadow: 0 8px 25px rgba(30, 127, 92, 0.35);
}

.kpi-card.orange {
  background: linear-gradient(135deg, var(--tvtc-secondary) 0%, var(--warning) 100%);
  box-shadow: 0 4px 15px rgba(200, 165, 92, 0.25);
}

.kpi-card.orange:hover {
  box-shadow: 0 8px 25px rgba(200, 165, 92, 0.35);
}

.kpi-card.red {
  background: linear-gradient(135deg, var(--error) 0%, #a32a1f 100%);
  box-shadow: 0 4px 15px rgba(192, 57, 43, 0.25);
}

.kpi-card.red:hover {
  box-shadow: 0 8px 25px rgba(192, 57, 43, 0.35);
}

.kpi-card.purple {
  background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.25);
}

.kpi-card.purple:hover {
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
}

.kpi-card.teal {
  background: linear-gradient(135deg, var(--tvtc-accent) 0%, var(--tvtc-primary) 100%);
  box-shadow: 0 4px 15px rgba(0, 162, 135, 0.25);
}

.kpi-card.teal:hover {
  box-shadow: 0 8px 25px rgba(0, 162, 135, 0.35);
}

.kpi-number {
  font-size: 36px;
  font-weight: bold;
  margin: 10px 0;
}

.kpi-label {
  font-size: 14px;
  opacity: 0.9;
}

.kpi-trend {
  font-size: 12px;
  margin-top: 8px;
  padding: 4px 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  display: inline-block;
}

.chart-container {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--tvtc-primary);
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--tvtc-primary-100);
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.report-table thead {
  background: linear-gradient(135deg, var(--tvtc-primary), var(--tvtc-primary-700));
  color: white;
}

.report-table th {
  padding: 14px;
  text-align: right;
  font-weight: 600;
  font-size: 14px;
}

.report-table tbody tr {
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.2s;
}

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.report-table td {
  padding: 12px 14px;
  font-size: 13px;
}

.progress-bar {
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 4px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--tvtc-secondary));
  transition: width 0.3s;
}

.badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-warning {
  background: #fff3cd;
  color: #856404;
}

.badge-danger {
  background: #f8d7da;
  color: #721c24;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}
</style>

<!-- ========== JavaScript Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let reportData = null;
let currentCharts = {};

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
async function openAdminReports() {
  const modal = document.getElementById('reportsModal');
  if (!modal) return;
  
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)
  const today = new Date();
  const monthAgo = new Date();
  monthAgo.setDate(monthAgo.getDate() - 30);
  
  document.getElementById('reportFromDate').value = monthAgo.toISOString().split('T')[0];
  document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
  
  await generateReport();
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function closeAdminReports() {
  document.getElementById('reportsModal').classList.add('hidden');
  document.body.style.overflow = '';
  
  // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
  Object.values(currentCharts).forEach(chart => chart.destroy());
  currentCharts = {};
}

// ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
async function generateReport() {
  showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...');
  
  try {
    reportData = await getReportData();
    
    if (!reportData) {
      hideLoading();
      return;
    }
    
    updateReportView();
    document.getElementById('reportLastUpdate').textContent = new Date().toLocaleString('ar-SA');
    
  } catch (error) {
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    console.error(error);
  }
  
  hideLoading();
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function updateReportView() {
  if (!reportData) return;
  
  const reportType = document.getElementById('reportType').value;
  
  // ØªØ­Ø¯ÙŠØ« KPIs
  renderKPIs();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  switch(reportType) {
    case 'overview':
      renderOverviewReport();
      break;
    case 'departments':
      renderDepartmentsReport();
      break;
    case 'advisors':
      renderAdvisorsReport();
      break;
    case 'services':
      renderServicesReport();
      break;
    case 'performance':
      renderPerformanceReport();
      break;
  }
}

// Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
function renderKPIs() {
  const container = document.getElementById('reportKPIs');
  const summary = reportData.summary;
  
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(1) : 0;
  
  container.innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
      <div class="kpi-number">${summary.total}</div>
      <div class="kpi-trend">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…: ${summary.last30Days}</div>
    </div>
    
    <div class="kpi-card green">
      <div class="kpi-label">Ù…ÙƒØªÙ…Ù„Ø©</div>
      <div class="kpi-number">${summary.completed}</div>
      <div class="kpi-trend">${completionRate}% Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
    </div>
    
    <div class="kpi-card orange">
      <div class="kpi-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
      <div class="kpi-number">${summary.inProgress}</div>
      <div class="kpi-trend">${summary.pending} Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>
    
    <div class="kpi-card purple">
      <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
      <div class="kpi-number">${summary.avgRating} â­</div>
      <div class="kpi-trend">${summary.totalRatings} ØªÙ‚ÙŠÙŠÙ…</div>
    </div>
    
    <div class="kpi-card teal">
      <div class="kpi-label">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
      <div class="kpi-number">${summary.avgCompletionDays}</div>
      <div class="kpi-trend">ÙŠÙˆÙ…</div>
    </div>
    
    <div class="kpi-card orange">
      <div class="kpi-label">Ù…Ø­ÙˆÙ‘Ù„Ø©</div>
      <div class="kpi-number">${summary.transferred}</div>
      <div class="kpi-trend">${((summary.transferred/summary.total)*100).toFixed(1)}%</div>
    </div>
  `;
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
function renderOverviewReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const summary = reportData.summary;
  
  chartsContainer.innerHTML = `
    <div class="chart-container">
      <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
      <canvas id="statusPieChart"></canvas>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">Ø§Ù„ØªØ°Ø§ÙƒØ± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</div>
      <canvas id="servicesBarChart"></canvas>
    </div>
  `;
  
  // Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±
  const statusCtx = document.getElementById('statusPieChart');
  if (currentCharts['statusPie']) currentCharts['statusPie'].destroy();
  currentCharts['statusPie'] = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'Ù…Ø¹Ù„Ù‚Ø©'],
      datasets: [{
        data: [summary.completed, summary.inProgress, summary.pending],
        backgroundColor: ['#1E7F5C', '#F59E0B', '#C0392B'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 13, family: 'Segoe UI' }, padding: 15 }
        }
      }
    }
  });
  
  // Ø±Ø³Ù… Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª
  const services = reportData.services;
  const serviceLabels = Object.keys(services);
  const serviceValues = Object.values(services).map(s => s.total || s);
  
  const servicesCtx = document.getElementById('servicesBarChart');
  if (currentCharts['servicesBar']) currentCharts['servicesBar'].destroy();
  currentCharts['servicesBar'] = new Chart(servicesCtx, {
    type: 'bar',
    data: {
      labels: serviceLabels,
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±',
        data: serviceValues,
        backgroundColor: '#006341',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  // Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ°Ø§ÙƒØ±
  renderRecentTicketsTable();
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
function renderDepartmentsReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const departments = reportData.departments;
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <canvas id="deptComparisonChart"></canvas>
    </div>
  `;
  
  const deptNames = Object.keys(departments);
  const deptTotals = deptNames.map(d => departments[d].total);
  const deptCompleted = deptNames.map(d => departments[d].completed);
  
  const ctx = document.getElementById('deptComparisonChart');
  if (currentCharts['deptComparison']) currentCharts['deptComparison'].destroy();
  currentCharts['deptComparison'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: deptNames,
      datasets: [
        {
          label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
          data: deptTotals,
          backgroundColor: '#006341'
        },
        {
          label: 'Ù…ÙƒØªÙ…Ù„Ø©',
          data: deptCompleted,
          backgroundColor: '#1E7F5C'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  // Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ
  renderDepartmentsTable();
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†
function renderAdvisorsReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const advisors = reportData.advisors;
  
  chartsContainer.innerHTML = `
    <div class="chart-container">
      <div class="chart-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ† - Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±</div>
      <canvas id="advisorsTicketsChart"></canvas>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†</div>
      <canvas id="advisorsRatingsChart"></canvas>
    </div>
  `;
  
  const advisorNames = Object.keys(advisors).slice(0, 10); // Ø£ÙØ¶Ù„ 10
  const advisorTickets = advisorNames.map(a => advisors[a].total);
  const advisorRatings = advisorNames.map(a => parseFloat(advisors[a].avgRating) || 0);
  
  // Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±
  const ticketsCtx = document.getElementById('advisorsTicketsChart');
  if (currentCharts['advisorsTickets']) currentCharts['advisorsTickets'].destroy();
  currentCharts['advisorsTickets'] = new Chart(ticketsCtx, {
    type: 'horizontalBar',
    data: {
      labels: advisorNames,
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±',
        data: advisorTickets,
        backgroundColor: '#006341'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } }
    }
  });
  
  // Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
  const ratingsCtx = document.getElementById('advisorsRatingsChart');
  if (currentCharts['advisorsRatings']) currentCharts['advisorsRatings'].destroy();
  currentCharts['advisorsRatings'] = new Chart(ratingsCtx, {
    type: 'horizontalBar',
    data: {
      labels: advisorNames,
      datasets: [{
        label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',
        data: advisorRatings,
        backgroundColor: '#C8A55C'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: { x: { max: 5 } }
    }
  });
  
  renderAdvisorsTable();
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª
function renderServicesReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const services = reportData.services;
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
      <canvas id="servicesPieChart"></canvas>
    </div>
  `;
  
  const serviceLabels = Object.keys(services);
  const serviceValues = Object.values(services).map(s => s.total || s);
  
  const colors = ['#006341', '#1E7F5C', '#C8A55C', '#C0392B', '#8B5CF6', '#F59E0B'];
  
  const ctx = document.getElementById('servicesPieChart');
  if (currentCharts['servicesPie']) currentCharts['servicesPie'].destroy();
  currentCharts['servicesPie'] = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: serviceLabels,
      datasets: [{
        data: serviceValues,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right' }
      }
    }
  });
  
  renderServicesTable();
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡
function renderPerformanceReport() {
  const chartsContainer = document.getElementById('reportCharts');
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <canvas id="performanceChart"></canvas>
    </div>
  `;
  
  const summary = reportData.summary;
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(0) : 0;
  const inProgressRate = summary.total > 0 ? ((summary.inProgress / summary.total) * 100).toFixed(0) : 0;
  const pendingRate = summary.total > 0 ? ((summary.pending / summary.total) * 100).toFixed(0) : 0;
  
  const ctx = document.getElementById('performanceChart');
  if (currentCharts['performance']) currentCharts['performance'].destroy();
  currentCharts['performance'] = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', 'Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'Ø§Ù„ÙƒÙØ§Ø¡Ø©'],
      datasets: [{
        label: 'Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        data: [
          completionRate,
          (summary.avgRating / 5) * 100,
          Math.max(0, 100 - (summary.avgCompletionDays * 10)),
          (summary.avgRating / 5) * 100,
          completionRate
        ],
        backgroundColor: 'rgba(0, 99, 65, 0.2)',
        borderColor: '#006341',
        borderWidth: 2,
        pointBackgroundColor: '#006341'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100
        }
      }
    }
  });
  
  renderPerformanceTable();
}

// Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
function renderRecentTicketsTable() {
  const container = document.getElementById('reportTables');
  const tickets = reportData.tickets.slice(0, 20);
  
  let html = '<div class="chart-title">Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ°Ø§ÙƒØ±</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©</th><th>Ø§Ù„Ù…ØªØ¯Ø±Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>';
  html += '</tr></thead><tbody>';
  
  tickets.forEach(t => {
    const status = t.status || t['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'pending';
    const badge = status === 'completed' ? 'badge-success' : status === 'in_progress' ? 'badge-warning' : 'badge-danger';
    const statusText = status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„Ø©' : status === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'Ù…Ø¹Ù„Ù‚Ø©';
    
    html += '<tr>';
    html += `<td><strong>${t.ticketNumber || t['Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '-'}</strong></td>`;
    html += `<td>${t.traineeName || t['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨'] || '-'}</td>`;
    html += `<td>${t.department || t['Ø§Ù„Ù‚Ø³Ù…'] || '-'}</td>`;
    html += `<td>${t.serviceType || t['Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '-'}</td>`;
    html += `<td><span class="badge ${badge}">${statusText}</span></td>`;
    html += `<td>${formatArabicDate(t.createdAt || t['Ø§Ù„ØªØ§Ø±ÙŠØ®'], true)}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderDepartmentsTable() {
  const container = document.getElementById('reportTables');
  const departments = reportData.departments;
  
  let html = '<div class="chart-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…ÙƒØªÙ…Ù„Ø©</th><th>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>Ù…Ø¹Ù„Ù‚Ø©</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(departments).forEach(([dept, stats]) => {
    const rate = stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
    html += '<tr>';
    html += `<td><strong>${dept}</strong></td>`;
    html += `<td>${stats.total}</td>`;
    html += `<td>${stats.completed}</td>`;
    html += `<td>${stats.inProgress || 0}</td>`;
    html += `<td>${stats.pending || 0}</td>`;
    html += `<td>${rate}%<div class="progress-bar"><div class="progress-fill" style="width:${rate}%"></div></div></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderAdvisorsTable() {
  const container = document.getElementById('reportTables');
  const advisors = reportData.advisors;
  
  let html = '<div class="chart-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>Ø§Ù„Ù…Ø±Ø´Ø¯</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</th><th>Ù…ÙƒØªÙ…Ù„Ø©</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(advisors).forEach(([advisor, stats]) => {
    const rating = parseFloat(stats.avgRating) || 0;
    const ratingsCount = stats.ratingsCount || 0;
    html += '<tr>';
    html += `<td><strong>${advisor}</strong></td>`;
    html += `<td>${stats.total}</td>`;
    html += `<td>${stats.completed}</td>`;
    html += `<td>${rating > 0 ? rating + ' â­' : '-'}</td>`;
    html += `<td>${ratingsCount}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderServicesTable() {
  const container = document.getElementById('reportTables');
  const services = reportData.services;
  const total = Object.values(services).reduce((sum, s) => sum + (s.total || s), 0);
  
  let html = '<div class="chart-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(services).forEach(([service, stats]) => {
    const count = stats.total || stats;
    const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
    html += '<tr>';
    html += `<td><strong>${service}</strong></td>`;
    html += `<td>${count}</td>`;
    html += `<td>${percent}%<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderPerformanceTable() {
  const container = document.getElementById('reportTables');
  const summary = reportData.summary;
  
  let html = '<div class="chart-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>';
  html += '</tr></thead><tbody>';
  
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(1) : 0;
  
  const metrics = [
    { name: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', value: completionRate + '%', status: completionRate >= 70 ? 'Ù…Ù…ØªØ§Ø²' : completionRate >= 50 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†' },
    { name: 'Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', value: summary.avgCompletionDays + ' ÙŠÙˆÙ…', status: summary.avgCompletionDays <= 3 ? 'Ù…Ù…ØªØ§Ø²' : summary.avgCompletionDays <= 5 ? 'Ø¬ÙŠØ¯' : 'Ø¨Ø·ÙŠØ¡' },
    { name: 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', value: summary.avgRating + ' â­', status: summary.avgRating >= 4 ? 'Ù…Ù…ØªØ§Ø²' : summary.avgRating >= 3 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†' },
    { name: 'Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù†Ø´Ø·Ø©', value: summary.inProgress + summary.pending, status: 'Ù†Ø´Ø·' }
  ];
  
  metrics.forEach(m => {
    const badgeClass = m.status === 'Ù…Ù…ØªØ§Ø²' ? 'badge-success' : m.status === 'Ø¬ÙŠØ¯' ? 'badge-info' : 'badge-warning';
    html += '<tr>';
    html += `<td><strong>${m.name}</strong></td>`;
    html += `<td>${m.value}</td>`;
    html += `<td><span class="badge ${badgeClass}">${m.status}</span></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ========== ØªØµØ¯ÙŠØ± PDF Ùˆ Excel ==========

// ØªØµØ¯ÙŠØ± PDF ÙƒØµÙˆØ±Ø© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù„ØºØ©
async function exportReportPDF() {
  showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...');
  
  try {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
    if (typeof jspdf === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    if (typeof html2canvas === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„Ø© ÙƒØµÙˆØ±Ø©
    const reportContent = document.getElementById('reportContent');
    if (!reportContent) {
      throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
    
    const canvas = await html2canvas(reportContent, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false
    });
    
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210; // Ø¹Ø±Ø¶ A4 Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= 297; // Ø§Ø±ØªÙØ§Ø¹ ØµÙØ­Ø© A4
    
    // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= 297;
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    const reportType = document.getElementById('reportType').value;
    const reportTypeNames = {
      'overview': 'Ù†Ø¸Ø±Ø©_Ø¹Ø§Ù…Ø©',
      'departments': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ù‚Ø³Ø§Ù…',
      'advisors': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†',
      'services': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø®Ø¯Ù…Ø§Øª',
      'performance': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ø¯Ø§Ø¡'
    };
    
    const date = new Date().toLocaleDateString('ar-SA').replace(/\//g, '-');
    const fileName = `ØªÙ‚Ø±ÙŠØ±_${reportTypeNames[reportType]}_${date}.pdf`;
    pdf.save(fileName);
    
    hideLoading();
    showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØµÙŠØºØ© PDF Ø¨Ù†Ø¬Ø§Ø­!');
    
  } catch (error) {
    hideLoading();
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
    console.error(error);
  }
}

// ØªØµØ¯ÙŠØ± Excel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SheetJS
function exportReportExcel() {
  showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel...');
  
  try {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
    if (typeof XLSX === 'undefined') {
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js')
        .then(() => generateExcelFile())
        .catch(err => {
          hideLoading();
          showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Excel');
        });
      return;
    }
    
    generateExcelFile();
    
  } catch (error) {
    hideLoading();
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
    console.error(error);
  }
}

function generateExcelFile() {
  const wb = XLSX.utils.book_new();
  const summary = reportData.summary;
  const reportType = document.getElementById('reportType').value;
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  const kpisData = [
    ['Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', ''],
    ['', ''],
    ['Ø§Ù„Ù…Ø¤Ø´Ø±', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±', summary.total],
    ['Ù…ÙƒØªÙ…Ù„Ø©', summary.completed],
    ['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', summary.inProgress],
    ['Ù…Ø¹Ù„Ù‚Ø©', summary.pending],
    ['Ù…Ø­ÙˆÙ„Ø©', summary.transferred],
    ['Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', summary.avgRating],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', summary.totalRatings],
    ['Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (ÙŠÙˆÙ…)', summary.avgCompletionDays],
    ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', ((summary.completed / summary.total) * 100).toFixed(1) + '%'],
    ['Ø§Ù„ØªØ°Ø§ÙƒØ± ÙÙŠ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…', summary.last30Days]
  ];
  
  const wsKPIs = XLSX.utils.aoa_to_sheet(kpisData);
  wsKPIs['!cols'] = [{ wch: 30 }, { wch: 15 }];
  
  // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
  const headerStyle = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
  const titleStyle = { fill: { fgColor: { rgb: "C8A55C" } }, font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
  const dataLabelStyle = { fill: { fgColor: { rgb: "E6F1EC" } }, font: { bold: true }, alignment: { horizontal: "right" } };
  
  wsKPIs['A1'].s = titleStyle;
  wsKPIs['A3'].s = headerStyle;
  wsKPIs['B3'].s = headerStyle;
  
  for (let i = 4; i <= 13; i++) {
    if (wsKPIs[`A${i}`]) wsKPIs[`A${i}`].s = dataLabelStyle;
  }
  
  XLSX.utils.book_append_sheet(wb, wsKPIs, 'Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  if (reportData.departments) {
    const deptData = [['Ø§Ù„Ù‚Ø³Ù…', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'Ù…Ø¹Ù„Ù‚Ø©', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²']];
    
    Object.entries(reportData.departments).forEach(([dept, stats]) => {
      const rate = stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
      deptData.push([
        dept,
        stats.total,
        stats.completed,
        stats.inProgress || 0,
        stats.pending || 0,
        rate + '%'
      ]);
    });
    
    const wsDept = XLSX.utils.aoa_to_sheet(deptData);
    wsDept['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 15 }];
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1'];
    headerCells.forEach(cell => {
      if (wsDept[cell]) wsDept[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsDept, 'Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
  }
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†
  if (reportData.advisors) {
    const advisorData = [['Ø§Ù„Ù…Ø±Ø´Ø¯', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±', 'Ù…ÙƒØªÙ…Ù„Ø©', 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª']];
    
    Object.entries(reportData.advisors).forEach(([advisor, stats]) => {
      advisorData.push([
        advisor,
        stats.total,
        stats.completed,
        stats.avgRating || 0,
        stats.ratingsCount || 0
      ]);
    });
    
    const wsAdvisor = XLSX.utils.aoa_to_sheet(advisorData);
    wsAdvisor['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }];
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1'];
    headerCells.forEach(cell => {
      if (wsAdvisor[cell]) wsAdvisor[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsAdvisor, 'Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†');
  }
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
  if (reportData.services) {
    const servicesData = [['Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±', 'Ø§Ù„Ù†Ø³Ø¨Ø©']];
    const total = Object.values(reportData.services).reduce((a, b) => a + b, 0);
    
    Object.entries(reportData.services).forEach(([service, count]) => {
      const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
      servicesData.push([service, count, percent + '%']);
    });
    
    const wsServices = XLSX.utils.aoa_to_sheet(servicesData);
    wsServices['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 10 }];
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const headerCells = ['A1', 'B1', 'C1'];
    headerCells.forEach(cell => {
      if (wsServices[cell]) wsServices[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsServices, 'Ø§Ù„Ø®Ø¯Ù…Ø§Øª');
  }
  
  // ÙˆØ±Ù‚Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
  if (reportData.tickets && reportData.tickets.length > 0) {
    const dailyLogData = [['Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„ØªØ®ØµØµ', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ', 'Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©', 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª']];
    
    reportData.tickets.forEach(t => {
      dailyLogData.push([
        t.ticketNumber || t['Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '',
        t.date || t['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
        t.time || t['Ø§Ù„ÙˆÙ‚Øª'] || '',
        t.traineeId || t['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '',
        t.traineeName || t['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨'] || '',
        t.department || t['Ø§Ù„Ù‚Ø³Ù…'] || '',
        t.specialization || t['Ø§Ù„ØªØ®ØµØµ'] || '',
        t.advisorName || t['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '',
        t.serviceType || t['Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '',
        t.serviceDetails || t['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '',
        t.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : t.status === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : t.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : t.status || t['Ø§Ù„Ø­Ø§Ù„Ø©'] || '',
        t.notes || t['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || ''
      ]);
    });
    
    const wsDailyLog = XLSX.utils.aoa_to_sheet(dailyLogData);
    wsDailyLog['!cols'] = [
      { wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 20 }, 
      { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 30 }, 
      { wch: 12 }, { wch: 30 }
    ];
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1', 'J1', 'K1', 'L1'];
    headerCells.forEach(cell => {
      if (wsDailyLog[cell]) wsDailyLog[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsDailyLog, 'Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙŠÙˆÙ…ÙŠØ©');
  }
  
  // ÙˆØ±Ù‚Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© (Ø¢Ø®Ø± 100 ØªØ°ÙƒØ±Ø©)
  if (reportData.tickets && reportData.tickets.length > 0) {
    const trackingData = [['Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ', 'Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', 'Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù…']];
    
    reportData.tickets.slice(0, 100).forEach(t => {
      trackingData.push([
        t.ticketNumber || t['Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '',
        t.traineeName || t['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨'] || '',
        t.department || t['Ø§Ù„Ù‚Ø³Ù…'] || '',
        t.advisorName || t['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '',
        t.serviceType || t['Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©'] || '',
        t.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : t.status === 'in_progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : t.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : t.status || t['Ø§Ù„Ø­Ø§Ù„Ø©'] || '',
        t.date || t['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
        t.completionDate || t['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²'] || '',
        t.solution || t['Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù…'] || ''
      ]);
    });
    
    const wsTracking = XLSX.utils.aoa_to_sheet(trackingData);
    wsTracking['!cols'] = [
      { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, 
      { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 30 }
    ];
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const trackingHeaders = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1'];
    trackingHeaders.forEach(cell => {
      if (wsTracking[cell]) wsTracking[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsTracking, 'ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©');
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
  const reportTypeNames = {
    'overview': 'Ù†Ø¸Ø±Ø©_Ø¹Ø§Ù…Ø©',
    'departments': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ù‚Ø³Ø§Ù…',
    'advisors': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠÙ†',
    'services': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø®Ø¯Ù…Ø§Øª',
    'performance': 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ø¯Ø§Ø¡'
  };
  
  const date = new Date().toLocaleDateString('ar-SA').replace(/\//g, '-');
  const fileName = `ØªÙ‚Ø±ÙŠØ±_${reportTypeNames[reportType]}_${date}.xlsx`;
  
  XLSX.writeFile(wb, fileName);
  
  hideLoading();
  showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØµÙŠØºØ© Excel Ø¨Ù†Ø¬Ø§Ø­!');
}

// ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø®Ø§Ø±Ø¬ÙŠ
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}
</script>

</body>
</html>
<!-- ========== Developer Credits ========== -->
<div id="devCredits" style="position:fixed;bottom:10px;left:10px;background:linear-gradient(135deg,var(--tvtc-primary),var(--tvtc-secondary));color:#fff;padding:8px 16px;border-radius:8px;font-size:12px;box-shadow:0 2px 10px rgba(0,99,65,0.3);z-index:9999;display:flex;align-items:center;gap:8px;">
  <span style="font-size:16px;">ğŸ’»</span>
  <div>
    <div style="font-weight:600;margin-bottom:2px;">ØªØ·ÙˆÙŠØ±: Ù…. ÙÙ‡Ø¯ ØµØ§Ù„Ø­</div>
    <div style="opacity:0.9;font-size:11px;">ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø© - Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø¨Ø­Ù‚Ù„</div>
  </div>
</div>

<style>
#devCredits {
  animation: slideInLeft 0.5s ease-out;
  transition: all 0.3s;
}
#devCredits:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 20px rgba(0,99,65,0.4);
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
@media (max-width: 768px) {
  #devCredits {
    bottom: 5px;
    left: 5px;
    padding: 6px 10px;
    font-size: 10px;
  }
  #devCredits > span {
    font-size: 14px;
  }
  #devCredits > div > div:first-child {
    font-size: 11px;
  }
  #devCredits > div > div:last-child {
    font-size: 9px;
  }
}
</style>
