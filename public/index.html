<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل المواقف اليومية للمتدربين - المؤسسة العامة للتدريب التقني والمهني</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-blue: #0A5F8F;
            --secondary-green: #2C9A4F;
            --accent-gold: #D4AF37;
            --light-blue: #E8F4F8;
            --dark-blue: #053D5C;
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --text-dark: #333333;
            --border-color: #DDD;
        }

        body {
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(10, 95, 143, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--secondary-green);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50%, -50%);
            z-index: 0;              /* تحت كل شيء */
            pointer-events: none;    /* لا يحجب النقر */
        }

        .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        position: relative;
        z-index: 1; /* بحيث يظهر فوق ::before */
        }


        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.1);
        }

        .btn {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 95, 143, 0.3);
        }

        .btn-success {
            background: var(--secondary-green);
            color: white;
        }

        .btn-success:hover {
            background: #247d42;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-gold);
            color: var(--dark-blue);
        }

        .btn-warning:hover {
            background: #c5a032;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 30px;
            background: var(--gray);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-card {
            background: var(--light-blue);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid var(--primary-blue);
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .info-item strong {
            color: var(--primary-blue);
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-item span {
            color: var(--text-dark);
            font-size: 15px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-green), var(--accent-gold));
            margin: 30px 0;
            border-radius: 2px;
        }

        .ticket-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ticket-number {
            background: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .ticket-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }


        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border-right: 4px solid #17A2B8;
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border-right: 4px solid #28A745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .rating {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .star {
            font-size: 30px;
            color: #DDD;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover,
        .star.active {
            color: var(--accent-gold);
            transform: scale(1.2);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 2;              /* فوق الزخرفة */
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-blue);
        }

        .footer {
            background: var(--gray);
            padding: 20px;
            text-align: center;
            color: var(--text-dark);
            border-top: 3px solid var(--accent-gold);
        }

        .service-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .service-btn {
            position: relative;
            display: block;
            cursor: pointer;
            padding: 20px;
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .service-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 95, 143, 0.2);
        }

        .service-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .service-btn input[type="radio"]:checked + span {
            color: white;
        }

        .service-btn input[type="radio"]:checked ~ span {
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            border-color: var(--primary-blue);
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) span {
            color: white;
        }

        .service-btn span {
            display: block;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        /* ========== بطاقة تذكرة حديثة ========== */
        .ticket-card.modern {
        border: 1.5px solid var(--border-color);
        border-radius: 14px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 4px 18px rgba(10,95,143,.06);
        transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .ticket-card.modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 26px rgba(10,95,143,.12);
        border-color: rgba(10,95,143,.25);
        }

        /* رأس البطاقة */
        .ticket-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
        }
        .ticket-id-chip {
        background: var(--dark-blue);
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: .3px;
        font-size: 13px;
        }
        .ticket-status-badge {
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        border: 1px solid transparent;
        }
        .ticket-status--completed {
        background: #E8F5E9;
        color: #1B5E20;
        border-color: #C8E6C9;
        }
        .ticket-status--pending {
        background: #FFF8E1;
        color: #8B6B00;
        border-color: #FFECB3;
        }
        .ticket-status--inprogress {
        background: #E1F5FE;
        color: #01579B;
        border-color: #B3E5FC;
        }

        /* فاصل */
        .ticket-sep {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent);
        margin: 10px 0 14px;
        border-radius: 1px;
        }

        /* شبكة معلومات */
        .ticket-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 10px 18px;
        }
        @media (max-width: 640px) {
        .ticket-grid { grid-template-columns: 1fr; }
        }
        .ticket-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        line-height: 1.7;
        }
        .ticket-row .k {
        min-width: 110px;
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 13px;
        }
        .ticket-row .v {
        color: var(--text-dark);
        font-size: 14px;
        word-wrap: break-word;
        }

        /* التفاصيل نص ممتد */
        .ticket-details {
        margin-top: 6px;
        background: var(--light-blue);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
        color: #0c2b3c;
        border: 1px dashed rgba(10,95,143,.25);
        }

        /* فوتر */
        .ticket-foot {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        color: #6b7280;
        font-size: 12px;
        }
        .ticket-foot .dot {
        width: 4px; height: 4px; border-radius: 50%; background:#c9cdd2;
        display: inline-block; margin-inline: 6px;
        }


    </style>

    <style>
  /* ✅ تنسيقات المودال */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  .modal {
    width: 100%; max-width: 640px;
    background: #fff; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    overflow: hidden;
    border: 2px solid var(--border-color);
  }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
    color: #fff;
  }
  .modal-close {
    background: transparent; border: 2px solid #fff; color: #fff;
    width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
    font-size: 20px; line-height: 1;
  }
  .modal-body {
    padding: 18px 20px;
  }
  .modal-label {
    display: block; font-weight: 700; color: var(--text-dark); margin-bottom: 8px;
  }
  .modal-textarea {
    width: 100%; padding: 14px;
    border: 2px solid var(--border-color); border-radius: 8px;
    font-size: 16px; resize: vertical;
    transition: box-shadow .2s, border-color .2s;
  }
  .modal-textarea:focus {
    outline: none; border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(10,95,143,.12);
  }
  .modal-hint {
    margin-top: 10px; color: #6B7280; font-size: 13px;
    background: var(--light-blue); padding: 10px 12px; border-radius: 8px;
  }
  .modal-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    padding: 14px 20px; border-top: 1px solid var(--border-color);
    background: #FAFAFA;
  }

  /* ====== تقييم احترافي ====== */
.rating-pro {
  display: flex; align-items: center; gap: 10px; justify-content: center;
}
.rating-pro .star {
  font-size: 30px; cursor: pointer; user-select: none; transition: transform .15s ease;
}
.rating-pro .star:hover { transform: scale(1.12); }
.rating-pro .star.dim { color: #D1D5DB; }          /* غير مُفعّل */
.rating-pro .star.lit { color: #D4AF37; }          /* مُضاءة */

.rating-scale {
  display: grid; grid-template-columns: repeat(5, minmax(0,1fr));
  gap: 6px; margin-top: 10px;
}
.rating-chip {
  text-align: center; font-size: 12px; padding: 6px 8px; border-radius: 999px;
  border: 1px solid #E5E7EB; color: #374151; background: #F9FAFB;
}
.rating-chip.active {
  background: #FFF7E6; border-color: #FBBF24; color: #92400E; font-weight: 700;
}

.rating-note {
  margin-top: 10px; color: #6B7280; font-size: 13px; text-align: center;
}

/* مودال التقييم */
.modal-backdrop--rating { z-index: 10001; }
.modal-rating .modal-header { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
.modal-rating .modal-body label { font-weight: 700; color: #0F172A; margin-bottom: 8px; display:block; }
.modal-rating .modal-textarea { min-height: 90px; }

/* شارة تقييم في البطاقات */
.rating-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; background:#FEF9C3; color:#854D0E; border:1px solid #FDE68A; font-weight:700; font-size:12px;
}

</style>
</head>


<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <h1>سجل المواقف اليومية للمتدربين</h1>
                <p>وكالة شؤون المتدربين - وحدة الخدمات الإرشادية</p>
                <p style="font-size: 14px; margin-top: 10px;">المؤسسة العامة للتدريب التقني والمهني</p>
            </div>
            <div class="content">
                <div class="login-form">
                    <h2 style="color: var(--primary-blue); margin-bottom: 30px;">تسجيل الدخول</h2>
                    <div class="form-group">
                        <label>الرقم التدريبي أو الرقم الوظيفي</label>
                        <input type="text" id="userId" placeholder="أدخل الرقم التدريبي أو الرقم الوظيفي" required>
                    </div>
                    <button class="btn btn-primary" onclick="login()">دخول</button>
                </div>
            </div>
        </div>

        <!-- Advisory Services Unit Interface -->
        <div id="advisoryInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1>وحدة الخدمات الإرشادية</h1>
                <p id="welcomeMessage"></p>
            </div>
            <div class="content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'newTicket')">تذكرة جديدة</button>
                    <button class="tab" onclick="switchTab(event, 'myRequests')">طلباتي</button>
                    <button class="tab" onclick="switchTab(event, 'statistics')">الإحصائيات</button>
                    <button class="tab hidden" id="advisoryTabRatings" onclick="switchTab(event, 'advisoryRatings')">التقييمات</button>
                </div>

                <!-- New Ticket Tab -->
                 <!-- تبويب التقييمات لوحدة الإرشاد -->
                    <div id="advisoryRatings" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">التقييمات</h2>
                    <div id="advisoryRatingsList">
                        <p style="text-align: center; color: #999;">جاري تحميل التقييمات...</p>
                    </div>
                    </div>

                <div id="newTicket" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">إنشاء تذكرة جديدة</h2>
                    <div class="form-group">
                        <label>الرقم التدريبي للمتدرب</label>
                        <input type="text" id="traineeId" placeholder="أدخل الرقم التدريبي">
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="loadTraineeData()">جلب البيانات</button>
                    </div>

                    <div id="traineeInfo" class="hidden">
                        <div class="info-card">
                            <h3 style="color: var(--primary-blue); margin-bottom: 15px;">بيانات المتدرب</h3>
                            <div class="info-row">
                                <div class="info-item">
                                    <strong>اسم المتدرب</strong>
                                    <span id="traineeName">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>الرقم التدريبي</strong>
                                    <span id="traineeIdDisplay">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>القسم</strong>
                                    <span id="traineeDept">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>التخصص</strong>
                                    <span id="traineeSpec">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>المرشد التدريبي</strong>
                                    <span id="traineeAdvisor">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>تاريخ اليوم</strong>
                                    <span id="currentDate">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>اليوم</strong>
                                    <span id="currentDay">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div class="form-group">
                            <label>طلب الخدمة المقدمة</label>
                            <div class="service-buttons">
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="سلوكية">
                                    <span>سلوكية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="مالية">
                                    <span>مالية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="تدريبية">
                                    <span>تدريبية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="اجتماعية">
                                    <span>اجتماعية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="مواصلات وسكن">
                                    <span>مواصلات وسكن</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="أخرى">
                                    <span>أخرى</span>
                                </label>
                            </div>
                        </div>

                        <div id="otherServiceDiv" class="form-group hidden">
                            <label>اكتب نوع الخدمة</label>
                            <input type="text" id="otherService" placeholder="حدد نوع الخدمة">
                        </div>

                        <div class="form-group">
                            <label>تفاصيل الطلب</label>
                            <textarea id="requestDetails" rows="4" placeholder="اكتب تفاصيل الطلب"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                            <button class="btn btn-success" onclick="completeTicket()">إنهاء الطلب</button>
                            <button class="btn btn-warning" onclick="showTransferOptions()">تحويل الطلب</button>
                        </div>

                        <div id="transferOptions" class="hidden" style="margin-top: 20px;">
                                <div class="form-group">
                                <label>تحويل الطلب إلى</label>
                                <div class="service-buttons" id="transferToGroup">
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="advisor">
                                    <span>المرشد التدريبي</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="dept_head">
                                    <span>رئيس القسم</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="elearning">
                                    <span>مدير التدريب الإلكتروني</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainees_vice">
                                    <span>وكيل شؤون المتدربين</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainers_deputy">
                                    <span>وكيل شؤون المدربين</span>
                                    </label>
                                </div>
                                </div>
                            <button class="btn btn-primary" onclick="transferTicketAction()">تأكيد التحويل</button>
                        </div>
                    </div>
                </div>

                <!-- My Requests Tab -->
                <div id="myRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">طلباتي</h2>
                    <div id="requestsList">
                        <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statistics" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">الإحصائيات</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalTickets">0</div>
                            <div class="stat-label">إجمالي التذاكر</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
                            <div class="stat-number" id="completedTickets">0</div>
                            <div class="stat-label">التذاكر المكتملة</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
                            <div class="stat-number" id="pendingTickets">0</div>
                            <div class="stat-label">التذاكر المعلقة</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
                            <div class="stat-number" id="inProgressTickets">0</div>
                            <div class="stat-label">قيد التنفيذ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Advisor Interface -->
        <div id="advisorInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1>المرشد التدريبي</h1>
                <p id="advisorWelcome"></p>
            </div>
            <div class="content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'assignedTickets')">التذاكر المحولة لي</button>
                    <button class="tab" onclick="switchTab(event, 'advisorRequests')">طلباتي</button>
                </div>

                <div id="assignedTickets" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">التذاكر المحولة لي</h2>
                    <div id="advisorTicketsList">
                        <p style="text-align: center; color: #999;">جاري تحميل التذاكر...</p>
                    </div>
                    <div class="alert alert-info" style="margin-top: 30px;">
                        <span>ℹ️</span>
                        <span>نأمل إبلاغ المتدرب بتقييم مستوى الخدمة بعد الانتهاء للدخول وتقييم الخدمة المقدمة له</span>
                    </div>
                </div>

                <div id="advisorRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">طلباتي</h2>
                    <div id="advisorRequestsList">
                        <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Head / Deputy Interface -->
         <div id="managementInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1 id="managementTitle">لوحة الإدارة</h1>
                <p id="managementWelcome"></p>
            </div>

            <div class="content">
                <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'managementAll')">جميع الطلبات</button>
                <button class="tab hidden" id="tabRatings" onclick="switchTab(event, 'managementRatings')">التقييمات</button>
                <button class="tab" onclick="switchTab(event, 'managementStats')">الإحصائيات</button>
                </div>

                <!-- تبويب جميع الطلبات -->
                <div id="managementAll" class="tab-content active">
                <div id="managementTicketsList">
                    <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
                </div>
                </div>

                <!-- تبويب التقييمات -->
                <div id="managementRatings" class="tab-content">
                <div id="ratingsList">
                    <p style="text-align: center; color: #999;">جاري تحميل التقييمات...</p>
                </div>
                </div>

                <!-- تبويب الإحصائيات -->
                <div id="managementStats" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                    <div class="stat-number" id="m_totalTickets">0</div>
                    <div class="stat-label">إجمالي التذاكر</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
                    <div class="stat-number" id="m_completedTickets">0</div>
                    <div class="stat-label">التذاكر المكتملة</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
                    <div class="stat-number" id="m_pendingTickets">0</div>
                    <div class="stat-label">التذاكر المعلقة</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
                    <div class="stat-number" id="m_inProgressTickets">0</div>
                    <div class="stat-label">قيد التنفيذ</div>
                    </div>
                </div>
                </div>
            </div>
            </div>



        <!-- Trainee Interface -->
        <div id="traineeInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1>تقييم الخدمة</h1>
                <p id="traineeWelcome"></p>
            </div>
            <div class="content">
                <h2 style="color: var(--primary-blue); margin-bottom: 25px;">تذاكري</h2>
                <div id="traineeTicketsList">
                    <p style="text-align: center; color: #999;">جاري تحميل التذاكر...</p>
                </div>
                <div class="alert alert-info" style="margin-top: 30px;">
                    <span>ℹ️</span>
                    <span><strong>ملاحظة:</strong> لمعرفة تفاصيل التذكرة نأمل مراجعة المسؤول</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 المؤسسة العامة للتدريب التقني والمهني - جميع الحقوق محفوظة</p>
        </div>
    </div>

    <!-- تضمين ملف API -->
    <script src="api_integration.js"></script>

    <script>
        let currentUser = null;
        let currentTraineeData = null;

        let __ratingTicketNumber = null;
        let __ratingValue = 0;

        let __lastTraineeTickets = [];   // آخر قائمة لتذاكر المتدرب
        let __ratingSubmitting   = false; // يمنع النقر المكرر أثناء الإرسال


        const RATING_LABELS = {
        1: 'سيئ',
        2: 'مقبول',
        3: 'جيد',
        4: 'جيد جدًا',
        5: 'ممتاز'
        };

        function buildRatingUI(containerStars, containerScale, current=0) {
        // نجوم
        containerStars.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const s = document.createElement('span');
            s.textContent = '★';
            s.className = 'star ' + (i <= current ? 'lit' : 'dim');
            s.title = `${i} - ${RATING_LABELS[i]}`;
            s.onclick = () => selectRating(i);
            containerStars.appendChild(s);
        }

        // شرائح لفظية
        containerScale.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const chip = document.createElement('div');
            chip.className = 'rating-chip' + (i === current ? ' active' : '');
            chip.textContent = `${i} — ${RATING_LABELS[i]}`;
            chip.onclick = () => selectRating(i);
            containerScale.appendChild(chip);
        }

        const note = document.getElementById('ratingNote');
        note.textContent = current ? `اخترت: ${current} — ${RATING_LABELS[current]}` : 'اختر من 1 (سيئ) إلى 5 (ممتاز)';
        }

        function selectRating(val) {
        __ratingValue = val;
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        if (stars && scale) buildRatingUI(stars, scale, __ratingValue);
        }

        function openRatingModal(ticketNumber) {
        // حماية: لا تفتح لو كانت مقيّمة مسبقًا
        if (isTicketRatedLocal(ticketNumber)) {
            showSuccess('تم تقديم تقييم لهذه التذكرة مسبقًا ✅');
            return;
        }

        __ratingTicketNumber = ticketNumber;
        __ratingValue = 0;

        const modal = document.getElementById('ratingModal');
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        const textarea = document.getElementById('ratingComment');

        if (textarea) textarea.value = '';
        if (stars && scale) buildRatingUI(stars, scale, 0);

        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => { stars?.querySelector('.star')?.focus?.(); }, 50);
        }
        }


        function getRoleCapabilities(user){
        const r = normalizeRole(user?.role || user?.data?.role || '');
        const CAPS = {
            dean: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            quality_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            trainees_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','managementStats','allTickets','reports'] },
            advisory_unit: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['newTicket','myRequests','assignedTickets','statistics','ratingsBoard'] },
            trainers_deputy: { scope:'all', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:['dashboard','managementAll','managementStats'] },
            dept_head: { scope:'department', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['deptTickets','managementStats'] }, // ← (اختياري) تفعيل الإنهاء لرئيس القسم
            advisor: { scope:'assigned_and_self', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['assignedTickets','advisorRequests','myRequests'] },

            // ✅ جديد: التدريب الإلكتروني
            elearning: { scope:'assigned_or_transferred', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['managementAll','managementStats'] },

            trainee: { scope:'self', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['newTicket','traineeTicketsList','rateService'] }
        };
        return CAPS[r] || { scope:'none', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:[] };
        }


        function closeRatingModal() {
        const modal = document.getElementById('ratingModal');
        if (modal) modal.classList.add('hidden');
        __ratingTicketNumber = null;
        __ratingValue = 0;
        }

        // خريطة موحّدة لاسم الشارة ونصها

        function statusBadgeText(st) {
        if (st === 'completed') return 'مكتملة';
        if (st === 'in_progress') return 'قيد التنفيذ';
        return 'معلقة';
        }

        // (اختياري) أبقي الدالتين القديمتين لكن وجّهها للخريطة الجديدة
        function statusBadgeClass(st){ if (st === 'completed') return 'ticket-status--completed'; if (st === 'in_progress') return 'ticket-status--inprogress'; return 'ticket-status--pending'; }
        // تحديث حالة تذكرة
        if (typeof window.updateTicketStatus !== 'function') {

        window.updateTicketStatus = async (ticketNumber, payload) => {
            const res = await sendRequest('updateTicketStatus', { ticketNumber, ...payload });
            return !!(res && res.success);
        };
        }

        
        // تحويل تذكرة
        if (typeof window.transferTicket !== 'function') {
        window.transferTicket = async (ticketNumber, to, by) => {
            const res = await sendRequest('transferTicket', { ticketNumber, to, by });
            return !!(res && res.success);
        };
        }

        // إنهاء تذكرة (تسجيل الحل)
        if (typeof window.completeTicketRequest !== 'function') {
        window.completeTicketRequest = async (ticketNumber, solutionText, completedBy, completionDate) => {
            const payload = { ticketNumber, solutionText, completedBy };
            if (completionDate) payload.completionDate = completionDate;
            const res = await sendRequest('completeTicket', payload);
            return !!(res && res.success);
        };
        }

        async function submitTraineeRating() {
        // تحقق أساسي
        if (!__ratingTicketNumber) { showError('رقم التذكرة غير معروف'); return; }
        if (!__ratingValue)        { showError('الرجاء اختيار تقييم من 1 إلى 5'); return; }
        if (__ratingSubmitting)     return; // منع النقر مرتين

        // زر الإرسال (لتعطيله أثناء الإرسال)
        const btn = document.querySelector('#ratingModal .btn.btn-success');

        // فحص محلي سريع: هل هذه التذكرة مُقيّمة في الذاكرة/العرض؟
        try {
            if (Array.isArray(__lastTraineeTickets)) {
            const localHit = __lastTraineeTickets.find(
                x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (localHit) {
                // إغلاق وتهذيب الواجهة
                closeRatingModal();
                showSuccess('هذه التذكرة مُقيّمة بالفعل ✅');
                return;
            }
            }
        } catch (_) { /* تجاهل أي خطأ محلي */ }

        __ratingSubmitting = true;
        if (btn) { btn.disabled = true; btn.textContent = 'جارٍ الإرسال...'; }

        try {
            // فحص حديث من المصدر (قد يكون قيّم من جهاز آخر)
            const fresh = await loadTraineeTickets(currentUser.id);
            const already = (fresh || []).find(
            x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (already) {
            // حدّث الذاكرة والعرض ثم اخرج
            __lastTraineeTickets = fresh;
            displayTraineeTickets(__lastTraineeTickets);
            closeRatingModal();
            showSuccess('تم تقديم التقييم لهذه التذكرة مسبقًا ✅');
            return;
            }

            // إرسال الطلب للخادوم (Apps Script) — يجب أن يعيد {success, code?}
            const comment = (document.getElementById('ratingComment')?.value || '').trim();
            showLoading('جاري حفظ التقييم...');
            const res = await saveRating(__ratingTicketNumber, __ratingValue, comment);
            hideLoading();

            // معالجة ردّ الخادوم
            if (!res || res.success === false) {
            if (res?.code === 'ALREADY_RATED') {
                // 🔒 قفل الخادوم: لا يسمح بالتقييم مرة أخرى
                closeRatingModal();
                showError('تم تقييم هذه التذكرة مسبقًا — لا يمكنك التقييم مرة أخرى.');
                // إعادة تحميل قائمة المتدرب لإخفاء زر "قيّم"
                if (typeof loadTraineeTicketsView === 'function') await loadTraineeTicketsView();
                return;
            }
            showError(res?.message || 'تعذّر حفظ التقييم، حاول لاحقًا.');
            return;
            }

            // نجاح
            closeRatingModal();
            showSuccess('تم استلام تقييمك. شكرًا لك!');

            // حدّث القوائم — سيختفي زر "قيّم الخدمة" وتظهر الشارة
            await loadTraineeTicketsView();

            // تحديث محلي فوري (في حال لم يُعاد الجلب أو لتسريع الانعكاس)
            try {
            if (Array.isArray(__lastTraineeTickets)) {
                const idx = __lastTraineeTickets.findIndex(
                x => String(x.ticketNumber) === String(__ratingTicketNumber)
                );
                if (idx >= 0) {
                __lastTraineeTickets[idx].rating = Number(__ratingValue);
                __lastTraineeTickets[idx].ratingComment = comment;
                displayTraineeTickets(__lastTraineeTickets);
                }
            }
            } catch (_) { /* اختياري */ }

        } catch (e) {
            hideLoading();
            showError(e?.message || String(e));
        } finally {
            __ratingSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'إرسال التقييم'; }
        }
        }

        // إغلاق بالمفتاح ESC والنقر خارج المودال
        document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeRatingModal(); });
        document.addEventListener('click', (ev) => {
        const m = document.getElementById('ratingModal');
        if (m && ev.target === m) closeRatingModal();
        });
        // ✅ 3) من يملك الصلاحيات العليا (يشوف كل الإدارات + تبويب "التقييمات")
        function hasFullAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return ['dean','trainees_vice','quality_vice','advisory_unit'].includes(r);
        }



        function hasOrgViewNoRatings() { // وكيل شؤون المدربين
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'trainers_deputy';
        }

        // ✅ 4) من يملك صلاحية نطاق القسم فقط (بدون تبويب "التقييمات")
        function hasDeptScopedAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'dept_head';
        }

        async function login() {
        const userId = (document.getElementById('userId')?.value || '').trim();

        if (!userId) {
            showError('الرجاء إدخال الرقم التدريبي أو الرقم الوظيفي');
            return;
        }

        try {
            // يفترض أن checkUserPermission تستدعي Apps Script وتعيد {type, name, role?, department?...}
            const userData = await checkUserPermission(userId);

            if (!userData || userData.success === false) {
            showError(userData?.message || 'الرقم غير موجود في النظام');
            return;
            }

            // لو كانت الاستجابة مباشرة من الدالة (بدون success):
            const payload = userData.data ? userData.data : userData;

            // طَبِّع الدور (إن وُجد)
            const role = normalizeRole(payload.role || '');

            // خزّن المستخدم الحالي بشكل موحّد ومتوفّر عالميًا
            currentUser = {
            id: userId,
            data: { ...payload, role }
            };
            window.currentUser = currentUser;

            // توجيه حسب نوع الحساب
            if (payload.type === 'trainee') {
            showTraineeInterface();
            return;
            }

            if (payload.type === 'staff') {
            switch (role) {
                case 'advisory_unit':
                showAdvisoryInterface();
                return;

                case 'advisor':
                showAdvisorInterface();
                return;
                // داخل switch(role) في login()
                case 'elearning':
                showManagementInterface();
                return;

                // لوحة الإدارة للأدوار الإدارية:
                case 'dept_head':        // رئيس القسم: يرى قسمه فقط
                case 'trainees_vice':    // وكيل شؤون المتدربين: كل الأقسام + تبويب التقييمات
                case 'trainers_deputy':  // وكيل شؤون المدربين: كل الأقسام بدون تبويب التقييمات
                case 'dean':
                case 'quality_vice':
                showManagementInterface();
                return;

                default:
                showError('صلاحية غير معروفة');
                return;
            }
            }

            // لو لم يكن Trainee أو Staff
            showError('نوع مستخدم غير مدعوم');
        } catch (err) {
            showError(err?.message || 'حدث خطأ أثناء تسجيل الدخول');
        }
        }
          document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('userId');
                if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                    }
                });
                }
            });
        // تحويل أي قيمة قديمة (camelCase) إلى الشكل الموحّد (snake_case)
            // تطبيع الأدوار القديمة/الجديدة لنفس الشكل
            function normalizeRole(role=''){
            let v = String(role || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g,'_');

            // تطبيع مباشر للإنجليزية/العربية
            const map = {
                // إنجليزي قديم/متنوع
                'depthead':'dept_head',
                'dept_head':'dept_head',
                'qualityvice':'quality_vice',
                'quality_vice':'quality_vice',
                'advisoryunit':'advisory_unit',
                'advisory_unit':'advisory_unit',
                'dean':'dean',
                'elearning':'elearning',
                'advisor':'advisor',
                'trainees_deputy':'trainees_vice',
                'trainees_vice':'trainees_vice',
                'trainers_deputy':'trainers_deputy',

                // عربي
                'العميد':'dean',
                'وكيل_ضبط_الجودة':'quality_vice',
                'وكيل_شؤون_المتدربين':'trainees_vice',
                'وكيل_شؤون_المدربين':'trainers_deputy',
                'وحدة_الخدمات_الإرشادية':'advisory_unit',
                'وحدة_الخدمات_الارشادية':'advisory_unit',
                'رئيس_القسم':'dept_head',
                'التدريب_الإلكتروني':'elearning',
                'التدريب_الالكتروني':'elearning',
                'المرشد':'advisor',
                'المرشد_التدريبي':'advisor',
                'متدرب':'trainee'
            };

            // تحويل بعض الأشكال الإنجليزية الشائعة قبل الخريطة
            v = v
                .replace(/^depthead$/,'dept_head')
                .replace(/^qualityvice$/,'quality_vice')
                .replace(/^advisoryunit$/,'advisory_unit')
                .replace(/^dean$/,'dean')
                .replace(/^trainees_deputy$/,'trainees_vice');

            return map[v] || v;
            }

                const ROLE_LABELS = {
                dean: 'العميد',
                quality_vice: 'وكيل ضبط الجودة',
                trainees_vice: 'وكيل شؤون المتدربين',
                trainers_deputy: 'وكيل شؤون المدربين',   // ← جديد
                advisory_unit: 'وحدة الخدمات الإرشادية',
                dept_head: 'رئيس القسم',
                advisor: 'المرشد/المدرب',
                elearning: 'التدريب الإلكتروني'
                };

            function labelOf(v) {
            const key = normalizeRole(v);
            return ROLE_LABELS[key] || v;
            }


        function logout() {
        currentUser = null;
        window.currentUser = null; // 👈 مهم لمسح النسخة العالمية
        currentTraineeData = null;
        closeRatingModal?.();
        closeSolutionModal?.();
        document.getElementById('userId').value = '';
        hideAllInterfaces();
        document.getElementById('loginScreen').classList.remove('hidden');
        }


        function hideAllInterfaces() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('advisoryInterface').classList.add('hidden');
            document.getElementById('advisorInterface').classList.add('hidden');
            document.getElementById('managementInterface').classList.add('hidden');
            document.getElementById('traineeInterface').classList.add('hidden');
        }

        async function showAdvisoryInterface() {
        hideAllInterfaces();
        document.getElementById('advisoryInterface').classList.remove('hidden');
        document.getElementById('welcomeMessage').textContent = `مرحباً ${currentUser.data.name}`;

        // 👇 أظهر تبويب "التقييمات" لوحدة الخدمات الإرشادية
        const advRatingsBtn = document.getElementById('advisoryTabRatings');
        if (advRatingsBtn) advRatingsBtn.classList.remove('hidden');

        await loadStatistics();
        }


        async function showAdvisorInterface() {
            hideAllInterfaces();
            document.getElementById('advisorInterface').classList.remove('hidden');
            document.getElementById('advisorWelcome').textContent = `مرحباً ${currentUser.data.name}`;
            await loadAdvisorTicketsView();
        }


        // ✅ 5) إظهار لوحة الإدارة بحسب الدور
        async function showManagementInterface() {
        hideAllInterfaces();
        document.getElementById('managementInterface').classList.remove('hidden');

        const role = normalizeRole(currentUser.data.role);
        const title =
            role === 'dean' ? 'العميد' :
            role === 'quality_vice' ? 'وكيل ضبط الجودة' :
            role === 'trainees_vice' ? 'وكيل شؤون المتدربين' :
            role === 'trainers_deputy' ? 'وكيل شؤون المدربين' :
            role === 'advisory_unit' ? 'وحدة الخدمات الإرشادية' :
            role === 'elearning'       ? 'التدريب الإلكتروني' : // 👈 أضف هذه
            role === 'dept_head' ? 'رئيس القسم' : 'لوحة الإدارة';

        document.getElementById('managementTitle').textContent = title;
        document.getElementById('managementWelcome').textContent = `مرحباً ${currentUser.data.name}`;

        // زر تبويب "التقييمات" (يجب أن يكون موجوداً في الـ HTML بعنصر #tabRatings)
        const ratingsTabBtn = document.getElementById('tabRatings');
        if (ratingsTabBtn) {
            if (hasFullAccess()) ratingsTabBtn.classList.remove('hidden');
            else ratingsTabBtn.classList.add('hidden');
        }

        await loadManagementTicketsView();
        }


        async function loadManagementRatingsView(listId = 'ratingsList') {
        if (!hasFullAccess()) {
            const target = document.getElementById(listId);
            if (target) {
            target.innerHTML = '<p style="text-align:center;color:#999;">لا تملك صلاحية عرض التقييمات</p>';
            }
            return;
        }

        const box = document.getElementById(listId);
        if (!box) return;
        box.innerHTML = '<p style="text-align:center;color:#999;">جاري تحميل التقييمات...</p>';

        let tickets = await loadAllTickets();
        tickets = Array.isArray(tickets) ? tickets : [];

        const rated = tickets.filter(t => String(t.status) === 'completed' && Number(t.rating) > 0);

        if (!rated.length) {
            box.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تقييمات حتى الآن</p>';
            return;
        }

        const card = (t) => {
            const stars   = Number(t.rating) || 0;
            const comment = (t.ratingComment || '').trim();
            const actionTaken = t.actionTaken || t['الاجراء المتخذ'] || t.updateAction || '-';
            const solution = t.solution || t.executedSolution || t['الحل المنفذ'] || t.solutionText || '-';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ticket-status--completed">مكتملة</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span><span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span><span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">تاريخ الإنهاء:</span><span class="v">${t.completionDate || t.date || '-'}</span></div>
                </div>

                <div class="ticket-details">
                <div><strong>التقييم:</strong> ★ ${stars}/5</div>
                ${comment ? `<div style="margin-top:6px;"><strong>تعليق المتدرب:</strong> <em>${comment}</em></div>` : ''}
                <div style="margin-top:6px;"><strong>الحل المنفذ:</strong> ${solution}</div>
                <div style="margin-top:6px;"><strong>الإجراء المتخذ:</strong> ${actionTaken}</div>
                ${t.completedBy ? `<div style="margin-top:6px;">تم بواسطة: <strong>${t.completedBy}</strong></div>` : ''}
                </div>
            </div>
            `;
        };

        try { rated.sort((a,b) => new Date(b.completionDate || b.date || 0) - new Date(a.completionDate || a.date || 0)); } catch(_){}

        box.innerHTML = rated.map(card).join('');
        }

        async function showTraineeInterface() {
            hideAllInterfaces();
            document.getElementById('traineeInterface').classList.remove('hidden');
            document.getElementById('traineeWelcome').textContent = `مرحباً ${currentUser.data.name}`;
            await loadTraineeTicketsView();
        }


        async function loadTraineeData() {
            const traineeId = document.getElementById('traineeId').value.trim();
            
            if (!traineeId) {
                showError('الرجاء إدخال الرقم التدريبي');
                return;
            }

            const trainee = await getTraineeById(traineeId);
            
            if (trainee) {
                currentTraineeData = trainee;
                
                document.getElementById('traineeName').textContent = trainee.name;
                document.getElementById('traineeIdDisplay').textContent = traineeId;
                document.getElementById('traineeDept').textContent = trainee.department;
                document.getElementById('traineeSpec').textContent = trainee.specialization;
                document.getElementById('traineeAdvisor').textContent = trainee.advisor;
                
                const now = new Date();
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA');
                document.getElementById('currentDay').textContent = days[now.getDay()];
                
                document.getElementById('traineeInfo').classList.remove('hidden');
            } else {
                showError('الرقم التدريبي غير موجود');
            }
        }

        function handleServiceTypeChange() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked');
            const otherDiv = document.getElementById('otherServiceDiv');
            
            if (serviceType && serviceType.value === 'أخرى') {
                otherDiv.classList.remove('hidden');
            } else {
                otherDiv.classList.add('hidden');
            }
        }

        // إضافة مستمع للأزرار
        document.addEventListener('DOMContentLoaded', function() {
            const serviceButtons = document.querySelectorAll('input[name="serviceType"]');
            serviceButtons.forEach(btn => {
                btn.addEventListener('change', handleServiceTypeChange);
            });
        });

        function showTransferOptions() {
            document.getElementById('transferOptions').classList.remove('hidden');
        }

        async function completeTicket() {
        if (!currentTraineeData) {
            showError('الرجاء جلب بيانات المتدرب أولاً');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();

        if (!serviceTypeRadio || !details) {
            showError('الرجاء اختيار نوع الخدمة وكتابة تفاصيل الطلب');
            return;
        }

        // تفاصيل الطلب = الحل المنفذ
        const solutionText = details;

        const now  = new Date();
        const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

        const serviceType = serviceTypeRadio.value === 'أخرى'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'أخرى' && !serviceType) {
            showError('الرجاء تحديد نوع الخدمة');
            return;
        }

        // 1) إنشاء التذكرة للحصول على رقمها (تبقى pending الآن)
        const payload = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            createdBy:      currentUser.data.name
        };

        showLoading('جاري إنشاء التذكرة...');
        const createRes = await saveNewTicket(payload);
        hideLoading();

        if (!createRes?.success || !createRes.ticketNumber) {
            showError('تعذّر إنشاء التذكرة');
            return;
        }

        const ticketNumber = createRes.ticketNumber;

        // 2) إكمال التذكرة فورًا — هذا ما يكتب "الحل المنفذ" في الأعمدة الصحيحة + السجل اليومي
        const completionDate = now.toLocaleDateString('ar-SA');

        showLoading('جاري إنهاء التذكرة وتسجيل الحل...');
        const ok = await completeTicketRequest(ticketNumber, solutionText, currentUser.data.name, completionDate);
        hideLoading();

        if (ok) {
            resetTicketForm();
            showSuccess('تم إنهاء التذكرة وتسجيل "الحل المنفذ" بنجاح');
            // تحديث واجهات إن لزم
            if (typeof loadStatistics === 'function') loadStatistics();
            if (typeof loadMyRequests === 'function') loadMyRequests('requestsList');
        } else {
            showError('تم إنشاء التذكرة، لكن تعذّر إنهاؤها. جرّب من شاشة التذاكر.');
        }
        }

        async function transferTicketAction() {
        if (!currentTraineeData) {
            showError('الرجاء جلب بيانات المتدرب أولاً');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();
        const transferRadio = document.querySelector('input[name="transferTo"]:checked');

        if (!serviceTypeRadio || !details || !transferRadio) {
            showError('الرجاء إكمال جميع الحقول');
            return;
        }

        let transferTo = normalizeRole(transferRadio.value);

        const serviceType = serviceTypeRadio.value === 'أخرى'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'أخرى' && !serviceType) {
            showError('الرجاء تحديد نوع الخدمة');
            return;
        }

        const now = new Date();
        const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

        const ticketData = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            transferredTo:  transferTo,
            createdBy:      currentUser.data.name
        };

        const result = await saveNewTicket(ticketData);
        if (result.success) resetTicketForm();
        }


        async function saveNewTicket(payload) {
        const res = await sendRequest('createTicket', payload);

        if (res && res.success) {
            const tn = res?.data?.ticketNumber ?? res?.ticketNumber ?? '—';
            showSuccess(`تم إنشاء التذكرة بنجاح! رقم التذكرة: ${tn}`);
            return { success: true, ticketNumber: tn };
        } else {
            showError(res?.message || 'تعذّر إنشاء التذكرة');
            return { success: false };
        }
        }

        function resetTicketForm() {
            document.getElementById('traineeId').value = '';
            document.querySelectorAll('input[name="serviceType"]').forEach(btn => btn.checked = false);
            document.getElementById('requestDetails').value = '';
            document.getElementById('otherService').value = '';
            document.getElementById('traineeInfo').classList.add('hidden');
            document.getElementById('transferOptions').classList.add('hidden');
            document.getElementById('otherServiceDiv').classList.add('hidden');
            currentTraineeData = null;
        }

        async function loadStatistics() {
            const stats = await calculateStatistics();
            
            document.getElementById('totalTickets').textContent = stats.total || 0;
            document.getElementById('completedTickets').textContent = stats.completed || 0;
            document.getElementById('pendingTickets').textContent = stats.pending || 0;
            document.getElementById('inProgressTickets').textContent = stats.inProgress || 0;
        }

        // ✅ جديد: يعرض أزرار “بدء المعالجة/إنهاء/تحويل” ويستخدم تفويض أحداث

        async function loadAdvisorTicketsView() {
        const containerId = 'advisorTicketsList';
        const container = document.getElementById(containerId);
        container.innerHTML = '<p style="text-align:center;color:#999;">جاري تحميل التذاكر...</p>';

        const ticketsRaw = await loadAdvisorTickets(currentUser.data.name);
        const tickets = (ticketsRaw || []).filter(t => String(t.status) !== 'completed');

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر محوّلة لك</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';

            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">بدء المعالجة</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">تم الحل</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">تحويل</button>
                </div>
            </div>
            `;
        }).join('');

        // تفويض أحداث الأزرار
        container.onclick = async (ev) => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const ticketNumber = btn.getAttribute('data-ticket');
            if (!ticketNumber) { showError('رقم التذكرة غير معروف'); return; }

            try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser.data.name,
                startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadAdvisorTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                const to = prompt('حوّل إلى من؟ (اكتب الاسم أو الدور مثل advisor / dept_head / elearning / trainees_vice)');
                if (!to || !to.trim()) { showError('لم يتم تحديد جهة التحويل'); return; }
                const ok = await transferTicket(ticketNumber, to.trim(), currentUser.data.name);
                if (ok) await loadAdvisorTicketsView();
            }
            } catch (err) {
            showError(err?.message || String(err));
            }
        };
        }


        // ✅ 6) تحميل طلبات الإدارة بما يناسب الدور
        async function loadManagementTicketsView() {
        const role   = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myName = (currentUser?.data?.name || '').trim();   // 👈 تعريف الاسم هنا
        let tickets  = [];

        if (hasFullAccess()) {
            // العميد + وكيل المتدربين + ضبط الجودة + وحدة الإرشاد
            tickets = await loadAllTickets();

        } else if (role === 'elearning') {
            // يشوف فقط ما حُوِّل إلى "التدريب الإلكتروني" أو أُسنِد لاسمه
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
            const toRole        = normalizeRole((t.transferredTo || '').trim());
            const toName        = (t.transferredTo || '').trim();
            const assigned      = (t.assignedTo || '').trim();
            // 1) محوّل إلى دور elearning (إنجليزي/عربي بعد normalize)
            const forElearningRole = toRole === 'elearning';
            // 2) محوّل بالاسم إلى نفس المستخدم (لو بعض السجلات تحفظ اسم المسؤول بدلاً من الدور)
            const forMeByName      = toName === myName || assigned === myName;
            return forElearningRole || forMeByName;
            });

        } else if (role === 'trainers_deputy') {
            // وكيل شؤون المدربين: رؤية عامة بدون تبويب التقييمات
            tickets = await loadAllTickets();

        } else if (role === 'dept_head' && myDept) {
            // رئيس القسم: قسمه فقط
            const res = await sendRequest('searchTickets', { department: myDept });
            tickets = (res && res.success) ? res.data : [];
        }


        function displayTicketsWithActions(containerId, tickets){
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!Array.isArray(tickets) || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">بدء المعالجة</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">تم الحل</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">تحويل</button>
                </div>
            </div>
            `;
        }).join('');
        }


        function attachManagementActions(containerId){
        const container = document.getElementById(containerId);
        if (!container) return;

        container.onclick = async (ev) => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const ticketNumber = btn.getAttribute('data-ticket');
            if (!ticketNumber) { showError('رقم التذكرة غير معروف'); return; }

            try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser.data.name,
                startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadManagementTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                const to = prompt('حوّل إلى من؟ (اسم/دور: advisor / dept_head / elearning / trainees_vice ...)');
                if (!to || !to.trim()) { showError('لم يتم تحديد جهة التحويل'); return; }
                const ok = await transferTicket(ticketNumber, to.trim(), currentUser.data.name);
                if (ok) await loadManagementTicketsView();
            }
            } catch (err) {
            showError(err?.message || String(err));
            }
        };
        }


        const caps = getRoleCapabilities(currentUser.data);
        if (caps.canClose) {
        displayTicketsWithActions('managementTicketsList', tickets);
        attachManagementActions('managementTicketsList'); // تفويض أحداث للأزرار
        } else {
        displayTickets('managementTicketsList', tickets); // عرض قراءة فقط
        }   
        }

        async function loadTraineeTicketsView() {
        const tickets = await loadTraineeTickets(currentUser.id);
        __lastTraineeTickets = Array.isArray(tickets) ? tickets : [];
        displayTraineeTickets(__lastTraineeTickets);
        }

        function isTicketRatedLocal(ticketNumber) {
        const t = (__lastTraineeTickets || []).find(x => String(x.ticketNumber) === String(ticketNumber));
        return t && Number(t.rating) > 0;
        }


        // 2) عدّل loadMyRequests لتأخذ containerId وتعرض فيه
        async function loadMyRequests(containerId = 'requestsList') {
        try {
            showLoading('جارٍ تحميل طلباتك...');
            const tickets = await loadAllTickets();
            hideLoading();

            if (!Array.isArray(tickets) || !tickets.length) {
            displayTickets(containerId, []);
            return;
            }

            const meName = (currentUser?.data?.name || '').trim();
            const meRole = normalizeRole((currentUser?.data?.role || '').trim());
            const meType = (currentUser?.data?.type || '').trim();

            let myTickets = [];

            if (meType === 'staff') {
            if (meRole === 'advisory_unit') {
                // 👈 وحدة الخدمات الإرشادية ترى جميع الطلبات في تبويب "طلباتي"
                myTickets = tickets;
            } else {
                myTickets = tickets.filter((t) => {
                const completedBy   = (t.completedBy   || '').trim();
                const createdBy     = (t.createdBy     || '').trim();
                const assignedTo    = (t.assignedTo    || '').trim();
                const advisorName   = (t.advisor       || '').trim();
                const transferredTo = normalizeRole((t.transferredTo || '').trim());
                return (
                    completedBy === meName ||
                    createdBy   === meName ||
                    assignedTo  === meName ||
                    transferredTo === meName ||
                    transferredTo === meRole ||
                    advisorName === meName
                );
                });
            }
            } else if (meType === 'trainee') {
            myTickets = tickets.filter((t) =>
                String(t.traineeId).trim() === String(currentUser.id).trim()
            );
            } else {
            myTickets = tickets.filter((t) => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy   = (t.createdBy   || '').trim();
                return completedBy === meName || createdBy === meName;
            });
            }

            try { myTickets.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)); } catch (_) {}

            const withLabels = myTickets.map((t) => ({
            ...t,
            transferredToLabel: labelOf(t.transferredTo || '')
            }));

            displayTickets(containerId, withLabels);
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }



        function displayTickets(containerId, tickets) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">التخصص:</span> <span class="v">${t.specialization || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${t.date || '-'}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}

                <div class="ticket-foot">
                ${t.completedBy ? `<span>تم بواسطة: <strong>${t.completedBy}</strong></span>` : ''}
                ${t.completedBy && (t.transferredTo || t.assignedTo) ? '<span class="dot"></span>' : ''}
                ${(t.transferredTo || t.transferredToLabel)  ? `<span>محوّل إلى: <strong>${t.transferredToLabel || labelOf(t.transferredTo)}</strong></span>`: ''}
                ${t.assignedTo ? `<span class="dot"></span><span>مُسنَد إلى: <strong>${t.assignedTo}</strong></span>` : ''}
                </div>
            </div>
            `;
        }).join('');
        }

        function displayTraineeTickets(tickets) {
        const container = document.getElementById('traineeTicketsList');
        if (!container) return;

        const list = Array.isArray(tickets) ? tickets : [];

        // تقسيم التذاكر: مكتملة تحتاج تقييم / مكتملة وتم تقييمها
        const needRating = list.filter(t =>
            String(t.status) === 'completed' && !(Number(t.rating) > 0)
        );
        const rated = list.filter(t =>
            String(t.status) === 'completed' && (Number(t.rating) > 0)
        );

        // بطاقة تذكرة
        const card = (ticket) => {
            const isRated = Number(ticket.rating) > 0;
            const cls = statusBadgeClass(ticket.status); // ✅ الدالة الموحّدة
            const txt = statusBadgeText(ticket.status);  // ✅ الدالة الموحّدة

            const ratingBadge = isRated
            ? `<span class="rating-badge" title="${ticket.rating} — ${RATING_LABELS[ticket.rating] || ''}">★ ${ticket.rating}/5</span>`
            : '';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span><span class="v">${ticket.date || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">المرشد:</span><span class="v">${ticket.advisor || '-'}</span></div>
                </div>

                <div class="ticket-foot">
                ${ratingBadge}
                ${isRated && ticket.ratingComment ? `<span class="dot"></span><span>تعليقك: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(!isRated && String(ticket.status) === 'completed')
                    ? `<span class="dot"></span>
                    <button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">قيّم الخدمة</button>`
                    : ''}
                </div>
            </div>
            `;
        };

        const needHtml = needRating.length
            ? needRating.map(card).join('')
            : `<p style="text-align:center;color:#999;">لا توجد تذاكر مكتملة تنتظر تقييمك</p>`;

        const ratedHtml = rated.length
            ? rated.map(card).join('')
            : `<p style="text-align:center;color:#999;">لا توجد تذاكر مكتملة ومقيَّمة</p>`;

        // التبويبات
        container.innerHTML = `
            <div class="tabs" id="traineeTicketsTabs" style="margin-bottom:16px;">
            <button class="tab active" data-tab="need" onclick="switchTraineeTicketsTab('need')">
                بحاجة لتقييم <span style="opacity:.8;font-size:12px;">(${needRating.length})</span>
            </button>
            <button class="tab" data-tab="rated" onclick="switchTraineeTicketsTab('rated')">
                مكتملة ومقيَّمة <span style="opacity:.8;font-size:12px;">(${rated.length})</span>
            </button>
            </div>

            <div id="traineeTab-need" class="tab-content active">
            ${needHtml}
            </div>
            <div id="traineeTab-rated" class="tab-content">
            ${ratedHtml}
            </div>
        `;
        }


        // حدّث مبدّل التبويبات ليتعامل مع القيم الجديدة: need / rated
        function switchTraineeTicketsTab(which) {
        const tabsBar = document.getElementById('traineeTicketsTabs');
        if (!tabsBar) return;

        tabsBar.querySelectorAll('.tab').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === which);
        });

        ['need','rated'].forEach(name => {
            const pane = document.getElementById('traineeTab-' + name);
            if (pane) pane.classList.toggle('active', name === which);
        });
        }


        async function loadMyTicketsUI() {
                    if (currentUser?.data?.type === 'trainee') {
        await loadTraineeTicketsView(); // نستخدم العرض الحديث فقط
        return;
        }

        try {
            const me = window.currentUser ?? currentUser;   // خذ أيهما متوفر
            if (!me || !me.id) {
            showError('لم يتم التعرف على المستخدم الحالي');
            return;
            }

            showLoading('جاري تحميل طلباتك...');
            const res = await sendRequest('getTraineeTickets', { traineeId: me.id });
            hideLoading();

            if (!res || !res.success) {
            showError(res?.message || 'تعذر تحميل طلباتك');
            return;
            }

            const list = document.getElementById('myTicketsList');
            if (!list) return;
            list.innerHTML = '';

            (res.data || []).forEach((row, i) => {
            const li = document.createElement('li');
            li.className = 'ticket-item';
            li.innerHTML = `
                <div class="ticket-head">
                <span class="ticket-id">#${i + 1}</span>
                <span class="ticket-date">${row['التاريخ'] || ''} (${row['اليوم'] || ''})</span>
                </div>
                <div class="ticket-body">
                <div><strong>المرشد:</strong> ${row['اسم المرشد التدريبي'] || '-'}</div>
                <div><strong>طلب الخدمة:</strong> ${row['طلب الخدمة'] || '-'}</div>
                <div><strong>الحل المنفذ:</strong> ${row['الحل المنفذ'] || row['تفاصيل الطلب'] || '-'}</div>
                </div>
            `;
            list.appendChild(li);
            });
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // ✅ حالة داخلية لحفظ رقم التذكرة المفتوحة في المودال
        let __activeTicketNumber = null;

        function openSolutionModal(ticketNumber) {
        __activeTicketNumber = ticketNumber;
        const modal = document.getElementById('solutionModal');
        const textarea = document.getElementById('solutionText');
        if (!modal || !textarea) return;

        textarea.value = ''; // تصفير كل مرة
        modal.classList.remove('hidden');
        textarea.focus();
        }

        function closeSolutionModal() {
        const modal = document.getElementById('solutionModal');
        if (modal) modal.classList.add('hidden');
        __activeTicketNumber = null;
        }


        async function submitSolution() {
        const textarea = document.getElementById('solutionText');
        const solution = (textarea?.value || '').trim();

        if (!__activeTicketNumber) {
            showError('رقم التذكرة غير معروف');
            return;
        }
        if (!solution) {
            showError('الرجاء كتابة الحل المنفذ');
            textarea?.focus();
            return;
        }

        showLoading('جاري إنهاء التذكرة...');

        // طلب الإنهاء من الخادوم
        const ok = await completeTicketRequest(__activeTicketNumber, solution, currentUser.data.name);

        hideLoading();

        if (ok) {
            // إزالة فورية اختيارية من القائمة الحالية (قبل إعادة التحميل)
            const card = document.querySelector(`.ticket-card[data-ticket="${__activeTicketNumber}"]`);
            if (card) card.remove();

            closeSolutionModal();

            // تعيد تحميل "المحوّلة لي" (لن تظهر المكتملة) + تحدّث "طلباتي"
            if (typeof loadAdvisorTicketsView === 'function') {
            await loadAdvisorTicketsView();
            }
            if (typeof loadMyRequests === 'function') {
            await loadMyRequests();
            }

            showSuccess('تم إنهاء التذكرة وتسجيل الحل بنجاح');
        }
        }


        // ✅ إغلاق بالمفتاح ESC والنقر خارج المربع
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeSolutionModal();
        });
        const _sm = document.getElementById('solutionModal');
        if (_sm) {
        _sm.addEventListener('click', (ev) => {
            if (ev.target.id === 'solutionModal') closeSolutionModal();
        });
        } else {
        // لو المودال تحت السكربت: انتظر DOM جاهز
        document.addEventListener('DOMContentLoaded', () => {
            const sm2 = document.getElementById('solutionModal');
            if (sm2) {
            sm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'solutionModal') closeSolutionModal();
            });
            }
        });
        }


async function switchTab(event, tabName) {
  // 1) تبديل التفعيل داخل نفس .content
  const parentContent = event.target.closest('.content');
  parentContent.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  parentContent.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  // 2) تحميل البيانات بحسب التبويب
  if (tabName === 'statistics') {
    loadStatistics();

  } else if (tabName === 'myRequests') {
    if (currentUser?.data?.type === 'trainee') {
      loadTraineeTickets(currentUser.id).then(list => {
        const holder = document.getElementById('requestsList');
        if (!holder) return;

        holder.innerHTML = '';
        const cards = (list || []).map(ticket => {
        const rated   = Number(ticket.rating) > 0;
        const details = ticket.requestDetails || ticket.details || '-';

        // ✅ استخدم الدوال الموحدة
        const cls = statusBadgeClass(ticket.status);
        const txt = statusBadgeText(ticket.status);

        const ratingBadge = rated
            ? `<span class="rating-badge" title="${ticket.rating} — ${RATING_LABELS[ticket.rating] || ''}">★ ${ticket.rating}/5</span>`
            : '';

        return `
            <div class="ticket-card modern">
            <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || '—'}</span>
            </div>
            <div class="ticket-sep"></div>
            <div class="ticket-grid">
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span><span class="v">${ticket.date || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">المرشد:</span><span class="v">${ticket.advisor || '-'}</span></div>
            </div>
            ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}
            <div class="ticket-foot">
                ${ratingBadge}
                ${rated && ticket.ratingComment ? `<span class="dot"></span><span>تعليقك: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(ticket.status === 'completed' && !rated)
                ? `<span class="dot"></span><button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">قيّم الخدمة</button>`
                : ''}
            </div>
            </div>
        `;
        }).join('');


        holder.innerHTML = cards || '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
      });
    } else {
      loadMyRequests('requestsList');
    }

  } else if (tabName === 'advisorRequests') {
    loadMyRequests('advisorRequestsList');

  } else if (tabName === 'advisoryRatings') {
    // ✅ تبويب تقييمات وحدة الخدمات الإرشادية
    await loadManagementRatingsView('advisoryRatingsList');

  } else if (tabName === 'managementRatings') {
    if (!hasFullAccess()) {
      showError('لا تملك صلاحية عرض التقييمات');
      return;
    }
    await loadManagementRatingsView('ratingsList');

  } else if (tabName === 'managementStats') {
    const stats = await calculateStatistics();
    document.getElementById('m_totalTickets').textContent      = stats.total || 0;
    document.getElementById('m_completedTickets').textContent  = stats.completed || 0;
    document.getElementById('m_pendingTickets').textContent    = stats.pending || 0;
    document.getElementById('m_inProgressTickets').textContent = stats.inProgress || 0;
  }
}


    </script>
    

    <!-- ✅ مودال إنهاء التذكرة بالحــل -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>إنهاء التذكرة بالحل</h3>
      <button class="modal-close" aria-label="اغلاق" onclick="closeSolutionModal()">×</button>
    </div>

    <div class="modal-body">
      <label for="solutionText" class="modal-label">الحل المنفذ <span style="color:#DC3545;">*</span></label>
      <textarea id="solutionText" rows="5" class="modal-textarea" placeholder="اكتب الحل المنفذ بشكل واضح ومختصر..."></textarea>

      <div class="modal-hint">
        💡 أمثلة جيدة: <em>تم التواصل مع المرشد وتحديث الجدول — تم حل التعارض، أعطي المتدرب خطة المتابعة لمدة أسبوع.</em>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeSolutionModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitSolution()">تم الحل</button>
    </div>
  </div>
</div>
<!-- ✅ مودال تقييم المتدرب -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>تقييم الخدمة</h3>
      <button class="modal-close" aria-label="إغلاق" onclick="closeRatingModal()">×</button>
    </div>

    <div class="modal-body">
      <!-- نجوم -->
      <div id="ratingStars" class="rating-pro" style="margin:6px 0 4px;"></div>
      <!-- مقياس لفظي -->
      <div class="rating-scale" id="ratingScale"></div>
      <div class="rating-note" id="ratingNote">اختر من 1 (سيئ) إلى 5 (ممتاز)</div>

      <label for="ratingComment" style="margin-top:14px;">تعليقك على الخدمة (اختياري)</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="اكتب ملاحظتك أو اقتراحك..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeRatingModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">إرسال التقييم</button>
    </div>
  </div>
</div>

</body>
</html>