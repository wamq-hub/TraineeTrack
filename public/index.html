<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل المواقف اليومية للمتدربين - المؤسسة العامة للتدريب التقني والمهني</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --tvtc-primary: #006341;
            --tvtc-primary-700: #0B5C3F;
            --tvtc-primary-100: #E6F1EC;
            --tvtc-secondary: #C8A55C;
            --tvtc-accent: #00A287;
            --tvtc-text: #1F2937;
            --tvtc-text-muted: #6B7280;
            --success: #1E7F5C;
            --warning: #C38E00;
            --error: #C0392B;
            --info: #2563EB;
            --border: #E5E7EB;
            --card: #FFFFFF;
            --surface: #F7FAF9;
            
            /* Compatibility aliases */
            --primary-blue: var(--tvtc-primary);
            --secondary-green: var(--success);
            --accent-gold: var(--tvtc-secondary);
            --light-blue: var(--tvtc-primary-100);
            --dark-blue: var(--tvtc-primary-700);
            --white: #FFFFFF;
            --gray: var(--surface);
            --text-dark: var(--tvtc-text);
            --border-color: var(--border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-blue: var(--tvtc-primary);
            --secondary-green: var(--success);
            --accent-gold: var(--tvtc-secondary);
            --light-blue: var(--tvtc-primary-100);
            --dark-blue: var(--tvtc-primary-700);
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --text-dark: #333333;
            --border-color: #DDD;
        }

        body {
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(10, 95, 143, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--secondary-green);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50%, -50%);
            z-index: 0;              /* تحت كل شيء */
            pointer-events: none;    /* لا يحجب النقر */
        }

        .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        position: relative;
        z-index: 1; /* بحيث يظهر فوق ::before */
        }


        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(10, 95, 143, 0.1);
        }

        .btn {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 95, 143, 0.3);
        }

        .btn-success {
            background: var(--secondary-green);
            color: white;
        }

        .btn-success:hover {
            background: #247d42;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-gold);
            color: var(--dark-blue);
        }

        .btn-warning:hover {
            background: #c5a032;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 30px;
            background: var(--gray);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .info-card {
            background: var(--light-blue);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 5px solid var(--primary-blue);
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .info-item strong {
            color: var(--primary-blue);
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-item span {
            color: var(--text-dark);
            font-size: 15px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-green), var(--accent-gold));
            margin: 30px 0;
            border-radius: 2px;
        }

        .ticket-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ticket-number {
            background: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .ticket-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }


        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border-right: 4px solid #17A2B8;
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border-right: 4px solid #28A745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .rating {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .star {
            font-size: 30px;
            color: #DDD;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover,
        .star.active {
            color: var(--accent-gold);
            transform: scale(1.2);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 2;              /* فوق الزخرفة */
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-blue);
        }

        .footer {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            border-top: 4px solid var(--accent-gold);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }

        .footer-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .footer-main {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .footer-divider {
            width: 80px;
            height: 3px;
            background: var(--accent-gold);
            margin: 15px auto;
            border-radius: 2px;
        }

        .footer-details {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 12px;
        }

        .footer-separator {
            color: var(--accent-gold);
            font-weight: bold;
        }

        .footer-version {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 10px;
            font-style: italic;
        }

        .service-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .service-btn {
            position: relative;
            display: block;
            cursor: pointer;
            padding: 20px;
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .service-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 95, 143, 0.2);
        }

        .service-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .service-btn input[type="radio"]:checked + span {
            color: white;
        }

        .service-btn input[type="radio"]:checked ~ span {
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            border-color: var(--primary-blue);
            color: white;
        }

        .service-btn:has(input[type="radio"]:checked) span {
            color: white;
        }

        .service-btn span {
            display: block;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        /* ========== بطاقة تذكرة حديثة ========== */
        .ticket-card.modern {
        border: 1.5px solid var(--border-color);
        border-radius: 14px;
        padding: 16px;
        background: #fff;
        box-shadow: 0 4px 18px rgba(10,95,143,.06);
        transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .ticket-card.modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 26px rgba(10,95,143,.12);
        border-color: rgba(10,95,143,.25);
        }

        /* رأس البطاقة */
        .ticket-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
        }
        .ticket-id-chip {
        background: var(--dark-blue);
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: .3px;
        font-size: 13px;
        }
        .ticket-status-badge {
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        border: 1px solid transparent;
        }
        .ticket-status--completed {
        background: #E8F5E9;
        color: #1B5E20;
        border-color: #C8E6C9;
        }
        .ticket-status--pending {
        background: #FFF8E1;
        color: #8B6B00;
        border-color: #FFECB3;
        }
        .ticket-status--inprogress {
        background: #E1F5FE;
        color: #01579B;
        border-color: #B3E5FC;
        }

        /* فاصل */
        .ticket-sep {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent);
        margin: 10px 0 14px;
        border-radius: 1px;
        }

        /* شبكة معلومات */
        .ticket-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 10px 18px;
        }
        @media (max-width: 640px) {
        .ticket-grid { grid-template-columns: 1fr; }
        }
        .ticket-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        line-height: 1.7;
        }
        .ticket-row .k {
        min-width: 110px;
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 13px;
        }
        .ticket-row .v {
        color: var(--text-dark);
        font-size: 14px;
        word-wrap: break-word;
        }

        /* التفاصيل نص ممتد */
        .ticket-details {
        margin-top: 6px;
        background: var(--light-blue);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
        color: #0c2b3c;
        border: 1px dashed rgba(10,95,143,.25);
        }

        /* فوتر */
        .ticket-foot {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        color: #6b7280;
        font-size: 12px;
        }
        .ticket-foot .dot {
        width: 4px; height: 4px; border-radius: 50%; background:#c9cdd2;
        display: inline-block; margin-inline: 6px;
        }


        /* ✅ أنماط علامة التحويل */
        .transferred-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .transfer-info {
            background: #FFF3E0;
            border: 1px solid #FFE0B2;
            border-right: 4px solid #FF9800;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: #E65100;
        }

        .transfer-info strong {
            color: #BF360C;
        }

        .transfer-from-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 8px;
        }

.badge.badge-transfer{
  display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:700;
  background:var(--success);color:#fff;vertical-align:middle
}
.ticket-card{border:1px solid #ddd;border-radius:10px;padding:12px;background:#fff;margin-bottom:10px}
.ticket-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.ticket-id{font-weight:800}
.transfer-meta{margin-top:6px;color:#555}

    </style>

    <style>
  /* ✅ تنسيقات المودال */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.45);
    display: flex; align-items: center; justify-content: center;
    z-index: 10000;
    padding: 20px;
  }
  .modal {
    width: 100%; max-width: 640px;
    background: #fff; border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    overflow: hidden;
    border: 2px solid var(--border-color);
  }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
    color: #fff;
  }
  .modal-close {
    background: transparent; border: 2px solid #fff; color: #fff;
    width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
    font-size: 20px; line-height: 1;
  }
  .modal-body {
    padding: 18px 20px;
  }
  .modal-label {
    display: block; font-weight: 700; color: var(--text-dark); margin-bottom: 8px;
  }
  .modal-textarea {
    width: 100%; padding: 14px;
    border: 2px solid var(--border-color); border-radius: 8px;
    font-size: 16px; resize: vertical;
    transition: box-shadow .2s, border-color .2s;
  }
  .modal-textarea:focus {
    outline: none; border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(10,95,143,.12);
  }
  .modal-hint {
    margin-top: 10px; color: #6B7280; font-size: 13px;
    background: var(--light-blue); padding: 10px 12px; border-radius: 8px;
  }
  .modal-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    padding: 14px 20px; border-top: 1px solid var(--border-color);
    background: #FAFAFA;
  }

  /* ====== تقييم احترافي ====== */
.rating-pro {
  display: flex; align-items: center; gap: 10px; justify-content: center;
}
.rating-pro .star {
  font-size: 30px; cursor: pointer; user-select: none; transition: transform .15s ease;
}
.rating-pro .star:hover { transform: scale(1.12); }
.rating-pro .star.dim { color: #D1D5DB; }          /* غير مُفعّل */
.rating-pro .star.lit { color: var(--tvtc-secondary); }          /* مُضاءة */

.rating-scale {
  display: grid; grid-template-columns: repeat(5, minmax(0,1fr));
  gap: 6px; margin-top: 10px;
}
.rating-chip {
  text-align: center; font-size: 12px; padding: 6px 8px; border-radius: 999px;
  border: 1px solid #E5E7EB; color: #374151; background: #F9FAFB;
}
.rating-chip.active {
  background: #FFF7E6; border-color: #FBBF24; color: #92400E; font-weight: 700;
}

.rating-note {
  margin-top: 10px; color: #6B7280; font-size: 13px; text-align: center;
}

/* مودال التقييم */
.modal-backdrop--rating { z-index: 10001; }
.modal-rating .modal-header { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
.modal-rating .modal-body label { font-weight: 700; color: #0F172A; margin-bottom: 8px; display:block; }
.modal-rating .modal-textarea { min-height: 90px; }

/* شارة تقييم في البطاقات */
.rating-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; background:#FEF9C3; color:#854D0E; border:1px solid #FDE68A; font-weight:700; font-size:12px;
}

  .date-filter{background:#e8f4f8;border-radius:14px;padding:12px}
  .date-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  .chip{border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff}
  .chip.active{background:var(--primary-blue,var(--tvtc-primary));color:#fff}
  .range-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .range-row .sep{opacity:.6;font-weight:700}
  .date-input{height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff}
  .btn-apply{height:38px;padding:0 14px;border-radius:10px;border:0;background:var(--tvtc-primary);color:#fff;font-weight:700;cursor:pointer}



</style>
</head>
<script>
(function(){
  const $ = s=>document.querySelector(s);

  function ymd(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
  function startOfWeek(d){const x=new Date(d);const day=(x.getDay());x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x;}
  function endOfWeek(d){const s=startOfWeek(d);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);return e;}
  function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}

  function setRange(from,to){
    $('#fltDateFrom').value = from ? ymd(from) : '';
    $('#fltDateTo').value   = to   ? ymd(to)   : '';
  }

  function applyRange(){
    const from=$('#fltDateFrom')?.value||'', to=$('#fltDateTo')?.value||'';
    document.dispatchEvent(new CustomEvent('filters:dateRangeChanged',{detail:{from,to}}));
    if(typeof window.applyFilters==='function') window.applyFilters();
  }

  function activate(pr){
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.pr===pr));
  }

  // presets
  const now=new Date();
  const presets={
    today: ()=>{const a=new Date();const b=new Date();setRange(a,b);},
    week:  ()=>{setRange(startOfWeek(now), endOfWeek(now));},
    month: ()=>{setRange(startOfMonth(now), endOfMonth(now));},
    quarter: ()=>{
      const m=Math.floor(now.getMonth()/3)*3;
      const s=new Date(now.getFullYear(),m,1);
      const e=new Date(now.getFullYear(),m+3,0);
      setRange(s,e);
    },
    custom: ()=>{}
  };

  // bind
  document.querySelectorAll('#dateFilter .chip').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const pr=btn.dataset.pr;
      activate(pr);
      if(presets[pr]) presets[pr]();
    });
  });
  $('#btnApplyRange')?.addEventListener('click', applyRange);

  // default: هذا الشهر
  activate('month'); presets.month(); applyRange();
})();
</script>


<script>
(function(){
  const $ = s => document.querySelector(s);

  function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function startOfWeek(d){ const x=new Date(d); const day=x.getDay(); x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(s.getDate()+6); e.setHours(23,59,59,999); return e; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

  function setDbRange(from,to){
    const f = $('#dbFrom'), t = $('#dbTo');
    if (f) f.value = from ? ymd(from) : '';
    if (t) t.value = to   ? ymd(to)   : '';
  }

  window.applyDbFilters = function(){
    const from = $('#dbFrom')?.value || '';
    const to   = $('#dbTo')?.value   || '';
    document.dispatchEvent(new CustomEvent('filters:dateRangeChanged', { detail:{ from, to } }));
    if (typeof window.applyFilters === 'function') window.applyFilters();
    else if (typeof window.refreshDashboard === 'function') window.refreshDashboard();
  };

  function activateChip(pr){
    document.querySelectorAll('#dateFilter .chip')
      .forEach(c=>c.classList.toggle('active', c.dataset.pr===pr));
  }

  const now = new Date();
  const presets = {
    today:   ()=>{ const a=new Date(); const b=new Date(); setDbRange(a,b); },
    week:    ()=> setDbRange(startOfWeek(now), endOfWeek(now)),
    month:   ()=> setDbRange(startOfMonth(now), endOfMonth(now)),
    quarter: ()=> { const m=Math.floor(now.getMonth()/3)*3; const s=new Date(now.getFullYear(),m,1); const e=new Date(now.getFullYear(),m+3,0); setDbRange(s,e); },
    custom:  ()=> {}
  };

  document.querySelectorAll('#dateFilter .chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const pr = btn.dataset.pr;
      activateChip(pr);
      if (presets[pr]) presets[pr]();
    });
  });

  // الوضع الافتراضي: هذا الشهر
  activateChip('month'); presets.month(); window.applyDbFilters();
})();
</script>


<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <h1>سجل المواقف اليومية للمتدربين</h1>
            </div>
            <div class="content">
                <div class="login-form">
                    <h2 style="color: var(--primary-blue); margin-bottom: 30px;">تسجيل الدخول</h2>
                    <div class="form-group">
                        <label>الرقم التدريبي أو الرقم الوظيفي</label>
                        <input type="text" id="userId" placeholder="أدخل الرقم التدريبي أو الرقم الوظيفي" required>
                    </div>
                    <button class="btn btn-primary" onclick="login()">دخول</button>
                </div>
            </div>
        </div>

        <!-- Advisory Services Unit Interface -->
        <div id="advisoryInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1>وحدة الخدمات الإرشادية</h1>
                <p id="welcomeMessage"></p>
            </div>
            <div class="content">
                <!-- ✅ زر التبديل بين الأوضاع - موضوع في الأعلى بشكل صحيح -->
                <div style="margin-bottom: 20px; text-align: right;">
                    <button id="advisoryModeToggle" class="btn btn-primary hidden" onclick="switchAdvisoryMode(advisoryCurrentMode === 'basic' ? 'admin' : 'basic')">
                        <span id="advisoryModeToggleText">🔓 وضع إداري</span>
                    </button>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'newTicket')">تذكرة جديدة</button>
                    <button class="tab" onclick="switchTab(event, 'myRequests')">طلباتي</button>
                    <button class="tab hidden" id="advisoryTabRatings" onclick="switchTab(event, 'advisoryRatings')">التقييمات</button>
                </div>

                <!-- New Ticket Tab -->
                 <!-- تبويب التقييمات لوحدة الإرشاد -->
                    <div id="advisoryRatings" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">التقييمات</h2>
                    <div id="advisoryRatingsList">
                        <p style="text-align: center; color: #999;">جاري تحميل التقييمات...</p>
                    </div>
                    </div>

                <div id="newTicket" class="tab-content active">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">إنشاء تذكرة جديدة</h2>
                    <div class="form-group">
                        <label>الرقم التدريبي للمتدرب</label>
                        <input type="text" id="traineeId" placeholder="أدخل الرقم التدريبي">
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="loadTraineeData()">جلب البيانات</button>
                    </div>

                    <div id="traineeInfo" class="hidden">
                        <div class="info-card">
                            <h3 style="color: var(--primary-blue); margin-bottom: 15px;">بيانات المتدرب</h3>
                            <div class="info-row">
                                <div class="info-item">
                                    <strong>اسم المتدرب</strong>
                                    <span id="traineeName">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>الرقم التدريبي</strong>
                                    <span id="traineeIdDisplay">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>القسم</strong>
                                    <span id="traineeDept">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>التخصص</strong>
                                    <span id="traineeSpec">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>المرشد التدريبي</strong>
                                    <span id="traineeAdvisor">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>تاريخ اليوم</strong>
                                    <span id="currentDate">-</span>
                                </div>
                                <div class="info-item">
                                    <strong>اليوم</strong>
                                    <span id="currentDay">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div class="form-group">
                            <label>طلب الخدمة المقدمة</label>
                            <div class="service-buttons">
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="سلوكية">
                                    <span>سلوكية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="مالية">
                                    <span>مالية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="تدريبية">
                                    <span>تدريبية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="اجتماعية">
                                    <span>اجتماعية</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="مواصلات وسكن">
                                    <span>مواصلات وسكن</span>
                                </label>
                                <label class="service-btn">
                                    <input type="radio" name="serviceType" value="أخرى">
                                    <span>أخرى</span>
                                </label>
                            </div>
                        </div>

                        <div id="otherServiceDiv" class="form-group hidden">
                            <label>اكتب نوع الخدمة</label>
                            <input type="text" id="otherService" placeholder="حدد نوع الخدمة">
                        </div>

                        <div class="form-group">
                            <label>تفاصيل الطلب</label>
                            <textarea id="requestDetails" rows="4" placeholder="اكتب تفاصيل الطلب"></textarea>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="completeTicket()">إنهاء الطلب</button>
                        <button id="transferBtn" class="btn btn-warning hidden" onclick="showTransferOptions()">تحويل الطلب</button>
                        </div>

                        <div id="transferOptions" class="hidden" style="margin-top: 20px;">
                                <div class="form-group">
                                <label>تحويل الطلب إلى</label>
                                <div class="service-buttons" id="transferToGroup">
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="advisor">
                                    <span>المرشد التدريبي</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="dept_head">
                                    <span>رئيس القسم</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="elearning">
                                    <span>مدير التدريب الإلكتروني</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainees_vice">
                                    <span>وكيل شؤون المتدربين</span>
                                    </label>
                                    <label class="service-btn">
                                    <input type="radio" name="transferTo" value="trainers_deputy">
                                    <span>وكيل شؤون المدربين</span>
                                    </label>
                                </div>
                                </div>
                            <button class="btn btn-primary" onclick="transferTicketAction()">تأكيد التحويل</button>
                        </div>
                    </div>
                </div>

                <!-- My Requests Tab -->
                <div id="myRequests" class="tab-content">
                    <h2 style="color: var(--primary-blue); margin-bottom: 25px;">طلباتي</h2>
                    
                    <!-- ✅ فلتره الأقسام للصلاحيات العليا -->
                    <div id="advRequestsFilterContainer" class="hidden" style="margin-bottom: 20px; background: var(--light-blue); padding: 15px; border-radius: 8px;">
                        <label style="font-weight: 600; color: var(--primary-blue); display: block; margin-bottom: 10px;">فلترة حسب القسم:</label>
                        <select id="advRequestsDeptFilter" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 5px; font-size: 14px;" onchange="filterRequestsByDept()">
                            <option value="">جميع الأقسام</option>
                        </select>
                    </div>

                    <div id="requestsList">
                        <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Advisor Interface -->
        <div id="advisorInterface" class="hidden">
          <div class="header">
            <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            <h1>المرشد التدريبي</h1>
            <p id="advisorWelcome"></p>
          </div>

          <div class="content">
            <div class="tabs">
              <button class="tab active" onclick="switchTab(event, 'assignedTickets')">التذاكر المحولة لي</button>
              <button class="tab" onclick="switchTab(event, 'advisorRequests')">طلباتي</button>
              <button class="tab" id="advisorRatingsTab" onclick="switchTab(event, 'advisorRatings')">التقييمات</button>
            </div>

            <!-- 🟦 التبويب الأول -->
            <div id="assignedTickets" class="tab-content active">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">التذاكر المحولة لي</h2>

              <div id="advisorTicketsList">
                <p style="text-align: center; color: #999;">جاري تحميل التذاكر...</p>
              </div>

              <!-- ℹ️ تنبيه معلوماتي -->
              <div class="alert alert-info" style="margin-top: 30px;">
                <span>ℹ️</span>
                <span>نأمل إبلاغ المتدرب بتقييم مستوى الخدمة بعد الانتهاء للدخول وتقييم الخدمة المقدمة له</span>
              </div>

              <!-- ⚠️ تنبيه مهم لوحدة الخدمات الإرشادية -->
              <div class="alert alert-warning" style="
                margin-top: 12px;
                display: flex; gap: 10px; align-items: flex-start;
                background: #FFF7E6; border: 1px solid #F5C26B; color: #7A4B00;
                padding: 12px 14px; border-radius: 10px; line-height: 1.7; font-size: 14.5px;">
                <span aria-label='تنبيه' title='تنبيه' style='font-size: 18px;'>⚠️</span>
                <div>
                  <strong style='display:inline-block; margin-bottom:4px;'>تنبيه:</strong>
                  <div>
                    يظهر لديك <u>فقط</u> الحالات <strong>التدريبية</strong> التي تم تحويلها إليك.
                    توجد حالات أخرى للمتدربين لدى المدربين ضمن الإرشاد التدريبي وهي <strong>خاصة</strong> ولا تُعرض هنا حفاظًا على الخصوصية.
                    لمعرفة هذه الحالات أو التنسيق بشأنها، نأمل التواصل مع <strong>وحدة الخدمات الإرشادية</strong>.
                  </div>
                </div>
              </div>
            </div> <!-- ✅ إغلاق التبويب الأول -->

            <!-- 🟩 التبويب الثاني -->
            <div id="advisorRequests" class="tab-content">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">طلباتي</h2>
              <div id="advisorRequestsList">
                <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
              </div>
            </div>

            <!-- 🟨 التبويب الثالث -->
            <div id="advisorRatings" class="tab-content">
              <h2 style="color: var(--primary-blue); margin-bottom: 25px;">التقييمات</h2>
              <div id="advisorRatingsList">
                <p style="text-align: center; color: #999;">جاري تحميل التقييمات...</p>
              </div>
            </div>
          </div>
        </div>


        <!-- Department Head / Deputy Interface لوحة الادارة العليا -->
        <div id="managementInterface" class="hidden">
        <div class="header">
            <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
            <!-- ✅ زر العودة إلى الوضع العادي لوحدة الخدمات الإرشادية -->
            <button id="backToBasicMode" class="btn btn-warning hidden" style="position: absolute; right: 20px; top: 30px;" onclick="switchAdvisoryMode('basic')">
                العودة إلى الوضع العادي ←
            </button>
            <h1 id="managementTitle">لوحة الإدارة</h1>
            <p id="managementWelcome"></p>
        </div>

        <div class="content">
            <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'managementAll')">جميع الطلبات</button>
            <button class="tab hidden" id="tabRatings" onclick="switchTab(event, 'managementRatings')">التقييمات</button>
            <!-- زر تبويب لوحة متابعة الأقسام (لذوي الصلاحيات العليا فقط) -->
            <button class="tab hidden" id="tabDeptBoard" onclick="switchTab(event, 'managementDeptBoard')">لوحة متابعة الأقسام</button>
            <!-- ✅ زر التقارير الإدارية المضاف -->
            <button class="btn" 
                    style="background:var(--tvtc-primary);color:#fff;border:0;padding:8px 14px;border-radius:8px;font-weight:600;margin-right:10px;"
                    onclick="openAdminReports()">📊 التقارير الإدارية</button>
        </div>

            <!-- تبويب جميع الطلبات -->
            <div id="managementAll" class="tab-content active">
            <!-- فلتر القسم والنوع والحالة للصلاحيات العليا -->
            <div id="mgmtRequestsFilterContainer" class="info-card" style="margin-bottom:16px;">
                <h3 style="color: var(--primary-blue); margin-bottom: 10px;">الفلاتر</h3>
                <div class="info-row">
                <div class="info-item">
                    <strong>الأقسام</strong>
                    <select id="mgmtRequestsDeptFilter" multiple style="height: 80px;">
                    <option value="">جميع الأقسام</option>
                    </select>
                </div>
                <div class="info-item">
                    <strong>نوع الخدمة</strong>
                    <select id="requestsTypeFilter" style="width:100%;">
                    <option value="">جميع الأنواع</option>
                    <option value="سلوكية">سلوكية</option>
                    <option value="مالية">مالية</option>
                    <option value="تدريبية">تدريبية</option>
                    <option value="اجتماعية">اجتماعية</option>
                    <option value="مواصلات وسكن">مواصلات وسكن</option>
                    <option value="أخرى">أخرى</option>
                    </select>
                </div>
                <div class="info-item">
                    <strong>حالة الطلب</strong>
                    <select id="requestsStatusFilter" style="width:100%;">
                    <option value="">جميع الحالات</option>
                    <option value="pending">معلقة</option>
                    <option value="in_progress">قيد التنفيذ</option>
                    <option value="completed">مكتملة</option>
                    </select>
                </div>
                <div class="info-item">
                    <button class="btn btn-primary" onclick="filterManagementRequestsByAll()" style="margin-top: 28px;">تطبيق الفلتر</button>
                </div>
                </div>
            </div>
            <div id="managementTicketsList">
                <p style="text-align: center; color: #999;">جاري تحميل الطلبات...</p>
            </div>
            </div>

            <!-- تبويب التقييمات -->
            <div id="managementRatings" class="tab-content">
            <div id="ratingsList">
                <p style="text-align: center; color: #999;">جاري تحميل التقييمات...</p>
            </div>
            </div>

            <!-- ✅ تبويب لوحة متابعة الأقسام (تاب مستقل شقيق) -->
            <div id="managementDeptBoard" class="tab-content">
            <!-- فلاتر -->
            <div class="info-card" style="margin-bottom:16px;">
            <h3 style="color: var(--primary-blue); margin-bottom: 10px;">الفلاتر</h3>

            <!-- شريط نطاق التاريخ الجديد -->
            <div class="date-filter" id="dateFilter" style="background:#e8f4f8;border-radius:14px;padding:12px;margin-bottom:12px;">
                <div class="date-toolbar" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;">
                <button class="chip" data-pr="today"   style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">اليوم</button>
                <button class="chip" data-pr="week"    style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">هذا الأسبوع</button>
                <button class="chip" data-pr="month"   style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">هذا الشهر</button>
                <button class="chip" data-pr="quarter" style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">هذا الربع</button>
                <button class="chip" data-pr="custom"  style="border:1px solid var(--primary-blue,var(--tvtc-primary));padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;background:#fff;">مخصص</button>
                </div>
                <div class="range-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <!-- نحافظ على نفس المعرّفات القديمة حتى لا يتأثر الكود الباقي -->
                <input id="dbFrom" class="date-input" type="date" placeholder="YYYY-MM-DD" style="height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff">
                <span class="sep" style="opacity:.6;font-weight:700">—</span>
                <input id="dbTo" class="date-input" type="date" placeholder="YYYY-MM-DD" style="height:38px;padding:6px 10px;border:1px solid #cfd8dc;border-radius:10px;background:#fff">
                <button class="btn-apply" id="btnApplyDbRange" onclick="applyDbFilters()" style="height:38px;padding:0 14px;border-radius:10px;border:0;background:var(--tvtc-primary);color:#fff;font-weight:700;cursor:pointer">تطبيق</button>
                </div>
            </div>

            <div class="info-row">
                <div class="info-item">
                <strong>الأقسام</strong>
                <select id="dbDept" multiple style="height: 110px;"></select>
                </div>
                <div class="info-item">
                <strong>الحالة</strong>
                <div style="display:flex; gap:10px; flex-wrap:wrap; padding-top:6px;">
                    <label><input type="checkbox" id="dbStPending" checked> معلّقة</label>
                    <label><input type="checkbox" id="dbStInProgress" checked> قيد التنفيذ</label>
                    <label><input type="checkbox" id="dbStCompleted" checked> مكتملة</label>
                </div>
                </div>
                <div class="info-item">
                <strong>المصدر</strong>
                <select id="dbSource">
                    <option value="all" selected>الكل</option>
                    <option value="advisory">من وحدة الإرشاد</option>
                    <option value="elearning">التدريب الإلكتروني</option>
                    <option value="departments">الأقسام التدريبية</option>
                </select>
                </div>
            </div>
            </div>


            <!-- KPIs -->
            <div class="stats-grid" id="dbKpis" style="margin-top: -8px;">
                <!-- يُملأ برمجيًا -->
            </div>

            <!-- جدول تفصيلي حسب القسم -->
            <div class="divider"></div>
            <div id="dbTableWrap">
                <div style="overflow:auto;">
                <table id="dbTable" style="width:100%; border-collapse: collapse;">
                    <thead>
                    <tr style="background: var(--light-blue);">
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">القسم</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">جديدة</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">قيد التنفيذ</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">معلّقة</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">مكتملة</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">% الإكمال</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">متوسط زمن الإغلاق (يوم)</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">% الالتزام بـ SLA</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">حلول الإرشاد (مكتملة)</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border-color);">تنبيهات</th>
                    </tr>
                    </thead>
                    <tbody id="dbTableBody">
                    <!-- يُملأ برمجيًا -->
                    </tbody>
                </table>
                </div>
            </div>
            </div> <!-- /managementDeptBoard -->

        </div> <!-- /content -->
        </div> <!-- /managementInterface -->



        <!-- Trainee Interface -->
        <div id="traineeInterface" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
                <h1>تقييم الخدمة</h1>
                <p id="traineeWelcome"></p>
            </div>
            <div class="content">
                <h2 style="color: var(--primary-blue); margin-bottom: 25px;">تذاكري</h2>
                <div id="traineeTicketsList">
                    <p style="text-align: center; color: #999;">جاري تحميل التذاكر...</p>
                </div>
                <div class="alert alert-info" style="margin-top: 30px;">
                    <span>ℹ️</span>
                    <span><strong>ملاحظة:</strong> لمعرفة تفاصيل التذكرة نأمل مراجعة المسؤول</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <div class="footer-main">الكلية التقنية حقل</div>
                <div class="footer-divider"></div>
                <div class="footer-details">
                    <span>وكالة شؤون المتدربين</span>
                    <span class="footer-separator">•</span>
                    <span>وحدة الخدمات الإرشادية</span>
                </div>
                <div class="footer-version">الإصدار 1.0 | © 2025 المؤسسة العامة للتدريب التقني والمهني</div>
            </div>
        </div>
    </div>


    
    <!-- تضمين ملف API -->
    <script src="api_integration.js"></script>

    <script>
        let currentUser = null;
        let currentTraineeData = null;

        let __ratingTicketNumber = null;
        let __ratingValue = 0;

        let __lastTraineeTickets = [];   // آخر قائمة لتذاكر المتدرب
        let __ratingSubmitting   = false; // يمنع النقر المكرر أثناء الإرسال

        /**
         * ✅ دالة تنسيق التاريخ - تحويل أي صيغة تاريخ إلى صيغة عربية مقروءة
         * @param {string|Date} dateInput - التاريخ بأي صيغة
         * @param {boolean} includeTime - هل نعرض الوقت أيضاً؟
         * @returns {string} - التاريخ بصيغة عربية مقروءة
         */
        function formatArabicDate(dateInput, includeTime = false) {
            if (!dateInput) return '-';
            
            try {
                // تحويل إلى Date object
                let date;
                if (dateInput instanceof Date) {
                    date = dateInput;
                } else if (typeof dateInput === 'string') {
                    // معالجة التواريخ بصيغة ISO (مثل: 2025-10-28T21:00:00.000Z)
                    date = new Date(dateInput);
                    
                    // إذا كان التاريخ invalid
                    if (isNaN(date.getTime())) {
                        // محاولة معالجة صيغ أخرى
                        const parts = dateInput.match(/(\d{4})-(\d{2})-(\d{2})/);
                        if (parts) {
                            date = new Date(parts[1], parseInt(parts[2]) - 1, parts[3]);
                        } else {
                            return dateInput; // إرجاع القيمة كما هي إذا فشل التحويل
                        }
                    }
                } else {
                    return '-';
                }

                // التأكد من صحة التاريخ
                if (isNaN(date.getTime())) {
                    return dateInput.toString();
                }

                // تنسيق التاريخ
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                let formatted = `${year}-${month}-${day}`;
                
                // إضافة الوقت إذا طُلب
                if (includeTime) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    formatted += ` ${hours}:${minutes}:${seconds}`;
                }
                
                return formatted;
            } catch (error) {
                console.error('خطأ في تنسيق التاريخ:', error);
                return dateInput.toString();
            }
        }

        /**
         * ✅ دالة تنسيق التاريخ للعرض العربي الكامل (مع اسم اليوم)
         */
        function formatArabicDateFull(dateInput) {
            if (!dateInput) return '-';
            
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return dateInput.toString();
                
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                const dayName = days[date.getDay()];
                
                return `${dayName} ${formatArabicDate(dateInput, false)}`;
            } catch (error) {
                return formatArabicDate(dateInput, false);
            }
        }

        /**
         * ✅ دالة مساعدة لتنسيق الوقت فقط
         */
        function formatTimeOnly(dateInput) {
            if (!dateInput) return '-';
            
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return '-';
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return '-';
            }
        }


        const RATING_LABELS = {
        1: 'سيئ',
        2: 'مقبول',
        3: 'جيد',
        4: 'جيد جدًا',
        5: 'ممتاز'
        };

        // 🔹 مساعدات مطلوبة (ضعها مرة واحدة في ملفك إن لم تكن موجودة)
        function normalizeServiceType(v){
        v = String(v || '').trim().toLowerCase();
        if (['تدريبية','تدريبي','training','train','تعليمي'].includes(v)) return 'training';
        return v;
        }
        function isAdvisoryUser(){
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '')
                        .toLowerCase().replace(/\s+/g,'_');
        return role === 'advisory_unit' || role === 'وحدة_الخدمات_الإرشادية';
        }

        // trainee_platform_live copy.html
        function refreshAdvisorTransferUI(){
        const btn  = document.getElementById('transferBtn');
        const opts = document.getElementById('transferOptions');
        if (!btn) return;
        const roleOk = isAdvisoryUser();
        const checked = document.querySelector('input[name="serviceType"]:checked');
        const type = normalizeServiceType(checked ? checked.value : '');
        const canTransfer = roleOk && type === 'training';
        btn.classList.toggle('hidden', !canTransfer);
        if (!canTransfer && opts) opts.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[name="serviceType"]').forEach(r=>{
            r.addEventListener('change', refreshAdvisorTransferUI);
        });
        refreshAdvisorTransferUI();
        });

        // هل المستخدم من وحدة الإرشاد؟

        // ✳️ الدالة الصحيحة: لو كانت الخدمة "تدريبية" ⇒ يسمح فقط بالتحويل.
        // لو "غير تدريبية" ⇒ تُعرض الأزرار الأخرى بدون "تحويل".
        function advisorAllowedActions(ticket){
        if (!isAdvisoryUser()) return null;
        const isTraining = normalizeServiceType(ticket?.serviceType) === 'training';
        return isTraining ? ['transfer'] : ['comment','request-info','close'];
        }
        // ===== إعدادات عامة للوحة متابعة الأقسام =====
        const SLA_DAYS = 5;  // يمكنك تعديلها لاحقًا أو قراءة من config

        // تحويل نص إلى تاريخ (يدعم تنسيقات شائعة و/ar-SA)
        function tryParseDate(s) {
        if (!s) return null;
        // لو صيغة yyyy-mm-dd من <input type="date">
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00');
        // محاولة عامة
        const d = new Date(s);
        if (!isNaN(d)) return d;
        // دعم شكل dd/mm/yyyy
        const m = String(s).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
        if (m) {
            const dd = +m[1], mm = +m[2]-1, yyyy = +m[3] < 100 ? 2000 + (+m[3]) : +m[3];
            return new Date(yyyy, mm, dd);
        }
        return null;
        }

        function daysBetween(a, b) {
        const MS = 1000*60*60*24;
        return Math.round((+b - +a)/MS);
        }

        // تبويب لوحة الأقسام: إظهار/إخفاء الزر حسب الصلاحيات
        (function exposeDeptBoardTab(){
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('tabDeptBoard');
            if (btn) {
            if (hasFullAccess()) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
            }
        });
        })();

        function buildRatingUI(containerStars, containerScale, current=0) {
        // نجوم
        containerStars.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const s = document.createElement('span');
            s.textContent = '★';
            s.className = 'star ' + (i <= current ? 'lit' : 'dim');
            s.title = `${i} - ${RATING_LABELS[i]}`;
            s.onclick = () => selectRating(i);
            containerStars.appendChild(s);
        }

        // شرائح لفظية
        containerScale.innerHTML = '';
        for (let i=1; i<=5; i++) {
            const chip = document.createElement('div');
            chip.className = 'rating-chip' + (i === current ? ' active' : '');
            chip.textContent = `${i} — ${RATING_LABELS[i]}`;
            chip.onclick = () => selectRating(i);
            containerScale.appendChild(chip);
        }

        const note = document.getElementById('ratingNote');
        note.textContent = current ? `اخترت: ${current} — ${RATING_LABELS[current]}` : 'اختر من 1 (سيئ) إلى 5 (ممتاز)';
        }

        function selectRating(val) {
        __ratingValue = val;
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        if (stars && scale) buildRatingUI(stars, scale, __ratingValue);
        }


        function openRatingModal(ticketNumber) {
        // حماية: لا تفتح لو كانت مقيّمة مسبقًا
        if (isTicketRatedLocal(ticketNumber)) {
            showSuccess('تم تقديم تقييم لهذه التذكرة مسبقًا ✅');
            return;
        }

        __ratingTicketNumber = ticketNumber;
        __ratingValue = 0;

        const modal = document.getElementById('ratingModal');
        const stars = document.getElementById('ratingStars');
        const scale = document.getElementById('ratingScale');
        const textarea = document.getElementById('ratingComment');

        if (textarea) textarea.value = '';
        if (stars && scale) buildRatingUI(stars, scale, 0);

        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => { stars?.querySelector('.star')?.focus?.(); }, 50);
        }
        }


        // === Helper: جلب القيم من بدائل أسماء مختلفة (en/snake_case/عربي)
        function _val(v){ return v===0 || v ? String(v).trim() : ''; }
        function fieldOf(obj, names=[]){
        for (const k of names){
            const v = obj?.[k];
            if (v!==undefined && v!==null && _val(v)!=='') return v;
        }
        return '';
        }

        // حزم بدائل جاهزة
        function getStatus(t){ return (fieldOf(t, ['status','الحالة']) || 'pending').toLowerCase(); }
        function getCreatedBy(t){ return fieldOf(t, ['createdBy','created_by','أنشأ بواسطة','المنشئ','منشئ']); }
        function getCompletedBy(t){ return fieldOf(t, ['completedBy','completed_by','أنهى','أنهى بواسطة']); }
        function getAssignedTo(t){ return fieldOf(t, ['assignedTo','assigned_to','المسنَد_إلى','المسند إلى','المسنَد إلى']); }
        function getTransferredBy(t){ return fieldOf(t, ['transferredBy','transferred_by','المحوّل_بواسطة','محوّل بواسطة','المحول بواسطة']); }
        function getTransferredTo(t){ return fieldOf(t, ['transferredTo','transferred_to','المحوّل_إلى','محوّل إلى','المحول إلى']); }
        function getDepartment(t){ return fieldOf(t, ['department','القسم']); }
        function getServiceType(t){ return fieldOf(t, ['serviceType','service_type','نوع الخدمة','طلب الخدمة']); }
        function getDateStr(t){ return fieldOf(t, ['date','creationDate','created_at','التاريخ']); }
        function getTicketNumber(t){ return fieldOf(t, ['ticketNumber','ticket_number','رقم التذكرة','التذكرة']); }
        function getDetails(t){ return fieldOf(t, ['requestDetails','details','تفاصيل الطلب']); }
        function getSolution(t){ return fieldOf(t, ['solution','executedSolution','solutionText','الحل المنفذ']); }

        function getRoleCapabilities(user){
        const r = normalizeRole(user?.role || user?.data?.role || '');
        const CAPS = {
            dean: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            quality_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            trainees_vice: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['dashboard','managementAll','managementRatings','allTickets','reports'] },
            advisory_unit: { scope:'all', canSeeRatings:true, canManageTickets:true, canAssign:true, canClose:true, ui:['newTicket','myRequests','assignedTickets','statistics','ratingsBoard','managementAll','deptBoard'] },
            trainers_deputy: { scope:'elearning_and_depts', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['dashboard','managementAll','managementRatings'] },
            dept_head: { scope:'department', canSeeRatings:true, canManageTickets:true, canAssign:false, canClose:true, ui:['deptTickets','deptRatings'] }, // ← تفعيل التقييمات لرئيس القسم
            advisor: { scope:'assigned_and_self', canSeeRatings:true, canManageTickets:true, canAssign:false, canClose:true, ui:['assignedTickets','advisorRequests','myRequests','advisorRatings'] },

            // ✅ جديد: التدريب الإلكتروني
            elearning: { scope:'assigned_or_transferred', canSeeRatings:false, canManageTickets:true, canAssign:false, canClose:true, ui:['managementAll'] },

            trainee: { scope:'self', canSeeRatings:true, canManageTickets:false, canAssign:false, canClose:false, ui:['newTicket','traineeTicketsList','rateService'] }
        };
        return CAPS[r] || { scope:'none', canSeeRatings:false, canManageTickets:false, canAssign:false, canClose:false, ui:[] };
        }


        function closeRatingModal() {
        const modal = document.getElementById('ratingModal');
        if (modal) modal.classList.add('hidden');
        __ratingTicketNumber = null;
        __ratingValue = 0;
        }

        // خريطة موحّدة لاسم الشارة ونصها

        function statusBadgeText(st) {
        if (st === 'completed') return 'مكتملة';
        if (st === 'in_progress') return 'قيد التنفيذ';
        return 'معلقة';
        }

        // (اختياري) أبقي الدالتين القديمتين لكن وجّهها للخريطة الجديدة
        function statusBadgeClass(st){ if (st === 'completed') return 'ticket-status--completed'; if (st === 'in_progress') return 'ticket-status--inprogress'; return 'ticket-status--pending'; }
        // تحديث حالة تذكرة
        if (typeof window.updateTicketStatus !== 'function') {

        window.updateTicketStatus = async (ticketNumber, payload) => {
            const res = await sendRequest('updateTicketStatus', { ticketNumber, ...payload });
            return !!(res && res.success);
        };
        }

        // يفترض وجود currentUser.role و/أو currentUser.data.role حسب تطبيقك
        function canShowTransferButton(ticket){
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '').toLowerCase().replace(/\s+/g,'_');
        const isAdvisory = (role === 'advisory_unit' || role === 'وحدة_الخدمات_الإرشادية');
        return isAdvisory && normalizeServiceType(ticket.serviceType) === 'training';
        }

        // مثال داخل بناء أزرار البطاقة:
        function renderTicketActions(ticket){
        const actions = [];
        // أزرار حالية… (لا تغيّرها)
        // ...
        const advisorActions = advisorAllowedActions(ticket);
        if (advisorActions) {
            // زر التحويل
            if (advisorActions.includes('transfer')) {
            actions.push(`<button class="btn btn-primary" onclick="openAdvisorTransferModal('${ticket.ticketNumber}')">تحويل</button>`);
            }
            // بقية الأزرار تُعرض فقط إن كانت غير تدريبية
            if (advisorActions.includes('comment')) {
            actions.push(`<button class="btn" onclick="openAddCommentModal('${ticket.ticketNumber}')">ملاحظة</button>`);
            }
            if (advisorActions.includes('request-info')) {
            actions.push(`<button class="btn" onclick="openRequestMoreInfo('${ticket.ticketNumber}')">طلب معلومات</button>`);
            }
            if (advisorActions.includes('close')) {
            actions.push(`<button class="btn btn-danger" onclick="confirmCloseTicket('${ticket.ticketNumber}')">إغلاق</button>`);
            }
            return `<div class="ticket-actions">${actions.join('')}</div>`;
        }
        // ✅ زر التحويل يظهر فقط لوحدة الإرشاد + تدريبية
        // 🔹 زر التحويل يظهر فقط لوحدة الإرشاد + تدريبية
        if (canShowTransferButton(ticket)) {
            actions.push(`<button class="btn btn-primary" onclick="openAdvisorTransferModal('${ticket.ticketNumber}')">تحويل الطلب</button>`);
        }
        return `<div class="ticket-actions">${actions.join('')}</div>`;
        }
        
        // تحويل تذكرة
        // === استبدال كامل للدالة السابقة ===
        if (typeof window.transferTicket !== 'function') { window.transferTicket = async () => {}; }
        window.transferTicket = async (ticketNumber, to, by) => {
        const transferDate = new Date().toLocaleDateString('ar-SA');
        // نرسل الأسماء المحتملة كلها احتياطًا
        const payload = {
            ticketNumber,
            to,
            transferredTo: to,
            by,
            transferredBy: by,
            transferDate
        };
        const res = await sendRequest('transferTicket', payload);
        return !!(res && res.success);
        };
        // إنهاء تذكرة (تسجيل الحل)
        if (typeof window.completeTicketRequest !== 'function') {
        window.completeTicketRequest = async (ticketNumber, solutionText, completedBy, completionDate) => {
            const payload = { ticketNumber, solutionText, completedBy };
            if (completionDate) payload.completionDate = completionDate;
            const res = await sendRequest('completeTicket', payload);
            return !!(res && res.success);
        };
        }

        async function submitTraineeRating() {
        // تحقق أساسي
        if (!__ratingTicketNumber) { showError('رقم التذكرة غير معروف'); return; }
        if (!__ratingValue)        { showError('الرجاء اختيار تقييم من 1 إلى 5'); return; }
        if (__ratingSubmitting)     return; // منع النقر مرتين

        // زر الإرسال (لتعطيله أثناء الإرسال)
        const btn = document.querySelector('#ratingModal .btn.btn-success');

        // فحص محلي سريع: هل هذه التذكرة مُقيّمة في الذاكرة/العرض؟
        try {
            if (Array.isArray(__lastTraineeTickets)) {
            const localHit = __lastTraineeTickets.find(
                x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (localHit) {
                // إغلاق وتهذيب الواجهة
                closeRatingModal();
                showSuccess('هذه التذكرة مُقيّمة بالفعل ✅');
                return;
            }
            }
        } catch (_) { /* تجاهل أي خطأ محلي */ }

        __ratingSubmitting = true;
        if (btn) { btn.disabled = true; btn.textContent = 'جارٍ الإرسال...'; }

        try {
            // فحص حديث من المصدر (قد يكون قيّم من جهاز آخر)
            const fresh = await loadTraineeTickets(currentUser.id);
            const already = (fresh || []).find(
            x => String(x.ticketNumber) === String(__ratingTicketNumber) && Number(x.rating) > 0
            );
            if (already) {
            // حدّث الذاكرة والعرض ثم اخرج
            __lastTraineeTickets = fresh;
            displayTraineeTickets(__lastTraineeTickets);
            closeRatingModal();
            showSuccess('تم تقديم التقييم لهذه التذكرة مسبقًا ✅');
            return;
            }

            // إرسال الطلب للخادوم (Apps Script) — يجب أن يعيد {success, code?}
            const comment = (document.getElementById('ratingComment')?.value || '').trim();
            showLoading('جاري حفظ التقييم...');
            const res = await saveRating(__ratingTicketNumber, __ratingValue, comment);
            hideLoading();

            // معالجة ردّ الخادوم
            if (!res || res.success === false) {
            if (res?.code === 'ALREADY_RATED') {
                // 🔒 قفل الخادوم: لا يسمح بالتقييم مرة أخرى
                closeRatingModal();
                showError('تم تقييم هذه التذكرة مسبقًا — لا يمكنك التقييم مرة أخرى.');
                // إعادة تحميل قائمة المتدرب لإخفاء زر "قيّم"
                if (typeof loadTraineeTicketsView === 'function') await loadTraineeTicketsView();
                return;
            }
            showError(res?.message || 'تعذّر حفظ التقييم، حاول لاحقًا.');
            return;
            }

            // نجاح
            closeRatingModal();
            showSuccess('تم استلام تقييمك. شكرًا لك!');

            // حدّث القوائم — سيختفي زر "قيّم الخدمة" وتظهر الشارة
            await loadTraineeTicketsView();

            // تحديث محلي فوري (في حال لم يُعاد الجلب أو لتسريع الانعكاس)
            try {
            if (Array.isArray(__lastTraineeTickets)) {
                const idx = __lastTraineeTickets.findIndex(
                x => String(x.ticketNumber) === String(__ratingTicketNumber)
                );
                if (idx >= 0) {
                __lastTraineeTickets[idx].rating = Number(__ratingValue);
                __lastTraineeTickets[idx].ratingComment = comment;
                displayTraineeTickets(__lastTraineeTickets);
                }
            }
            } catch (_) { /* اختياري */ }

        } catch (e) {
            hideLoading();
            showError(e?.message || String(e));
        } finally {
            __ratingSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'إرسال التقييم'; }
        }
        }

        // إغلاق بالمفتاح ESC والنقر خارج المودال
        document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeRatingModal(); });
        document.addEventListener('click', (ev) => {
        const m = document.getElementById('ratingModal');
        if (m && ev.target === m) closeRatingModal();
        });
        // ✅ 3) من يملك الصلاحيات العليا (يشوف كل الإدارات + تبويب "التقييمات")
        function hasFullAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        // وحدة الإرشاد تملك صلاحيات عليا عندما تكون في وضع admin
        if (r === 'advisory_unit' && advisoryCurrentMode === 'admin') {
            return true;
        }
        return ['dean','trainees_vice','quality_vice'].includes(r);
        }


        // ✅ متغير لتخزين الدور الحالي للمرشدين (للتبديل بين الدورين)
        let advisoryCurrentMode = 'basic'; // 'basic' أو 'admin'

        // ✅ دالة التبديل بين دور الإرشاد الأساسي والصلاحيات العليا
        function switchAdvisoryMode(mode) {
        if (normalizeRole((currentUser?.data?.role || '').trim()) !== 'advisory_unit') {
            showError('هذه الميزة متاحة فقط لوحدة الخدمات الإرشادية');
            return;
        }

        advisoryCurrentMode = mode; // 'basic' أو 'admin'

        // حدّث نص زر التبديل فورًا
        const toggleText = document.getElementById('advisoryModeToggleText');
        if (toggleText) {
            toggleText.textContent = advisoryCurrentMode === 'admin' ? '🔒 وضع عادي' : '🔓 وضع إداري';
        }

        if (mode === 'admin') {
            // عرض لوحة الإدارة مع صلاحيات عليا
            showManagementInterface();
        } else {
            // عرض واجهة الإرشاد الأساسية
            showAdvisoryInterface();
        }
        }

        // === 🟢 شرط ظهور زر التحويل لوحدة الإرشاد فقط للطلبات التدريبية ===
        function canShowTransferButton(ticket) {
        const role = (window.currentUser?.role || window.currentUser?.data?.role || '').toLowerCase().replace(/\s+/g,'_');
        const serviceType = String(ticket.serviceType || '').trim().toLowerCase();
        const isTraining = ['تدريبية','training','train','تعليمي'].includes(serviceType);
        const isAdvisory = (role === 'advisory_unit' || role === 'وحدة_الخدمات_الإرشادية');
        return isAdvisory && isTraining;
        }

        // ✅ CORRECT: اكتشاف قوي لحالة التحويل + تفاصيل واضحة + توافق تام مع CSS
// ✅ تصحيح كامل لدالة عرض البطاقة مع شارة التحويل (transfer badge) تظهر دائماً عند التحويل
        function renderTicketCard(ticket) {
        const card = document.createElement('div');
        card.className = 'ticket-card';

        // قيم خام من السجل
        const toRaw   = String(ticket.transferredTo || '').trim();
        const byRaw   = String(ticket.transferredBy || '').trim();
        const dateRaw = String(ticket.transferDate  || '').trim();
        const stRaw   = String(ticket.status        || '').trim();

        // تطبيع جهة التحويل إلى شكل موحّد
        const toNorm = (typeof normalizeRole === 'function')
            ? normalizeRole(toRaw)
            : toRaw.toLowerCase().replace(/\s+/g,'_');

        // 🔎 اكتشاف شامل لوضع "محوّلة"
        const isTransferred =
            (!!toRaw) || (!!byRaw) || (!!dateRaw) ||
            (stRaw.toUpperCase() === 'TRANSFERRED') ||
            (ticket.transferred === true);

        // 🏷️ شارة التحويل (تُعرض فقط إن كان isTransferred = true)
        const badgeHTML = isTransferred
            ? `<span class="badge badge-transfer" title="${
                [
                byRaw   ? ('بواسطة: ' + byRaw) : '',
                toRaw   ? ('إلى: '     + toRaw) : '',
                dateRaw ? ('بتاريخ: '  + dateRaw) : ''
                ].filter(Boolean).join(' | ')
            }">محوَّلة</span>`
            : '';

        // 🗂️ ترجمة الوجهات لأسماء عربية لطيفة
        const roleTranslation = {
            'advisor':        'المرشد',
            'dept_head':      'رئيس القسم',
            'elearning':      'التدريب الإلكتروني',
            'trainees_vice':  'وكيل شؤون المتدربين',
            'quality_vice':   'وكيل ضبط الجودة',
            'dean':           'العميد'
        };
        const toLabel = roleTranslation[toNorm] || toRaw || (isTransferred ? 'جهة أخرى' : '');

        // 🟢 شارة الحالة (يعتمد على دوالك الموحدة إن كانت متوفرة)
        const stKey = stRaw.toLowerCase();
        const statusClass = (typeof statusBadgeClass === 'function') ? statusBadgeClass(stKey) : (
            stKey === 'completed'   ? 'ticket-status--completed' :
            stKey === 'in_progress' ? 'ticket-status--inprogress' :
                                    'ticket-status--pending'
        );
        const statusText = (typeof statusBadgeText === 'function') ? statusBadgeText(stKey) : (
            stKey === 'completed'   ? 'مكتملة' :
            stKey === 'in_progress' ? 'قيد التنفيذ' :
                                    'معلقة'
        );

        // ✅ بناء هيكل البطاقة
        card.innerHTML = `
            <div class="ticket-header">
            <span class="ticket-id">#${ticket.ticketNumber || ''}</span>
            ${badgeHTML}
            </div>

            <div class="ticket-body">
            <div><strong>المشكلة:</strong> ${ticket.title || ticket.requestDetails || '-'}</div>
            <div><strong>الحالة:</strong> <span class="ticket-status-badge ${statusClass}">${statusText}</span></div>
            ${
                isTransferred
                ? `<div class="transfer-meta">
                    <small>
                        ${byRaw   ? ('محول بواسطة: ' + byRaw) : ''}
                        ${toLabel ? (byRaw ? ' | ' : '') + 'إلى: ' + toLabel : ''}
                        ${dateRaw ? ' | بتاريخ: ' + formatArabicDate(dateRaw, true) : ''}
                    </small>
                    </div>`
                : ''
            }
            </div>
        `;

        // سمات بيانات للفلاتر الإدارية
        if (ticket.department)  card.setAttribute('data-mgmt-dept',   ticket.department);
        if (ticket.serviceType) card.setAttribute('data-mgmt-type',   ticket.serviceType);
        if (ticket.status)      card.setAttribute('data-mgmt-status', ticket.status);

        return card;
        }


        // ✅ دالة إظهار/إخفاء الفلتره
        // ✅ دالة إظهار الفلتر في قائمة الطلبات الإدارية
        function showManagementRequestsFilter() {
        const filterContainer = document.getElementById('mgmtRequestsFilterContainer');
        if (filterContainer) {
            if (hasFullAccess()) {
            filterContainer.style.display = '';
            populateManagementDeptFilter();
            } else {
            filterContainer.style.display = 'none';
            }
        }
        }


        // ✅ دالة ملء قائمة الأقسام في الفلتر الإداري
        function populateManagementDeptFilter() {
        const filterSelect = document.getElementById('mgmtRequestsDeptFilter');
        if (!filterSelect) return;
        const depts = new Set();
        const cards = document.querySelectorAll('[data-mgmt-dept]');
        cards.forEach(card => {
            const dept = card.getAttribute('data-mgmt-dept');
            if (dept && dept.trim()) depts.add(dept);
        });
        const keep = Array.from(filterSelect.options).filter(o => o.value === '');
        filterSelect.innerHTML = '';
        keep.forEach(opt => filterSelect.appendChild(opt));
        Array.from(depts).sort((a,b)=>a.localeCompare(b,'ar')).forEach(dept=>{
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            filterSelect.appendChild(option);
        });
        }


        // ✅ دالة فلترة الطلبات الإدارية بناءً على القسم والنوع والحالة
        function filterManagementRequestsByAll() {
        const deptFilterSelect   = document.getElementById('mgmtRequestsDeptFilter');
        const typeFilterSelect   = document.getElementById('requestsTypeFilter');
        const statusFilterSelect = document.getElementById('requestsStatusFilter');

        const selectedDepts = Array.from(deptFilterSelect?.selectedOptions || []).map(o => o.value).filter(Boolean);
        const selectedType  = typeFilterSelect?.value || '';
        const selectedStatus= statusFilterSelect?.value || '';

        document.querySelectorAll('[data-mgmt-dept]').forEach(card => {
            const cardDept   = card.getAttribute('data-mgmt-dept');
            const cardType   = card.getAttribute('data-mgmt-type') || '';
            const cardStatus = card.getAttribute('data-mgmt-status') || '';
            const okDept   = !selectedDepts.length || selectedDepts.includes(cardDept);
            const okType   = !selectedType || cardType === selectedType;
            const okStatus = !selectedStatus || cardStatus === selectedStatus;
            card.style.display = (okDept && okType && okStatus) ? '' : 'none';
        });
        }


        // ✅ دالة فلترة الطلبات الإدارية حسب القسم
        function filterManagementRequestsByDept() {
            filterManagementRequestsByAll();
        }
        function showRequestsFilterForAdmin() {
        const filterContainer = document.getElementById('advRequestsFilterContainer');
        if (filterContainer) {
            if (advisoryCurrentMode === 'admin') {
            filterContainer.classList.remove('hidden');
            populateDeptFilter();
            } else {
            filterContainer.classList.add('hidden');
            }
        }
        }


        // ✅ دالة ملء قائمة الأقسام في الفلتره
        function populateDeptFilter() {
        const filterSelect = document.getElementById('advRequestsDeptFilter');
        if (!filterSelect) return;
        const depts = new Set();
        if (window.__allRequestsData && Array.isArray(window.__allRequestsData)) {
            window.__allRequestsData.forEach(req => { if (req.department) depts.add(req.department); });
        }
        const existing = new Set(Array.from(filterSelect.options).map(o => o.value));
        depts.forEach(dept => {
            if (dept && !existing.has(dept)) {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            filterSelect.appendChild(option);
            }
        });
        }


        // ✅ دالة فلترة الطلبات حسب القسم
        function filterRequestsByDept() {
        const filterSelect = document.getElementById('advRequestsDeptFilter');
        const selectedDept = filterSelect ? filterSelect.value : '';
        document.querySelectorAll('[data-req-dept]').forEach(card => {
            const cardDept = card.getAttribute('data-req-dept');
            card.style.display = (!selectedDept || cardDept === selectedDept) ? '' : 'none';
        });
        }




        function hasOrgViewNoRatings() { // وكيل شؤون المدربين
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'trainers_deputy';
        }

        // ✅ 4) من يملك صلاحية نطاق القسم فقط (بدون تبويب "التقييمات")
        function hasDeptScopedAccess() {
        const r = normalizeRole((currentUser?.data?.role || '').trim());
        return r === 'dept_head';
        }

        async function login() {
        const userId = (document.getElementById('userId')?.value || '').trim();

        if (!userId) {
            showError('الرجاء إدخال الرقم التدريبي أو الرقم الوظيفي');
            return;
        }

        try {
            // يفترض أن checkUserPermission تستدعي Apps Script وتعيد {type, name, role?, department?...}
            const userData = await checkUserPermission(userId);

            if (!userData || userData.success === false) {
            showError(userData?.message || 'الرقم غير موجود في النظام');
            return;
            }

            // لو كانت الاستجابة مباشرة من الدالة (بدون success):
            const payload = userData.data ? userData.data : userData;

            // طَبِّع الدور (إن وُجد)
            const role = normalizeRole(payload.role || '');

            // خزّن المستخدم الحالي بشكل موحّد ومتوفّر عالميًا
            currentUser = {
            id: userId,
            data: { ...payload, role }
            };
            window.currentUser = currentUser;

            // توجيه حسب نوع الحساب
            if (payload.type === 'trainee') {
            showTraineeInterface();
            return;
            }

            if (payload.type === 'staff') {
            switch (role) {
                case 'advisory_unit':
                advisoryCurrentMode = 'basic';  // 👈 الوضع الافتراضي
                showAdvisoryInterface();
                return;

                case 'advisor':
                showAdvisorInterface();
                return;
                // داخل switch(role) في login()
                case 'elearning':
                showManagementInterface();
                return;

                // لوحة الإدارة للأدوار الإدارية:
                case 'dept_head':        // رئيس القسم: يرى قسمه فقط
                case 'trainees_vice':    // وكيل شؤون المتدربين: كل الأقسام + تبويب التقييمات
                case 'trainers_deputy':  // وكيل شؤون المدربين: كل الأقسام بدون تبويب التقييمات
                case 'dean':
                case 'quality_vice':
                showManagementInterface();
                return;

                default:
                showError('صلاحية غير معروفة');
                return;
            }
            }

            // لو لم يكن Trainee أو Staff
            showError('نوع مستخدم غير مدعوم');
        } catch (err) {
            showError(err?.message || 'حدث خطأ أثناء تسجيل الدخول');
        }
        }
          document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('userId');
                if (input) {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                    }
                });
                }
            });
        // تحويل أي قيمة قديمة (camelCase) إلى الشكل الموحّد (snake_case)
            // تطبيع الأدوار القديمة/الجديدة لنفس الشكل
            function normalizeRole(role=''){
            let v = String(role || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g,'_');

            // تطبيع مباشر للإنجليزية/العربية
            const map = {
                // إنجليزي قديم/متنوع
                'depthead':'dept_head',
                'dept_head':'dept_head',
                'qualityvice':'quality_vice',
                'quality_vice':'quality_vice',
                'advisoryunit':'advisory_unit',
                'advisory_unit':'advisory_unit',
                'dean':'dean',
                'elearning':'elearning',
                'advisor':'advisor',
                'trainees_deputy':'trainees_vice',
                'trainees_vice':'trainees_vice',
                'trainers_deputy':'trainers_deputy',

                // عربي
                'العميد':'dean',
                'وكيل_ضبط_الجودة':'quality_vice',
                'وكيل_شؤون_المتدربين':'trainees_vice',
                'وكيل_شؤون_المدربين':'trainers_deputy',
                'وحدة_الخدمات_الإرشادية':'advisory_unit',
                'وحدة_الخدمات_الارشادية':'advisory_unit',
                'رئيس_القسم':'dept_head',
                'التدريب_الإلكتروني':'elearning',
                'التدريب_الالكتروني':'elearning',
                'المرشد':'advisor',
                'المرشد_التدريبي':'advisor',
                'متدرب':'trainee'
            };

            // تحويل بعض الأشكال الإنجليزية الشائعة قبل الخريطة
            v = v
                .replace(/^depthead$/,'dept_head')
                .replace(/^qualityvice$/,'quality_vice')
                .replace(/^advisoryunit$/,'advisory_unit')
                .replace(/^dean$/,'dean')
                .replace(/^trainees_deputy$/,'trainees_vice');

            return map[v] || v;
            }

                const ROLE_LABELS = {
                dean: 'العميد',
                quality_vice: 'وكيل ضبط الجودة',
                trainees_vice: 'وكيل شؤون المتدربين',
                trainers_deputy: 'وكيل شؤون المدربين',
                advisory_unit: 'وحدة الخدمات الإرشادية',
                dept_head: 'رئيس القسم',
                advisor: 'المرشد/المدرب',
                elearning: 'التدريب الإلكتروني'
                };

            function labelOf(v) {
            const key = normalizeRole(v);
            return ROLE_LABELS[key] || v;
            }


        function logout() {
        currentUser = null;
        window.currentUser = null; // 👈 مهم لمسح النسخة العالمية
        currentTraineeData = null;
        closeRatingModal?.();
        closeSolutionModal?.();
        document.getElementById('userId').value = '';
        hideAllInterfaces();
        document.getElementById('loginScreen').classList.remove('hidden');
        }


        function hideAllInterfaces() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('advisoryInterface').classList.add('hidden');
            document.getElementById('advisorInterface').classList.add('hidden');
            document.getElementById('managementInterface').classList.add('hidden');
            document.getElementById('traineeInterface').classList.add('hidden');
        }

        async function showAdvisoryInterface() {
        hideAllInterfaces();
        document.getElementById('advisoryInterface').classList.remove('hidden');
        document.getElementById('welcomeMessage').textContent = `مرحباً ${currentUser.data.name}`;

        // 👇 أظهر تبويب "التقييمات" لوحدة الخدمات الإرشادية
        const advRatingsBtn = document.getElementById('advisoryTabRatings');
        if (advRatingsBtn) advRatingsBtn.classList.remove('hidden');

        // ✅ أظهر زر التبديل بين الأوضاع إذا كان المستخدم من وحدة الخدمات الإرشادية
        const modeToggle = document.getElementById('advisoryModeToggle');
        if (modeToggle && normalizeRole((currentUser?.data?.role || '').trim()) === 'advisory_unit') {
            modeToggle.classList.remove('hidden');
            const toggleText = document.getElementById('advisoryModeToggleText');
            if (toggleText) {
                toggleText.textContent = advisoryCurrentMode === 'admin' ? '🔒 وضع عادي' : '🔓 وضع إداري';
            }
        } else if (modeToggle) {
            modeToggle.classList.add('hidden');
        }

        // ✅ أظهر الفلتره إذا كان في الوضع الإداري
        showRequestsFilterForAdmin();

        await loadStatistics();
        }


        async function showAdvisorInterface() {
            hideAllInterfaces();
            document.getElementById('advisorInterface').classList.remove('hidden');
            document.getElementById('advisorWelcome').textContent = `مرحباً ${currentUser.data.name}`;
            await loadAdvisorTicketsView();
        }


        // ✅ 5) إظهار لوحة الإدارة بحسب الدور
        async function showManagementInterface() {
        hideAllInterfaces();
        document.getElementById('managementInterface').classList.remove('hidden');

        const role = normalizeRole(currentUser.data.role);
        const title =
            role === 'dean' ? 'العميد' :
            role === 'quality_vice' ? 'وكيل ضبط الجودة' :
            role === 'trainees_vice' ? 'وكيل شؤون المتدربين' :
            role === 'trainers_deputy' ? 'وكيل شؤون المدربين' :
            role === 'advisory_unit' ? 'وحدة الخدمات الإرشادية - وضع إداري' :
            role === 'elearning'       ? 'التدريب الإلكتروني' :
            role === 'dept_head' ? 'رئيس القسم' : 'لوحة الإدارة';

        document.getElementById('managementTitle').textContent = title;
        document.getElementById('managementWelcome').textContent = `مرحباً ${currentUser.data.name}`;

        // زر العودة لوضع الإرشاد الأساسي
        const backBtn = document.getElementById('backToBasicMode');
        if (backBtn) {
            if (role === 'advisory_unit' && advisoryCurrentMode === 'admin') {
            backBtn.classList.remove('hidden');
            } else {
            backBtn.classList.add('hidden');
            }
        }

        // إظهار تبويب لوحة متابعة الأقسام لمن يملك صلاحيات عليا
        const deptBoardBtn = document.getElementById('tabDeptBoard');
        if (deptBoardBtn) {
            if (hasFullAccess()) deptBoardBtn.classList.remove('hidden');
            else deptBoardBtn.classList.add('hidden');
        }

        // إظهار تبويب "التقييمات" للجميع (مع تقييد البيانات بحسب الدور داخل الدالة)
        const ratingsTabBtn = document.getElementById('tabRatings');
        if (ratingsTabBtn) ratingsTabBtn.classList.remove('hidden');

        // تحميل جميع الطلبات
        await loadManagementTicketsView();

        // ✅ مباشرةً بعد التحميل: أظهر واملأ فلاتر الإدارة لمن يملك الصلاحية
        populateManagementDeptFilter();
        showManagementRequestsFilter();
        }


        async function loadManagementRatingsView(listId = 'ratingsList') {
        const box = document.getElementById(listId);
        if (!box) return;
        box.innerHTML = '<p style="text-align:center;color:#999;">جاري تحميل التقييمات...</p>';

        let tickets = await loadAllTickets();
        tickets = Array.isArray(tickets) ? tickets : [];

        const role = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myId = currentUser?.id || '';

        // ✅ فلترة التقييمات حسب الدور
        let filtered = tickets.filter(t => String(t.status) === 'completed' && Number(t.rating) > 0);

        if (hasFullAccess()) {
            // الصلاحيات العليا: تشوف كل التقييمات
            // (لا تغيير - كل التقييمات)
        } else if (role === 'trainers_deputy') {
            // وكيل شؤون المدربين: تقييمات الأقسام والتدريب الإلكتروني فقط
            filtered = filtered.filter(t => {
                const transferredTo = (t.transferredTo || '').trim();
                const toRole = normalizeRole(transferredTo);
                const dept = (t.department || '').trim();
                
                // يرى التقييمات من التدريب الإلكتروني
                if (toRole === 'elearning' || dept === 'التدريب الإلكتروني') {
                    return true;
                }
                
                // يرى التقييمات من الأقسام العادية
                if (dept && dept !== 'التدريب الإلكتروني') {
                    return true;
                }
                
                return false;
            });
        } else if (role === 'dept_head' && myDept) {
            // ✅ رئيس القسم: تقييمات قسمه + التقييمات الخاصة به (نفس منطق "طلباتي")
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const dept = (t.department || '').trim();
                const completedBy = (t.completedBy || '').trim();
                const createdBy = (t.createdBy || '').trim();
                const assignedTo = (t.assignedTo || '').trim();
                const transferredToName = (t.transferredTo || '').trim();
                
                // يرى تقييمات قسمه أو ما يخصه شخصيًا
                return dept === myDept ||
                       completedBy === myName ||
                       createdBy === myName ||
                       assignedTo === myName ||
                       transferredToName === myName;
            });
        } else if (role === 'advisor') {
            // ✅ المرشد: التقييمات الخاصة به (نفس منطق "طلباتي")
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy = (t.createdBy || '').trim();
                const assignedTo = (t.assignedTo || '').trim();
                const transferredToName = (t.transferredTo || '').trim();
                
                return (
                    completedBy === myName ||
                    createdBy === myName ||
                    assignedTo === myName ||
                    transferredToName === myName
                );
            });
        } else if (role === 'elearning') {
            // التدريب الإلكتروني: تقييمات الطلبات اللي تم تحويلها له
            const myName = (currentUser?.data?.name || '').trim();
            filtered = filtered.filter(t => {
                const transferredTo = (t.transferredTo || '').trim();
                const toRole = normalizeRole(transferredTo);
                return toRole === 'elearning' || transferredTo === myName;
            });
        } else {
            // ✅ الموظفون العاديون: التقييمات الخاصة بهم (نفس منطق "طلباتي")
            const myName = (currentUser?.data?.name || '').trim();
            const myType = (currentUser?.data?.type || '').trim();
            
            if (myType === 'staff') {
                // موظف عادي: يرى التقييمات للتذاكر التي أنشأها أو أكملها أو مُسندة إليه أو محوّلة إليه
                filtered = filtered.filter(t => {
                    const completedBy = (t.completedBy || '').trim();
                    const createdBy = (t.createdBy || '').trim();
                    const assignedTo = (t.assignedTo || '').trim();
                    const transferredToName = (t.transferredTo || '').trim();
                    
                    return (
                        completedBy === myName ||
                        createdBy === myName ||
                        assignedTo === myName ||
                        transferredToName === myName
                    );
                });
            } else if (myType === 'trainee') {
                // متدرب: يرى تقييمات طلباته فقط
                filtered = filtered.filter(t => (t.traineeId || '').trim() === myId);
            } else {
                // حالة أخرى: تقييمات ما أنشأه أو أكمله
                filtered = filtered.filter(t => {
                    const completedBy = (t.completedBy || '').trim();
                    const createdBy = (t.createdBy || '').trim();
                    return completedBy === myName || createdBy === myName;
                });
            }
        }

        const rated = filtered;

        if (!rated.length) {
            box.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تقييمات</p>';
            return;
        }

        // ✅ حساب متوسط التقييمات للصلاحيات العليا فقط
        let averageRatingHtml = '';
        if (hasFullAccess()) {
            const validRatings = rated.filter(t => Number(t.rating) > 0);
            if (validRatings.length > 0) {
                const total = validRatings.reduce((sum, t) => sum + (Number(t.rating) || 0), 0);
                const average = (total / validRatings.length).toFixed(1);
                const roundedAvg = Math.round(parseFloat(average));
                const stars = '★'.repeat(roundedAvg);
                const emptyStars = '☆'.repeat(5 - roundedAvg);
                
                averageRatingHtml = `
                <div style="background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-secondary) 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 99, 65, 0.2);">
                    <div style="font-size: 32px; margin-bottom: 8px;">
                        <span style="color: #FFD700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${stars}${emptyStars}</span>
                    </div>
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 4px;">${average}</div>
                    <div style="font-size: 16px; opacity: 0.9; margin-bottom: 4px;">من 5 نجوم</div>
                    <div style="font-size: 14px; opacity: 0.85;">متوسط التقييمات</div>
                    <div style="font-size: 13px; margin-top: 8px; opacity: 0.8; background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 12px; display: inline-block;">${validRatings.length} تقييم</div>
                </div>
                `;
            } else {
                averageRatingHtml = `
                <div style="background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-secondary) 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">☆☆☆☆☆</div>
                    <div style="font-size: 18px; opacity: 0.9;">لا توجد تقييمات بعد</div>
                </div>
                `;
            }
        }

        const card = (t) => {
            const stars   = Number(t.rating) || 0;
            const comment = (t.ratingComment || '').trim();
            const solution = t.solution || t.executedSolution || t['الحل المنفذ'] || t.solutionText || '-';
            // ✅ إضافة تفاصيل الطلب
            const details = t.requestDetails || t.details || '-';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ticket-status--completed">مكتملة</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span><span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span><span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">تاريخ الإنهاء:</span><span class="v">${formatArabicDate(t.completionDate || t.date)}</span></div>
                </div>

                <div class="ticket-details">
                <div><strong>التقييم:</strong> ★ ${stars}/5</div>
                ${comment ? `<div style="margin-top:6px;"><strong>تعليق المتدرب:</strong> <em>${comment}</em></div>` : ''}
                ${details && details !== '-' ? `<div style="margin-top:6px;"><strong>تفاصيل الطلب:</strong> ${details}</div>` : ''}
                <div style="margin-top:6px;"><strong>الحل المنفذ:</strong> ${solution}</div>
                ${t.completedBy ? `<div style="margin-top:6px;">تم بواسطة: <strong>${t.completedBy}</strong></div>` : ''}
                </div>
            </div>
            `;
        };

        try { rated.sort((a,b) => new Date(b.completionDate || b.date || 0) - new Date(a.completionDate || a.date || 0)); } catch(_){}

        box.innerHTML = averageRatingHtml + rated.map(card).join('');
        }

        async function showTraineeInterface() {
            hideAllInterfaces();
            document.getElementById('traineeInterface').classList.remove('hidden');
            document.getElementById('traineeWelcome').textContent = `مرحباً ${currentUser.data.name}`;
            await loadTraineeTicketsView();
        }


        async function loadTraineeData() {
            const traineeId = document.getElementById('traineeId').value.trim();
            
            if (!traineeId) {
                showError('الرجاء إدخال الرقم التدريبي');
                return;
            }

            const trainee = await getTraineeById(traineeId);
            
            if (trainee) {
                currentTraineeData = trainee;
                
                document.getElementById('traineeName').textContent = trainee.name;
                document.getElementById('traineeIdDisplay').textContent = traineeId;
                document.getElementById('traineeDept').textContent = trainee.department;
                document.getElementById('traineeSpec').textContent = trainee.specialization;
                document.getElementById('traineeAdvisor').textContent = trainee.advisor;
                
                const now = new Date();
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA');
                document.getElementById('currentDay').textContent = days[now.getDay()];
                
                document.getElementById('traineeInfo').classList.remove('hidden');
            } else {
                showError('الرقم التدريبي غير موجود');
            }
        }

        function handleServiceTypeChange() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked');
            const otherDiv = document.getElementById('otherServiceDiv');
            
            if (serviceType && serviceType.value === 'أخرى') {
                otherDiv.classList.remove('hidden');
            } else {
                otherDiv.classList.add('hidden');
            }
        }

        // إضافة مستمع للأزرار
        document.addEventListener('DOMContentLoaded', function() {
            const serviceButtons = document.querySelectorAll('input[name="serviceType"]');
            serviceButtons.forEach(btn => {
                btn.addEventListener('change', handleServiceTypeChange);
            });
        });

        function showTransferOptions() {
            document.getElementById('transferOptions').classList.remove('hidden');
        }

        async function completeTicket() {
        if (!currentTraineeData) {
            showError('الرجاء جلب بيانات المتدرب أولاً');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();

        if (!serviceTypeRadio || !details) {
            showError('الرجاء اختيار نوع الخدمة وكتابة تفاصيل الطلب');
            return;
        }

        // تفاصيل الطلب = الحل المنفذ
        const solutionText = details;

        const now  = new Date();
        const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

        const serviceType = serviceTypeRadio.value === 'أخرى'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'أخرى' && !serviceType) {
            showError('الرجاء تحديد نوع الخدمة');
            return;
        }

        // 1) إنشاء التذكرة للحصول على رقمها (تبقى pending الآن)
        const payload = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            createdBy:      currentUser.data.name
        };

        showLoading('جاري الإرسال...');
        const createRes = await saveNewTicket(payload);

        if (!createRes?.success || !createRes.ticketNumber) {
            hideLoading();
            showError('تعذّر إنشاء التذكرة');
            return;
        }

        const ticketNumber = createRes.ticketNumber;

        // 2) إكمال التذكرة فورًا — هذا ما يكتب "الحل المنفذ" في الأعمدة الصحيحة + السجل اليومي
        const completionDate = now.toLocaleDateString('ar-SA');

        const ok = await completeTicketRequest(ticketNumber, solutionText, currentUser.data.name, completionDate);
        hideLoading();

        if (ok) {
            resetTicketForm();
            showSuccess('تم إنهاء التذكرة وتسجيل "الحل المنفذ" بنجاح');
            // تحديث واجهات إن لزم
            if (typeof loadStatistics === 'function') loadStatistics();
            if (typeof loadMyRequests === 'function') loadMyRequests('requestsList');
        } else {
            showError('تم إنشاء التذكرة، لكن تعذّر إنهاؤها. جرّب من شاشة التذاكر.');
        }
        }

        async function transferTicketAction() {
        if (!currentTraineeData) {
            showError('الرجاء جلب بيانات المتدرب أولاً');
            return;
        }

        const serviceTypeRadio = document.querySelector('input[name="serviceType"]:checked');
        const details = (document.getElementById('requestDetails')?.value || '').trim();
        const transferRadio = document.querySelector('input[name="transferTo"]:checked');

        if (!serviceTypeRadio || !details || !transferRadio) {
            showError('الرجاء إكمال جميع الحقول');
            return;
        }

        let transferTo = normalizeRole(transferRadio.value);

        const serviceType = serviceTypeRadio.value === 'أخرى'
            ? (document.getElementById('otherService')?.value || '').trim()
            : serviceTypeRadio.value;

        if (serviceTypeRadio.value === 'أخرى' && !serviceType) {
            showError('الرجاء تحديد نوع الخدمة');
            return;
        }

        const now = new Date();
        const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

        const ticketData = {
            traineeId:      currentTraineeData.id,
            traineeName:    currentTraineeData.name,
            department:     currentTraineeData.department,
            specialization: currentTraineeData.specialization,
            advisor:        currentTraineeData.advisor,
            date:           now.toLocaleDateString('ar-SA'),
            day:            days[now.getDay()],
            serviceType,
            requestDetails: details,
            status:         'pending',
            transferredTo:  transferTo,
            createdBy:      currentUser.data.name
        };

        showLoading('جاري الإرسال...');
        const result = await saveNewTicket(ticketData);
        hideLoading();
        
        if (result.success) resetTicketForm();
        }


        async function saveNewTicket(payload) {
        const res = await sendRequest('createTicket', payload);

        if (res && res.success) {
            const tn = res?.data?.ticketNumber ?? res?.ticketNumber ?? '—';
            showSuccess(`تم إنشاء التذكرة بنجاح! رقم التذكرة: ${tn}`);
            return { success: true, ticketNumber: tn };
        } else {
            showError(res?.message || 'تعذّر إنشاء التذكرة');
            return { success: false };
        }
        }

        function resetTicketForm() {
            document.getElementById('traineeId').value = '';
            document.querySelectorAll('input[name="serviceType"]').forEach(btn => btn.checked = false);
            document.getElementById('requestDetails').value = '';
            document.getElementById('otherService').value = '';
            document.getElementById('traineeInfo').classList.add('hidden');
            document.getElementById('transferOptions').classList.add('hidden');
            document.getElementById('otherServiceDiv').classList.add('hidden');
            currentTraineeData = null;
        }

        async function loadStatistics() {
        const stats = await calculateStatistics();
        const ids = ['totalTickets','completedTickets','pendingTickets','inProgressTickets'];
        const vals = [stats.total||0, stats.completed||0, stats.pending||0, stats.inProgress||0];
        ids.forEach((id,i)=>{
            const el = document.getElementById(id);
            if (el) el.textContent = vals[i];
        });
        }


        // ✅ جديد: يعرض أزرار “بدء المعالجة/إنهاء/تحويل” ويستخدم تفويض أحداث

// ========== دالة محسّنة لعرض تذاكر المرشد التدريبي ==========
// هذه الدالة تعرض بوضوح التذاكر المحولة مع عبارة "محول إلى"

async function loadAdvisorTicketsView() {
    const containerId = 'advisorTicketsList';
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '<p style="text-align:center;color:#999;">جاري تحميل التذاكر...</p>';

    // 1) اجلب كل التذاكر
    let allTickets = await loadAllTickets();
    allTickets = Array.isArray(allTickets) ? allTickets : [];

    const myName = (currentUser?.data?.name || '').trim();
    const myRole = normalizeRole((currentUser?.data?.role || '').trim());

    // 2) فلترة ذكية لضمان بقاء "المحوّلة منّي" ظاهرة
    const tickets = allTickets.filter(t => {
        const st = String(t.status || '').trim().toLowerCase();
        if (st === 'completed') return false; // لا نعرض المكتملة هنا

        const assignedTo     = (t.assignedTo     || '').trim();
        const createdBy      = (t.createdBy      || '').trim();
        const transferredTo  = (t.transferredTo  || '').trim();
        const transferredBy  = (t.transferredBy  || '').trim();

        // تذاكر "لي" صراحة
        const forMe =
            normalizeRole(transferredTo) === 'advisor' ||   // محوّلة لدور المرشد
            transferredTo === myName ||                     // أو محوّلة باسمي
            assignedTo === myName;                          // أو مُسنَدة باسمي

        // تذاكر "حوّلتها أنا" إلى أي جهة أخرى
        const fromMe =
            transferredBy === myName &&
            normalizeRole(transferredTo) !== 'advisor' &&
            transferredTo !== myName;

        // تذاكر أنشأتها أنا ولم أحولها (بعد)
        const createdByMe = createdBy === myName && !transferredTo;

        return forMe || fromMe || createdByMe;
    });

    // 3) عرض التذاكر
    if (!tickets.length) {
        container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
        return;
    }

    // دوال الشارات
    const clsOf = (st) =>
        st === 'completed'   ? 'ticket-status--completed' :
        st === 'in_progress' ? 'ticket-status--inprogress' : 'ticket-status--pending';

    const txtOf = (st) =>
        st === 'completed'   ? 'مكتملة' :
        st === 'in_progress' ? 'قيد التنفيذ' : 'معلقة';

    container.innerHTML = tickets.map(t => {
        const details = t.requestDetails || t.details || '-';
        const stCls = clsOf(String(t.status||'').trim().toLowerCase());
        const stTxt = txtOf(String(t.status||'').trim().toLowerCase());
        const transferredBy  = (t.transferredBy  || '').trim();
        const transferredTo  = (t.transferredTo  || '').trim();
        const toNorm = normalizeRole(transferredTo);
        
        // ✅ هل حوّلها المرشد؟
        const isTransferredByMe =
            transferredBy === myName &&
            toNorm !== 'advisor' &&           // جهة غير "المرشد"
            transferredTo !== myName;         // ليست محوّلة لاسمي

        // تسمية الجهة بالعربي
        const roleTranslation = {
            'advisor': 'المرشد',
            'dept_head': 'رئيس القسم',
            'elearning': 'التدريب الإلكتروني',
            'trainees_vice': 'وكيل شؤون المتدربين',
            'quality_vice': 'وكيل ضبط الجودة',
            'dean': 'العميد'
        };

        let transferDestination = '';
        if (isTransferredByMe) {
            const toRoleNorm = normalizeRole(transferredTo);
            transferDestination = roleTranslation[toRoleNorm] || transferredTo || 'جهة أخرى';
            if (toRoleNorm === 'dept_head' && t.department) {
                transferDestination = `رئيس القسم (${t.department})`;
            }
        }

        return `
        <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}">
            <div class="ticket-head">
            ${isTransferredByMe ? '<span class="transferred-badge">↗️ محوّلة</span>' : ''}
            <span class="ticket-status-badge ${stCls}">${stTxt}</span>
            <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
            </div>

            <div class="ticket-sep"></div>

            <div class="ticket-grid">
            <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
            <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
            <div class="ticket-row"><span class="k">القسم:</span> <span class="v">${t.department || '-'}</span></div>
            <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
            <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${formatArabicDate(t.date)}</span></div>

            ${(() => {
                let statusDisplay = '📋 بانتظار البدء';
                if (isTransferredByMe) {
                    // ✅ عرض واضح جداً: "محول إلى"
                    statusDisplay = `📤 <strong style="color:#FF9800; font-size:16px;">محول إلى:</strong> <strong style="color:var(--tvtc-primary); font-size:17px;">${transferDestination}</strong>`;
                    if (t.transferDate) statusDisplay += ` <span style="color:#6B7280;">— بتاريخ ${formatArabicDate(t.transferDate, true)}</span>`;
                } else if (String(t.status) === 'in_progress' && t.startedBy) {
                    statusDisplay = `⏱️ قيد المعالجة منذ: ${t.startDate || '—'} (بواسطة ${t.startedBy})`;
                } else if (String(t.status) === 'pending') {
                    statusDisplay = '🔔 بانتظار البدء';
                }
                return `<div class="ticket-row" style="background:#FFF3E0; padding:12px; border-radius:6px; border-right:4px solid #FF9800;">
                <span class="v" style="width:100%; text-align:right;">${statusDisplay}</span>
                </div>`;
            })()}
            </div>

            ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}

            ${isTransferredByMe ? `
            <div class="transfer-info" style="background:#FFF3E0; border:2px solid #FFE0B2; border-right:4px solid #FF9800; padding:14px;">
                <div style="font-size:17px; margin-bottom:10px; font-weight:700;">
                    <strong style="color:#E65100;">📍 محول إلى:</strong> 
                    <strong style="color:var(--tvtc-primary); font-size:19px;">${transferDestination}</strong>
                </div>
                ${t.transferDate ? `<div style="color:#6B7280; font-size:14px; margin-top:6px;"><strong>⏰ تاريخ التحويل:</strong> ${formatArabicDate(t.transferDate, true)}</div>` : ''}
                ${transferredBy ? `<div style="color:#6B7280; font-size:14px; margin-top:4px;"><strong>👤 حوّلها:</strong> ${transferredBy}</div>` : ''}
                <div style="margin-top:12px; font-size:13px; color:#6B7280; padding:10px; background:#FFF8E1; border-radius:6px; border:1px dashed #FFB74D;">
                    ⚠️ التذكرة محوّلة إلى <strong>${transferDestination}</strong> — يمكنك إلغاء التحويل عند الحاجة
                </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="view-details" data-ticket="${t.ticketNumber}">عرض التفاصيل</button>
                <button class="btn btn-warning" data-action="cancel-transfer" data-ticket="${t.ticketNumber}">إلغاء التحويل</button>
            </div>
            ` : `
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">بدء المعالجة</button>
                <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">تم الحل</button>
                <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">تحويل</button>
            </div>
            `}
        </div>`;
    }).join('');

    // 4) تفويض أحداث الأزرار
    container.onclick = async (ev) => {
        const btn = ev.target.closest('button[data-action]');
        if (!btn) return;

        const action = btn.getAttribute('data-action');
        const ticketNumber = btn.getAttribute('data-ticket');
        if (!ticketNumber) { 
            showError('رقم التذكرة غير معروف'); 
            return; 
        }

        try {
            if (action === 'start') {
                const ok = await updateTicketStatus(ticketNumber, {
                    status: 'in_progress',
                    startedBy: currentUser.data.name,
                    startDate: new Date().toLocaleDateString('ar-SA')
                });
                if (ok) await loadAdvisorTicketsView();

            } else if (action === 'complete') {
                openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
                openAdvisorTransferModal(ticketNumber);

            } else if (action === 'view-details') {
                showMessage('عرض التفاصيل', 'يمكنك متابعة الحالة في لوحة "جميع الطلبات".');

            } else if (action === 'cancel-transfer') {
                const go = window.confirm('هل تريد إلغاء التحويل وإرجاع التذكرة إليك؟');
                if (!go) return;
                const ok = await updateTicketStatus(ticketNumber, {
                    transferredTo: 'advisor',
                    transferredBy: '',
                    transferDate: ''
                });
                if (ok) {
                    showMessage('تم إلغاء التحويل', 'تم إرجاع التذكرة بنجاح.');
                    await loadAdvisorTicketsView();
                }
            }
        } catch (err) {
            showError(err?.message || String(err));
        }
    };
}

        // ✅ 6) تحميل طلبات الإدارة بما يناسب الدور
        async function loadManagementTicketsView() {
        const role   = normalizeRole(currentUser?.data?.role || '');
        const myDept = (currentUser?.data?.department || '').trim();
        const myName = (currentUser?.data?.name || '').trim();   // 👈 تعريف الاسم هنا
        let tickets  = [];

        if (hasFullAccess()) {
            // العميد + وكيل المتدربين + ضبط الجودة + وحدة الإرشاد
            tickets = await loadAllTickets();

        } else if (role === 'elearning') {
            // يشوف فقط ما حُوِّل إلى "التدريب الإلكتروني" أو أُسنِد لاسمه
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
            const toRole        = normalizeRole((t.transferredTo || '').trim());
            const toName        = (t.transferredTo || '').trim();
            const assigned      = (t.assignedTo || '').trim();
            // 1) محوّل إلى دور elearning (إنجليزي/عربي بعد normalize)
            const forElearningRole = toRole === 'elearning';
            // 2) محوّل بالاسم إلى نفس المستخدم (لو بعض السجلات تحفظ اسم المسؤول بدلاً من الدور)
            const forMeByName      = toName === myName || assigned === myName;
            return forElearningRole || forMeByName;
            });

        } else if (role === 'trainers_deputy') {
            // وكيل شؤون المدربين: يشوف التدريب الإلكتروني والأقسام (اطلاع فقط)
            const all = await loadAllTickets();
            tickets = (all || []).filter(t => {
                const dept = (t.department || '').trim();
                // يشوف التدريب الإلكتروني والأقسام العادية
                return dept === 'التدريب الإلكتروني' || (dept && dept !== '');
            });

        } else if (role === 'dept_head' && myDept) {
            // رئيس القسم: قسمه فقط
            const res = await sendRequest('searchTickets', { department: myDept });
            tickets = (res && res.success) ? res.data : [];
        }


        function displayTicketsWithActions(containerId, tickets){
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!Array.isArray(tickets) || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
            return;
        }

        const myRole = normalizeRole(currentUser?.data?.role || '');
        const myName = (currentUser?.data?.name || '').trim();
        
        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass((t.status || '').toLowerCase());
            const txt = statusBadgeText((t.status || '').toLowerCase());
            const details = t.requestDetails || t.details || '-';
            const isCompleted = String(t.status).toLowerCase() === 'completed';
            
            const transferredByRaw = (t.transferredBy || '').trim();
            const transferredToRaw = (t.transferredTo || '').trim();
            const toNorm = normalizeRole(transferredToRaw); // ✅ مهم

            // ✅ صحيح: نعتبرها "محوّلة من المرشد" إذا كانت جهتها رئيس القسم (بأي لغة/تنسيق) أو محوّلة بالاسم
            const isFromAdvisor =
                !!transferredByRaw && (
                toNorm === 'dept_head' ||
                transferredToRaw === myName
                );

            // ترجمة الوجهات بالاعتماد على toNorm أولًا
            const roleTranslation = {
                'advisor': 'المرشد',
                'dept_head': 'رئيس القسم',
                'elearning': 'التدريب الإلكتروني',
                'trainees_vice': 'وكيل شؤون المتدربين',
                'quality_vice': 'وكيل ضبط الجودة',
                'dean': 'العميد'
            };
            const roleAr = roleTranslation[toNorm] || transferredToRaw || 'جهة أخرى';

            return `
            <div class="ticket-card modern" data-ticket="${t.ticketNumber || ''}" data-mgmt-dept="${t.department || ''}" data-mgmt-type="${t.serviceType || ''}" data-mgmt-status="${t.status || ''}">
                <div class="ticket-head">
                ${isFromAdvisor ? '<span class="transfer-from-badge">↗️ محوّلة من المرشد</span>' : ''}
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${formatArabicDate(t.date)}</span></div>

                ${(() => {
                    let statusDisplay = '📋 بانتظار المتابعة';
                    if (String(t.status).toLowerCase() === 'in_progress' && t.startedBy) {
                    statusDisplay = `⏱️ قيد المعالجة لدى: <strong>${t.startedBy}</strong>`;
                    } else if (isFromAdvisor && transferredByRaw) {
                    statusDisplay = `📥 محوّلة من: <strong>${transferredByRaw}</strong>`;
                    } else if (transferredToRaw) {
                    statusDisplay = `📤 محول إلى: <strong>${roleAr}</strong>`;
                    }
                    return `<div class="ticket-row" style="background:#f0f0f0; padding:8px; border-radius:4px;"><span class="k">الحالة:</span> <span class="v">${statusDisplay}</span></div>`;
                })()}
                
                ${t.completedBy ? `<div class="ticket-row"><span class="k">أنهاه:</span> <span class="v" style="color:#2c9a4f; font-weight:600;">${t.completedBy}</span></div>` : ''}
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}

                ${isCompleted 
                ? `<div style="padding:12px; background:#e8f5e9; border-radius:6px; text-align:center; color:#2c9a4f; font-weight:600; margin-top:12px;">✓ الطلب مكتمل</div>` 
                : `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                    <button class="btn btn-primary" data-action="start" data-ticket="${t.ticketNumber}">بدء المعالجة</button>
                    <button class="btn btn-success" data-action="complete" data-ticket="${t.ticketNumber}">تم الحل</button>
                    <button class="btn btn-warning" data-action="transfer" data-ticket="${t.ticketNumber}">تحويل</button>
                    </div>`
                }
            </div>
            `;
        }).join('');
        }

      /* ===== [FIX] attachManagementActions: افتح مودال التحويل بدل prompt ===== */
      function attachManagementActions(containerId){
        const container = document.getElementById(containerId);
        if (!container) return;

        container.onclick = async (ev) => {
          const btn = ev.target.closest('button[data-action]');
          if (!btn) return;

          const action = btn.getAttribute('data-action');
          const ticketNumber = btn.getAttribute('data-ticket');
          if (!ticketNumber) { showError('رقم التذكرة غير معروف'); return; }

          try {
            if (action === 'start') {
              const ok = await updateTicketStatus(ticketNumber, {
                status: 'in_progress',
                startedBy: currentUser?.data?.name || currentUser?.name || 'مشرف',
                startDate: new Date().toLocaleDateString('ar-SA')
              });
              if (ok) await loadManagementTicketsView();

            } else if (action === 'complete') {
              openSolutionModal(ticketNumber);

            } else if (action === 'transfer') {
              openAdvisorTransferModal(ticketNumber); // ✅ لا prompt
            }
          } catch (err) {
            showError(err?.message || String(err));
          }
        };
      }




        const caps = getRoleCapabilities(currentUser.data);
        if (caps.canClose) {
        displayTicketsWithActions('managementTicketsList', tickets);
        attachManagementActions('managementTicketsList'); // تفويض أحداث للأزرار
        } else {
        displayTickets('managementTicketsList', tickets); // عرض قراءة فقط
        }   
        }

        async function loadTraineeTicketsView() {
        const tickets = await loadTraineeTickets(currentUser.id);
        __lastTraineeTickets = Array.isArray(tickets) ? tickets : [];
        displayTraineeTickets(__lastTraineeTickets);
        }

        function isTicketRatedLocal(ticketNumber) {
        const t = (__lastTraineeTickets || []).find(x => String(x.ticketNumber) === String(ticketNumber));
        return t && Number(t.rating) > 0;
        }


        // 2) عدّل loadMyRequests لتأخذ containerId وتعرض فيه
        // ========== استبدال كامل للدالة ==========
        async function loadMyRequests(containerId = 'requestsList') {
        try {
            showLoading('جارٍ تحميل طلباتك...');
            const tickets = await loadAllTickets();
            hideLoading();

            if (!Array.isArray(tickets) || !tickets.length) {
            displayTickets(containerId, []);
            return;
            }

            const meName = (currentUser?.data?.name || '').trim();
            const meRole = normalizeRole((currentUser?.data?.role || '').trim());
            const meType = (currentUser?.data?.type || '').trim();

            let myTickets = [];

            if (meType === 'staff') {
            if (meRole === 'advisory_unit') {
                // وحدة الإرشاد: تُظهر الكل في وضع إداري (لو عندك سويتش وضع)
                // إن أردتها مقيّدة في الوضع العادي، عدّل هنا حسب حاجتك
                myTickets = tickets;
            } else {
                // المرشد/الموظفون العاديون:
                myTickets = tickets.filter((t) => {
                const st                 = String(t.status || '').trim().toLowerCase();
                const createdBy          = (t.createdBy || '').trim();
                const completedBy        = (t.completedBy || '').trim();
                const assignedTo         = (t.assignedTo || '').trim();
                const transferredToName  = (t.transferredTo || '').trim();
                const transferredByName  = (t.transferredBy || '').trim();

                // 👈 الجديد: ثبّت الطلبات التي حوّلها المرشد "منّي"
                // بشرط ألا تكون مُكتملة — متى اكتملت، نتركها تسقط ما لم تكن تخصّه بشيء آخر.
                const fromMeAndNotClosed = (transferredByName === meName) && (st !== 'completed');

                // الحالات التي تُبقي التذكرة في «طلباتي»
                return (
                    fromMeAndNotClosed ||           // ✅ جديدة
                    completedBy === meName ||       // أكملتها أنا
                    createdBy   === meName ||       // أنشأتها أنا
                    assignedTo  === meName ||       // مُسنَدة لي
                    transferredToName === meName    // مُحوّلة لاسمي مباشرة
                );
                });
            }

            } else if (meType === 'trainee') {
            myTickets = tickets.filter((t) =>
                String(t.traineeId).trim() === String(currentUser.id).trim()
            );

            } else {
            // أي نوع آخر: اعرض ما أنشأته أو أكملته
            myTickets = tickets.filter((t) => {
                const completedBy = (t.completedBy || '').trim();
                const createdBy   = (t.createdBy   || '').trim();
                return completedBy === meName || createdBy === meName;
            });
            }

            // ترتيب تنازلي بالتاريخ إن وُجد
            try { myTickets.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)); } catch (_) {}

            // إضافة لابل ودي لجهة التحويل
            const withLabels = myTickets.map((t) => ({
            ...t,
            transferredToLabel: labelOf(t.transferredTo || '')
            }));

            displayTickets(containerId, withLabels);

        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }
        // ======== نهاية الاستبدال الكامل للدالة ==========



        function displayTickets(containerId, tickets) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!tickets || !tickets.length) {
            container.innerHTML = '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            const cls = statusBadgeClass(t.status);
            const txt = statusBadgeText(t.status);
            const details = t.requestDetails || t.details || '-';
            // ✅ إضافة الحل المنفذ
            const solution = t.solution || t.executedSolution || t['الحل المنفذ'] || t.solutionText || '-';
            const showSolution = String(t.status) === 'completed' && solution !== '-';
            
            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${t.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">المتدرب:</span> <span class="v">${t.traineeName || '-'}</span></div>
                <div class="ticket-row"><span class="k">الرقم التدريبي:</span> <span class="v">${t.traineeId || '-'}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span> <span class="v">${t.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">التخصص:</span> <span class="v">${t.specialization || '-'}</span></div>
                <div class="ticket-row"><span class="k">نوع الخدمة:</span> <span class="v">${t.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span> <span class="v">${formatArabicDate(t.date)}</span></div>
                </div>

                ${details && details !== '-' ? `<div class="ticket-details">📝 <strong>تفاصيل الطلب:</strong> ${details}</div>` : ''}
                ${showSolution ? `<div class="ticket-details" style="margin-top:8px;">✅ <strong>الحل المنفذ:</strong> ${solution}</div>` : ''}

                <div class="ticket-foot">
                ${t.completedBy ? `<span>تم بواسطة: <strong>${t.completedBy}</strong></span>` : ''}
                ${t.completedBy && (t.transferredTo || t.assignedTo) ? '<span class="dot"></span>' : ''}
                ${(t.transferredTo || t.transferredToLabel)  ? `<span>محوّل إلى: <strong>${t.transferredToLabel || labelOf(t.transferredTo)}</strong></span>`: ''}
                ${t.assignedTo ? `<span class="dot"></span><span>مُسنَد إلى: <strong>${t.assignedTo}</strong></span>` : ''}
                </div>
            </div>
            `;
        }).join('');
        }

        // ✅ CORRECT
        function displayTraineeTickets(tickets) {
        const host = document.getElementById('traineeTicketsList');
        if (!host) return;

        const list = Array.isArray(tickets) ? tickets : [];

        // تقسيم التذاكر
        const needRating = list.filter(t => String(t.status) === 'completed' && !(Number(t.rating) > 0));
        const rated      = list.filter(t => String(t.status) === 'completed' &&  (Number(t.rating) > 0));

        // مولد بطاقة (مبسّط ويستخدم دوال الشارات الموحّدة لديك)
        const card = (ticket) => {
            const isRated = Number(ticket.rating) > 0;
            const cls = statusBadgeClass(String(ticket.status).toLowerCase());
            const txt = statusBadgeText(String(ticket.status).toLowerCase());
            const ratingBadge = isRated
            ? `<span class="rating-badge" title="${ticket.rating} — ${RATING_LABELS[ticket.rating] || ''}">★ ${ticket.rating}/5</span>`
            : '';

            return `
            <div class="ticket-card modern">
                <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || '—'}</span>
                </div>

                <div class="ticket-sep"></div>

                <div class="ticket-grid">
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span><span class="v">${formatArabicDate(ticket.date)}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">المرشد:</span><span class="v">${ticket.advisor || '-'}</span></div>
                </div>

                <div class="ticket-foot">
                ${ratingBadge}
                ${isRated && ticket.ratingComment ? `<span class="dot"></span><span>تعليقك: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(!isRated && String(ticket.status) === 'completed')
                    ? `<span class="dot"></span>
                    <button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">قيّم الخدمة</button>`
                    : ''}
                </div>
            </div>
            `;
        };

        

        const needHtml  = needRating.length ? needRating.map(card).join('') :
            `<p style="text-align:center;color:#999;">لا توجد تذاكر مكتملة تنتظر تقييمك</p>`;

        const ratedHtml = rated.length ? rated.map(card).join('') :
            `<p style="text-align:center;color:#999;">لا توجد تذاكر مكتملة ومقيَّمة</p>`;

        // مخرجات التبويبات داخل نفس الحاوية الصحيحة (#traineeTicketsList)
        host.innerHTML = `
            <div class="tabs" id="traineeTicketsTabs" style="margin-bottom:16px;">
            <button class="tab active" data-tab="need"  onclick="switchTraineeTicketsTab('need')">
                بحاجة لتقييم <span style="opacity:.8;font-size:12px;">(${needRating.length})</span>
            </button>
            <button class="tab"        data-tab="rated" onclick="switchTraineeTicketsTab('rated')">
                مكتملة ومقيَّمة <span style="opacity:.8;font-size:12px;">(${rated.length})</span>
            </button>
            </div>

            <div id="traineeTab-need"  class="tab-content active">${needHtml}</div>
            <div id="traineeTab-rated" class="tab-content">${ratedHtml}</div>
        `;
        }

        // حدّث مبدّل التبويبات ليتعامل مع القيم الجديدة: need / rated
        function switchTraineeTicketsTab(which) {
        const tabsBar = document.getElementById('traineeTicketsTabs');
        if (!tabsBar) return;

        tabsBar.querySelectorAll('.tab').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === which);
        });

        ['need','rated'].forEach(name => {
            const pane = document.getElementById('traineeTab-' + name);
            if (pane) pane.classList.toggle('active', name === which);
        });
        }


        async function loadMyTicketsUI() {
                    if (currentUser?.data?.type === 'trainee') {
        await loadTraineeTicketsView(); // نستخدم العرض الحديث فقط
        return;
        }

        try {
            const me = window.currentUser ?? currentUser;   // خذ أيهما متوفر
            if (!me || !me.id) {
            showError('لم يتم التعرف على المستخدم الحالي');
            return;
            }

            showLoading('جاري تحميل طلباتك...');
            const res = await sendRequest('getTraineeTickets', { traineeId: me.id });
            hideLoading();

            if (!res || !res.success) {
            showError(res?.message || 'تعذر تحميل طلباتك');
            return;
            }

            const list = document.getElementById('myTicketsList');
            if (!list) return;
            list.innerHTML = '';

            (res.data || []).forEach((row, i) => {
            const li = document.createElement('li');
            li.className = 'ticket-item';
            li.innerHTML = `
                <div class="ticket-head">
                <span class="ticket-id">#${i + 1}</span>
                <span class="ticket-date">${row['التاريخ'] || ''} (${row['اليوم'] || ''})</span>
                </div>
                <div class="ticket-body">
                <div><strong>المرشد:</strong> ${row['اسم المرشد التدريبي'] || '-'}</div>
                <div><strong>طلب الخدمة:</strong> ${row['طلب الخدمة'] || '-'}</div>
                <div><strong>الحل المنفذ:</strong> ${row['الحل المنفذ'] || row['تفاصيل الطلب'] || '-'}</div>
                </div>
            `;
            list.appendChild(li);
            });
        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // ✅ حالة داخلية لحفظ رقم التذكرة المفتوحة في المودال
        let __activeTicketNumber = null;

        function openSolutionModal(ticketNumber) {
        __activeTicketNumber = ticketNumber;
        const modal = document.getElementById('solutionModal');
        const textarea = document.getElementById('solutionText');
        if (!modal || !textarea) return;

        textarea.value = ''; // تصفير كل مرة
        modal.classList.remove('hidden');
        textarea.focus();
        }

        function closeSolutionModal() {
        const modal = document.getElementById('solutionModal');
        if (modal) modal.classList.add('hidden');
        __activeTicketNumber = null;
        }


        async function submitSolution() {
        const textarea = document.getElementById('solutionText');
        const solution = (textarea?.value || '').trim();
        const saveButton = document.getElementById('saveSolutionBtn') || event?.target;

        if (!__activeTicketNumber) {
            showError('رقم التذكرة غير معروف');
            return;
        }
        if (!solution) {
            showError('الرجاء كتابة الحل المنفذ');
            textarea?.focus();
            return;
        }

        // إظهار مؤشر الانتظار
        let originalText = '';
        if (saveButton) {
            originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span style="display:inline-block;animation:spin 1s linear infinite">⏳</span> جاري الحفظ...';
        }

        showLoading('جاري إنهاء التذكرة...');

        try {
            // طلب الإنهاء من الخادوم
            const ok = await completeTicketRequest(__activeTicketNumber, solution, currentUser.data.name);

            hideLoading();

            if (ok) {
                // إزالة فورية اختيارية من القائمة الحالية (قبل إعادة التحميل)
                const card = document.querySelector(`.ticket-card[data-ticket="${__activeTicketNumber}"]`);
                if (card) card.remove();

                closeSolutionModal();

                // تعيد تحميل "المحوّلة لي" (لن تظهر المكتملة) + تحدّث "طلباتي"
                if (typeof loadAdvisorTicketsView === 'function') {
                await loadAdvisorTicketsView();
                }
                if (typeof loadMyRequests === 'function') {
                await loadMyRequests();
                }

                showSuccess('تم إنهاء التذكرة وتسجيل الحل بنجاح');
            }
        } finally {
            // إعادة الزر لحالته الطبيعية
            if (saveButton && originalText) {
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            }
        }
        }


        // ✅ إغلاق بالمفتاح ESC والنقر خارج المربع
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeSolutionModal();
        });
        const _sm = document.getElementById('solutionModal');
        if (_sm) {
        _sm.addEventListener('click', (ev) => {
            if (ev.target.id === 'solutionModal') closeSolutionModal();
        });
        } else {
        // لو المودال تحت السكربت: انتظر DOM جاهز
        document.addEventListener('DOMContentLoaded', () => {
            const sm2 = document.getElementById('solutionModal');
            if (sm2) {
            sm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'solutionModal') closeSolutionModal();
            });
            }
        });
        }

      // ✅ دالة فتح التقارير الإدارية
      function openAdminReports() {
          // التحقق من الصلاحيات أولاً
          const user = currentUser?.data || currentUser;
          if (!user) {
              showError('يجب تسجيل الدخول أولاً');
              return;
          }

          const role = normalizeRole(user.role);
          
          // قائمة الأدور المسموح لها بالوصول
          const allowedRoles = [
              'management', 'admin', 'quality_admin', 
              'quality_vice', 'dean', 'trainees_vice'
          ];

          if (!allowedRoles.includes(role)) {
              showError('⛔️ الوصول مقصور على الإدارة العليا فقط');
              return;
          }

          // فتح صفحة التقارير في نافذة جديدة
          window.open('reports_admin.html', '_blank', 'width=1200,height=700,scrollbars=yes');
      }

        // ===== تطبيع الأدوار إلى مفاتيح موحّدة =====
      function normalizeRoleId(rawRole) {
        if (!rawRole) return '';
        const r = String(rawRole).trim().toLowerCase().replace(/\s+/g, '_');

        // خرائط مرادفات عربية/إنجليزية لكل دور
        const MAP = {
          // رئيس القسم
          dept_head: new Set([
            'dept_head','department_head','head_of_department','hod',
            'رئيس_القسم','رئيس-القسم','رئيس القسم','رئيس/القسم','رئيسالقسم'
          ]),
          // المرشد التدريبي
          advisor: new Set([
            'advisor','training_advisor','student_counselor',
            'المرشد','المرشد_التدريبي','مرشد_تدريبي','مرشد تدريبي'
          ]),
          // مدير التدريب الإلكتروني
          elearning: new Set([
            'elearning','e_learning','e-learning','مدير_التدريب_الإلكتروني','مدير التدريب الإلكتروني'
          ]),
          // وكيل شؤون المتدربين
          trainees_vice: new Set([
            'trainees_vice','vice_dean_trainees','وكيل_شؤون_المتدربين','وكيل شؤون المتدربين'
          ]),
          // وكيل شؤون المدربين (اختياري)
          trainers_vice: new Set([
            'trainers_vice','vice_dean_trainers','وكيل_شؤون_المدربين','وكيل شؤون المدربين'
          ]),
          // وكيل ضبط الجودة
          quality_vice: new Set([
            'quality_vice','vice_dean_quality','وكيل_ضبط_الجودة','وكيل ضبط الجودة'
          ]),
          // العميد
          dean: new Set([
            'dean','العميد'
          ])
        };

        for (const [key, variants] of Object.entries(MAP)) {
          if (variants.has(r)) return key;
        }
        // لو ما تطابق شيء نرجّع النص بعد تبسيطه — معناه دور غير معروف لكن سنعرضه كخيار عام
        return r;
      }

        // ============================================
        // ✅ دوال مودال التحويل للمرشد
        // ============================================

        // ===== [FIX] فتح مودال التحويل ببناء الخيارات حسب دور المستخدم =====
        /* ===== [FIX] openAdvisorTransferModal: بناء الخيارات حسب الدور الحالي ===== */
        let __advisorTransferTicketNumber = null;

        function openAdvisorTransferModal(ticketNumber) {
          __advisorTransferTicketNumber = ticketNumber;

          // عناوين العرض لكل دور
          const LABELS = {
            advisor:        'المرشد التدريبي',
            dept_head:      'رئيس القسم',
            elearning:      'مدير التدريب الإلكتروني',
            trainees_vice:  'وكيل شؤون المتدربين',
            trainers_vice:  'وكيل شؤون المدربين',   // ✅ مضاف
            quality_vice:   'وكيل ضبط الجودة',
            dean:           'العميد'
          };

          // القائمة الافتراضية
          let base = [
            'dept_head',
            'elearning',
            'trainees_vice',
            'trainers_vice', // ✅ مضاف
            'quality_vice',
            'dean',
            'advisor'
          ];

          const myRole = (currentUser?.role || currentUser?.data?.role || '').trim();

          // لا تظهر نفس الدور في جهات التحويل
          base = base.filter(r => r && r !== myRole);

          // تخصيص: إن كان المستخدم رئيس قسم، لا تعرض "رئيس القسم" وأبرز "المرشد التدريبي"
          if (myRole === 'dept_head') {
            base = base.filter(r => r !== 'dept_head');
            if (!base.includes('advisor')) base.unshift('advisor');
          }

          // حقن الخيارات داخل المودال
          const listEl = document.querySelector('#advisorTransferModal .transfer-options, #advisorTransferModal .transfer-targets');
          if (listEl) {
            listEl.innerHTML = base.map(role => {
              const id = `transfer_to_${role}`;
              return `
                <label for="${id}" class="transfer-card">
                  <input type="radio" id="${id}" name="advisorTransferTo" value="${role}">
                  <span>${LABELS[role] || role}</span>
                </label>
              `;
            }).join('');
          } else {
            console.warn('لم يتم العثور على .transfer-options داخل #advisorTransferModal');
          }

          // افتح المودال
          document.getElementById('advisorTransferModal')?.classList.remove('hidden');
          document.body.classList.add('modal-open');
        }

        function closeAdvisorTransferModal() {
          document.getElementById('advisorTransferModal')?.classList.add('hidden');
          document.body.classList.remove('modal-open');
        }



        async function submitAdvisorTransfer() {
        const selected = document.querySelector('input[name="advisorTransferTo"]:checked');
        
        if (!__advisorTransferTicketNumber) {
            showError('رقم التذكرة غير معروف');
            return;
        }
        
        if (!selected) {
            showError('الرجاء اختيار جهة التحويل');
            return;
        }

        const transferTo = selected.value; // dept_head أو elearning
        
        showLoading('جاري تحويل التذكرة...');

        try {
            // ✅ تثبيت محلي + إعادة تحميل
            const ok = await transferTicket(__advisorTransferTicketNumber, transferTo, currentUser.data.name);
            hideLoading();
            if (ok) {
            // تطبيع فوري على DOM الحالي ليبقى الكرت ظاهرًا كـ "↗️ محوّلة"
            try {
                const card = document.querySelector(`.ticket-card[data-ticket="${__advisorTransferTicketNumber}"]`);
                if (card) {
                const badge = card.querySelector('.transferred-badge');
                if (!badge) {
                    const head = card.querySelector('.ticket-head');
                    if (head) head.insertAdjacentHTML('afterbegin', '<span class="transferred-badge">↗️ محوّلة</span>');
                }
                }
            } catch(_) {}

            closeAdvisorTransferModal();
            await loadAdvisorTicketsView();
            showSuccess('تم تحويل التذكرة بنجاح');
            }

        } catch (err) {
            hideLoading();
            showError(err?.message || String(err));
        }
        }

        // إغلاق بالمفتاح ESC والنقر خارج المربع
        document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') closeAdvisorTransferModal();
        });
        
        const _atm = document.getElementById('advisorTransferModal');
        if (_atm) {
        _atm.addEventListener('click', (ev) => {
            if (ev.target.id === 'advisorTransferModal') closeAdvisorTransferModal();
        });
        } else {
        document.addEventListener('DOMContentLoaded', () => {
            const atm2 = document.getElementById('advisorTransferModal');
            if (atm2) {
            atm2.addEventListener('click', (ev) => {
                if (ev.target.id === 'advisorTransferModal') closeAdvisorTransferModal();
            });
            }
        });
        }
        // ============================================
// Utility: رسالة مبسطة عند الحاجة (تفادي undefined)
function showMessage(title = 'معلومة', text = '') {
  try {
    // لو عندك نظام توست/مودال موحد، استخدمه هنا
    if (typeof showSuccess === 'function' && !text) return showSuccess(title);
    if (typeof showSuccess === 'function') return showSuccess(`${title} — ${text}`);
  } catch(_) {}
  alert(`${title}${text ? ':\n' + text : ''}`);
}


async function switchTab(event, tabName) {
  // 1) تبديل التفعيل داخل نفس .content
  const parentContent = event.target.closest('.content');
  parentContent.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  parentContent.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  // 2) تحميل البيانات بحسب التبويب
  if (tabName === 'statistics') {
    loadStatistics();

  } else if (tabName === 'managementAll') {
    // ✅ تحميل جميع الطلبات للصلاحيات العليا مع الفلتر
    await loadManagementTicketsView();
    // ملء الفلتر وإظهاره للصلاحيات العليا
    populateManagementDeptFilter();
    showManagementRequestsFilter();

  } else if (tabName === 'myRequests') {
    if (currentUser?.data?.type === 'trainee') {
      loadTraineeTickets(currentUser.id).then(list => {
        const holder = document.getElementById('requestsList');
        if (!holder) return;

        window.__allRequestsData = list || [];  // ✅ احفظ البيانات للفلتره
        holder.innerHTML = '';
        const cards = (list || []).map(ticket => {
        const rated   = Number(ticket.rating) > 0;
        const details = ticket.requestDetails || ticket.details || '-';

        // ✅ استخدم الدوال الموحدة
        const cls = statusBadgeClass(ticket.status);
        const txt = statusBadgeText(ticket.status);

        const ratingBadge = rated
            ? `<span class="rating-badge" title="${ticket.rating} — ${RATING_LABELS[ticket.rating] || ''}">★ ${ticket.rating}/5</span>`
            : '';

        return `
            <div class="ticket-card modern" data-req-dept="${ticket.department || ''}">
            <div class="ticket-head">
                <span class="ticket-status-badge ${cls}">${txt}</span>
                <span class="ticket-id-chip">${ticket.ticketNumber || '—'}</span>
            </div>
            <div class="ticket-sep"></div>
            <div class="ticket-grid">
                <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${ticket.serviceType || '-'}</span></div>
                <div class="ticket-row"><span class="k">التاريخ:</span><span class="v">${formatArabicDate(ticket.date)}</span></div>
                <div class="ticket-row"><span class="k">القسم:</span><span class="v">${ticket.department || '-'}</span></div>
                <div class="ticket-row"><span class="k">المرشد:</span><span class="v">${ticket.advisor || '-'}</span></div>
            </div>
            ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}
            <div class="ticket-foot">
                ${ratingBadge}
                ${rated && ticket.ratingComment ? `<span class="dot"></span><span>تعليقك: <em>${ticket.ratingComment}</em></span>` : ''}
                ${(ticket.status === 'completed' && !rated)
                ? `<span class="dot"></span><button class="btn btn-success" onclick="openRatingModal('${ticket.ticketNumber}')">قيّم الخدمة</button>`
                : ''}
            </div>
            </div>
        `;
        }).join('');


        holder.innerHTML = cards || '<p style="text-align:center;color:#999;">لا توجد تذاكر</p>';
        // ✅ ملء الفلتره وإظهارها إذا كان في الوضع الإداري
        populateDeptFilter();
        showRequestsFilterForAdmin();
      });
    } else {
      loadMyRequests('requestsList');
    }

    } else if (tabName === 'managementDeptBoard') {
  await loadDeptBoardView();

  } else if (tabName === 'advisorRequests') {
    loadMyRequests('advisorRequestsList');

  } else if (tabName === 'advisorRatings') {
    // ✅ تبويب تقييمات المرشد التدريبي
    await loadManagementRatingsView('advisorRatingsList');

  } else if (tabName === 'advisoryRatings') {
    // ✅ تبويب تقييمات وحدة الخدمات الإرشادية
    await loadManagementRatingsView('advisoryRatingsList');

  } else if (tabName === 'managementRatings') {
    // ✅ السماح لكل الأدوار برؤية تقييماتهم حسب صلاحياتهم
    await loadManagementRatingsView('ratingsList');
  }
}


// بناء خيارات الأقسام في الفلتر من البيانات
function dbFillDepartmentsOptions(tickets) {
  const sel = document.getElementById('dbDept');
  if (!sel) return;

  const set = new Set();
  tickets.forEach(t => {
    const d = (t.department || '').trim();
    if (d) set.add(d);
  });
  // إضافة "التدريب الإلكتروني" كسطر مستقل إن أردت جمع خاص
  set.add('التدريب الإلكتروني');

  const arr = Array.from(set).sort((a,b)=> a.localeCompare(b, 'ar'));

  sel.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
}

// قراءة الفلاتر من الواجهة
function dbReadFilters() {
  const from = tryParseDate(document.getElementById('dbFrom')?.value || '');
  const to   = tryParseDate(document.getElementById('dbTo')?.value || '');
  const deptSel = document.getElementById('dbDept');
  const selectedDepts = Array.from(deptSel?.selectedOptions || []).map(o => o.value);

  const stPending   = document.getElementById('dbStPending')?.checked;
  const stInProg    = document.getElementById('dbStInProgress')?.checked;
  const stCompleted = document.getElementById('dbStCompleted')?.checked;

  const source = (document.getElementById('dbSource')?.value || 'all');

  return {
    from, to,
    depts: selectedDepts,
    allow: {
      pending: !!stPending,
      in_progress: !!stInProg,
      completed: !!stCompleted
    },
    source
  };
}

// هل ينطبق المصدر؟
function dbMatchSource(t, sourceValue) {
  if (sourceValue === 'all') return true;

  const roleOfTransfer = normalizeRole((t.transferredTo || '').trim());
  const createdBy  = (t.createdBy || '').trim();
  const dept       = (t.department || '').trim();

  if (sourceValue === 'elearning') {
    return roleOfTransfer === 'elearning' || dept === 'التدريب الإلكتروني';
  }
  if (sourceValue === 'advisory') {
    // نحاول اكتشاف "وحدة الإرشاد" من createdBy أو source field إن وُجد
    const src = (t.source || '').trim();
    return /الإرشاد/i.test(src) || /إرشاد/i.test(createdBy) || /وحدة الخدمات الإرشادية/.test(src);
  }
  if (sourceValue === 'departments') {
    // ليس من الإرشاد ولا التدريب الإلكتروني
    const isEL = (roleOfTransfer === 'elearning' || dept === 'التدريب الإلكتروني');
    const isAd = /الإرشاد|إرشادي|وحدة الخدمات الإرشادية/.test((t.source||'') + ' ' + createdBy);
    return !isEL && !isAd;
  }
  return true;
}

// تطبيق الفلاتر على التذاكر
function dbFilterTickets(tickets, filters) {
  return (tickets || []).filter(t => {
    // التاريخ
    const dt = tryParseDate(t.date || t.creationDate || '');
    if (filters.from && dt && dt < filters.from) return false;
    if (filters.to   && dt && dt > filters.to)   return false;

    // الحالة
    const st = String(t.status || 'pending');
    if (st === 'pending'     && !filters.allow.pending)     return false;
    if (st === 'in_progress' && !filters.allow.in_progress) return false;
    if (st === 'completed'   && !filters.allow.completed)   return false;

    // المصدر
    if (!dbMatchSource(t, filters.source)) return false;

    // الأقسام
    const d = (t.department || '').trim();
    if (filters.depts && filters.depts.length && !filters.depts.includes(d) && !(filters.depts.includes('التدريب الإلكتروني') && normalizeRole((t.transferredTo||'').trim())==='elearning')) {
      return false;
    }

    return true;
  });
}

// تجميع وإحصائيات لكل قسم
function dbAggregateByDept(tickets) {
  const map = new Map(); // dept -> { counts..., sums... }

  function ensure(dept) {
    if (!map.has(dept)) {
      map.set(dept, {
        dept,
        newCount: 0,
        inProgress: 0,
        pending: 0,
        completed: 0,
        closeDaysSum: 0,
        closeDaysCount: 0,
        slaOk: 0,
        slaAll: 0,
        advisorySolved: 0,
        alerts: { older7: 0 }
      });
    }
    return map.get(dept);
  }

  tickets.forEach(t => {
    let dept = (t.department || '').trim() || 'غير محدد';
    // لو كانت محوّلة للتدريب الإلكتروني، نضعها تحت قسم "التدريب الإلكتروني" لتجميع خاص
    const toRole = normalizeRole((t.transferredTo || '').trim());
    if (toRole === 'elearning') dept = 'التدريب الإلكتروني';

    const row = ensure(dept);

    const st = String(t.status || 'pending');
    if (st === 'pending') row.pending++;
    else if (st === 'in_progress') row.inProgress++;
    else if (st === 'completed') row.completed++;

    // "جديدة" كعدد الوارد ضمن الفترة = نحتسب كل ما له تاريخ ضمن الفلاتر كـ newCount
    row.newCount++;

    // SLA & متوسط الإغلاق للتذاكر المكتملة
    if (st === 'completed') {
      const start = tryParseDate(t.date || t.creationDate || '');
      const end   = tryParseDate(t.completionDate || t.updateDate || t.date || '');
      if (start && end) {
        const d = Math.max(0, daysBetween(start, end));
        row.closeDaysSum += d;
        row.closeDaysCount++;
        row.slaAll++;
        if (d <= SLA_DAYS) row.slaOk++;
      }
    }

    // حلول الإرشاد (مكتملة فقط)
    const src = (t.source || '').trim();
    const createdBy = (t.createdBy || '').trim();
    const isAdvisory = /الإرشاد|إرشادي|وحدة الخدمات الإرشادية/.test(src + ' ' + createdBy);
    if (isAdvisory && st === 'completed') row.advisorySolved++;

    // تنبيه عمر > 7 أيام للتذاكر غير المكتملة
    if (st !== 'completed') {
      const start = tryParseDate(t.date || t.creationDate || '');
      if (start) {
        const age = daysBetween(start, new Date());
        if (age > 7) row.alerts.older7++;
      }
    }
  });

  return Array.from(map.values()).sort((a,b) => a.dept.localeCompare(b.dept, 'ar'));
}

// رسم KPIs أعلى الصفحة
function dbRenderKpis(containerId, tickets) {
  const box = document.getElementById(containerId);
  if (!box) return;

  const total = tickets.length;
  const completed = tickets.filter(t => String(t.status)==='completed').length;
  const inprog   = tickets.filter(t => String(t.status)==='in_progress').length;
  const pending  = tickets.filter(t => String(t.status)==='pending').length;

  // متوسط زمن الإغلاق العام + SLA
  let sum = 0, cnt = 0, slaAll=0, slaOk=0;
  tickets.forEach(t => {
    if (String(t.status)==='completed') {
      const s = tryParseDate(t.date || t.creationDate || '');
      const e = tryParseDate(t.completionDate || t.updateDate || t.date || '');
      if (s && e) {
        const d = Math.max(0, daysBetween(s, e));
        sum += d; cnt++; slaAll++;
        if (d <= SLA_DAYS) slaOk++;
      }
    }
  });

  const avg = cnt ? (sum/cnt).toFixed(1) : '—';
  const slaPct = slaAll ? Math.round((slaOk/slaAll)*100) + '%' : '—';

  box.innerHTML = `
    <div class="stat-card">
      <div class="stat-number">${total}</div>
      <div class="stat-label">إجمالي التذاكر</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-green) 0%, #247d42 100%);">
      <div class="stat-number">${completed}</div>
      <div class="stat-label">مكتملة</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #c5a032 100%);">
      <div class="stat-number">${inprog}</div>
      <div class="stat-label">قيد التنفيذ</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);">
      <div class="stat-number">${pending}</div>
      <div class="stat-label">معلّقة</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--dark-blue) 0%, #031f31 100%);">
      <div class="stat-number">${avg}</div>
      <div class="stat-label">متوسط زمن الإغلاق (يوم)</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, var(--success) 0%, #1d6a36 100%);">
      <div class="stat-number">${slaPct}</div>
      <div class="stat-label">الالتزام بـ SLA ≤ ${SLA_DAYS} أيام</div>
    </div>
  `;
}

// رسم الجدول
function dbRenderTable(rows) {
  const tbody = document.getElementById('dbTableBody');
  if (!tbody) return;

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:16px; color:#999;">لا توجد بيانات</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const rate = (r.newCount ? Math.round((r.completed / r.newCount)*100) : 0) + '%';
    const avg  = r.closeDaysCount ? (r.closeDaysSum / r.closeDaysCount).toFixed(1) : '—';
    const sla  = r.slaAll ? Math.round((r.slaOk / r.slaAll)*100) + '%' : '—';
    const alert = r.alerts.older7 ? `⚠︎ ${r.alerts.older7} > 7 أيام` : '-';

    // نضع data-attrs لتغذية الدرور بالنقر
    return `
      <tr>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${r.dept}</td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="new">${r.newCount}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="in_progress">${r.inProgress}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="pending">${r.pending}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">
          <a href="#" data-db-click="open" data-dept="${r.dept}" data-kind="completed">${r.completed}</a>
        </td>

        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${rate}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${avg}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${sla}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${r.advisorySolved}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border-color);">${alert}</td>
      </tr>
    `;
  }).join('');
}

// فتح/غلق الدرور
function openDbDrawer(title, tickets) {
  const host = document.getElementById('dbDrawer');
  const body = document.getElementById('dbDrawerBody');
  const head = document.getElementById('dbDrawerTitle');
  if (!host || !body || !head) return;
  head.textContent = title;

  if (!tickets.length) {
    body.innerHTML = `<p style="text-align:center;color:#999;">لا توجد تذاكر مطابقة</p>`;
  } else {
    body.innerHTML = tickets.map(t => {
      const stTxt = statusBadgeText(t.status);
      const stCls = statusBadgeClass(t.status);
      const details = t.requestDetails || t.details || '-';
      return `
        <div class="ticket-card modern">
          <div class="ticket-head">
            <span class="ticket-status-badge ${stCls}">${stTxt}</span>
            <span class="ticket-id-chip" onclick="navigator.clipboard.writeText('${t.ticketNumber||''}')">${t.ticketNumber || '—'}</span>
          </div>
          <div class="ticket-sep"></div>
          <div class="ticket-grid">
            <div class="ticket-row"><span class="k">القسم:</span><span class="v">${t.department || '-'}</span></div>
            <div class="ticket-row"><span class="k">نوع الخدمة:</span><span class="v">${t.serviceType || '-'}</span></div>
            <div class="ticket-row"><span class="k">التاريخ:</span><span class="v">${formatArabicDate(t.date)}</span></div>
            <div class="ticket-row"><span class="k">المُسنَد:</span><span class="v">${t.assignedTo || '-'}</span></div>
          </div>
          ${details && details !== '-' ? `<div class="ticket-details">📝 ${details}</div>` : ''}
        </div>
      `;
    }).join('');
  }

  host.classList.remove('hidden');
}

function closeDbDrawer() {
  const host = document.getElementById('dbDrawer');
  if (host) host.classList.add('hidden');
}

// مُعالج تحميل التبويب
async function loadDeptBoardView() {
  if (!hasFullAccess()) {
    document.getElementById('managementDeptBoard')?.classList.add('hidden');
    showError?.('لا تملك صلاحية عرض لوحة متابعة الأقسام');
    return;
  }

  const list = await loadAllTickets();
  const tickets = Array.isArray(list) ? list : [];

  // أول مرة: نملأ أقسام الفلتر
  dbFillDepartmentsOptions(tickets);

  const filters = dbReadFilters();
  const view = dbFilterTickets(tickets, filters);
  dbRenderKpis('dbKpis', view);

  const rows = dbAggregateByDept(view);
  dbRenderTable(rows);

  // تفعيل النقر على أرقام الجدول لفتح الدرور
  const table = document.getElementById('dbTable');
  if (table && !table.__dbBound) {
    table.addEventListener('click', (ev) => {
      const a = ev.target.closest('[data-db-click="open"]');
      if (!a) return;
      ev.preventDefault();
      const dept = a.getAttribute('data-dept');
      const kind = a.getAttribute('data-kind'); // new|pending|in_progress|completed
      openDeptBucket(dept, kind, tickets);
    });
    table.__dbBound = true;
  }

  // ربط الفلاتر لإعادة التحميل
  dbBindFiltersOnce(tickets);
}

// ربط الفلاتر مرة واحدة
function dbBindFiltersOnce(allTickets) {
  const ids = ['dbFrom','dbTo','dbDept','dbStPending','dbStInProgress','dbStCompleted','dbSource'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el && !el.__dbBound) {
      el.addEventListener('change', () => loadDeptBoardView());
      el.__dbBound = true;
    }
  });
}

// فتح مجموعة معينة في الدرور
function openDeptBucket(deptName, kind, allTickets) {
  // 1) نقرأ الفلاتر الحالية ونطبّقها أولاً (الفترة/المصدر/الحالات)
  const filters = dbReadFilters();
  let view = dbFilterTickets(allTickets, filters);

  // 2) حصر القسم:
  //    - لو «التدريب الإلكتروني»: نجمع ما تم تحويله لدور elearning أو قسمه مسجل "التدريب الإلكتروني"
  //    - غير ذلك: نطابق اسم القسم نصاً
  view = view.filter(t => {
    const toRole = normalizeRole((t.transferredTo || '').trim());
    const dept   = (t.department || '').trim();
    if (deptName === 'التدريب الإلكتروني') {
      return toRole === 'elearning' || dept === 'التدريب الإلكتروني';
    }
    return dept === deptName;
  });

  // 3) نوع السطل (bucket) حسب العمود الذي نقر عليه في الجدول:
  //    new        => كل ما ضمن الفلترة الزمنية (لا نضيف فلتر حالة إضافي)
  //    pending    => حالة معلّقة فقط
  //    in_progress=> قيد التنفيذ فقط
  //    completed  => مكتملة فقط
  if (kind === 'pending' || kind === 'in_progress' || kind === 'completed') {
    view = view.filter(t => String(t.status || 'pending') === kind);
  } else if (kind === 'new') {
    // لا شيء إضافي—«new» تعني الوارد ضمن الفترة المحددة بالفلاتر
  }

  // 4) عنوان أنيق
  const kindLabel =
    kind === 'pending'     ? 'معلّقة' :
    kind === 'in_progress' ? 'قيد التنفيذ' :
    kind === 'completed'   ? 'مكتملة' :
                              'جديدة (ضمن الفترة)';

  const title = `${deptName} — ${kindLabel}`;

  // 5) افتح الدرج واعرض البطاقات
  openDbDrawer(title, view);
}


    </script>
    

    <!-- ✅ مودال إنهاء التذكرة بالحــل -->
<!-- ✅ مودال الحل المنفذ -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>تسجيل الحل المنفذ</h3>
      <button class="modal-close" onclick="closeSolutionModal()">×</button>
    </div>
    <div class="modal-body">
      <label class="modal-label" for="solutionText">اكتب الحل المنفذ:</label>
      <textarea id="solutionText" class="modal-textarea" placeholder="مثال: تم التواصل مع المتدرب ومعالجة المشكلة..."></textarea>
      <div class="modal-hint">سيتم إنهاء التذكرة وكتابة الحل في السجلات.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSolutionModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitSolution()">حفظ الحل</button>
    </div>
  </div>
</div>

<!-- ✅ مودال تحويل التذكرة للمرشد -->
<!-- ✅ مودال تحويل التذكرة (خاصة بالمرشد) -->
<!-- ✅ مودال تحويل المرشد -->
<div id="advisorTransferModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>تحويل التذكرة</h3>
      <button class="modal-close" onclick="closeAdvisorTransferModal()">×</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;gap:10px;">
        <label class="modal-label">اختر جهة التحويل:</label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="dept_head">
          <span>رئيس القسم</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="elearning">
          <span>مدير التدريب الإلكتروني</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="trainees_vice">
          <span>وكيل شؤون المتدربين</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="quality_vice">
          <span>وكيل ضبط الجودة</span>
        </label>

        <label class="service-btn" style="text-align:right;">
          <input type="radio" name="advisorTransferTo" value="dean">
          <span>العميد</span>
        </label>
      </div>
      <div class="modal-hint">سيتم تسجيل بيانات التحويل (الجهة/التاريخ/من قام بالتحويل).</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAdvisorTransferModal()">إلغاء</button>
      <button class="btn btn-primary" onclick="submitAdvisorTransfer()">تأكيد التحويل</button>
    </div>
  </div>
</div>

<!-- ✅ مودال تقييم المتدرب -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>تقييم الخدمة</h3>
      <button class="modal-close" aria-label="إغلاق" onclick="closeRatingModal()">×</button>
    </div>

    <div class="modal-body">
      <!-- نجوم -->
      <div id="ratingStars" class="rating-pro" style="margin:6px 0 4px;"></div>
      <!-- مقياس لفظي -->
      <div class="rating-scale" id="ratingScale"></div>
      <div class="rating-note" id="ratingNote">اختر من 1 (سيئ) إلى 5 (ممتاز)</div>

      <label for="ratingComment" style="margin-top:14px;">تعليقك على الخدمة (اختياري)</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="اكتب ملاحظتك أو اقتراحك..."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-warning" onclick="closeRatingModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">إرسال التقييم</button>
    </div>
  </div>
</div>

<!-- درور متابعة الأقسام -->
<!-- ✅ درج التفاصيل للوحة الأقسام -->
<!-- ✅ درج عرض تفاصيل «لوحة متابعة الأقسام» -->
<div id="dbDrawer" class="modal-backdrop hidden" style="align-items:flex-end;">
  <div class="modal" style="max-width:900px;width:100%;max-height:85vh;overflow:auto;">
    <div class="modal-header">
      <h3 id="dbDrawerTitle">تفاصيل القسم</h3>
      <button class="modal-close" onclick="closeDbDrawer()">×</button>
    </div>
    <div id="dbDrawerBody" class="modal-body">
      <!-- تُملأ برمجياً -->
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeDbDrawer()">إغلاق</button>
    </div>
  </div>
</div>


<!-- ✅ درج إدارة السلال (dbDrawer) -->
<div id="dbDrawer" class="db-drawer" aria-hidden="true">
  <!-- سيتم حقن المحتوى ديناميكياً من الدالة -->
</div>

<!-- ✅ نافذة حلّ المشكلة (solutionModal) -->
<div id="solutionModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="solutionTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="solutionTitle">إضافة حلّ / إجراء</h3>
      <button class="modal-close" data-close="true" aria-label="إغلاق">×</button>
    </header>
    <section class="modal-body">
      <textarea id="solutionNotes" rows="6" class="w-full" placeholder="أدخل وصف الحل والإجراءات..."></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">إلغاء</button>
      <button class="btn btn-primary" id="saveSolutionBtn" onclick="submitSolution()">حفظ</button>
    </footer>
  </div>
</div>

<!-- ✅ نافذة تحويل للمرشد (advisorTransferModal) -->
<div id="advisorTransferModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="advisorTransferTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="advisorTransferTitle">تحويل الطلب إلى المرشد</h3>
      <button class="modal-close" data-close="true" aria-label="إغلاق">×</button>
    </header>
    <section class="modal-body">
      <label class="block mb-2">اختر المرشد:</label>
      <select id="advisorSelect" class="w-full mb-4"></select>
      <label class="block mb-2">ملاحظات التحويل (اختياري):</label>
      <textarea id="advisorNotes" rows="4" class="w-full"></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">إلغاء</button>
      <button class="btn btn-primary" id="confirmAdvisorTransferBtn">تحويل</button>
    </footer>
  </div>
</div>

<!-- ✅ نافذة التقييم (ratingModal) -->
<div id="ratingModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="ratingTitle">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-panel">
    <header class="modal-header">
      <h3 id="ratingTitle">تقييم الخدمة</h3>
      <button class="modal-close" data-close="true" aria-label="إغلاق">×</button>
    </header>
    <section class="modal-body">
      <div class="rating-stars" id="ratingStars" aria-label="التقييم من 1 إلى 5"></div>
      <textarea id="ratingNotes" rows="4" class="w-full mt-3" placeholder="ملاحظاتك (اختياري)"></textarea>
    </section>
    <footer class="modal-footer">
      <button class="btn btn-secondary" data-close="true">إغلاق</button>
      <button class="btn btn-primary" id="submitRatingBtn">إرسال التقييم</button>
    </footer>
  </div>
</div>

<!-- ✅ مودال تقييم الخدمة للمتدرب -->
<div id="ratingModal" class="modal-backdrop modal-backdrop--rating hidden">
  <div class="modal modal-rating">
    <div class="modal-header">
      <h3>تقييم الخدمة</h3>
      <button class="modal-close" onclick="closeRatingModal()">×</button>
    </div>
    <div class="modal-body">
      <div id="ratingStars" class="rating-pro" style="margin-bottom:10px;"></div>
      <div id="ratingScale" class="rating-scale"></div>
      <div id="ratingNote" class="rating-note">اختر من 1 (سيئ) إلى 5 (ممتاز)</div>

      <label for="ratingComment" style="margin-top:14px;">تعليق (اختياري):</label>
      <textarea id="ratingComment" class="modal-textarea" placeholder="اكتب ملاحظتك عن الخدمة..."></textarea>
      <div class="modal-hint">لا يمكن تقييم نفس التذكرة أكثر من مرة.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeRatingModal()">إغلاق</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">إرسال التقييم</button>
    </div>
  </div>
</div>
<!-- =========================
  ✅ مودال "الحل المنفذ" (إنهاء التذكرة)
========================= -->
<div id="solutionModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>إنهاء التذكرة وتسجيل الحل</h3>
      <button class="modal-close" onclick="closeSolutionModal()">×</button>
    </div>
    <div class="modal-body">
      <label for="solutionText" class="modal-label">الحل المنفذ</label>
      <textarea id="solutionText" class="modal-textarea" rows="5" placeholder="اكتب تفاصيل الحل المنفذ بدقة..."></textarea>
      <div class="modal-hint">سيتم تغيير حالة التذكرة إلى «مكتملة» وتسجيل الحل في السجل.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSolutionModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitSolution()">تم الحل</button>
    </div>
  </div>
</div>

<!-- =========================
  ✅ مودال "تحويل تذكرة" للمرشد التدريبي
========================= -->
<div id="advisorTransferModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>تحويل التذكرة</h3>
      <button class="modal-close" onclick="closeAdvisorTransferModal()">×</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:10px;font-weight:700;">اختر جهة التحويل:</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="dept_head">
          <span>رئيس القسم</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="elearning">
          <span>التدريب الإلكتروني</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="trainees_vice">
          <span>وكيل شؤون المتدربين</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="quality_vice">
          <span>وكيل ضبط الجودة</span>
        </label>
        <label class="service-btn" style="margin:0;">
          <input type="radio" name="advisorTransferTo" value="dean">
          <span>العميد</span>
        </label>
      </div>
      <div class="modal-hint" style="margin-top:12px;">
        ملاحظة: ستظهر التذكرة كـ «↗️ محوّلة» في قائمة المرشد، مع توضيح الجهة وتاريخ التحويل.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAdvisorTransferModal()">إلغاء</button>
      <button class="btn btn-primary" onclick="submitAdvisorTransfer()">تأكيد التحويل</button>
    </div>
  </div>
</div>

<!-- =========================
  ✅ مودال "تقييم الخدمة" للمتدرب
========================= -->
<div id="ratingModal" class="modal-backdrop hidden modal-rating">
  <div class="modal">
    <div class="modal-header">
      <h3>قيّم الخدمة</h3>
      <button class="modal-close" onclick="closeRatingModal()">×</button>
    </div>
    <div class="modal-body">
      <label class="modal-label">اختر التقييم</label>
      <div id="ratingStars" class="rating-pro" style="margin-bottom:8px;"></div>
      <div id="ratingScale" class="rating-scale"></div>
      <div id="ratingNote" class="rating-note" style="margin-top:8px;">اختر من 1 إلى 5</div>

      <label for="ratingComment" class="modal-label" style="margin-top:14px;">تعليق (اختياري)</label>
      <textarea id="ratingComment" class="modal-textarea" rows="4" placeholder="اكتب ملاحظاتك لتحسين الخدمة..."></textarea>
      <div class="modal-hint">لن تستطيع تقييم نفس التذكرة مرة أخرى بعد الإرسال.</div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeRatingModal()">إلغاء</button>
      <button class="btn btn-success" onclick="submitTraineeRating()">إرسال التقييم</button>
    </div>
  </div>
</div>

<!-- =========================
  ✅ درج عرض تفاصيل الأقسام (لوحة المتابعة)
========================= -->
<div id="dbDrawer" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10000;display:flex;justify-content:flex-end;">
  <div style="width:min(900px,100%);height:100%;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,.25);display:flex;flex-direction:column;">
    <div style="padding:14px 16px;background:linear-gradient(135deg, var(--primary-blue), var(--dark-blue));color:#fff;display:flex;align-items:center;justify-content:space-between;">
      <h3 id="dbDrawerTitle" style="font-size:18px;margin:0;">تفاصيل القسم</h3>
      <button class="modal-close" onclick="document.getElementById('dbDrawer').classList.add('hidden')">×</button>
    </div>
    <div id="dbDrawerBody" style="padding:16px;overflow:auto;">
      <!-- يُملأ برمجياً -->
    </div>
  </div>
</div>
<!-- ========== مودال التقارير الإدارية ========== -->
<div id="reportsModal" class="modal-backdrop hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;">
  <div class="modal" style="width:95%;max-width:1400px;height:90vh;display:flex;flex-direction:column;background:#fff;border-radius:16px;overflow:hidden;">
    <div class="modal-header" style="background:linear-gradient(135deg, var(--tvtc-primary), var(--tvtc-primary-700));color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;">
      <h3 style="margin:0;font-size:22px;">📊 التقارير الإدارية الشاملة</h3>
      <button class="modal-close" onclick="closeAdminReports()" style="background:transparent;border:0;color:#fff;font-size:28px;cursor:pointer;padding:0;line-height:1;">×</button>
    </div>
    
    <div class="modal-body" style="flex:1;overflow-y:auto;padding:24px;">
      <!-- فلاتر التقارير -->
      <div class="report-filters" style="background:var(--tvtc-primary-100);border-radius:12px;padding:16px;margin-bottom:24px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">نوع التقرير</label>
            <select id="reportType" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
              <option value="overview">نظرة عامة</option>
              <option value="departments">تقرير الأقسام</option>
              <option value="advisors">تقرير المرشدين</option>
              <option value="services">تقرير الخدمات</option>
              <option value="performance">تقرير الأداء</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">من تاريخ</label>
            <input type="date" id="reportFromDate" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;font-weight:600;color:var(--tvtc-primary);">إلى تاريخ</label>
            <input type="date" id="reportToDate" onchange="updateReportView()" style="width:100%;padding:10px;border:2px solid #ccc;border-radius:8px;">
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px;">
            <button class="btn btn-primary" onclick="generateReport()" style="flex:1;padding:10px;">تحديث</button>
            <button class="btn btn-success" onclick="exportReportPDF()" style="padding:10px;">PDF ⬇</button>
            <button class="btn" onclick="exportReportExcel()" style="padding:10px;background:var(--success);color:#fff;border:0;">Excel ⬇</button>
          </div>
        </div>
      </div>

      <!-- محتوى التقرير الكامل للتصدير -->
      <div id="reportContent" style="background:white;padding:20px;">
        <!-- مؤشرات الأداء الرئيسية -->
        <div id="reportKPIs" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
          <!-- يتم ملؤها برمجياً -->
        </div>

        <!-- الرسوم البيانية -->
        <div id="reportCharts" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px;">
          <!-- يتم ملؤها برمجياً -->
        </div>

        <!-- الجداول التفصيلية -->
        <div id="reportTables" style="margin-top:24px;">
          <!-- يتم ملؤها برمجياً -->
        </div>
      </div>
    </div>

    <div class="modal-footer" style="border-top:1px solid #ddd;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9;">
      <div style="color:#666;font-size:13px;">آخر تحديث: <span id="reportLastUpdate"></span></div>
      <button class="btn" onclick="closeAdminReports()" style="background:#6c757d;color:#fff;border:0;padding:10px 24px;border-radius:8px;cursor:pointer;">إغلاق</button>
    </div>
  </div>
</div>

<!-- ========== CSS التقارير ========== -->
<style>
.kpi-card {
  background: linear-gradient(135deg, var(--tvtc-primary) 0%, var(--tvtc-accent) 100%);
  color: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 99, 65, 0.25);
  transition: all 0.3s;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.kpi-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 8px 25px rgba(0, 99, 65, 0.35);
}

.kpi-card.green {
  background: linear-gradient(135deg, var(--success) 0%, var(--tvtc-primary-700) 100%);
  box-shadow: 0 4px 15px rgba(30, 127, 92, 0.25);
}

.kpi-card.green:hover {
  box-shadow: 0 8px 25px rgba(30, 127, 92, 0.35);
}

.kpi-card.orange {
  background: linear-gradient(135deg, var(--tvtc-secondary) 0%, var(--warning) 100%);
  box-shadow: 0 4px 15px rgba(200, 165, 92, 0.25);
}

.kpi-card.orange:hover {
  box-shadow: 0 8px 25px rgba(200, 165, 92, 0.35);
}

.kpi-card.red {
  background: linear-gradient(135deg, var(--error) 0%, #a32a1f 100%);
  box-shadow: 0 4px 15px rgba(192, 57, 43, 0.25);
}

.kpi-card.red:hover {
  box-shadow: 0 8px 25px rgba(192, 57, 43, 0.35);
}

.kpi-card.purple {
  background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.25);
}

.kpi-card.purple:hover {
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
}

.kpi-card.teal {
  background: linear-gradient(135deg, var(--tvtc-accent) 0%, var(--tvtc-primary) 100%);
  box-shadow: 0 4px 15px rgba(0, 162, 135, 0.25);
}

.kpi-card.teal:hover {
  box-shadow: 0 8px 25px rgba(0, 162, 135, 0.35);
}

.kpi-number {
  font-size: 36px;
  font-weight: bold;
  margin: 10px 0;
}

.kpi-label {
  font-size: 14px;
  opacity: 0.9;
}

.kpi-trend {
  font-size: 12px;
  margin-top: 8px;
  padding: 4px 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  display: inline-block;
}

.chart-container {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--tvtc-primary);
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--tvtc-primary-100);
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.report-table thead {
  background: linear-gradient(135deg, var(--tvtc-primary), var(--tvtc-primary-700));
  color: white;
}

.report-table th {
  padding: 14px;
  text-align: right;
  font-weight: 600;
  font-size: 14px;
}

.report-table tbody tr {
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.2s;
}

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.report-table td {
  padding: 12px 14px;
  font-size: 13px;
}

.progress-bar {
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 4px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--tvtc-secondary));
  transition: width 0.3s;
}

.badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-warning {
  background: #fff3cd;
  color: #856404;
}

.badge-danger {
  background: #f8d7da;
  color: #721c24;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}
</style>

<!-- ========== JavaScript التقارير ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let reportData = null;
let currentCharts = {};

// فتح نافذة التقارير
async function openAdminReports() {
  const modal = document.getElementById('reportsModal');
  if (!modal) return;
  
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  // تعيين التواريخ الافتراضية (آخر 30 يوم)
  const today = new Date();
  const monthAgo = new Date();
  monthAgo.setDate(monthAgo.getDate() - 30);
  
  document.getElementById('reportFromDate').value = monthAgo.toISOString().split('T')[0];
  document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
  
  await generateReport();
}

// إغلاق نافذة التقارير
function closeAdminReports() {
  document.getElementById('reportsModal').classList.add('hidden');
  document.body.style.overflow = '';
  
  // تدمير الرسوم البيانية
  Object.values(currentCharts).forEach(chart => chart.destroy());
  currentCharts = {};
}

// توليد التقرير
async function generateReport() {
  showLoading('جاري إنشاء التقرير...');
  
  try {
    reportData = await getReportData();
    
    if (!reportData) {
      hideLoading();
      return;
    }
    
    updateReportView();
    document.getElementById('reportLastUpdate').textContent = new Date().toLocaleString('ar-SA');
    
  } catch (error) {
    showError('حدث خطأ أثناء إنشاء التقرير');
    console.error(error);
  }
  
  hideLoading();
}

// تحديث عرض التقرير
function updateReportView() {
  if (!reportData) return;
  
  const reportType = document.getElementById('reportType').value;
  
  // تحديث KPIs
  renderKPIs();
  
  // تحديث الرسوم البيانية والجداول حسب نوع التقرير
  switch(reportType) {
    case 'overview':
      renderOverviewReport();
      break;
    case 'departments':
      renderDepartmentsReport();
      break;
    case 'advisors':
      renderAdvisorsReport();
      break;
    case 'services':
      renderServicesReport();
      break;
    case 'performance':
      renderPerformanceReport();
      break;
  }
}

// عرض مؤشرات الأداء
function renderKPIs() {
  const container = document.getElementById('reportKPIs');
  const summary = reportData.summary;
  
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(1) : 0;
  
  container.innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">إجمالي التذاكر</div>
      <div class="kpi-number">${summary.total}</div>
      <div class="kpi-trend">آخر 30 يوم: ${summary.last30Days}</div>
    </div>
    
    <div class="kpi-card green">
      <div class="kpi-label">مكتملة</div>
      <div class="kpi-number">${summary.completed}</div>
      <div class="kpi-trend">${completionRate}% نسبة الإنجاز</div>
    </div>
    
    <div class="kpi-card orange">
      <div class="kpi-label">قيد التنفيذ</div>
      <div class="kpi-number">${summary.inProgress}</div>
      <div class="kpi-trend">${summary.pending} معلقة</div>
    </div>
    
    <div class="kpi-card purple">
      <div class="kpi-label">متوسط التقييم</div>
      <div class="kpi-number">${summary.avgRating} ⭐</div>
      <div class="kpi-trend">${summary.totalRatings} تقييم</div>
    </div>
    
    <div class="kpi-card teal">
      <div class="kpi-label">متوسط وقت الإنجاز</div>
      <div class="kpi-number">${summary.avgCompletionDays}</div>
      <div class="kpi-trend">يوم</div>
    </div>
    
    <div class="kpi-card orange">
      <div class="kpi-label">محوّلة</div>
      <div class="kpi-number">${summary.transferred}</div>
      <div class="kpi-trend">${((summary.transferred/summary.total)*100).toFixed(1)}%</div>
    </div>
  `;
}

// تقرير النظرة العامة
function renderOverviewReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const summary = reportData.summary;
  
  chartsContainer.innerHTML = `
    <div class="chart-container">
      <div class="chart-title">توزيع حالة التذاكر</div>
      <canvas id="statusPieChart"></canvas>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">التذاكر حسب نوع الخدمة</div>
      <canvas id="servicesBarChart"></canvas>
    </div>
  `;
  
  // رسم دائري لحالة التذاكر
  const statusCtx = document.getElementById('statusPieChart');
  if (currentCharts['statusPie']) currentCharts['statusPie'].destroy();
  currentCharts['statusPie'] = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['مكتملة', 'قيد التنفيذ', 'معلقة'],
      datasets: [{
        data: [summary.completed, summary.inProgress, summary.pending],
        backgroundColor: ['#1E7F5C', '#F59E0B', '#C0392B'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 13, family: 'Segoe UI' }, padding: 15 }
        }
      }
    }
  });
  
  // رسم أعمدة للخدمات
  const services = reportData.services;
  const serviceLabels = Object.keys(services);
  const serviceValues = Object.values(services).map(s => s.total || s);
  
  const servicesCtx = document.getElementById('servicesBarChart');
  if (currentCharts['servicesBar']) currentCharts['servicesBar'].destroy();
  currentCharts['servicesBar'] = new Chart(servicesCtx, {
    type: 'bar',
    data: {
      labels: serviceLabels,
      datasets: [{
        label: 'عدد التذاكر',
        data: serviceValues,
        backgroundColor: '#006341',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  // جدول أحدث التذاكر
  renderRecentTicketsTable();
}

// تقرير الأقسام
function renderDepartmentsReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const departments = reportData.departments;
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">أداء الأقسام</div>
      <canvas id="deptComparisonChart"></canvas>
    </div>
  `;
  
  const deptNames = Object.keys(departments);
  const deptTotals = deptNames.map(d => departments[d].total);
  const deptCompleted = deptNames.map(d => departments[d].completed);
  
  const ctx = document.getElementById('deptComparisonChart');
  if (currentCharts['deptComparison']) currentCharts['deptComparison'].destroy();
  currentCharts['deptComparison'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: deptNames,
      datasets: [
        {
          label: 'إجمالي',
          data: deptTotals,
          backgroundColor: '#006341'
        },
        {
          label: 'مكتملة',
          data: deptCompleted,
          backgroundColor: '#1E7F5C'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  // جدول تفصيلي
  renderDepartmentsTable();
}

// تقرير المرشدين
function renderAdvisorsReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const advisors = reportData.advisors;
  
  chartsContainer.innerHTML = `
    <div class="chart-container">
      <div class="chart-title">أداء المرشدين - عدد التذاكر</div>
      <canvas id="advisorsTicketsChart"></canvas>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">تقييمات المرشدين</div>
      <canvas id="advisorsRatingsChart"></canvas>
    </div>
  `;
  
  const advisorNames = Object.keys(advisors).slice(0, 10); // أفضل 10
  const advisorTickets = advisorNames.map(a => advisors[a].total);
  const advisorRatings = advisorNames.map(a => parseFloat(advisors[a].avgRating) || 0);
  
  // عدد التذاكر
  const ticketsCtx = document.getElementById('advisorsTicketsChart');
  if (currentCharts['advisorsTickets']) currentCharts['advisorsTickets'].destroy();
  currentCharts['advisorsTickets'] = new Chart(ticketsCtx, {
    type: 'horizontalBar',
    data: {
      labels: advisorNames,
      datasets: [{
        label: 'عدد التذاكر',
        data: advisorTickets,
        backgroundColor: '#006341'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } }
    }
  });
  
  // التقييمات
  const ratingsCtx = document.getElementById('advisorsRatingsChart');
  if (currentCharts['advisorsRatings']) currentCharts['advisorsRatings'].destroy();
  currentCharts['advisorsRatings'] = new Chart(ratingsCtx, {
    type: 'horizontalBar',
    data: {
      labels: advisorNames,
      datasets: [{
        label: 'متوسط التقييم',
        data: advisorRatings,
        backgroundColor: '#C8A55C'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: { x: { max: 5 } }
    }
  });
  
  renderAdvisorsTable();
}

// تقرير الخدمات
function renderServicesReport() {
  const chartsContainer = document.getElementById('reportCharts');
  const services = reportData.services;
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">توزيع أنواع الخدمات</div>
      <canvas id="servicesPieChart"></canvas>
    </div>
  `;
  
  const serviceLabels = Object.keys(services);
  const serviceValues = Object.values(services).map(s => s.total || s);
  
  const colors = ['#006341', '#1E7F5C', '#C8A55C', '#C0392B', '#8B5CF6', '#F59E0B'];
  
  const ctx = document.getElementById('servicesPieChart');
  if (currentCharts['servicesPie']) currentCharts['servicesPie'].destroy();
  currentCharts['servicesPie'] = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: serviceLabels,
      datasets: [{
        data: serviceValues,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right' }
      }
    }
  });
  
  renderServicesTable();
}

// تقرير الأداء
function renderPerformanceReport() {
  const chartsContainer = document.getElementById('reportCharts');
  
  chartsContainer.innerHTML = `
    <div class="chart-container" style="grid-column:1/-1;">
      <div class="chart-title">مؤشرات الأداء الرئيسية</div>
      <canvas id="performanceChart"></canvas>
    </div>
  `;
  
  const summary = reportData.summary;
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(0) : 0;
  const inProgressRate = summary.total > 0 ? ((summary.inProgress / summary.total) * 100).toFixed(0) : 0;
  const pendingRate = summary.total > 0 ? ((summary.pending / summary.total) * 100).toFixed(0) : 0;
  
  const ctx = document.getElementById('performanceChart');
  if (currentCharts['performance']) currentCharts['performance'].destroy();
  currentCharts['performance'] = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['نسبة الإنجاز', 'متوسط التقييم', 'سرعة الإنجاز', 'رضا العملاء', 'الكفاءة'],
      datasets: [{
        label: 'الأداء الحالي',
        data: [
          completionRate,
          (summary.avgRating / 5) * 100,
          Math.max(0, 100 - (summary.avgCompletionDays * 10)),
          (summary.avgRating / 5) * 100,
          completionRate
        ],
        backgroundColor: 'rgba(0, 99, 65, 0.2)',
        borderColor: '#006341',
        borderWidth: 2,
        pointBackgroundColor: '#006341'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100
        }
      }
    }
  });
  
  renderPerformanceTable();
}

// جداول التفاصيل
function renderRecentTicketsTable() {
  const container = document.getElementById('reportTables');
  const tickets = reportData.tickets.slice(0, 20);
  
  let html = '<div class="chart-title">أحدث التذاكر</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>رقم التذكرة</th><th>المتدرب</th><th>القسم</th><th>الخدمة</th><th>الحالة</th><th>التاريخ</th>';
  html += '</tr></thead><tbody>';
  
  tickets.forEach(t => {
    const status = t.status || t['الحالة'] || 'pending';
    const badge = status === 'completed' ? 'badge-success' : status === 'in_progress' ? 'badge-warning' : 'badge-danger';
    const statusText = status === 'completed' ? 'مكتملة' : status === 'in_progress' ? 'قيد التنفيذ' : 'معلقة';
    
    html += '<tr>';
    html += `<td><strong>${t.ticketNumber || t['رقم التذكرة'] || '-'}</strong></td>`;
    html += `<td>${t.traineeName || t['اسم المتدرب'] || '-'}</td>`;
    html += `<td>${t.department || t['القسم'] || '-'}</td>`;
    html += `<td>${t.serviceType || t['طلب الخدمة'] || '-'}</td>`;
    html += `<td><span class="badge ${badge}">${statusText}</span></td>`;
    html += `<td>${formatArabicDate(t.createdAt || t['التاريخ'], true)}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderDepartmentsTable() {
  const container = document.getElementById('reportTables');
  const departments = reportData.departments;
  
  let html = '<div class="chart-title">تفاصيل الأقسام</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>القسم</th><th>إجمالي</th><th>مكتملة</th><th>قيد التنفيذ</th><th>معلقة</th><th>نسبة الإنجاز</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(departments).forEach(([dept, stats]) => {
    const rate = stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
    html += '<tr>';
    html += `<td><strong>${dept}</strong></td>`;
    html += `<td>${stats.total}</td>`;
    html += `<td>${stats.completed}</td>`;
    html += `<td>${stats.inProgress || 0}</td>`;
    html += `<td>${stats.pending || 0}</td>`;
    html += `<td>${rate}%<div class="progress-bar"><div class="progress-fill" style="width:${rate}%"></div></div></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderAdvisorsTable() {
  const container = document.getElementById('reportTables');
  const advisors = reportData.advisors;
  
  let html = '<div class="chart-title">أداء المرشدين</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>المرشد</th><th>إجمالي التذاكر</th><th>مكتملة</th><th>متوسط التقييم</th><th>عدد التقييمات</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(advisors).forEach(([advisor, stats]) => {
    const rating = parseFloat(stats.avgRating) || 0;
    const ratingsCount = stats.ratingsCount || 0;
    html += '<tr>';
    html += `<td><strong>${advisor}</strong></td>`;
    html += `<td>${stats.total}</td>`;
    html += `<td>${stats.completed}</td>`;
    html += `<td>${rating > 0 ? rating + ' ⭐' : '-'}</td>`;
    html += `<td>${ratingsCount}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderServicesTable() {
  const container = document.getElementById('reportTables');
  const services = reportData.services;
  const total = Object.values(services).reduce((sum, s) => sum + (s.total || s), 0);
  
  let html = '<div class="chart-title">تفاصيل الخدمات</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>نوع الخدمة</th><th>عدد التذاكر</th><th>النسبة</th>';
  html += '</tr></thead><tbody>';
  
  Object.entries(services).forEach(([service, stats]) => {
    const count = stats.total || stats;
    const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
    html += '<tr>';
    html += `<td><strong>${service}</strong></td>`;
    html += `<td>${count}</td>`;
    html += `<td>${percent}%<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderPerformanceTable() {
  const container = document.getElementById('reportTables');
  const summary = reportData.summary;
  
  let html = '<div class="chart-title">ملخص الأداء</div>';
  html += '<table class="report-table"><thead><tr>';
  html += '<th>المؤشر</th><th>القيمة</th><th>الحالة</th>';
  html += '</tr></thead><tbody>';
  
  const completionRate = summary.total > 0 ? ((summary.completed / summary.total) * 100).toFixed(1) : 0;
  
  const metrics = [
    { name: 'نسبة الإنجاز', value: completionRate + '%', status: completionRate >= 70 ? 'ممتاز' : completionRate >= 50 ? 'جيد' : 'يحتاج تحسين' },
    { name: 'متوسط وقت الإنجاز', value: summary.avgCompletionDays + ' يوم', status: summary.avgCompletionDays <= 3 ? 'ممتاز' : summary.avgCompletionDays <= 5 ? 'جيد' : 'بطيء' },
    { name: 'متوسط التقييم', value: summary.avgRating + ' ⭐', status: summary.avgRating >= 4 ? 'ممتاز' : summary.avgRating >= 3 ? 'جيد' : 'يحتاج تحسين' },
    { name: 'التذاكر النشطة', value: summary.inProgress + summary.pending, status: 'نشط' }
  ];
  
  metrics.forEach(m => {
    const badgeClass = m.status === 'ممتاز' ? 'badge-success' : m.status === 'جيد' ? 'badge-info' : 'badge-warning';
    html += '<tr>';
    html += `<td><strong>${m.name}</strong></td>`;
    html += `<td>${m.value}</td>`;
    html += `<td><span class="badge ${badgeClass}">${m.status}</span></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ========== تصدير PDF و Excel ==========

// تصدير PDF كصورة لحل مشكلة اللغة
async function exportReportPDF() {
  showLoading('جاري إنشاء ملف PDF...');
  
  try {
    // تحميل المكتبات إذا لم تكن محملة
    if (typeof jspdf === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    }
    if (typeof html2canvas === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // التقاط صفحة التقرير كاملة كصورة
    const reportContent = document.getElementById('reportContent');
    if (!reportContent) {
      throw new Error('لم يتم العثور على محتوى التقرير');
    }
    
    const canvas = await html2canvas(reportContent, {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false
    });
    
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210; // عرض A4 بالملليمتر
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    // إضافة الصفحة الأولى
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= 297; // ارتفاع صفحة A4
    
    // إضافة صفحات إضافية إذا لزم الأمر
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= 297;
    }
    
    // حفظ الملف
    const reportType = document.getElementById('reportType').value;
    const reportTypeNames = {
      'overview': 'نظرة_عامة',
      'departments': 'تقرير_الأقسام',
      'advisors': 'تقرير_المرشدين',
      'services': 'تقرير_الخدمات',
      'performance': 'تقرير_الأداء'
    };
    
    const date = new Date().toLocaleDateString('ar-SA').replace(/\//g, '-');
    const fileName = `تقرير_${reportTypeNames[reportType]}_${date}.pdf`;
    pdf.save(fileName);
    
    hideLoading();
    showSuccess('تم تصدير التقرير بصيغة PDF بنجاح!');
    
  } catch (error) {
    hideLoading();
    showError('حدث خطأ أثناء تصدير PDF: ' + error.message);
    console.error(error);
  }
}

// تصدير Excel باستخدام SheetJS
function exportReportExcel() {
  showLoading('جاري إنشاء ملف Excel...');
  
  try {
    // تحميل المكتبة إذا لم تكن محملة
    if (typeof XLSX === 'undefined') {
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js')
        .then(() => generateExcelFile())
        .catch(err => {
          hideLoading();
          showError('فشل تحميل مكتبة Excel');
        });
      return;
    }
    
    generateExcelFile();
    
  } catch (error) {
    hideLoading();
    showError('حدث خطأ أثناء تصدير Excel: ' + error.message);
    console.error(error);
  }
}

function generateExcelFile() {
  const wb = XLSX.utils.book_new();
  const summary = reportData.summary;
  const reportType = document.getElementById('reportType').value;
  
  // ورقة المؤشرات الرئيسية
  const kpisData = [
    ['مؤشرات الأداء الرئيسية', ''],
    ['', ''],
    ['المؤشر', 'القيمة'],
    ['إجمالي التذاكر', summary.total],
    ['مكتملة', summary.completed],
    ['قيد التنفيذ', summary.inProgress],
    ['معلقة', summary.pending],
    ['محولة', summary.transferred],
    ['متوسط التقييم', summary.avgRating],
    ['إجمالي التقييمات', summary.totalRatings],
    ['متوسط وقت الإنجاز (يوم)', summary.avgCompletionDays],
    ['نسبة الإنجاز', ((summary.completed / summary.total) * 100).toFixed(1) + '%'],
    ['التذاكر في آخر 30 يوم', summary.last30Days]
  ];
  
  const wsKPIs = XLSX.utils.aoa_to_sheet(kpisData);
  wsKPIs['!cols'] = [{ wch: 30 }, { wch: 15 }];
  
  // إضافة ألوان للعناوين
  const headerStyle = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
  const titleStyle = { fill: { fgColor: { rgb: "C8A55C" } }, font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
  const dataLabelStyle = { fill: { fgColor: { rgb: "E6F1EC" } }, font: { bold: true }, alignment: { horizontal: "right" } };
  
  wsKPIs['A1'].s = titleStyle;
  wsKPIs['A3'].s = headerStyle;
  wsKPIs['B3'].s = headerStyle;
  
  for (let i = 4; i <= 13; i++) {
    if (wsKPIs[`A${i}`]) wsKPIs[`A${i}`].s = dataLabelStyle;
  }
  
  XLSX.utils.book_append_sheet(wb, wsKPIs, 'المؤشرات الرئيسية');
  
  // ورقة الأقسام
  if (reportData.departments) {
    const deptData = [['القسم', 'إجمالي', 'مكتملة', 'قيد التنفيذ', 'معلقة', 'نسبة الإنجاز']];
    
    Object.entries(reportData.departments).forEach(([dept, stats]) => {
      const rate = stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
      deptData.push([
        dept,
        stats.total,
        stats.completed,
        stats.inProgress || 0,
        stats.pending || 0,
        rate + '%'
      ]);
    });
    
    const wsDept = XLSX.utils.aoa_to_sheet(deptData);
    wsDept['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 15 }];
    
    // إضافة ألوان للعناوين
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1'];
    headerCells.forEach(cell => {
      if (wsDept[cell]) wsDept[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsDept, 'الأقسام');
  }
  
  // ورقة المرشدين
  if (reportData.advisors) {
    const advisorData = [['المرشد', 'إجمالي التذاكر', 'مكتملة', 'متوسط التقييم', 'عدد التقييمات']];
    
    Object.entries(reportData.advisors).forEach(([advisor, stats]) => {
      advisorData.push([
        advisor,
        stats.total,
        stats.completed,
        stats.avgRating || 0,
        stats.ratingsCount || 0
      ]);
    });
    
    const wsAdvisor = XLSX.utils.aoa_to_sheet(advisorData);
    wsAdvisor['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }];
    
    // إضافة ألوان للعناوين
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1'];
    headerCells.forEach(cell => {
      if (wsAdvisor[cell]) wsAdvisor[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsAdvisor, 'المرشدين');
  }
  
  // ورقة الخدمات
  if (reportData.services) {
    const servicesData = [['نوع الخدمة', 'عدد التذاكر', 'النسبة']];
    const total = Object.values(reportData.services).reduce((a, b) => a + b, 0);
    
    Object.entries(reportData.services).forEach(([service, count]) => {
      const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
      servicesData.push([service, count, percent + '%']);
    });
    
    const wsServices = XLSX.utils.aoa_to_sheet(servicesData);
    wsServices['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 10 }];
    
    // إضافة ألوان للعناوين
    const headerCells = ['A1', 'B1', 'C1'];
    headerCells.forEach(cell => {
      if (wsServices[cell]) wsServices[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsServices, 'الخدمات');
  }
  
  // ورقة سجل المواقف اليومية للمتدربين
  if (reportData.tickets && reportData.tickets.length > 0) {
    const dailyLogData = [['رقم التذكرة', 'التاريخ', 'الوقت', 'الرقم التدريبي', 'اسم المتدرب', 'القسم', 'التخصص', 'اسم المرشد التدريبي', 'طلب الخدمة', 'تفاصيل الخدمة', 'الحالة', 'ملاحظات']];
    
    reportData.tickets.forEach(t => {
      dailyLogData.push([
        t.ticketNumber || t['رقم التذكرة'] || '',
        t.date || t['التاريخ'] || '',
        t.time || t['الوقت'] || '',
        t.traineeId || t['الرقم التدريبي'] || '',
        t.traineeName || t['اسم المتدرب'] || '',
        t.department || t['القسم'] || '',
        t.specialization || t['التخصص'] || '',
        t.advisorName || t['اسم المرشد التدريبي'] || '',
        t.serviceType || t['طلب الخدمة'] || '',
        t.serviceDetails || t['تفاصيل الخدمة'] || '',
        t.status === 'completed' ? 'مكتمل' : t.status === 'in_progress' ? 'قيد التنفيذ' : t.status === 'pending' ? 'معلق' : t.status || t['الحالة'] || '',
        t.notes || t['ملاحظات'] || ''
      ]);
    });
    
    const wsDailyLog = XLSX.utils.aoa_to_sheet(dailyLogData);
    wsDailyLog['!cols'] = [
      { wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 20 }, 
      { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 30 }, 
      { wch: 12 }, { wch: 30 }
    ];
    
    // إضافة ألوان للعناوين
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1', 'J1', 'K1', 'L1'];
    headerCells.forEach(cell => {
      if (wsDailyLog[cell]) wsDailyLog[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsDailyLog, 'سجل المواقف اليومية');
  }
  
  // ورقة تتبع الحالة (آخر 100 تذكرة)
  if (reportData.tickets && reportData.tickets.length > 0) {
    const trackingData = [['رقم التذكرة', 'اسم المتدرب', 'القسم', 'اسم المرشد التدريبي', 'نوع الخدمة', 'الحالة', 'التاريخ', 'تاريخ الإنجاز', 'الحل المقدم']];
    
    reportData.tickets.slice(0, 100).forEach(t => {
      trackingData.push([
        t.ticketNumber || t['رقم التذكرة'] || '',
        t.traineeName || t['اسم المتدرب'] || '',
        t.department || t['القسم'] || '',
        t.advisorName || t['اسم المرشد التدريبي'] || '',
        t.serviceType || t['طلب الخدمة'] || '',
        t.status === 'completed' ? 'مكتمل' : t.status === 'in_progress' ? 'قيد التنفيذ' : t.status === 'pending' ? 'معلق' : t.status || t['الحالة'] || '',
        t.date || t['التاريخ'] || '',
        t.completionDate || t['تاريخ الإنجاز'] || '',
        t.solution || t['الحل المقدم'] || ''
      ]);
    });
    
    const wsTracking = XLSX.utils.aoa_to_sheet(trackingData);
    wsTracking['!cols'] = [
      { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, 
      { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 30 }
    ];
    
    // إضافة ألوان للعناوين
    const trackingHeaders = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1'];
    trackingHeaders.forEach(cell => {
      if (wsTracking[cell]) wsTracking[cell].s = { fill: { fgColor: { rgb: "006341" } }, font: { bold: true, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center" } };
    });
    
    XLSX.utils.book_append_sheet(wb, wsTracking, 'تتبع الحالة');
  }
  
  // حفظ الملف
  const reportTypeNames = {
    'overview': 'نظرة_عامة',
    'departments': 'تقرير_الأقسام',
    'advisors': 'تقرير_المرشدين',
    'services': 'تقرير_الخدمات',
    'performance': 'تقرير_الأداء'
  };
  
  const date = new Date().toLocaleDateString('ar-SA').replace(/\//g, '-');
  const fileName = `تقرير_${reportTypeNames[reportType]}_${date}.xlsx`;
  
  XLSX.writeFile(wb, fileName);
  
  hideLoading();
  showSuccess('تم تصدير التقرير بصيغة Excel بنجاح!');
}

// تحميل سكريبت خارجي
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}
</script>

</body>
</html>
<!-- ========== Developer Credits ========== -->
<div id="devCredits" style="position:fixed;bottom:10px;left:10px;background:linear-gradient(135deg,var(--tvtc-primary),var(--tvtc-secondary));color:#fff;padding:8px 16px;border-radius:8px;font-size:12px;box-shadow:0 2px 10px rgba(0,99,65,0.3);z-index:9999;display:flex;align-items:center;gap:8px;">
  <span style="font-size:16px;">💻</span>
  <div>
    <div style="font-weight:600;margin-bottom:2px;">تطوير: م. فهد صالح</div>
    <div style="opacity:0.9;font-size:11px;">وكيل ضبط الجودة - الكلية التقنية بحقل</div>
  </div>
</div>

<style>
#devCredits {
  animation: slideInLeft 0.5s ease-out;
  transition: all 0.3s;
}
#devCredits:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 20px rgba(0,99,65,0.4);
}
@keyframes slideInLeft {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
@media (max-width: 768px) {
  #devCredits {
    bottom: 5px;
    left: 5px;
    padding: 6px 10px;
    font-size: 10px;
  }
  #devCredits > span {
    font-size: 14px;
  }
  #devCredits > div > div:first-child {
    font-size: 11px;
  }
  #devCredits > div > div:last-child {
    font-size: 9px;
  }
}
</style>
